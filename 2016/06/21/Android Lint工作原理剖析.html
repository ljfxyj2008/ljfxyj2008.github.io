<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8">
  
  <title>Android Lint工作原理剖析 | ljfxyj2008风巢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Android Lint是Android SDK提供的一项静态代码分析工具，对于提高代码质量具有重要作用。到目前为止，Android SDK自带的Lint检查项目达到了253项，我们在开发过程中经常见到的提示信息比如“Id被重复定义”“HandlerLeak风险”其实都是由Lint检查实现的。本文结合源码对其工作原理进行分析。">
<meta property="og:type" content="article">
<meta property="og:title" content="Android Lint工作原理剖析">
<meta property="og:url" content="http://www.carrotsight.com/2016/06/21/Android Lint工作原理剖析.html">
<meta property="og:site_name" content="ljfxyj2008风巢">
<meta property="og:description" content="Android Lint是Android SDK提供的一项静态代码分析工具，对于提高代码质量具有重要作用。到目前为止，Android SDK自带的Lint检查项目达到了253项，我们在开发过程中经常见到的提示信息比如“Id被重复定义”“HandlerLeak风险”其实都是由Lint检查实现的。本文结合源码对其工作原理进行分析。">
<meta property="og:image" content="http://7xle8x.com1.z0.glb.clouddn.com/16-4-13/85143697.jpg">
<meta property="og:image" content="http://7xle8x.com1.z0.glb.clouddn.com/16-4-13/26772828.jpg">
<meta property="og:image" content="http://7xle8x.com1.z0.glb.clouddn.com/16-4-14/7318144.jpg">
<meta property="og:image" content="http://7xle8x.com1.z0.glb.clouddn.com/16-4-14/97736321.jpg">
<meta property="og:image" content="http://7xle8x.com1.z0.glb.clouddn.com/16-4-14/34604208.jpg">
<meta property="og:image" content="http://7xle8x.com1.z0.glb.clouddn.com/16-4-14/97287156.jpg">
<meta property="og:image" content="http://7xle8x.com1.z0.glb.clouddn.com/16-4-14/6501806.jpg">
<meta property="og:image" content="http://7xle8x.com1.z0.glb.clouddn.com/16-4-14/70344961.jpg">
<meta property="og:updated_time" content="2016-06-21T03:50:35.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android Lint工作原理剖析">
<meta name="twitter:description" content="Android Lint是Android SDK提供的一项静态代码分析工具，对于提高代码质量具有重要作用。到目前为止，Android SDK自带的Lint检查项目达到了253项，我们在开发过程中经常见到的提示信息比如“Id被重复定义”“HandlerLeak风险”其实都是由Lint检查实现的。本文结合源码对其工作原理进行分析。">
  
    <link rel="alternative" href="/atom.xml" title="ljfxyj2008风巢" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
  
      <link href="//cdn.bootcss.com/jqueryui/1.10.4/css/jquery-ui.min.css" rel="stylesheet">
  
  
      <script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
      <link href="//cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-minimal.css" rel="stylesheet">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css" type="text/css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
  
    <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  
  <script src="//cdn.bootcss.com/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
  <script>
      var yiliaConfig = {
          fancybox: true,
          animate: false,
          isHome: false,
          isPost: true,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false,
      }
  </script>

  
      <script>
          yiliaConfig.rootUrl = "/";
      </script>
  

  
      <script>
          var _hmt = _hmt || [];
          (function() {
              var hm = document.createElement("script");
              hm.src = "//hm.baidu.com/hm.js?449259d6f926d9e469b862f243275e59";
              var s = document.getElementsByTagName("script")[0]; 
              s.parentNode.insertBefore(hm, s);
          })();
      </script>
  
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        <a href="/" class="profilepic">
            <img src="/uploads/icon_leehom.jpg" class="animated zoomIn">
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">ljfxyj2008</a></h1>
        </hgroup>

        
        <p class="header-subtitle">记录点滴</p>
        
                


        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                    
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>友情链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        

        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a href="/">主页</a></li>
                        
                            <li><a href="/archives/">所有文章</a></li>
                        
                            <li><a href="/tags/">标签云</a></li>
                        
                            <li><a href="/memo/">备忘</a></li>
                        
                            <li><a href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <li id="Email"><a class="Email" target="_blank" href="mailto:ljfxyj2008@gmail.com" title="Email"></a></li>
                            
                                <li id="GitHub"><a class="GitHub" target="_blank" href="https://github.com/ljfxyj2008" title="GitHub"></a></li>
                            
                                <li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
                            
                                <li id="Facebook"><a class="Facebook" target="_blank" href="https://www.facebook.com/ljfxyj2008" title="Facebook"></a></li>
                            
                                <li id="StackOverflow"><a class="StackOverflow" target="_blank" href="http://stackoverflow.com/users/5788604/ljfxyj2008" title="StackOverflow"></a></li>
                            
                        </ul>
                    </nav>
                </section>
                
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/Android/" style="font-size: 20px;">Android</a> <a href="/tags/Annotation/" style="font-size: 10px;">Annotation</a> <a href="/tags/EventBus/" style="font-size: 13.33px;">EventBus</a> <a href="/tags/FlatBuffers/" style="font-size: 10px;">FlatBuffers</a> <a href="/tags/Google/" style="font-size: 10px;">Google</a> <a href="/tags/IPC/" style="font-size: 10px;">IPC</a> <a href="/tags/Java/" style="font-size: 16.67px;">Java</a> <a href="/tags/Lint/" style="font-size: 16.67px;">Lint</a> <a href="/tags/Otto/" style="font-size: 10px;">Otto</a> <a href="/tags/Proguard/" style="font-size: 10px;">Proguard</a> <a href="/tags/View/" style="font-size: 10px;">View</a> <a href="/tags/custom-lint-rules/" style="font-size: 13.33px;">custom lint rules</a> <a href="/tags/facebook/" style="font-size: 10px;">facebook</a> <a href="/tags/reflection/" style="font-size: 10px;">reflection</a> <a href="/tags/system-server/" style="font-size: 10px;">system_server</a> <a href="/tags/zygote/" style="font-size: 13.33px;">zygote</a> <a href="/tags/反射/" style="font-size: 13.33px;">反射</a> <a href="/tags/多线程/" style="font-size: 10px;">多线程</a> <a href="/tags/安全/" style="font-size: 10px;">安全</a> <a href="/tags/并发/" style="font-size: 10px;">并发</a> <a href="/tags/库项目/" style="font-size: 10px;">库项目</a> <a href="/tags/日志/" style="font-size: 10px;">日志</a> <a href="/tags/时间轴/" style="font-size: 10px;">时间轴</a> <a href="/tags/源码分析/" style="font-size: 13.33px;">源码分析</a> <a href="/tags/观察者模式/" style="font-size: 10px;">观察者模式</a>
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part3">
                    <div id="js-friends">
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://hexo.io">Hexo</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="https://pages.github.com/">GitHub</a>
                    
                      <a target="_blank" class="main-nav-link switch-friends-link" href="http://moxfive.xyz/">MOxFIVE</a>
                    
                    </div>
                </section>
                

                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">专注于Android应用开发</div>
                </section>
                
            </div>
        </div>
    </header>                
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">ljfxyj2008</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                <img src="/uploads/icon_leehom.jpg" class="animated zoomIn">
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">ljfxyj2008</a></h1>
            </hgroup>
            
            <p class="header-subtitle">记录点滴</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/">主页</a></li>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/tags/">标签云</a></li>
                
                    <li><a href="/memo/">备忘</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                        <ul class="social">
                            
                                <li id="Email"><a class="Email" target="_blank" href="mailto:ljfxyj2008@gmail.com" title="Email"></a></li>
                            
                                <li id="GitHub"><a class="GitHub" target="_blank" href="https://github.com/ljfxyj2008" title="GitHub"></a></li>
                            
                                <li id="RSS"><a class="RSS" target="_blank" href="/atom.xml" title="RSS"></a></li>
                            
                                <li id="Facebook"><a class="Facebook" target="_blank" href="https://www.facebook.com/ljfxyj2008" title="Facebook"></a></li>
                            
                                <li id="StackOverflow"><a class="StackOverflow" target="_blank" href="http://stackoverflow.com/users/5788604/ljfxyj2008" title="StackOverflow"></a></li>
                            
                        </ul>
            </nav>
        </header>                
    </div>
</nav>
      <div class="body-wrap"><article id="post-Android Lint工作原理剖析" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/06/21/Android Lint工作原理剖析.html" class="article-date">
      <time datetime="2016-06-21T03:45:50.000Z" itemprop="datePublished">2016-06-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Android Lint工作原理剖析
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
    <div class="article-category tagcloud">
    <a class="article-category-link" href="/categories/Android/">Android</a>
    </div>


        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Lint/">Lint</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <h2 id="官方对自定义Lint的支持">官方对自定义Lint的支持</h2><p>Android Lint是Android SDK提供的一项静态代码分析工具，对于提高代码质量具有重要作用。到目前为止，Android SDK自带的Lint检查项目达到了253项，我们在开发过程中经常见到的提示信息比如“Id被重复定义”“HandlerLeak风险”其实都是由Lint检查实现的。</p>
<p>Android Studio 2.0 Stable版本已经于2016年4月7日正式发布。除了Instant Run让人眼前一亮，更让人惊喜的是，官方已经悄然把自定义Lint的检查与IDE整合起来了。在此之前，自定义Lint规则只能通过在终端中执行gradle任务来运行，然后生成报告文件。<br>Android Studio 2.0中整合自定义Lint检查的效果如图：<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-4-13/85143697.jpg" alt=""></p>
<p>图中红线提示的错误是我自定义的Lint规则检查的结果，大意是Activity使用的布局文件应该以“activity_”为前缀进行命名。  </p>
<p>关于Lint的一些基本知识，以及自定义Lint如何实现，可以参考我之前的文章：<br><a href="http://www.carrotsight.com/2016/01/29/浅谈Android自定义Lint规则的实现%20（一）.html">浅谈Android自定义Lint规则的实现 （一）</a><br><a href="http://www.carrotsight.com/2016/02/01/浅谈Android自定义Lint规则的实现%20（二）.html">浅谈Android自定义Lint规则的实现 （二）</a></p>
<p>从Android Studio的“偏好”设置窗口中，用户可以设置IDE整合的Lint检查功能的细节，如图：<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-4-13/26772828.jpg" alt=""></p>
<p>虽然这个设置选项在旧版的Android Studio中也能看到，但实际上在旧版中是不起作用的。  </p>
<p>除了在Editor中能够以红色下划线标注自定义检查项目外，使用Android Studio的 “Analyze” –&gt; “Inspect Code”现在也会检查自定义Lint规则中定义的项目了。Android Studio 2.0的这一功能整合真是太棒了，大大提高了自定义Lint的实用性。</p>
<h2 id="Lint工作流程探究">Lint工作流程探究</h2><p>介绍完Android Studio 2.0的新特性，现在进入正题，我们来探究一下Lint检查的工作原理，包括系统默认的Lint检查项目以及用户自定义的Lint检查项目。<br>本文以终端运行gradle的lint任务为例进行分析。其中自定义lint的使用方式是把自定义lint以aar的形式提供给app进行引用，具体实现方式可以参考<a href="http://www.carrotsight.com/2016/01/29/浅谈Android自定义Lint规则的实现%20（一）.html">浅谈Android自定义Lint规则的实现 （一）</a> 。</p>
<p>当我们在终端执行“gradle lint”任务后，会加载com.android.build.gradle.tasks.Lint类，它的源码位于Lint.groovy文件中。<br>Lint类的lint（）方法会首先被执行，这也是整个lint检查流程开始运转的起点。这部分代码如下：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@SuppressWarnings</span>(<span class="string">"GroovyUnusedDeclaration"</span>)</span><br><span class="line"><span class="annotation">@TaskAction</span></span><br><span class="line"><span class="keyword">public</span> <span class="typename">void</span> lint() &#123;</span><br><span class="line">    <span class="keyword">def</span> modelProject = createAndroidProject(project)</span><br><span class="line">    <span class="keyword">if</span> (getVariantName() != <span class="literal">null</span> &amp;&amp; !getVariantName().isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Variant <span class="string">variant :</span> modelProject.getVariants()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (variant.getName().equals(getVariantName())) &#123;</span><br><span class="line">                lintSingleVariant(modelProject, variant);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        lintAllVariants(modelProject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里会根据getVariantName()的执行结果，选择去调用lintSingleVariant（）还是lintAllVariants（）。而观察lintSingleVariant（）和lintAllVariants（）的源码，发现这两个方法最终都要调用runLint（）方法，这个runLint（）方法很重要，代码片段如下：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Runs lint on the given variant and returns the set of warnings */</span></span><br><span class="line"><span class="keyword">private</span> List&lt;Warning&gt; runLint(</span><br><span class="line">        <span class="annotation">@NonNull</span> AndroidProject modelProject,</span><br><span class="line">        <span class="annotation">@NonNull</span> Variant variant,</span><br><span class="line">        <span class="typename">boolean</span> report) &#123;</span><br><span class="line">    IssueRegistry registry = createIssueRegistry()</span><br><span class="line">    LintCliFlags flags = <span class="keyword">new</span> LintCliFlags()</span><br><span class="line">    LintGradleClient client = <span class="keyword">new</span> LintGradleClient(registry, flags, project, modelProject,</span><br><span class="line">            mSdkHome, variant, getBuildTools())</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//..........这里省略部分代码.......</span></span><br><span class="line">    </span><br><span class="line">    warnings = client.run(registry)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//.........</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法的第一句话是创建了一个IssueRegistry，而了解自定义Lint的用户一定对这个类不会陌生，在之前的文章中我们提到过，Android内建的Lint检查项目都是定义在BuiltinIssueRegistry类中，而BuiltinIssueRegistry就是派生自IssueRegistry，我们要实现的自定义Lint检查规则实际上也就是实现自定义的IssueRegistry子类。<br>IssueRegistry类的完整名称是com.android.tools.lint.client.api.IssueRegistry，它是一个Java类。自此，lint从一个gradle task开始与lint api包中的java类产生交互了。  </p>
<p>createIssueRegistry()方法很简单，只有一句话：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> BuiltinIssueRegistry createIssueRegistry() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LintGradleIssueRegistry()</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>继续跟踪LintGradleIssueRegistry类：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LintGradleIssueRegistry</span> <span class="keyword">extends</span> <span class="title">BuiltinIssueRegistry</span> &#123;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="typename">boolean</span> mInitialized;</span><br><span class="line">    <span class="keyword">public</span> LintGradleIssueRegistry() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="annotation">@NonNull</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Issue&gt; getIssues() &#123;</span><br><span class="line">        List&lt;Issue&gt; issues = <span class="keyword">super</span>.getIssues();</span><br><span class="line">        <span class="keyword">if</span> (!mInitialized) &#123;</span><br><span class="line">            mInitialized = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">for</span> (Issue <span class="string">issue :</span> issues) &#123;</span><br><span class="line">                <span class="keyword">if</span> (issue.getImplementation().getDetectorClass() == GradleDetector.<span class="keyword">class</span>) &#123;</span><br><span class="line">                    issue.setImplementation(GroovyGradleDetector.IMPLEMENTATION);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> issues;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的BuiltinIssueRegistry我们刚才也提到了，用户平时在执行gradle lint时默认会执行200多项检查，这些默认检查项目都是Android SDK通过BuiltinIssueRegistry定义的。  </p>
<p>继续执行上面的run（）方法，new出来的LintGradleClient实际上是com.android.tools.lint.LintCliClient的子类，这个类的作用是提供执行lint任务的环境信息（比如控制台、IDE的信息），执行IssueRegistry中定义的各种ISSUE检查，以及以多种形式输出lint报告等。  </p>
<p>继续执行run（）方法，也就是<code>warnings = client.run(registry)</code>。看到这里终于知道BuiltinIssueRegistry中定义的200多项ISSUE是如何被gradle的lint任务引入检查了。</p>
<p>到这里为止，对groovy文件的分析就结束了，由于LintGradleClient是继承自java类LintCliClient，后续真正的lint检查工作都通过<code>client.run(registry)</code>这句话转交给java实现的LintCliClient类来完成。  </p>
<p>读到这里有人会问，client.run(registry)中的参数registry是派生自BuiltinIssueRegistry，那么lint检查的项目也就是BuiltinIssueRegistry中定义的那200多项默认检查项目。那么我们自定义的lint规则中的ISSUE又是如何被引入lint检查的呢？不要急，下面会有分析。</p>
<p>LintCliClient类的run（）方法的主要代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//LintCliClient.run（)部分代码</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(@NonNull IssueRegistry registry, @NonNull List&lt;File&gt; files)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">//............    </span></span><br><span class="line">    mDriver = <span class="keyword">new</span> LintDriver(registry, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//............ </span></span><br><span class="line">    mDriver.analyze(createLintRequest(files));</span><br><span class="line"></span><br><span class="line">    Collections.sort(mWarnings);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> hasConsoleOutput = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (Reporter reporter : mFlags.getReporters()) &#123;</span><br><span class="line">        reporter.write(mErrorCount, mWarningCount, mWarnings);</span><br><span class="line">        <span class="keyword">if</span> (reporter <span class="keyword">instanceof</span> TextReporter &amp;&amp; ((TextReporter)reporter).isWriteToConsole()) &#123;</span><br><span class="line">            hasConsoleOutput = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mFlags.isQuiet() &amp;&amp; !hasConsoleOutput) &#123;</span><br><span class="line">        System.out.println(String.format(</span><br><span class="line">                <span class="string">"Lint found %1$d errors and %2$d warnings"</span>, mErrorCount, mWarningCount));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mFlags.isSetExitCode() ? (mHasErrors ? ERRNO_ERRORS : ERRNO_SUCCESS) : ERRNO_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不要被run（）这个方法名迷惑了，以为LintCliClient是一个线程类。其实LintCliClient只是一个普通类，不是Runnable类，这里的方法也叫run（）仅仅是一个巧合。<br>这里的run（）方法中首先new了一个LintDriver对象，其实它才是真正用来对project和file进行lint分析的类，也就是通过mDriver.analyze（）来进行lint分析。</p>
<p>LintDriver的analyze()方法精简后的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//LintDriver.analyze()部分源码</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">analyze</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//............</span></span><br><span class="line">    Collection&lt;Project&gt; projects;</span><br><span class="line"></span><br><span class="line">    projects = mRequest.getProjects();</span><br><span class="line">        <span class="keyword">if</span> (projects == <span class="keyword">null</span>) &#123;</span><br><span class="line">            projects = computeProjects(mRequest.getFiles());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//............</span></span><br><span class="line">   </span><br><span class="line">    registerCustomDetectors(projects);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mScope == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mScope = Scope.infer(projects);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fireEvent(EventType.STARTING, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Project project : projects) &#123;</span><br><span class="line">        mPhase = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        Project main = mRequest.getMainProject(project);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The set of available detectors varies between projects</span></span><br><span class="line">        computeDetectors(project);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mApplicableDetectors.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// No detectors enabled in this project: skip it</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        checkProject(project, main);</span><br><span class="line">        <span class="keyword">if</span> (mCanceled) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        runExtraPhases(project, main);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fireEvent(mCanceled ? EventType.CANCELED : EventType.COMPLETED, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的projects变量中保存的就是等待进行Lint检查的工程项目，它是我们最开始在终端中执行<code>gradle lint</code>任务时指定的。比如在本例中，projects中保存的就是“Project [dir=/Users/netease/AndroidStudioProjects/HTLint/app]”这个项目。</p>
<p>继续往下执行，走到<code>registerCustomDetectors(projects)</code>这句话，看到这个方法名你是不是发现了什么？别急，我们先看看registerCustomDetectors（）方法的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerCustomDetectors</span><span class="params">(Collection&lt;Project&gt; projects)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Look at the various projects, and if any of them provide a custom</span></span><br><span class="line">    <span class="comment">// lint jar, "add" them (this will replace the issue registry with</span></span><br><span class="line">    <span class="comment">// a CompositeIssueRegistry containing the original issue registry</span></span><br><span class="line">    <span class="comment">// plus JarFileIssueRegistry instances for each lint jar</span></span><br><span class="line">    Set&lt;File&gt; jarFiles = Sets.newHashSet();</span><br><span class="line">    <span class="keyword">for</span> (Project project : projects) &#123;</span><br><span class="line">        jarFiles.addAll(mClient.findRuleJars(project));</span><br><span class="line">        <span class="keyword">for</span> (Project library : project.getAllLibraries()) &#123;</span><br><span class="line">            jarFiles.addAll(mClient.findRuleJars(library));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    jarFiles.addAll(mClient.findGlobalRuleJars());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!jarFiles.isEmpty()) &#123;</span><br><span class="line">        List&lt;IssueRegistry&gt; registries = Lists.newArrayListWithExpectedSize(jarFiles.size());</span><br><span class="line">        registries.add(mRegistry);</span><br><span class="line">        <span class="keyword">for</span> (File jarFile : jarFiles) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                IssueRegistry registry = JarFileIssueRegistry.get(mClient, jarFile);</span><br><span class="line">                <span class="keyword">if</span> (myCustomIssues == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    myCustomIssues = Sets.newHashSet();</span><br><span class="line">                &#125;</span><br><span class="line">                myCustomIssues.addAll(registry.getIssues());</span><br><span class="line">                registries.add(registry);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                mClient.log(e, <span class="string">"Could not load custom rule jar file %1$s"</span>, jarFile);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (registries.size() &gt; <span class="number">1</span>) &#123; <span class="comment">// the first item is mRegistry itself</span></span><br><span class="line">            mRegistry = <span class="keyword">new</span> CompositeIssueRegistry(registries);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于projects中的每一项project，都通过<code>mClient.findRuleJars(project)</code>方法来寻找该project中的RuleJars，那么findRuleJars（）是如何实现的呢？它返回的RuleJars又是什么呢？</p>
<p>由于在LintDriver的构造函数中，mClient被初始化为一个LintClientWrapper对象，而LintClientWrapper类的findRuleJars（）方法内部只有一句话:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> mDelegate.findRuleJars(project)</span><br></pre></td></tr></table></figure>
<p>所以上面的<code>mClient.findRuleJars(project)</code>实际上是被委托给了LintGradleClient.java来实现。LintGradleClient类又在它的createLintRequest（）方法中调用了LintGradleProject的静态方法create()，其中有这样一个片段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Pair&lt;LintGradleProject, List&lt;File&gt;&gt; create(</span><br><span class="line">        <span class="annotation">@NonNull</span> LintGradleClient client,</span><br><span class="line">        <span class="annotation">@NonNull</span> AndroidProject project,</span><br><span class="line">        <span class="annotation">@NonNull</span> Variant variant,</span><br><span class="line">        <span class="annotation">@NonNull</span> org.gradle.api.Project gradleProject) &#123;</span><br><span class="line">    <span class="comment">//............</span></span><br><span class="line"></span><br><span class="line">    List&lt;File&gt; customRules = Lists.newArrayList();</span><br><span class="line">    File appLintJar = <span class="keyword">new</span> File(gradleProject.getBuildDir(),</span><br><span class="line">            <span class="string">"lint"</span> + separatorChar + <span class="string">"lint.jar"</span>);</span><br><span class="line">    <span class="keyword">if</span> (appLintJar.exists()) &#123;</span><br><span class="line">        customRules.add(appLintJar);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//............</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码会寻找当前项目的构建目录下是否引用了一个名为lint.jar文件，如果有就把它加入customRules列表中。<br>我们在《浅谈Android自定义Lint规则的实现》中提到过通过aar包装lint.jar文件，然后让需要自定义lint检查的android项目添加对aar的依赖，这也是本文的例子使用的引入自定义lint规则的方法。原来我们添加的依赖中的lint.jar文件是在这里被找出来的。</p>
<p>继续回去看registerCustomDetectors（）方法后续的代码执行，也就是这一段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Project library : project.getAllLibraries()) &#123;</span><br><span class="line">    jarFiles.addAll(mClient.findRuleJars(library));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码会对当前工程依赖的所有库文件进行检查，如果这些库文件有对名为lint.jar文件的引用，则把它们引用的lint.jar文件也加入到jarFiles集合中。<br>如此一来，不管是项目直接依赖的lint.jar文件，还是间接通过其他库引入的lint.jar文件，就都被放入jarFiles集合中了。</p>
<p>继续往下执行registerCustomDetectors（）中的代码，走到了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jarFiles.addAll(mClient.findGlobalRuleJars());</span><br></pre></td></tr></table></figure>
<p>这里的findGlobalRuleJars()方法实际是由LintClient实现的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.android.tools.lint.client.api.LintClient类</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;File&gt; <span class="title">findGlobalRuleJars</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Look for additional detectors registered by the user, via</span></span><br><span class="line">    <span class="comment">// (1) an environment variable (useful for build servers etc), and</span></span><br><span class="line">    <span class="comment">// (2) via jar files in the .android/lint directory</span></span><br><span class="line">    List&lt;File&gt; files = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String androidHome = AndroidLocation.getFolder();</span><br><span class="line">        File lint = <span class="keyword">new</span> File(androidHome + File.separator + <span class="string">"lint"</span>); <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">        <span class="keyword">if</span> (lint.exists()) &#123;</span><br><span class="line">            File[] list = lint.listFiles();</span><br><span class="line">            <span class="keyword">if</span> (list != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (File jarFile : list) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (endsWith(jarFile.getName(), DOT_JAR)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (files == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            files = <span class="keyword">new</span> ArrayList&lt;File&gt;();</span><br><span class="line">                        &#125;</span><br><span class="line">                        files.add(jarFile);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (AndroidLocation.AndroidLocationException e) &#123;</span><br><span class="line">        <span class="comment">// Ignore -- no android dir, so no rules to load.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String lintClassPath = System.getenv(<span class="string">"ANDROID_LINT_JARS"</span>); <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">    <span class="keyword">if</span> (lintClassPath != <span class="keyword">null</span> &amp;&amp; !lintClassPath.isEmpty()) &#123;</span><br><span class="line">        String[] paths = lintClassPath.split(File.pathSeparator);</span><br><span class="line">        <span class="keyword">for</span> (String path : paths) &#123;</span><br><span class="line">            File jarFile = <span class="keyword">new</span> File(path);</span><br><span class="line">            <span class="keyword">if</span> (jarFile.exists()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (files == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    files = <span class="keyword">new</span> ArrayList&lt;File&gt;();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (files.contains(jarFile)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                files.add(jarFile);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> files != <span class="keyword">null</span> ? files : Collections.&lt;File&gt;emptyList();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码逻辑也很简单，就是在环境变量指定的路径和“.android/lint”路径下分别寻找是否存在自定义lint规则的jar文件。如果有，就把它们返回并加入jarFiles集合中。<br>现在，不管是通过引入依赖库的方式，还是在系统指定路径或环境变量指定路径下放置lint.jar的方式（这2种方式在《浅谈Android自定义Lint规则的实现》中都有介绍）引入的lint.jar文件都已经被找出来放到jarFiles集合中了。</p>
<p>继续往下执行registerCustomDetectors（）中的代码，这一行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">registries.add(mRegistry);</span><br></pre></td></tr></table></figure>
<p>会把最开始生成的LintGradleIssueRegistry（实际就是系统默认的Lint检查项目BuiltinIssueRegistry的子类）缓存到列表registries中。</p>
<p>然后紧接着的for循环会针对jarFiles中的每一项指定lint规则的jarFile，获取jarFile中包含的IssueRegistry，把这些IssueRegistry也都缓存到列表registries中，并把IssueRegistry中包含的所有ISSUE都缓存到集合myCustomIssues中。也就是这段代码（再贴一遍😓）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!jarFiles.isEmpty()) &#123;</span><br><span class="line">    <span class="comment">//............</span></span><br><span class="line">    <span class="keyword">for</span> (File jarFile : jarFiles) &#123;</span><br><span class="line">        <span class="comment">//............</span></span><br><span class="line">        myCustomIssues.addAll(registry.getIssues());</span><br><span class="line">        registries.add(registry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (registries.size() &gt; <span class="number">1</span>) &#123; <span class="comment">// the first item is mRegistry itself</span></span><br><span class="line">        mRegistry = <span class="keyword">new</span> CompositeIssueRegistry(registries);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后通过创建一个CompositeIssueRegistry对象，把所有lint检查的IssueRegistry对象（不论是系统默认的检查项目还是用户实现的自定义检查项目）都包装到CompositeIssueRegistry中。这样，在后面真正进行ISSUE检查工作时，就可以直接使用CompositeIssueRegistry对象中返回的ISSUE列表了，因为它包含了系统自带的和用户自定义的所有ISSUE。</p>
<p>到了这里，registerCustomDetectors(projects)方法就执行完了（你不会忘了我们其实是因为跟踪LintDriver的analyze()方法所以才会有上面这么多balabala吧o(╯□╰)o ），让我们继续回到LintDriver的analyze()方法中往下看，也就是这一段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//LintDriver.analyze()部分源码</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (mScope == <span class="keyword">null</span>) &#123;</span><br><span class="line">    mScope = Scope.infer(projects);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fireEvent(EventType.STARTING, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (Project project : projects) &#123;</span><br><span class="line">    mPhase = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    Project main = mRequest.getMainProject(project);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The set of available detectors varies between projects</span></span><br><span class="line">    computeDetectors(project);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mApplicableDetectors.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// No detectors enabled in this project: skip it</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    checkProject(project, main);</span><br><span class="line">    <span class="keyword">if</span> (mCanceled) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    runExtraPhases(project, main);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fireEvent(mCanceled ? EventType.CANCELED : EventType.COMPLETED, <span class="keyword">null</span>);</span><br></pre></td></tr></table></figure>
<p>首先会在mScope字段中缓存当前要做Lint检查的工程都需要对哪些Scope进行检查，比如需不需要检查Java源代码（Scope.JAVA_FILE）、Java字节码（Scope.CLASS_FILE）、资源文件（Scope.RESOURCE_FILE）等等。</p>
<p><code>fireEvent(EventType.STARTING, null)</code>会回调所有已经注册过的LintListener，通知它们Lint检查开始了。LintListener是一个interface，可以对Lint检查的各个阶段进行响应。  </p>
<p>接着一个for循环分别对projects中的每个project进行检查，由于每个project对lint的配置都不同，比如用户通过配置当前project目录下的lint.xml文件关闭了某些检查项目，或者更改了某些ISSUE的严重等级等。所以这里使用了<code>computeDetectors(project)</code>来获取当前检查的project的lint配置信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">computeDetectors</span><span class="params">(@NonNull Project project)</span> </span>&#123;        </span><br><span class="line">    <span class="comment">//...................</span></span><br><span class="line">    Configuration configuration = project.getConfiguration(<span class="keyword">this</span>);</span><br><span class="line">    mScopeDetectors = <span class="keyword">new</span> EnumMap&lt;Scope, List&lt;Detector&gt;&gt;(Scope.class);</span><br><span class="line">    mApplicableDetectors = mRegistry.createDetectors(mClient, configuration,</span><br><span class="line">            mScope, mScopeDetectors);</span><br><span class="line"></span><br><span class="line">    validateScopeList();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里获取到的configuration中包含了当前正接受lint检查的project的基本信息，以及lint属性配置文件的信息，debug截图如下：<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-4-14/7318144.jpg" alt=""></p>
<p>然后这个configuration中的信息就被作为参数传给了mRegistry.createDetectors（）方法，来获知需要使用哪些Detector来检查当前project，而这里的mRegistry对象其实是一个CompositeIssueRegistry对象，也就是把android sdk自带的lint检查项目和用户自定义实现的lint检查项目都包含在内了。这里的createDetectors（）是没有被CompositeIssueRegistry重写，直接继承父类IssueRegistry的方法，主要代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> List&lt;? extends Detector&gt; createDetectors(</span><br><span class="line">        <span class="annotation">@NonNull</span> LintClient client,</span><br><span class="line">        <span class="annotation">@NonNull</span> Configuration configuration,</span><br><span class="line">        <span class="annotation">@NonNull</span> EnumSet&lt;Scope&gt; scope,</span><br><span class="line">        <span class="annotation">@Nullable</span> Map&lt;Scope, List&lt;Detector&gt;&gt; scopeToDetectors) &#123;</span><br><span class="line">    List&lt;Issue&gt; issues = getIssuesForScope(scope);</span><br><span class="line">    <span class="comment">//.................</span></span><br><span class="line">    Set&lt;Class&lt;? extends Detector&gt;&gt; detectorClasses = <span class="keyword">new</span> HashSet&lt;Class&lt;? extends Detector&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Issue issue : issues) &#123;</span><br><span class="line">        Implementation implementation = issue.getImplementation();</span><br><span class="line">        Class&lt;? extends Detector&gt; detectorClass = implementation.getDetectorClass();</span><br><span class="line">        EnumSet&lt;Scope&gt; issueScope = implementation.getScope();</span><br><span class="line">        <span class="keyword">if</span> (!detectorClasses.contains(detectorClass)) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (!configuration.isEnabled(issue)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//.................</span></span><br><span class="line">            </span><br><span class="line">            detectorClasses.add(detectorClass);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	List&lt;Detector&gt; detectors = <span class="keyword">new</span> ArrayList&lt;Detector&gt;(detectorClasses.size());</span><br><span class="line">	<span class="keyword">for</span> (Class&lt;? extends Detector&gt; clz : detectorClasses) &#123;    </span><br><span class="line">    	Detector detector = clz.newInstance();</span><br><span class="line">    	detectors.add(detector);</span><br><span class="line">		<span class="comment">//................    </span></span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">return</span> detectors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>逻辑很简单，先获取CompositeIssueRegistry对象中所有的ISSUE，也就是默认的200多项检查加上用户自己实现的检查项目，然后分别对这些ISSUE进行判断：如果集合detectorClasses中还没有包含当前ISSUE对应的lint探测器实现类detectorClass，并且当前project的配置文件没有禁用这个issue，那么就把探测器实现类detectorClass加入集合detectorClasses中。当所有issue都通过这个循环检查完毕后，把这些测器实现类都实例化成对象detector，加入列表detectors，最后把detectors返回给调用者，这样上一级调用者就获得了当前project可以用的所有Detector的实例了。</p>
<p>回到上一级调用者，继续往下执行LintDriver.analyze()剩下的代码，终于完成了所有的前期准备工作，来到了<code>checkProject(project, main)</code>这一句，这个方法才是真正使用前面所有工作提供的信息，开始正式对project的文件、字节码等进行lint检查了。而checkProject（）方法中又调用了一个最核心的方法runFileDetectors()来进行lint检查工作，大致结构如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//LintDriver.runFileDetectors()部分源码</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">runFileDetectors</span><span class="params">(@NonNull Project project, @Nullable Project main)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Look up manifest information (but not for library projects)</span></span><br><span class="line">    <span class="keyword">if</span> (project.isAndroidProject()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (File manifestFile : project.getManifestFiles()) &#123;                </span><br><span class="line">            <span class="comment">//.................                </span></span><br><span class="line">            fireEvent(EventType.SCANNING_FILE, context);</span><br><span class="line">            v.visitFile(context, manifestFile);                </span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (mScope.contains(Scope.ALL_RESOURCE_FILES)</span><br><span class="line">                || mScope.contains(Scope.RESOURCE_FILE)</span><br><span class="line">                || mScope.contains(Scope.RESOURCE_FOLDER)</span><br><span class="line">                || mScope.contains(Scope.BINARY_RESOURCE_FILE)) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (......) &#123;                    </span><br><span class="line">                checkIndividualResources(project, main, xmlDetectors, dirChecks,</span><br><span class="line">                            binaryChecks, files);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            	checkResFolder(project, main, res, xmlDetectors, dirChecks,</span><br><span class="line">                                    binaryChecks);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//.................</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mScope.contains(Scope.JAVA_FILE) || mScope.contains(Scope.ALL_JAVA_FILES)) &#123;          </span><br><span class="line">		<span class="keyword">if</span> (......) &#123;</span><br><span class="line">            checkIndividualJavaFiles(project, main, checks, files);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//.................</span></span><br><span class="line">            checkJava(project, main, sourceFolders, checks);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//.................</span></span><br><span class="line">    <span class="keyword">if</span> (mScope.contains(Scope.CLASS_FILE)</span><br><span class="line">            || mScope.contains(Scope.ALL_CLASS_FILES)</span><br><span class="line">            || mScope.contains(Scope.JAVA_LIBRARIES)) &#123;</span><br><span class="line">        checkClasses(project, main);</span><br><span class="line">    &#125;        </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mScope.contains(Scope.GRADLE_FILE)) &#123;</span><br><span class="line">        checkBuildScripts(project, main);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mScope.contains(Scope.OTHER)) &#123;</span><br><span class="line">        List&lt;Detector&gt; checks = mScopeDetectors.get(Scope.OTHER);</span><br><span class="line">        <span class="keyword">if</span> (checks != <span class="keyword">null</span>) &#123;</span><br><span class="line">            OtherFileVisitor visitor = <span class="keyword">new</span> OtherFileVisitor(checks);</span><br><span class="line">            visitor.scan(<span class="keyword">this</span>, project, main);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (project == main &amp;&amp; mScope.contains(Scope.PROGUARD_FILE) &amp;&amp;</span><br><span class="line">            project.isAndroidProject()) &#123;</span><br><span class="line">        checkProGuard(project, main);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (project == main &amp;&amp; mScope.contains(Scope.PROPERTY_FILE)) &#123;</span><br><span class="line">        checkProperties(project, main);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段原始代码比较长，这里只截取了一个大致的框架。可以看到首先判断如果当前检查的是一个android项目，那么就检查它所有的Manifest文件，检查顺序为：</p>
<blockquote>
<p>The manifests should be provided such that the main manifest comes first, then any flavor versions, then any build types.</p>
</blockquote>
<p>然后再检查所有的资源文件和文件夹。  </p>
<p>到了这里，专门针对android项目的检查就完成了，接下来就是对所有类型项目都要进行的检查了，这段代码框架的结构很清晰的列出了检查顺序为：<code>java源文件 --&gt; java字节码 --&gt; GRADLE文件 --&gt; 其他文件 --&gt; ProGuard文件  --&gt; PROPERTY文件</code>。这与<a href="http://tools.android.com/tips/lint/writing-a-lint-check" target="_blank" rel="external">http://tools.android.com/tips/lint/writing-a-lint-check</a>上关于lint检查顺序的描述是一致的：<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-4-14/97736321.jpg" alt="">  </p>
<p>OK，对所有project的所有issue都已经检查完成了，现在让我们回到LintCliClient.run()的执行（别怪我一下跳的太远，实在是计算机就是这样执行的啊o(╯□╰)o，代码再贴一遍…）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//LintCliClient.run（)部分代码</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(@NonNull IssueRegistry registry, @NonNull List&lt;File&gt; files)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">//............    </span></span><br><span class="line">    mDriver = <span class="keyword">new</span> LintDriver(registry, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//............ </span></span><br><span class="line">    mDriver.analyze(createLintRequest(files));</span><br><span class="line"></span><br><span class="line">    Collections.sort(mWarnings);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> hasConsoleOutput = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (Reporter reporter : mFlags.getReporters()) &#123;</span><br><span class="line">        reporter.write(mErrorCount, mWarningCount, mWarnings);</span><br><span class="line">        <span class="keyword">if</span> (reporter <span class="keyword">instanceof</span> TextReporter &amp;&amp; ((TextReporter)reporter).isWriteToConsole()) &#123;</span><br><span class="line">            hasConsoleOutput = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mFlags.isQuiet() &amp;&amp; !hasConsoleOutput) &#123;</span><br><span class="line">        System.out.println(String.format(</span><br><span class="line">                <span class="string">"Lint found %1$d errors and %2$d warnings"</span>, mErrorCount, mWarningCount));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mFlags.isSetExitCode() ? (mHasErrors ? ERRNO_ERRORS : ERRNO_SUCCESS) : ERRNO_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们前面这么长的篇幅其实都是在分析这里的mDriver.analyze(createLintRequest(files))方法，它会把lint检查出来的警告和错误信息保存在列表mWarnings中，然后用这句<code>Collections.sort(mWarnings)</code>对所有警告进行排序。剩下的工作当然就是把这些警告信息输出啦，输出成为我们平常见到的html报告、或者控制台报告、或者其他形式。输出报告的工作是由这段代码完成的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Reporter reporter : mFlags.getReporters()) &#123;</span><br><span class="line">    reporter.write(mErrorCount, mWarningCount, mWarnings);</span><br><span class="line">    <span class="keyword">if</span> (reporter <span class="keyword">instanceof</span> TextReporter &amp;&amp; ((TextReporter)reporter).isWriteToConsole()) &#123;</span><br><span class="line">        hasConsoleOutput = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到此为止，Lint的工作流程就分析完了。</p>
<h2 id="如何debug_Lint源码">如何debug Lint源码</h2><p>在终端执行gradle的lint任务默认是无法debug的，也就是说你在系统定义的200多项Issue或者你自定义的Issue中打的断点都不起作用。如果需要调试，可以用下面的方法：</p>
<p>1、在gradle.properties文件中加上下面这句话：  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org<span class="class">.gradle</span><span class="class">.jvmargs</span>=<span class="string">'-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005'</span></span><br></pre></td></tr></table></figure>
<p>2、创建一个Remote类型的debug配置文件：<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-4-14/34604208.jpg" alt="">  </p>
<p><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-4-14/97287156.jpg" alt=""></p>
<p>3、在终端中以daemon模式启动gradle lint任务<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-4-14/6501806.jpg" alt=""></p>
<p>然后快速点击debug按钮（注意此时要切换到刚才创建的Debug Lint的配置文件上），如图：<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-4-14/70344961.jpg" alt=""></p>
<p>现在Lint源码（包括Android SDK中的和用户自定义的Lint规则）中的断点就可以调试了。</p>

      
    </div>
    
  </div>
  
    
    <div class="copyright">
        <p><span>本文标题:</span><a href="/2016/06/21/Android Lint工作原理剖析.html">Android Lint工作原理剖析</a></p>
        <p><span>文章作者:</span><a href="/" title="回到主页">ljfxyj2008</a></p>
        <p><span>发布时间:</span>2016-06-21, 11:45:50</p>
        <p><span>最后更新:</span>2016-06-21, 11:50:35</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2016/06/21/Android Lint工作原理剖析.html" title="Android Lint工作原理剖析">http://www.carrotsight.com/2016/06/21/Android Lint工作原理剖析.html</a>
            <span class="copy-path" data-clipboard-text="原文: http://www.carrotsight.com/2016/06/21/Android Lint工作原理剖析.html　　作者: ljfxyj2008" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
            <script src="/js/clipboard.min.js"></script>
            <script> var clipboard = new Clipboard('.copy-path'); </script>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target = "_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



    <nav id="article-nav">
        
        
            <div id="article-nav-older" class="article-nav-title">
                <a href="/2016/05/25/system_server启动过程.html">
                    System_server启动过程
                </a>
            </div>
        
    </nav>

  
</article>

    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#官方对自定义Lint的支持"><span class="toc-number">1.</span> <span class="toc-text">官方对自定义Lint的支持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lint工作流程探究"><span class="toc-number">2.</span> <span class="toc-text">Lint工作流程探究</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#如何debug_Lint源码"><span class="toc-number">3.</span> <span class="toc-text">如何debug Lint源码</span></a></li></ol>
</div>
<style>
    .left-col .switch-btn {
        display: none;
    }
    .left-col .switch-area {
        display: none;
    }
</style>

<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">
<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";

    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }

    $("#tocButton").click(function() {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
            $(".switch-btn, .switch-area").fadeOut(300);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
            $(".switch-btn, .switch-area").fadeIn(500);
        }
    })

    if ($(".toc").length < 1) {
        $("#toc, #tocButton").hide();
        $(".switch-btn, .switch-area").show();
    }
</script>




    <div class="share">
    <div class="bdsharebuttonbox">
    <a href="#" class="bds_more" data-cmd="more"></a>
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
    <a href="#" class="bds_sqq" data-cmd="sqq" title="分享给 QQ 好友"></a>
    <a href="#" class="bds_copy" data-cmd="copy" title="复制网址"></a>
    <a href="#" class="bds_mail" data-cmd="mail" title="通过邮件分享"></a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="生成文章二维码"></a>
    </div>
    <script>
        window._bd_share_config={
            "common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
    </script>
</div>



    
      <div class="duoshuo" id="comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="2016/06/21/Android Lint工作原理剖析.html" data-title="Android Lint工作原理剖析" data-url="http://www.carrotsight.com/2016/06/21/Android Lint工作原理剖析.html"></div>
    <!-- 多说评论框 end -->
    <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
    var duoshuoQuery = {short_name:"carrotsight"};
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0] 
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>
    <!-- 多说公共JS代码 end -->
</div>

    




    <div class="scroll" id="post-nav-button">
        
            <a href="/" title="回到主页"><i class="fa fa-home"></i></a>
        

        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>

        
            <a href="/2016/05/25/system_server启动过程.html" title="下一篇: System_server启动过程">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>

    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/06/21/Android Lint工作原理剖析.html">Android Lint工作原理剖析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/25/system_server启动过程.html">System_server启动过程</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/24/Zygote启动过程.html">Zygote启动过程</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/01/学习笔记：Android中的View.html">学习笔记：Android中的View</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/03/29/学习笔记：Android的IPC机制.html">学习笔记：Android中的IPC机制</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/01/浅谈Android自定义Lint规则的实现 （二）.html">浅谈Android自定义Lint规则的实现 （二）</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/29/浅谈Android自定义Lint规则的实现 （一）.html">浅谈Android自定义Lint规则的实现 （一）</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/13/2016-1-13-Java中的Pluggable-Annotation-Processing-API.html">Java中的Pluggable Annotation Processing API</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/22/Android中的Proguard.html">Android中的Proguard</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/09/可缩放时间轴和录像片段选择器的实现.html">可缩放时间轴和录像片段选择器的实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/13/一个android日志库的实现.html">一个android日志库的实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/10/10/FlatBuffers学习总结.html">FlatBuffers学习总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/09/19/2015-9-19-Android编程要注意的安全规范.html">Android编程要注意的安全规范</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/09/16/2015-9-16-《Think-in-Java》类型信息-–-学习笔记.html">《Think in Java》类型信息 – 学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/09/15/2015-9-15-Otto学习笔记.html">Otto学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/09/14/2015-9-14-EventBus学习总结.html">EventBus学习总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/09/08/2015-9-8-《Think-in-Java》并发-学习笔记.html">《Think in Java》并发 - 学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2013/12/02/2013-12-2-FLEX无法启动服务因为fml文件损坏.html">【FLEX bug:无法启动服务，因为fml文件损坏】的解决办法</a></li><li class="post-list-item"><a class="post-list-link" href="/2013/04/03/2013-4-3-Flex中datagrid中checkbox的全选实现.html">Flex中datagrid中checkbox的全选实现</a></li></ul>




    <script>
        
    </script>
</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2016 ljfxyj2008
            </div>
            <div class="footer-right">
                <a href="http://hexo.io/" target="_blank" title="快速、简洁且高效的博客框架">Hexo</a>  Theme <a href="https://github.com/MOxFIVE/hexo-theme-yelee" target="_blank" title="简而不减 Hexo 双栏博客主题">Yelee</a> by MOxFIVE
            </div>
        </div>
        
    </div>
</footer>
    </div>
    
<script data-main="/js/main.js" src="//cdn.bootcss.com/require.js/2.1.22/require.min.js"></script>

    <script>
        $(document).ready(function() {
            var iPad = window.navigator.userAgent.indexOf('iPad');
            if (iPad > -1 || $(".left-col").css("display") === "none") {
                var bgColorList = ["#9db3f4", "#414141", "#e5a859", "#f5dfc6", "#c084a0", "#847e72", "#cd8390", "#996731"];
                var bgColor = Math.ceil(Math.random() * (bgColorList.length - 1));
                $("body").css({"background-color": bgColorList[bgColor], "background-size": "cover"});
            }
            else {
                var backgroundnum = 3;
                var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
                $("body").css({"background": backgroundimg, "background-attachment": "fixed", "background-size": "cover"});
            }
        })
    </script>


<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-73957282-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



<div class="scroll" id="scroll">
    <a href="#" title="返回顶部"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments" title="查看评论"><i class="fa fa-comments-o"></i></a>
    <a href="#footer" title="转到底部"><i class="fa fa-arrow-down"></i></a>
</div>

    <script src="//cdn.bootcss.com/jqueryui/1.10.4/jquery-ui.min.js"></script>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
  </div>
</body>
</html>