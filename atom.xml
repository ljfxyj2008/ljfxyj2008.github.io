<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title><![CDATA[ljfxyj2008é£å·¢]]></title>
  <subtitle><![CDATA[è®°å½•ç‚¹æ»´]]></subtitle>
  <link href="/atom.xml" rel="self"/>
  <link href="http://www.carrotsight.com/"/>
  <updated>2016-06-21T03:50:35.000Z</updated>
  <id>http://www.carrotsight.com/</id>
  
  <author>
    <name><![CDATA[ljfxyj2008]]></name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title><![CDATA[Android Lintå·¥ä½œåŸç†å‰–æ]]></title>
    <link href="http://www.carrotsight.com/2016/06/21/Android%20Lint%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90.html"/>
    <id>http://www.carrotsight.com/2016/06/21/Android Lintå·¥ä½œåŸç†å‰–æ.html</id>
    <published>2016-06-21T03:45:50.000Z</published>
    <updated>2016-06-21T03:50:35.000Z</updated>
    <content type="html"><![CDATA[<h2 id="å®˜æ–¹å¯¹è‡ªå®šä¹‰Lintçš„æ”¯æŒ">å®˜æ–¹å¯¹è‡ªå®šä¹‰Lintçš„æ”¯æŒ</h2><p>Android Lintæ˜¯Android SDKæä¾›çš„ä¸€é¡¹é™æ€ä»£ç åˆ†æå·¥å…·ï¼Œå¯¹äºæé«˜ä»£ç è´¨é‡å…·æœ‰é‡è¦ä½œç”¨ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒAndroid SDKè‡ªå¸¦çš„Lintæ£€æŸ¥é¡¹ç›®è¾¾åˆ°äº†253é¡¹ï¼Œæˆ‘ä»¬åœ¨å¼€å‘è¿‡ç¨‹ä¸­ç»å¸¸è§åˆ°çš„æç¤ºä¿¡æ¯æ¯”å¦‚â€œIdè¢«é‡å¤å®šä¹‰â€â€œHandlerLeaké£é™©â€å…¶å®éƒ½æ˜¯ç”±Lintæ£€æŸ¥å®ç°çš„ã€‚</p>
<p>Android Studio 2.0 Stableç‰ˆæœ¬å·²ç»äº2016å¹´4æœˆ7æ—¥æ­£å¼å‘å¸ƒã€‚é™¤äº†Instant Runè®©äººçœ¼å‰ä¸€äº®ï¼Œæ›´è®©äººæƒŠå–œçš„æ˜¯ï¼Œå®˜æ–¹å·²ç»æ‚„ç„¶æŠŠè‡ªå®šä¹‰Lintçš„æ£€æŸ¥ä¸IDEæ•´åˆèµ·æ¥äº†ã€‚åœ¨æ­¤ä¹‹å‰ï¼Œè‡ªå®šä¹‰Lintè§„åˆ™åªèƒ½é€šè¿‡åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œgradleä»»åŠ¡æ¥è¿è¡Œï¼Œç„¶åç”ŸæˆæŠ¥å‘Šæ–‡ä»¶ã€‚<br>Android Studio 2.0ä¸­æ•´åˆè‡ªå®šä¹‰Lintæ£€æŸ¥çš„æ•ˆæœå¦‚å›¾ï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-4-13/85143697.jpg" alt=""></p>
<p>å›¾ä¸­çº¢çº¿æç¤ºçš„é”™è¯¯æ˜¯æˆ‘è‡ªå®šä¹‰çš„Lintè§„åˆ™æ£€æŸ¥çš„ç»“æœï¼Œå¤§æ„æ˜¯Activityä½¿ç”¨çš„å¸ƒå±€æ–‡ä»¶åº”è¯¥ä»¥â€œactivity_â€ä¸ºå‰ç¼€è¿›è¡Œå‘½åã€‚  </p>
<p>å…³äºLintçš„ä¸€äº›åŸºæœ¬çŸ¥è¯†ï¼Œä»¥åŠè‡ªå®šä¹‰Lintå¦‚ä½•å®ç°ï¼Œå¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„æ–‡ç« ï¼š<br><a href="http://www.carrotsight.com/2016/01/29/æµ…è°ˆAndroidè‡ªå®šä¹‰Lintè§„åˆ™çš„å®ç°%20ï¼ˆä¸€ï¼‰.html">æµ…è°ˆAndroidè‡ªå®šä¹‰Lintè§„åˆ™çš„å®ç° ï¼ˆä¸€ï¼‰</a><br><a href="http://www.carrotsight.com/2016/02/01/æµ…è°ˆAndroidè‡ªå®šä¹‰Lintè§„åˆ™çš„å®ç°%20ï¼ˆäºŒï¼‰.html">æµ…è°ˆAndroidè‡ªå®šä¹‰Lintè§„åˆ™çš„å®ç° ï¼ˆäºŒï¼‰</a></p>
<p>ä»Android Studioçš„â€œåå¥½â€è®¾ç½®çª—å£ä¸­ï¼Œç”¨æˆ·å¯ä»¥è®¾ç½®IDEæ•´åˆçš„Lintæ£€æŸ¥åŠŸèƒ½çš„ç»†èŠ‚ï¼Œå¦‚å›¾ï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-4-13/26772828.jpg" alt=""></p>
<p>è™½ç„¶è¿™ä¸ªè®¾ç½®é€‰é¡¹åœ¨æ—§ç‰ˆçš„Android Studioä¸­ä¹Ÿèƒ½çœ‹åˆ°ï¼Œä½†å®é™…ä¸Šåœ¨æ—§ç‰ˆä¸­æ˜¯ä¸èµ·ä½œç”¨çš„ã€‚  </p>
<p>é™¤äº†åœ¨Editorä¸­èƒ½å¤Ÿä»¥çº¢è‰²ä¸‹åˆ’çº¿æ ‡æ³¨è‡ªå®šä¹‰æ£€æŸ¥é¡¹ç›®å¤–ï¼Œä½¿ç”¨Android Studioçš„ â€œAnalyzeâ€ â€“&gt; â€œInspect Codeâ€ç°åœ¨ä¹Ÿä¼šæ£€æŸ¥è‡ªå®šä¹‰Lintè§„åˆ™ä¸­å®šä¹‰çš„é¡¹ç›®äº†ã€‚Android Studio 2.0çš„è¿™ä¸€åŠŸèƒ½æ•´åˆçœŸæ˜¯å¤ªæ£’äº†ï¼Œå¤§å¤§æé«˜äº†è‡ªå®šä¹‰Lintçš„å®ç”¨æ€§ã€‚</p>
<h2 id="Lintå·¥ä½œæµç¨‹æ¢ç©¶">Lintå·¥ä½œæµç¨‹æ¢ç©¶</h2><p>ä»‹ç»å®ŒAndroid Studio 2.0çš„æ–°ç‰¹æ€§ï¼Œç°åœ¨è¿›å…¥æ­£é¢˜ï¼Œæˆ‘ä»¬æ¥æ¢ç©¶ä¸€ä¸‹Lintæ£€æŸ¥çš„å·¥ä½œåŸç†ï¼ŒåŒ…æ‹¬ç³»ç»Ÿé»˜è®¤çš„Lintæ£€æŸ¥é¡¹ç›®ä»¥åŠç”¨æˆ·è‡ªå®šä¹‰çš„Lintæ£€æŸ¥é¡¹ç›®ã€‚<br>æœ¬æ–‡ä»¥ç»ˆç«¯è¿è¡Œgradleçš„lintä»»åŠ¡ä¸ºä¾‹è¿›è¡Œåˆ†æã€‚å…¶ä¸­è‡ªå®šä¹‰lintçš„ä½¿ç”¨æ–¹å¼æ˜¯æŠŠè‡ªå®šä¹‰lintä»¥aarçš„å½¢å¼æä¾›ç»™appè¿›è¡Œå¼•ç”¨ï¼Œå…·ä½“å®ç°æ–¹å¼å¯ä»¥å‚è€ƒ<a href="http://www.carrotsight.com/2016/01/29/æµ…è°ˆAndroidè‡ªå®šä¹‰Lintè§„åˆ™çš„å®ç°%20ï¼ˆä¸€ï¼‰.html">æµ…è°ˆAndroidè‡ªå®šä¹‰Lintè§„åˆ™çš„å®ç° ï¼ˆä¸€ï¼‰</a> ã€‚</p>
<p>å½“æˆ‘ä»¬åœ¨ç»ˆç«¯æ‰§è¡Œâ€œgradle lintâ€ä»»åŠ¡åï¼Œä¼šåŠ è½½com.android.build.gradle.tasks.Lintç±»ï¼Œå®ƒçš„æºç ä½äºLint.groovyæ–‡ä»¶ä¸­ã€‚<br>Lintç±»çš„lintï¼ˆï¼‰æ–¹æ³•ä¼šé¦–å…ˆè¢«æ‰§è¡Œï¼Œè¿™ä¹Ÿæ˜¯æ•´ä¸ªlintæ£€æŸ¥æµç¨‹å¼€å§‹è¿è½¬çš„èµ·ç‚¹ã€‚è¿™éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@SuppressWarnings</span>(<span class="string">"GroovyUnusedDeclaration"</span>)</span><br><span class="line"><span class="annotation">@TaskAction</span></span><br><span class="line"><span class="keyword">public</span> <span class="typename">void</span> lint() &#123;</span><br><span class="line">    <span class="keyword">def</span> modelProject = createAndroidProject(project)</span><br><span class="line">    <span class="keyword">if</span> (getVariantName() != <span class="literal">null</span> &amp;&amp; !getVariantName().isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Variant <span class="string">variant :</span> modelProject.getVariants()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (variant.getName().equals(getVariantName())) &#123;</span><br><span class="line">                lintSingleVariant(modelProject, variant);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        lintAllVariants(modelProject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œä¼šæ ¹æ®getVariantName()çš„æ‰§è¡Œç»“æœï¼Œé€‰æ‹©å»è°ƒç”¨lintSingleVariantï¼ˆï¼‰è¿˜æ˜¯lintAllVariantsï¼ˆï¼‰ã€‚è€Œè§‚å¯ŸlintSingleVariantï¼ˆï¼‰å’ŒlintAllVariantsï¼ˆï¼‰çš„æºç ï¼Œå‘ç°è¿™ä¸¤ä¸ªæ–¹æ³•æœ€ç»ˆéƒ½è¦è°ƒç”¨runLintï¼ˆï¼‰æ–¹æ³•ï¼Œè¿™ä¸ªrunLintï¼ˆï¼‰æ–¹æ³•å¾ˆé‡è¦ï¼Œä»£ç ç‰‡æ®µå¦‚ä¸‹ï¼š</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Runs lint on the given variant and returns the set of warnings */</span></span><br><span class="line"><span class="keyword">private</span> List&lt;Warning&gt; runLint(</span><br><span class="line">        <span class="annotation">@NonNull</span> AndroidProject modelProject,</span><br><span class="line">        <span class="annotation">@NonNull</span> Variant variant,</span><br><span class="line">        <span class="typename">boolean</span> report) &#123;</span><br><span class="line">    IssueRegistry registry = createIssueRegistry()</span><br><span class="line">    LintCliFlags flags = <span class="keyword">new</span> LintCliFlags()</span><br><span class="line">    LintGradleClient client = <span class="keyword">new</span> LintGradleClient(registry, flags, project, modelProject,</span><br><span class="line">            mSdkHome, variant, getBuildTools())</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//..........è¿™é‡Œçœç•¥éƒ¨åˆ†ä»£ç .......</span></span><br><span class="line">    </span><br><span class="line">    warnings = client.run(registry)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//.........</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ³•çš„ç¬¬ä¸€å¥è¯æ˜¯åˆ›å»ºäº†ä¸€ä¸ªIssueRegistryï¼Œè€Œäº†è§£è‡ªå®šä¹‰Lintçš„ç”¨æˆ·ä¸€å®šå¯¹è¿™ä¸ªç±»ä¸ä¼šé™Œç”Ÿï¼Œåœ¨ä¹‹å‰çš„æ–‡ç« ä¸­æˆ‘ä»¬æåˆ°è¿‡ï¼ŒAndroidå†…å»ºçš„Lintæ£€æŸ¥é¡¹ç›®éƒ½æ˜¯å®šä¹‰åœ¨BuiltinIssueRegistryç±»ä¸­ï¼Œè€ŒBuiltinIssueRegistryå°±æ˜¯æ´¾ç”Ÿè‡ªIssueRegistryï¼Œæˆ‘ä»¬è¦å®ç°çš„è‡ªå®šä¹‰Lintæ£€æŸ¥è§„åˆ™å®é™…ä¸Šä¹Ÿå°±æ˜¯å®ç°è‡ªå®šä¹‰çš„IssueRegistryå­ç±»ã€‚<br>IssueRegistryç±»çš„å®Œæ•´åç§°æ˜¯com.android.tools.lint.client.api.IssueRegistryï¼Œå®ƒæ˜¯ä¸€ä¸ªJavaç±»ã€‚è‡ªæ­¤ï¼Œlintä»ä¸€ä¸ªgradle taskå¼€å§‹ä¸lint apiåŒ…ä¸­çš„javaç±»äº§ç”Ÿäº¤äº’äº†ã€‚  </p>
<p>createIssueRegistry()æ–¹æ³•å¾ˆç®€å•ï¼Œåªæœ‰ä¸€å¥è¯ï¼š</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> BuiltinIssueRegistry createIssueRegistry() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LintGradleIssueRegistry()</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>ç»§ç»­è·Ÿè¸ªLintGradleIssueRegistryç±»ï¼š</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LintGradleIssueRegistry</span> <span class="keyword">extends</span> <span class="title">BuiltinIssueRegistry</span> &#123;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="typename">boolean</span> mInitialized;</span><br><span class="line">    <span class="keyword">public</span> LintGradleIssueRegistry() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="annotation">@NonNull</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Issue&gt; getIssues() &#123;</span><br><span class="line">        List&lt;Issue&gt; issues = <span class="keyword">super</span>.getIssues();</span><br><span class="line">        <span class="keyword">if</span> (!mInitialized) &#123;</span><br><span class="line">            mInitialized = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">for</span> (Issue <span class="string">issue :</span> issues) &#123;</span><br><span class="line">                <span class="keyword">if</span> (issue.getImplementation().getDetectorClass() == GradleDetector.<span class="keyword">class</span>) &#123;</span><br><span class="line">                    issue.setImplementation(GroovyGradleDetector.IMPLEMENTATION);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> issues;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„BuiltinIssueRegistryæˆ‘ä»¬åˆšæ‰ä¹Ÿæåˆ°äº†ï¼Œç”¨æˆ·å¹³æ—¶åœ¨æ‰§è¡Œgradle lintæ—¶é»˜è®¤ä¼šæ‰§è¡Œ200å¤šé¡¹æ£€æŸ¥ï¼Œè¿™äº›é»˜è®¤æ£€æŸ¥é¡¹ç›®éƒ½æ˜¯Android SDKé€šè¿‡BuiltinIssueRegistryå®šä¹‰çš„ã€‚  </p>
<p>ç»§ç»­æ‰§è¡Œä¸Šé¢çš„runï¼ˆï¼‰æ–¹æ³•ï¼Œnewå‡ºæ¥çš„LintGradleClientå®é™…ä¸Šæ˜¯com.android.tools.lint.LintCliClientçš„å­ç±»ï¼Œè¿™ä¸ªç±»çš„ä½œç”¨æ˜¯æä¾›æ‰§è¡Œlintä»»åŠ¡çš„ç¯å¢ƒä¿¡æ¯ï¼ˆæ¯”å¦‚æ§åˆ¶å°ã€IDEçš„ä¿¡æ¯ï¼‰ï¼Œæ‰§è¡ŒIssueRegistryä¸­å®šä¹‰çš„å„ç§ISSUEæ£€æŸ¥ï¼Œä»¥åŠä»¥å¤šç§å½¢å¼è¾“å‡ºlintæŠ¥å‘Šç­‰ã€‚  </p>
<p>ç»§ç»­æ‰§è¡Œrunï¼ˆï¼‰æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯<code>warnings = client.run(registry)</code>ã€‚çœ‹åˆ°è¿™é‡Œç»ˆäºçŸ¥é“BuiltinIssueRegistryä¸­å®šä¹‰çš„200å¤šé¡¹ISSUEæ˜¯å¦‚ä½•è¢«gradleçš„lintä»»åŠ¡å¼•å…¥æ£€æŸ¥äº†ã€‚</p>
<p>åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œå¯¹groovyæ–‡ä»¶çš„åˆ†æå°±ç»“æŸäº†ï¼Œç”±äºLintGradleClientæ˜¯ç»§æ‰¿è‡ªjavaç±»LintCliClientï¼Œåç»­çœŸæ­£çš„lintæ£€æŸ¥å·¥ä½œéƒ½é€šè¿‡<code>client.run(registry)</code>è¿™å¥è¯è½¬äº¤ç»™javaå®ç°çš„LintCliClientç±»æ¥å®Œæˆã€‚  </p>
<p>è¯»åˆ°è¿™é‡Œæœ‰äººä¼šé—®ï¼Œclient.run(registry)ä¸­çš„å‚æ•°registryæ˜¯æ´¾ç”Ÿè‡ªBuiltinIssueRegistryï¼Œé‚£ä¹ˆlintæ£€æŸ¥çš„é¡¹ç›®ä¹Ÿå°±æ˜¯BuiltinIssueRegistryä¸­å®šä¹‰çš„é‚£200å¤šé¡¹é»˜è®¤æ£€æŸ¥é¡¹ç›®ã€‚é‚£ä¹ˆæˆ‘ä»¬è‡ªå®šä¹‰çš„lintè§„åˆ™ä¸­çš„ISSUEåˆæ˜¯å¦‚ä½•è¢«å¼•å…¥lintæ£€æŸ¥çš„å‘¢ï¼Ÿä¸è¦æ€¥ï¼Œä¸‹é¢ä¼šæœ‰åˆ†æã€‚</p>
<p>LintCliClientç±»çš„runï¼ˆï¼‰æ–¹æ³•çš„ä¸»è¦ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//LintCliClient.runï¼ˆ)éƒ¨åˆ†ä»£ç </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(@NonNull IssueRegistry registry, @NonNull List&lt;File&gt; files)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">//............    </span></span><br><span class="line">    mDriver = <span class="keyword">new</span> LintDriver(registry, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//............ </span></span><br><span class="line">    mDriver.analyze(createLintRequest(files));</span><br><span class="line"></span><br><span class="line">    Collections.sort(mWarnings);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> hasConsoleOutput = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (Reporter reporter : mFlags.getReporters()) &#123;</span><br><span class="line">        reporter.write(mErrorCount, mWarningCount, mWarnings);</span><br><span class="line">        <span class="keyword">if</span> (reporter <span class="keyword">instanceof</span> TextReporter &amp;&amp; ((TextReporter)reporter).isWriteToConsole()) &#123;</span><br><span class="line">            hasConsoleOutput = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mFlags.isQuiet() &amp;&amp; !hasConsoleOutput) &#123;</span><br><span class="line">        System.out.println(String.format(</span><br><span class="line">                <span class="string">"Lint found %1$d errors and %2$d warnings"</span>, mErrorCount, mWarningCount));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mFlags.isSetExitCode() ? (mHasErrors ? ERRNO_ERRORS : ERRNO_SUCCESS) : ERRNO_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸è¦è¢«runï¼ˆï¼‰è¿™ä¸ªæ–¹æ³•åè¿·æƒ‘äº†ï¼Œä»¥ä¸ºLintCliClientæ˜¯ä¸€ä¸ªçº¿ç¨‹ç±»ã€‚å…¶å®LintCliClientåªæ˜¯ä¸€ä¸ªæ™®é€šç±»ï¼Œä¸æ˜¯Runnableç±»ï¼Œè¿™é‡Œçš„æ–¹æ³•ä¹Ÿå«runï¼ˆï¼‰ä»…ä»…æ˜¯ä¸€ä¸ªå·§åˆã€‚<br>è¿™é‡Œçš„runï¼ˆï¼‰æ–¹æ³•ä¸­é¦–å…ˆnewäº†ä¸€ä¸ªLintDriverå¯¹è±¡ï¼Œå…¶å®å®ƒæ‰æ˜¯çœŸæ­£ç”¨æ¥å¯¹projectå’Œfileè¿›è¡Œlintåˆ†æçš„ç±»ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡mDriver.analyzeï¼ˆï¼‰æ¥è¿›è¡Œlintåˆ†æã€‚</p>
<p>LintDriverçš„analyze()æ–¹æ³•ç²¾ç®€åçš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//LintDriver.analyze()éƒ¨åˆ†æºç </span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">analyze</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//............</span></span><br><span class="line">    Collection&lt;Project&gt; projects;</span><br><span class="line"></span><br><span class="line">    projects = mRequest.getProjects();</span><br><span class="line">        <span class="keyword">if</span> (projects == <span class="keyword">null</span>) &#123;</span><br><span class="line">            projects = computeProjects(mRequest.getFiles());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//............</span></span><br><span class="line">   </span><br><span class="line">    registerCustomDetectors(projects);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mScope == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mScope = Scope.infer(projects);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fireEvent(EventType.STARTING, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Project project : projects) &#123;</span><br><span class="line">        mPhase = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        Project main = mRequest.getMainProject(project);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The set of available detectors varies between projects</span></span><br><span class="line">        computeDetectors(project);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mApplicableDetectors.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// No detectors enabled in this project: skip it</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        checkProject(project, main);</span><br><span class="line">        <span class="keyword">if</span> (mCanceled) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        runExtraPhases(project, main);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fireEvent(mCanceled ? EventType.CANCELED : EventType.COMPLETED, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„projectså˜é‡ä¸­ä¿å­˜çš„å°±æ˜¯ç­‰å¾…è¿›è¡ŒLintæ£€æŸ¥çš„å·¥ç¨‹é¡¹ç›®ï¼Œå®ƒæ˜¯æˆ‘ä»¬æœ€å¼€å§‹åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œ<code>gradle lint</code>ä»»åŠ¡æ—¶æŒ‡å®šçš„ã€‚æ¯”å¦‚åœ¨æœ¬ä¾‹ä¸­ï¼Œprojectsä¸­ä¿å­˜çš„å°±æ˜¯â€œProject [dir=/Users/netease/AndroidStudioProjects/HTLint/app]â€è¿™ä¸ªé¡¹ç›®ã€‚</p>
<p>ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œèµ°åˆ°<code>registerCustomDetectors(projects)</code>è¿™å¥è¯ï¼Œçœ‹åˆ°è¿™ä¸ªæ–¹æ³•åä½ æ˜¯ä¸æ˜¯å‘ç°äº†ä»€ä¹ˆï¼Ÿåˆ«æ€¥ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹registerCustomDetectorsï¼ˆï¼‰æ–¹æ³•çš„æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerCustomDetectors</span><span class="params">(Collection&lt;Project&gt; projects)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Look at the various projects, and if any of them provide a custom</span></span><br><span class="line">    <span class="comment">// lint jar, "add" them (this will replace the issue registry with</span></span><br><span class="line">    <span class="comment">// a CompositeIssueRegistry containing the original issue registry</span></span><br><span class="line">    <span class="comment">// plus JarFileIssueRegistry instances for each lint jar</span></span><br><span class="line">    Set&lt;File&gt; jarFiles = Sets.newHashSet();</span><br><span class="line">    <span class="keyword">for</span> (Project project : projects) &#123;</span><br><span class="line">        jarFiles.addAll(mClient.findRuleJars(project));</span><br><span class="line">        <span class="keyword">for</span> (Project library : project.getAllLibraries()) &#123;</span><br><span class="line">            jarFiles.addAll(mClient.findRuleJars(library));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    jarFiles.addAll(mClient.findGlobalRuleJars());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!jarFiles.isEmpty()) &#123;</span><br><span class="line">        List&lt;IssueRegistry&gt; registries = Lists.newArrayListWithExpectedSize(jarFiles.size());</span><br><span class="line">        registries.add(mRegistry);</span><br><span class="line">        <span class="keyword">for</span> (File jarFile : jarFiles) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                IssueRegistry registry = JarFileIssueRegistry.get(mClient, jarFile);</span><br><span class="line">                <span class="keyword">if</span> (myCustomIssues == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    myCustomIssues = Sets.newHashSet();</span><br><span class="line">                &#125;</span><br><span class="line">                myCustomIssues.addAll(registry.getIssues());</span><br><span class="line">                registries.add(registry);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                mClient.log(e, <span class="string">"Could not load custom rule jar file %1$s"</span>, jarFile);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (registries.size() &gt; <span class="number">1</span>) &#123; <span class="comment">// the first item is mRegistry itself</span></span><br><span class="line">            mRegistry = <span class="keyword">new</span> CompositeIssueRegistry(registries);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹äºprojectsä¸­çš„æ¯ä¸€é¡¹projectï¼Œéƒ½é€šè¿‡<code>mClient.findRuleJars(project)</code>æ–¹æ³•æ¥å¯»æ‰¾è¯¥projectä¸­çš„RuleJarsï¼Œé‚£ä¹ˆfindRuleJarsï¼ˆï¼‰æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿå®ƒè¿”å›çš„RuleJarsåˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>ç”±äºåœ¨LintDriverçš„æ„é€ å‡½æ•°ä¸­ï¼ŒmClientè¢«åˆå§‹åŒ–ä¸ºä¸€ä¸ªLintClientWrapperå¯¹è±¡ï¼Œè€ŒLintClientWrapperç±»çš„findRuleJarsï¼ˆï¼‰æ–¹æ³•å†…éƒ¨åªæœ‰ä¸€å¥è¯:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> mDelegate.findRuleJars(project)</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥ä¸Šé¢çš„<code>mClient.findRuleJars(project)</code>å®é™…ä¸Šæ˜¯è¢«å§”æ‰˜ç»™äº†LintGradleClient.javaæ¥å®ç°ã€‚LintGradleClientç±»åˆåœ¨å®ƒçš„createLintRequestï¼ˆï¼‰æ–¹æ³•ä¸­è°ƒç”¨äº†LintGradleProjectçš„é™æ€æ–¹æ³•create()ï¼Œå…¶ä¸­æœ‰è¿™æ ·ä¸€ä¸ªç‰‡æ®µï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Pair&lt;LintGradleProject, List&lt;File&gt;&gt; create(</span><br><span class="line">        <span class="annotation">@NonNull</span> LintGradleClient client,</span><br><span class="line">        <span class="annotation">@NonNull</span> AndroidProject project,</span><br><span class="line">        <span class="annotation">@NonNull</span> Variant variant,</span><br><span class="line">        <span class="annotation">@NonNull</span> org.gradle.api.Project gradleProject) &#123;</span><br><span class="line">    <span class="comment">//............</span></span><br><span class="line"></span><br><span class="line">    List&lt;File&gt; customRules = Lists.newArrayList();</span><br><span class="line">    File appLintJar = <span class="keyword">new</span> File(gradleProject.getBuildDir(),</span><br><span class="line">            <span class="string">"lint"</span> + separatorChar + <span class="string">"lint.jar"</span>);</span><br><span class="line">    <span class="keyword">if</span> (appLintJar.exists()) &#123;</span><br><span class="line">        customRules.add(appLintJar);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//............</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç ä¼šå¯»æ‰¾å½“å‰é¡¹ç›®çš„æ„å»ºç›®å½•ä¸‹æ˜¯å¦å¼•ç”¨äº†ä¸€ä¸ªåä¸ºlint.jaræ–‡ä»¶ï¼Œå¦‚æœæœ‰å°±æŠŠå®ƒåŠ å…¥customRulesåˆ—è¡¨ä¸­ã€‚<br>æˆ‘ä»¬åœ¨ã€Šæµ…è°ˆAndroidè‡ªå®šä¹‰Lintè§„åˆ™çš„å®ç°ã€‹ä¸­æåˆ°è¿‡é€šè¿‡aaråŒ…è£…lint.jaræ–‡ä»¶ï¼Œç„¶åè®©éœ€è¦è‡ªå®šä¹‰lintæ£€æŸ¥çš„androidé¡¹ç›®æ·»åŠ å¯¹aarçš„ä¾èµ–ï¼Œè¿™ä¹Ÿæ˜¯æœ¬æ–‡çš„ä¾‹å­ä½¿ç”¨çš„å¼•å…¥è‡ªå®šä¹‰lintè§„åˆ™çš„æ–¹æ³•ã€‚åŸæ¥æˆ‘ä»¬æ·»åŠ çš„ä¾èµ–ä¸­çš„lint.jaræ–‡ä»¶æ˜¯åœ¨è¿™é‡Œè¢«æ‰¾å‡ºæ¥çš„ã€‚</p>
<p>ç»§ç»­å›å»çœ‹registerCustomDetectorsï¼ˆï¼‰æ–¹æ³•åç»­çš„ä»£ç æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¿™ä¸€æ®µï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Project library : project.getAllLibraries()) &#123;</span><br><span class="line">    jarFiles.addAll(mClient.findRuleJars(library));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç ä¼šå¯¹å½“å‰å·¥ç¨‹ä¾èµ–çš„æ‰€æœ‰åº“æ–‡ä»¶è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœè¿™äº›åº“æ–‡ä»¶æœ‰å¯¹åä¸ºlint.jaræ–‡ä»¶çš„å¼•ç”¨ï¼Œåˆ™æŠŠå®ƒä»¬å¼•ç”¨çš„lint.jaræ–‡ä»¶ä¹ŸåŠ å…¥åˆ°jarFilesé›†åˆä¸­ã€‚<br>å¦‚æ­¤ä¸€æ¥ï¼Œä¸ç®¡æ˜¯é¡¹ç›®ç›´æ¥ä¾èµ–çš„lint.jaræ–‡ä»¶ï¼Œè¿˜æ˜¯é—´æ¥é€šè¿‡å…¶ä»–åº“å¼•å…¥çš„lint.jaræ–‡ä»¶ï¼Œå°±éƒ½è¢«æ”¾å…¥jarFilesé›†åˆä¸­äº†ã€‚</p>
<p>ç»§ç»­å¾€ä¸‹æ‰§è¡ŒregisterCustomDetectorsï¼ˆï¼‰ä¸­çš„ä»£ç ï¼Œèµ°åˆ°äº†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jarFiles.addAll(mClient.findGlobalRuleJars());</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„findGlobalRuleJars()æ–¹æ³•å®é™…æ˜¯ç”±LintClientå®ç°çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.android.tools.lint.client.api.LintClientç±»</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;File&gt; <span class="title">findGlobalRuleJars</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Look for additional detectors registered by the user, via</span></span><br><span class="line">    <span class="comment">// (1) an environment variable (useful for build servers etc), and</span></span><br><span class="line">    <span class="comment">// (2) via jar files in the .android/lint directory</span></span><br><span class="line">    List&lt;File&gt; files = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String androidHome = AndroidLocation.getFolder();</span><br><span class="line">        File lint = <span class="keyword">new</span> File(androidHome + File.separator + <span class="string">"lint"</span>); <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">        <span class="keyword">if</span> (lint.exists()) &#123;</span><br><span class="line">            File[] list = lint.listFiles();</span><br><span class="line">            <span class="keyword">if</span> (list != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (File jarFile : list) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (endsWith(jarFile.getName(), DOT_JAR)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (files == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            files = <span class="keyword">new</span> ArrayList&lt;File&gt;();</span><br><span class="line">                        &#125;</span><br><span class="line">                        files.add(jarFile);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (AndroidLocation.AndroidLocationException e) &#123;</span><br><span class="line">        <span class="comment">// Ignore -- no android dir, so no rules to load.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String lintClassPath = System.getenv(<span class="string">"ANDROID_LINT_JARS"</span>); <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">    <span class="keyword">if</span> (lintClassPath != <span class="keyword">null</span> &amp;&amp; !lintClassPath.isEmpty()) &#123;</span><br><span class="line">        String[] paths = lintClassPath.split(File.pathSeparator);</span><br><span class="line">        <span class="keyword">for</span> (String path : paths) &#123;</span><br><span class="line">            File jarFile = <span class="keyword">new</span> File(path);</span><br><span class="line">            <span class="keyword">if</span> (jarFile.exists()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (files == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    files = <span class="keyword">new</span> ArrayList&lt;File&gt;();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (files.contains(jarFile)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                files.add(jarFile);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> files != <span class="keyword">null</span> ? files : Collections.&lt;File&gt;emptyList();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç é€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨ç¯å¢ƒå˜é‡æŒ‡å®šçš„è·¯å¾„å’Œâ€œ.android/lintâ€è·¯å¾„ä¸‹åˆ†åˆ«å¯»æ‰¾æ˜¯å¦å­˜åœ¨è‡ªå®šä¹‰lintè§„åˆ™çš„jaræ–‡ä»¶ã€‚å¦‚æœæœ‰ï¼Œå°±æŠŠå®ƒä»¬è¿”å›å¹¶åŠ å…¥jarFilesé›†åˆä¸­ã€‚<br>ç°åœ¨ï¼Œä¸ç®¡æ˜¯é€šè¿‡å¼•å…¥ä¾èµ–åº“çš„æ–¹å¼ï¼Œè¿˜æ˜¯åœ¨ç³»ç»ŸæŒ‡å®šè·¯å¾„æˆ–ç¯å¢ƒå˜é‡æŒ‡å®šè·¯å¾„ä¸‹æ”¾ç½®lint.jarçš„æ–¹å¼ï¼ˆè¿™2ç§æ–¹å¼åœ¨ã€Šæµ…è°ˆAndroidè‡ªå®šä¹‰Lintè§„åˆ™çš„å®ç°ã€‹ä¸­éƒ½æœ‰ä»‹ç»ï¼‰å¼•å…¥çš„lint.jaræ–‡ä»¶éƒ½å·²ç»è¢«æ‰¾å‡ºæ¥æ”¾åˆ°jarFilesé›†åˆä¸­äº†ã€‚</p>
<p>ç»§ç»­å¾€ä¸‹æ‰§è¡ŒregisterCustomDetectorsï¼ˆï¼‰ä¸­çš„ä»£ç ï¼Œè¿™ä¸€è¡Œï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">registries.add(mRegistry);</span><br></pre></td></tr></table></figure>
<p>ä¼šæŠŠæœ€å¼€å§‹ç”Ÿæˆçš„LintGradleIssueRegistryï¼ˆå®é™…å°±æ˜¯ç³»ç»Ÿé»˜è®¤çš„Lintæ£€æŸ¥é¡¹ç›®BuiltinIssueRegistryçš„å­ç±»ï¼‰ç¼“å­˜åˆ°åˆ—è¡¨registriesä¸­ã€‚</p>
<p>ç„¶åç´§æ¥ç€çš„forå¾ªç¯ä¼šé’ˆå¯¹jarFilesä¸­çš„æ¯ä¸€é¡¹æŒ‡å®šlintè§„åˆ™çš„jarFileï¼Œè·å–jarFileä¸­åŒ…å«çš„IssueRegistryï¼ŒæŠŠè¿™äº›IssueRegistryä¹Ÿéƒ½ç¼“å­˜åˆ°åˆ—è¡¨registriesä¸­ï¼Œå¹¶æŠŠIssueRegistryä¸­åŒ…å«çš„æ‰€æœ‰ISSUEéƒ½ç¼“å­˜åˆ°é›†åˆmyCustomIssuesä¸­ã€‚ä¹Ÿå°±æ˜¯è¿™æ®µä»£ç ï¼ˆå†è´´ä¸€éğŸ˜“ï¼‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!jarFiles.isEmpty()) &#123;</span><br><span class="line">    <span class="comment">//............</span></span><br><span class="line">    <span class="keyword">for</span> (File jarFile : jarFiles) &#123;</span><br><span class="line">        <span class="comment">//............</span></span><br><span class="line">        myCustomIssues.addAll(registry.getIssues());</span><br><span class="line">        registries.add(registry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (registries.size() &gt; <span class="number">1</span>) &#123; <span class="comment">// the first item is mRegistry itself</span></span><br><span class="line">        mRegistry = <span class="keyword">new</span> CompositeIssueRegistry(registries);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åé€šè¿‡åˆ›å»ºä¸€ä¸ªCompositeIssueRegistryå¯¹è±¡ï¼ŒæŠŠæ‰€æœ‰lintæ£€æŸ¥çš„IssueRegistryå¯¹è±¡ï¼ˆä¸è®ºæ˜¯ç³»ç»Ÿé»˜è®¤çš„æ£€æŸ¥é¡¹ç›®è¿˜æ˜¯ç”¨æˆ·å®ç°çš„è‡ªå®šä¹‰æ£€æŸ¥é¡¹ç›®ï¼‰éƒ½åŒ…è£…åˆ°CompositeIssueRegistryä¸­ã€‚è¿™æ ·ï¼Œåœ¨åé¢çœŸæ­£è¿›è¡ŒISSUEæ£€æŸ¥å·¥ä½œæ—¶ï¼Œå°±å¯ä»¥ç›´æ¥ä½¿ç”¨CompositeIssueRegistryå¯¹è±¡ä¸­è¿”å›çš„ISSUEåˆ—è¡¨äº†ï¼Œå› ä¸ºå®ƒåŒ…å«äº†ç³»ç»Ÿè‡ªå¸¦çš„å’Œç”¨æˆ·è‡ªå®šä¹‰çš„æ‰€æœ‰ISSUEã€‚</p>
<p>åˆ°äº†è¿™é‡Œï¼ŒregisterCustomDetectors(projects)æ–¹æ³•å°±æ‰§è¡Œå®Œäº†ï¼ˆä½ ä¸ä¼šå¿˜äº†æˆ‘ä»¬å…¶å®æ˜¯å› ä¸ºè·Ÿè¸ªLintDriverçš„analyze()æ–¹æ³•æ‰€ä»¥æ‰ä¼šæœ‰ä¸Šé¢è¿™ä¹ˆå¤šbalabalaå§o(â•¯â–¡â•°)o ï¼‰ï¼Œè®©æˆ‘ä»¬ç»§ç»­å›åˆ°LintDriverçš„analyze()æ–¹æ³•ä¸­å¾€ä¸‹çœ‹ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸€æ®µï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//LintDriver.analyze()éƒ¨åˆ†æºç </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (mScope == <span class="keyword">null</span>) &#123;</span><br><span class="line">    mScope = Scope.infer(projects);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fireEvent(EventType.STARTING, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (Project project : projects) &#123;</span><br><span class="line">    mPhase = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    Project main = mRequest.getMainProject(project);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The set of available detectors varies between projects</span></span><br><span class="line">    computeDetectors(project);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mApplicableDetectors.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// No detectors enabled in this project: skip it</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    checkProject(project, main);</span><br><span class="line">    <span class="keyword">if</span> (mCanceled) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    runExtraPhases(project, main);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fireEvent(mCanceled ? EventType.CANCELED : EventType.COMPLETED, <span class="keyword">null</span>);</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆä¼šåœ¨mScopeå­—æ®µä¸­ç¼“å­˜å½“å‰è¦åšLintæ£€æŸ¥çš„å·¥ç¨‹éƒ½éœ€è¦å¯¹å“ªäº›Scopeè¿›è¡Œæ£€æŸ¥ï¼Œæ¯”å¦‚éœ€ä¸éœ€è¦æ£€æŸ¥Javaæºä»£ç ï¼ˆScope.JAVA_FILEï¼‰ã€Javaå­—èŠ‚ç ï¼ˆScope.CLASS_FILEï¼‰ã€èµ„æºæ–‡ä»¶ï¼ˆScope.RESOURCE_FILEï¼‰ç­‰ç­‰ã€‚</p>
<p><code>fireEvent(EventType.STARTING, null)</code>ä¼šå›è°ƒæ‰€æœ‰å·²ç»æ³¨å†Œè¿‡çš„LintListenerï¼Œé€šçŸ¥å®ƒä»¬Lintæ£€æŸ¥å¼€å§‹äº†ã€‚LintListeneræ˜¯ä¸€ä¸ªinterfaceï¼Œå¯ä»¥å¯¹Lintæ£€æŸ¥çš„å„ä¸ªé˜¶æ®µè¿›è¡Œå“åº”ã€‚  </p>
<p>æ¥ç€ä¸€ä¸ªforå¾ªç¯åˆ†åˆ«å¯¹projectsä¸­çš„æ¯ä¸ªprojectè¿›è¡Œæ£€æŸ¥ï¼Œç”±äºæ¯ä¸ªprojectå¯¹lintçš„é…ç½®éƒ½ä¸åŒï¼Œæ¯”å¦‚ç”¨æˆ·é€šè¿‡é…ç½®å½“å‰projectç›®å½•ä¸‹çš„lint.xmlæ–‡ä»¶å…³é—­äº†æŸäº›æ£€æŸ¥é¡¹ç›®ï¼Œæˆ–è€…æ›´æ”¹äº†æŸäº›ISSUEçš„ä¸¥é‡ç­‰çº§ç­‰ã€‚æ‰€ä»¥è¿™é‡Œä½¿ç”¨äº†<code>computeDetectors(project)</code>æ¥è·å–å½“å‰æ£€æŸ¥çš„projectçš„linté…ç½®ä¿¡æ¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">computeDetectors</span><span class="params">(@NonNull Project project)</span> </span>&#123;        </span><br><span class="line">    <span class="comment">//...................</span></span><br><span class="line">    Configuration configuration = project.getConfiguration(<span class="keyword">this</span>);</span><br><span class="line">    mScopeDetectors = <span class="keyword">new</span> EnumMap&lt;Scope, List&lt;Detector&gt;&gt;(Scope.class);</span><br><span class="line">    mApplicableDetectors = mRegistry.createDetectors(mClient, configuration,</span><br><span class="line">            mScope, mScopeDetectors);</span><br><span class="line"></span><br><span class="line">    validateScopeList();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œè·å–åˆ°çš„configurationä¸­åŒ…å«äº†å½“å‰æ­£æ¥å—lintæ£€æŸ¥çš„projectçš„åŸºæœ¬ä¿¡æ¯ï¼Œä»¥åŠlintå±æ€§é…ç½®æ–‡ä»¶çš„ä¿¡æ¯ï¼Œdebugæˆªå›¾å¦‚ä¸‹ï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-4-14/7318144.jpg" alt=""></p>
<p>ç„¶åè¿™ä¸ªconfigurationä¸­çš„ä¿¡æ¯å°±è¢«ä½œä¸ºå‚æ•°ä¼ ç»™äº†mRegistry.createDetectorsï¼ˆï¼‰æ–¹æ³•ï¼Œæ¥è·çŸ¥éœ€è¦ä½¿ç”¨å“ªäº›Detectoræ¥æ£€æŸ¥å½“å‰projectï¼Œè€Œè¿™é‡Œçš„mRegistryå¯¹è±¡å…¶å®æ˜¯ä¸€ä¸ªCompositeIssueRegistryå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯æŠŠandroid sdkè‡ªå¸¦çš„lintæ£€æŸ¥é¡¹ç›®å’Œç”¨æˆ·è‡ªå®šä¹‰å®ç°çš„lintæ£€æŸ¥é¡¹ç›®éƒ½åŒ…å«åœ¨å†…äº†ã€‚è¿™é‡Œçš„createDetectorsï¼ˆï¼‰æ˜¯æ²¡æœ‰è¢«CompositeIssueRegistryé‡å†™ï¼Œç›´æ¥ç»§æ‰¿çˆ¶ç±»IssueRegistryçš„æ–¹æ³•ï¼Œä¸»è¦ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> List&lt;? extends Detector&gt; createDetectors(</span><br><span class="line">        <span class="annotation">@NonNull</span> LintClient client,</span><br><span class="line">        <span class="annotation">@NonNull</span> Configuration configuration,</span><br><span class="line">        <span class="annotation">@NonNull</span> EnumSet&lt;Scope&gt; scope,</span><br><span class="line">        <span class="annotation">@Nullable</span> Map&lt;Scope, List&lt;Detector&gt;&gt; scopeToDetectors) &#123;</span><br><span class="line">    List&lt;Issue&gt; issues = getIssuesForScope(scope);</span><br><span class="line">    <span class="comment">//.................</span></span><br><span class="line">    Set&lt;Class&lt;? extends Detector&gt;&gt; detectorClasses = <span class="keyword">new</span> HashSet&lt;Class&lt;? extends Detector&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Issue issue : issues) &#123;</span><br><span class="line">        Implementation implementation = issue.getImplementation();</span><br><span class="line">        Class&lt;? extends Detector&gt; detectorClass = implementation.getDetectorClass();</span><br><span class="line">        EnumSet&lt;Scope&gt; issueScope = implementation.getScope();</span><br><span class="line">        <span class="keyword">if</span> (!detectorClasses.contains(detectorClass)) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (!configuration.isEnabled(issue)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//.................</span></span><br><span class="line">            </span><br><span class="line">            detectorClasses.add(detectorClass);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	List&lt;Detector&gt; detectors = <span class="keyword">new</span> ArrayList&lt;Detector&gt;(detectorClasses.size());</span><br><span class="line">	<span class="keyword">for</span> (Class&lt;? extends Detector&gt; clz : detectorClasses) &#123;    </span><br><span class="line">    	Detector detector = clz.newInstance();</span><br><span class="line">    	detectors.add(detector);</span><br><span class="line">		<span class="comment">//................    </span></span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">return</span> detectors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€»è¾‘å¾ˆç®€å•ï¼Œå…ˆè·å–CompositeIssueRegistryå¯¹è±¡ä¸­æ‰€æœ‰çš„ISSUEï¼Œä¹Ÿå°±æ˜¯é»˜è®¤çš„200å¤šé¡¹æ£€æŸ¥åŠ ä¸Šç”¨æˆ·è‡ªå·±å®ç°çš„æ£€æŸ¥é¡¹ç›®ï¼Œç„¶ååˆ†åˆ«å¯¹è¿™äº›ISSUEè¿›è¡Œåˆ¤æ–­ï¼šå¦‚æœé›†åˆdetectorClassesä¸­è¿˜æ²¡æœ‰åŒ…å«å½“å‰ISSUEå¯¹åº”çš„lintæ¢æµ‹å™¨å®ç°ç±»detectorClassï¼Œå¹¶ä¸”å½“å‰projectçš„é…ç½®æ–‡ä»¶æ²¡æœ‰ç¦ç”¨è¿™ä¸ªissueï¼Œé‚£ä¹ˆå°±æŠŠæ¢æµ‹å™¨å®ç°ç±»detectorClassåŠ å…¥é›†åˆdetectorClassesä¸­ã€‚å½“æ‰€æœ‰issueéƒ½é€šè¿‡è¿™ä¸ªå¾ªç¯æ£€æŸ¥å®Œæ¯•åï¼ŒæŠŠè¿™äº›æµ‹å™¨å®ç°ç±»éƒ½å®ä¾‹åŒ–æˆå¯¹è±¡detectorï¼ŒåŠ å…¥åˆ—è¡¨detectorsï¼Œæœ€åæŠŠdetectorsè¿”å›ç»™è°ƒç”¨è€…ï¼Œè¿™æ ·ä¸Šä¸€çº§è°ƒç”¨è€…å°±è·å¾—äº†å½“å‰projectå¯ä»¥ç”¨çš„æ‰€æœ‰Detectorçš„å®ä¾‹äº†ã€‚</p>
<p>å›åˆ°ä¸Šä¸€çº§è°ƒç”¨è€…ï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡ŒLintDriver.analyze()å‰©ä¸‹çš„ä»£ç ï¼Œç»ˆäºå®Œæˆäº†æ‰€æœ‰çš„å‰æœŸå‡†å¤‡å·¥ä½œï¼Œæ¥åˆ°äº†<code>checkProject(project, main)</code>è¿™ä¸€å¥ï¼Œè¿™ä¸ªæ–¹æ³•æ‰æ˜¯çœŸæ­£ä½¿ç”¨å‰é¢æ‰€æœ‰å·¥ä½œæä¾›çš„ä¿¡æ¯ï¼Œå¼€å§‹æ­£å¼å¯¹projectçš„æ–‡ä»¶ã€å­—èŠ‚ç ç­‰è¿›è¡Œlintæ£€æŸ¥äº†ã€‚è€ŒcheckProjectï¼ˆï¼‰æ–¹æ³•ä¸­åˆè°ƒç”¨äº†ä¸€ä¸ªæœ€æ ¸å¿ƒçš„æ–¹æ³•runFileDetectors()æ¥è¿›è¡Œlintæ£€æŸ¥å·¥ä½œï¼Œå¤§è‡´ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//LintDriver.runFileDetectors()éƒ¨åˆ†æºç </span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">runFileDetectors</span><span class="params">(@NonNull Project project, @Nullable Project main)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Look up manifest information (but not for library projects)</span></span><br><span class="line">    <span class="keyword">if</span> (project.isAndroidProject()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (File manifestFile : project.getManifestFiles()) &#123;                </span><br><span class="line">            <span class="comment">//.................                </span></span><br><span class="line">            fireEvent(EventType.SCANNING_FILE, context);</span><br><span class="line">            v.visitFile(context, manifestFile);                </span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (mScope.contains(Scope.ALL_RESOURCE_FILES)</span><br><span class="line">                || mScope.contains(Scope.RESOURCE_FILE)</span><br><span class="line">                || mScope.contains(Scope.RESOURCE_FOLDER)</span><br><span class="line">                || mScope.contains(Scope.BINARY_RESOURCE_FILE)) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (......) &#123;                    </span><br><span class="line">                checkIndividualResources(project, main, xmlDetectors, dirChecks,</span><br><span class="line">                            binaryChecks, files);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            	checkResFolder(project, main, res, xmlDetectors, dirChecks,</span><br><span class="line">                                    binaryChecks);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//.................</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mScope.contains(Scope.JAVA_FILE) || mScope.contains(Scope.ALL_JAVA_FILES)) &#123;          </span><br><span class="line">		<span class="keyword">if</span> (......) &#123;</span><br><span class="line">            checkIndividualJavaFiles(project, main, checks, files);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//.................</span></span><br><span class="line">            checkJava(project, main, sourceFolders, checks);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//.................</span></span><br><span class="line">    <span class="keyword">if</span> (mScope.contains(Scope.CLASS_FILE)</span><br><span class="line">            || mScope.contains(Scope.ALL_CLASS_FILES)</span><br><span class="line">            || mScope.contains(Scope.JAVA_LIBRARIES)) &#123;</span><br><span class="line">        checkClasses(project, main);</span><br><span class="line">    &#125;        </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mScope.contains(Scope.GRADLE_FILE)) &#123;</span><br><span class="line">        checkBuildScripts(project, main);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mScope.contains(Scope.OTHER)) &#123;</span><br><span class="line">        List&lt;Detector&gt; checks = mScopeDetectors.get(Scope.OTHER);</span><br><span class="line">        <span class="keyword">if</span> (checks != <span class="keyword">null</span>) &#123;</span><br><span class="line">            OtherFileVisitor visitor = <span class="keyword">new</span> OtherFileVisitor(checks);</span><br><span class="line">            visitor.scan(<span class="keyword">this</span>, project, main);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (project == main &amp;&amp; mScope.contains(Scope.PROGUARD_FILE) &amp;&amp;</span><br><span class="line">            project.isAndroidProject()) &#123;</span><br><span class="line">        checkProGuard(project, main);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (project == main &amp;&amp; mScope.contains(Scope.PROPERTY_FILE)) &#123;</span><br><span class="line">        checkProperties(project, main);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µåŸå§‹ä»£ç æ¯”è¾ƒé•¿ï¼Œè¿™é‡Œåªæˆªå–äº†ä¸€ä¸ªå¤§è‡´çš„æ¡†æ¶ã€‚å¯ä»¥çœ‹åˆ°é¦–å…ˆåˆ¤æ–­å¦‚æœå½“å‰æ£€æŸ¥çš„æ˜¯ä¸€ä¸ªandroidé¡¹ç›®ï¼Œé‚£ä¹ˆå°±æ£€æŸ¥å®ƒæ‰€æœ‰çš„Manifestæ–‡ä»¶ï¼Œæ£€æŸ¥é¡ºåºä¸ºï¼š</p>
<blockquote>
<p>The manifests should be provided such that the main manifest comes first, then any flavor versions, then any build types.</p>
</blockquote>
<p>ç„¶åå†æ£€æŸ¥æ‰€æœ‰çš„èµ„æºæ–‡ä»¶å’Œæ–‡ä»¶å¤¹ã€‚  </p>
<p>åˆ°äº†è¿™é‡Œï¼Œä¸“é—¨é’ˆå¯¹androidé¡¹ç›®çš„æ£€æŸ¥å°±å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å¯¹æ‰€æœ‰ç±»å‹é¡¹ç›®éƒ½è¦è¿›è¡Œçš„æ£€æŸ¥äº†ï¼Œè¿™æ®µä»£ç æ¡†æ¶çš„ç»“æ„å¾ˆæ¸…æ™°çš„åˆ—å‡ºäº†æ£€æŸ¥é¡ºåºä¸ºï¼š<code>javaæºæ–‡ä»¶ --&gt; javaå­—èŠ‚ç  --&gt; GRADLEæ–‡ä»¶ --&gt; å…¶ä»–æ–‡ä»¶ --&gt; ProGuardæ–‡ä»¶  --&gt; PROPERTYæ–‡ä»¶</code>ã€‚è¿™ä¸<a href="http://tools.android.com/tips/lint/writing-a-lint-check" target="_blank" rel="external">http://tools.android.com/tips/lint/writing-a-lint-check</a>ä¸Šå…³äºlintæ£€æŸ¥é¡ºåºçš„æè¿°æ˜¯ä¸€è‡´çš„ï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-4-14/97736321.jpg" alt="">  </p>
<p>OKï¼Œå¯¹æ‰€æœ‰projectçš„æ‰€æœ‰issueéƒ½å·²ç»æ£€æŸ¥å®Œæˆäº†ï¼Œç°åœ¨è®©æˆ‘ä»¬å›åˆ°LintCliClient.run()çš„æ‰§è¡Œï¼ˆåˆ«æ€ªæˆ‘ä¸€ä¸‹è·³çš„å¤ªè¿œï¼Œå®åœ¨æ˜¯è®¡ç®—æœºå°±æ˜¯è¿™æ ·æ‰§è¡Œçš„å•Šo(â•¯â–¡â•°)oï¼Œä»£ç å†è´´ä¸€éâ€¦ï¼‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//LintCliClient.runï¼ˆ)éƒ¨åˆ†ä»£ç </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(@NonNull IssueRegistry registry, @NonNull List&lt;File&gt; files)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">//............    </span></span><br><span class="line">    mDriver = <span class="keyword">new</span> LintDriver(registry, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//............ </span></span><br><span class="line">    mDriver.analyze(createLintRequest(files));</span><br><span class="line"></span><br><span class="line">    Collections.sort(mWarnings);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> hasConsoleOutput = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (Reporter reporter : mFlags.getReporters()) &#123;</span><br><span class="line">        reporter.write(mErrorCount, mWarningCount, mWarnings);</span><br><span class="line">        <span class="keyword">if</span> (reporter <span class="keyword">instanceof</span> TextReporter &amp;&amp; ((TextReporter)reporter).isWriteToConsole()) &#123;</span><br><span class="line">            hasConsoleOutput = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!mFlags.isQuiet() &amp;&amp; !hasConsoleOutput) &#123;</span><br><span class="line">        System.out.println(String.format(</span><br><span class="line">                <span class="string">"Lint found %1$d errors and %2$d warnings"</span>, mErrorCount, mWarningCount));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mFlags.isSetExitCode() ? (mHasErrors ? ERRNO_ERRORS : ERRNO_SUCCESS) : ERRNO_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å‰é¢è¿™ä¹ˆé•¿çš„ç¯‡å¹…å…¶å®éƒ½æ˜¯åœ¨åˆ†æè¿™é‡Œçš„mDriver.analyze(createLintRequest(files))æ–¹æ³•ï¼Œå®ƒä¼šæŠŠlintæ£€æŸ¥å‡ºæ¥çš„è­¦å‘Šå’Œé”™è¯¯ä¿¡æ¯ä¿å­˜åœ¨åˆ—è¡¨mWarningsä¸­ï¼Œç„¶åç”¨è¿™å¥<code>Collections.sort(mWarnings)</code>å¯¹æ‰€æœ‰è­¦å‘Šè¿›è¡Œæ’åºã€‚å‰©ä¸‹çš„å·¥ä½œå½“ç„¶å°±æ˜¯æŠŠè¿™äº›è­¦å‘Šä¿¡æ¯è¾“å‡ºå•¦ï¼Œè¾“å‡ºæˆä¸ºæˆ‘ä»¬å¹³å¸¸è§åˆ°çš„htmlæŠ¥å‘Šã€æˆ–è€…æ§åˆ¶å°æŠ¥å‘Šã€æˆ–è€…å…¶ä»–å½¢å¼ã€‚è¾“å‡ºæŠ¥å‘Šçš„å·¥ä½œæ˜¯ç”±è¿™æ®µä»£ç å®Œæˆçš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Reporter reporter : mFlags.getReporters()) &#123;</span><br><span class="line">    reporter.write(mErrorCount, mWarningCount, mWarnings);</span><br><span class="line">    <span class="keyword">if</span> (reporter <span class="keyword">instanceof</span> TextReporter &amp;&amp; ((TextReporter)reporter).isWriteToConsole()) &#123;</span><br><span class="line">        hasConsoleOutput = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ°æ­¤ä¸ºæ­¢ï¼ŒLintçš„å·¥ä½œæµç¨‹å°±åˆ†æå®Œäº†ã€‚</p>
<h2 id="å¦‚ä½•debug_Lintæºç ">å¦‚ä½•debug Lintæºç </h2><p>åœ¨ç»ˆç«¯æ‰§è¡Œgradleçš„lintä»»åŠ¡é»˜è®¤æ˜¯æ— æ³•debugçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä½ åœ¨ç³»ç»Ÿå®šä¹‰çš„200å¤šé¡¹Issueæˆ–è€…ä½ è‡ªå®šä¹‰çš„Issueä¸­æ‰“çš„æ–­ç‚¹éƒ½ä¸èµ·ä½œç”¨ã€‚å¦‚æœéœ€è¦è°ƒè¯•ï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„æ–¹æ³•ï¼š</p>
<p>1ã€åœ¨gradle.propertiesæ–‡ä»¶ä¸­åŠ ä¸Šä¸‹é¢è¿™å¥è¯ï¼š  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org<span class="class">.gradle</span><span class="class">.jvmargs</span>=<span class="string">'-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005'</span></span><br></pre></td></tr></table></figure>
<p>2ã€åˆ›å»ºä¸€ä¸ªRemoteç±»å‹çš„debugé…ç½®æ–‡ä»¶ï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-4-14/34604208.jpg" alt="">  </p>
<p><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-4-14/97287156.jpg" alt=""></p>
<p>3ã€åœ¨ç»ˆç«¯ä¸­ä»¥daemonæ¨¡å¼å¯åŠ¨gradle lintä»»åŠ¡<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-4-14/6501806.jpg" alt=""></p>
<p>ç„¶åå¿«é€Ÿç‚¹å‡»debugæŒ‰é’®ï¼ˆæ³¨æ„æ­¤æ—¶è¦åˆ‡æ¢åˆ°åˆšæ‰åˆ›å»ºçš„Debug Lintçš„é…ç½®æ–‡ä»¶ä¸Šï¼‰ï¼Œå¦‚å›¾ï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-4-14/70344961.jpg" alt=""></p>
<p>ç°åœ¨Lintæºç ï¼ˆåŒ…æ‹¬Android SDKä¸­çš„å’Œç”¨æˆ·è‡ªå®šä¹‰çš„Lintè§„åˆ™ï¼‰ä¸­çš„æ–­ç‚¹å°±å¯ä»¥è°ƒè¯•äº†ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[Android Lintæ˜¯Android SDKæä¾›çš„ä¸€é¡¹é™æ€ä»£ç åˆ†æå·¥å…·ï¼Œå¯¹äºæé«˜ä»£ç è´¨é‡å…·æœ‰é‡è¦ä½œç”¨ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒAndroid SDKè‡ªå¸¦çš„Lintæ£€æŸ¥é¡¹ç›®è¾¾åˆ°äº†253é¡¹ï¼Œæˆ‘ä»¬åœ¨å¼€å‘è¿‡ç¨‹ä¸­ç»å¸¸è§åˆ°çš„æç¤ºä¿¡æ¯æ¯”å¦‚â€œIdè¢«é‡å¤å®šä¹‰â€â€œHandlerLeaké£é™©â€å…¶å®éƒ½æ˜¯ç”±Lintæ£€æŸ¥å®ç°çš„ã€‚æœ¬æ–‡ç»“åˆæºç å¯¹å…¶å·¥ä½œåŸç†è¿›è¡Œåˆ†æã€‚]]>
    
    </summary>
    
      <category term="Android" scheme="http://www.carrotsight.com/tags/Android/"/>
    
      <category term="Lint" scheme="http://www.carrotsight.com/tags/Lint/"/>
    
      <category term="Android" scheme="http://www.carrotsight.com/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[System_serverå¯åŠ¨è¿‡ç¨‹]]></title>
    <link href="http://www.carrotsight.com/2016/05/25/system_server%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B.html"/>
    <id>http://www.carrotsight.com/2016/05/25/system_serverå¯åŠ¨è¿‡ç¨‹.html</id>
    <published>2016-05-25T08:18:20.000Z</published>
    <updated>2016-05-25T08:22:15.000Z</updated>
    <content type="html"><![CDATA[<p><code>Zygote</code>å’Œ<code>system_server</code>æ˜¯Androidç³»ç»Ÿä¸­æœ€é‡è¦çš„ä¸¤ä¸ªè¿›ç¨‹ï¼Œä»»ä½•ä¸€ä¸ªè¿›ç¨‹çš„æ­»äº¡éƒ½ä¼šå¯¼è‡´Javaä¸–ç•Œçš„å´©æºƒã€‚<br>ä¹‹å‰åœ¨ã€Šzygoteå¯åŠ¨è¿‡ç¨‹ã€‹ä¸­ä»‹ç»äº†zygoteçš„å¯åŠ¨è¿‡ç¨‹ï¼Œæœ¬æ–‡ç»§ç»­åˆ†æsystem_serverå¯åŠ¨è¿‡ç¨‹ã€‚  </p>
<a id="more"></a>
<p>ã€Šzygoteå¯åŠ¨è¿‡ç¨‹ã€‹ä¸­æåˆ°ï¼ŒZygoteInit.main()æ–¹æ³•çš„5ä¸ªå…³é”®æ­¥éª¤ä¸­ï¼Œç¬¬â‘¢æ­¥å°±æ˜¯è°ƒç”¨<code>startSystemServer(abiList, socketName)</code>æ¥å¯åŠ¨system_serverè¿›ç¨‹ï¼ŒstartSystemServerï¼ˆï¼‰æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ZygoteInit.java</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">startSystemServer</span><span class="params">(String abiList, String socketName)</span></span><br><span class="line">        <span class="keyword">throws</span> MethodAndArgsCaller, RuntimeException </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> capabilities = posixCapabilitiesAsBits(</span><br><span class="line">        OsConstants.CAP_BLOCK_SUSPEND,</span><br><span class="line">        OsConstants.CAP_KILL,</span><br><span class="line">        OsConstants.CAP_NET_ADMIN,</span><br><span class="line">        OsConstants.CAP_NET_BIND_SERVICE,</span><br><span class="line">        OsConstants.CAP_NET_BROADCAST,</span><br><span class="line">        OsConstants.CAP_NET_RAW,</span><br><span class="line">        OsConstants.CAP_SYS_MODULE,</span><br><span class="line">        OsConstants.CAP_SYS_NICE,</span><br><span class="line">        OsConstants.CAP_SYS_RESOURCE,</span><br><span class="line">        OsConstants.CAP_SYS_TIME,</span><br><span class="line">        OsConstants.CAP_SYS_TTY_CONFIG</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">/* ç¡¬ç¼–ç ç›¸å…³å¯åŠ¨å‚æ•° */</span></span><br><span class="line">    String args[] = &#123;</span><br><span class="line">        <span class="string">"--setuid=1000"</span>,</span><br><span class="line">        <span class="string">"--setgid=1000"</span>,</span><br><span class="line">        <span class="string">"--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1032,3001,3002,3003,3006,3007"</span>,</span><br><span class="line">        <span class="string">"--capabilities="</span> + capabilities + <span class="string">","</span> + capabilities,</span><br><span class="line">        <span class="string">"--nice-name=system_server"</span>,<span class="comment">//è®¾ç½®è¿›ç¨‹åä¸ºsystem_server</span></span><br><span class="line">        <span class="string">"--runtime-args"</span>,</span><br><span class="line">        <span class="string">"com.android.server.SystemServer"</span>,<span class="comment">//å®é™…å¯åŠ¨çš„ç±»</span></span><br><span class="line">    &#125;;</span><br><span class="line">    ZygoteConnection.Arguments parsedArgs = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> pid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        parsedArgs = <span class="keyword">new</span> ZygoteConnection.Arguments(args);</span><br><span class="line">        ZygoteConnection.applyDebuggerSystemProperty(parsedArgs);</span><br><span class="line">        ZygoteConnection.applyInvokeWithSystemProperty(parsedArgs);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* forkä¸€ä¸ªå­è¿›ç¨‹ï¼Œä¹Ÿå°±æ˜¯system_serverè¿›ç¨‹ */</span></span><br><span class="line">        pid = Zygote.forkSystemServer(</span><br><span class="line">                parsedArgs.uid, parsedArgs.gid,</span><br><span class="line">                parsedArgs.gids,</span><br><span class="line">                parsedArgs.debugFlags,</span><br><span class="line">                <span class="keyword">null</span>,</span><br><span class="line">                parsedArgs.permittedCapabilities,</span><br><span class="line">                parsedArgs.effectiveCapabilities);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å¯¹äºå­è¿›ç¨‹ï¼Œä¹Ÿå°±æ˜¯system_serverï¼Œè¿›å…¥ä¸‹é¢çš„ä»£ç  */</span></span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* å‚è€ƒã€Šzygoteå¯åŠ¨è¿‡ç¨‹ã€‹æœ€å¼€å¤´çš„init.zygote32_64.rcæ–‡ä»¶ï¼Œä¼šå¯åŠ¨2ä¸ªzygoteï¼Œç¬¬äºŒä¸ªçš„åå­—æ˜¯"zygote_secondary" */</span></span><br><span class="line">        <span class="keyword">if</span> (hasSecondZygote(abiList)) &#123; </span><br><span class="line">            waitForSecondaryZygote(socketName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* æŠŠå‰©ä¸‹çš„å·¥ä½œäº¤ç»™system_serverè¿›ç¨‹å¤„ç† */</span></span><br><span class="line">        handleSystemServerProcess(parsedArgs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç é€šè¿‡è°ƒç”¨Zygote.forkSystemServerï¼ˆï¼‰æ–¹æ³•ï¼Œä»zygoteè¿›ç¨‹forkå‡ºäº†system_serverè¿›ç¨‹ã€‚é‚£ä¹ˆæ¥çœ‹çœ‹Zygote.forkSystemServerï¼ˆï¼‰æ–¹æ³•çš„ç»†èŠ‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Zygote.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">forkSystemServer</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">int</span> gid, <span class="keyword">int</span>[] gids, <span class="keyword">int</span> debugFlags,</span><br><span class="line">        <span class="keyword">int</span>[][] rlimits, <span class="keyword">long</span> permittedCapabilities, <span class="keyword">long</span> effectiveCapabilities)</span> </span>&#123;</span><br><span class="line">    VM_HOOKS.preFork();</span><br><span class="line">    <span class="keyword">int</span> pid = nativeForkSystemServer(</span><br><span class="line">            uid, gid, gids, debugFlags, rlimits, permittedCapabilities, effectiveCapabilities);</span><br><span class="line">    <span class="comment">// Enable tracing as soon as we enter the system_server.</span></span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        Trace.setTracingEnabled(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    VM_HOOKS.postForkCommon();</span><br><span class="line">    <span class="keyword">return</span> pid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡åå­—å°±å¯ä»¥çœ‹å‡ºï¼ŒnativeForkSystemServer()åº”è¯¥æ˜¯ä¸€ä¸ªnativeæ–¹æ³•ï¼Œforkçš„å·¥ä½œå°±åœ¨è¿™ä¸ªæ–¹æ³•ä¸­å®Œæˆã€‚åœ¨forkå®Œæˆåï¼Œç³»ç»Ÿä¼šè®°å½•forkå‡ºæ¥çš„system_serverè¿›ç¨‹çš„pidï¼Œè¿™æ ·ä¸€æ¥å°±å¯ä»¥å®ç°<code>å½“system_serveræ­»äº¡æ—¶é€šçŸ¥zygoteè‡ªæ€</code>ã€‚</p>
<p>è¿™ä¸ªåä¸ºnativeForkSystemServer()çš„nativeæ–¹æ³•å®ç°åœ¨<code>/Users/netease/AndroidSourceCode/frameworks/base/core/jni/com_android_internal_os_Zygote.cpp</code>ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com_android_internal_os_Zygote.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> jint <span class="title">com_android_internal_os_Zygote_nativeForkSystemServer</span><span class="params">(</span><br><span class="line">        JNIEnv* env, jclass, uid_t uid, gid_t gid, jintArray gids,</span><br><span class="line">        jint debug_flags, jobjectArray rlimits, jlong permittedCapabilities,</span><br><span class="line">        jlong effectiveCapabilities)</span> </span>&#123;</span><br><span class="line">  <span class="comment">/*åœ¨è¿™é‡Œforkæ–°è¿›ç¨‹*/</span></span><br><span class="line">  <span class="keyword">pid_t</span> pid = ForkAndSpecializeCommon(env, uid, gid, gids,</span><br><span class="line">                                      debug_flags, rlimits,</span><br><span class="line">                                      permittedCapabilities, effectiveCapabilities,</span><br><span class="line">                                      MOUNT_EXTERNAL_DEFAULT, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">true</span>, <span class="literal">NULL</span>,</span><br><span class="line">                                      <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">/* 	zygoteè¿›ç¨‹æ£€æŸ¥å­è¿›ç¨‹system_serveræœ‰æ²¡æœ‰æ­»äº¡ã€‚</span><br><span class="line">					å¦‚æœå­è¿›ç¨‹æ­»äº¡ï¼Œåˆ™zygoteè¿›ç¨‹ä¹Ÿè‡ªæ€é‡å¯ */</span></span><br><span class="line">      ALOGI(<span class="string">"System server process %d has been created"</span>, pid);</span><br><span class="line">      gSystemServerPid = pid;</span><br><span class="line">      <span class="keyword">int</span> status;</span><br><span class="line">      <span class="keyword">if</span> (waitpid(pid, &amp;status, WNOHANG) == pid) &#123;</span><br><span class="line">          ALOGE(<span class="string">"System server process %d has died. Restarting Zygote!"</span>, pid);</span><br><span class="line">          RuntimeAbort(env, __LINE__, <span class="string">"System server process has died. Restarting Zygote!"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> pid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å›åˆ°æœ¬æ–‡å¼€å¤´æåˆ°çš„<code>ZygoteInit. startSystemServer()</code>ä»£ç ç‰‡æ®µï¼Œåœ¨zygoteå®Œæˆäº†ä¸Šé¢forkå­è¿›ç¨‹system_serverçš„å·¥ä½œåï¼Œå°±ä¼šè°ƒç”¨<code>handleSystemServerProcess(parsedArgs)</code>æ–¹æ³•ï¼ˆæ³¨æ„ï¼Œæ­¤æ—¶ä»ç„¶åœ¨zygoteè¿›ç¨‹ä¸­ï¼‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ZygoteInit.java</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handleSystemServerProcess</span><span class="params">(</span><br><span class="line">        ZygoteConnection.Arguments parsedArgs)</span></span><br><span class="line">        <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</span><br><span class="line">    <span class="comment">/*å…³é—­ä»zygoteè¿›ç¨‹ç»§æ‰¿æ¥çš„socket*/</span></span><br><span class="line">    closeServerSocket();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*è®¾ç½®umaskä¸º0077ï¼Œè¿™æ ·å°±ä¿è¯äº†æ–°çš„æ–‡ä»¶å’Œç›®å½•é»˜è®¤éƒ½åªæœ‰æ‹¥æœ‰è€…æ‰æœ‰æƒé™*/</span></span><br><span class="line">    Os.umask(S_IRWXG | S_IRWXO);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*è®¾ç½®è¿›ç¨‹åä¸ºsystem_server*/</span></span><br><span class="line">    <span class="keyword">if</span> (parsedArgs.niceName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Process.setArgV0(parsedArgs.niceName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String systemServerClasspath = Os.getenv(<span class="string">"SYSTEMSERVERCLASSPATH"</span>);</span><br><span class="line">    <span class="keyword">if</span> (systemServerClasspath != <span class="keyword">null</span>) &#123;</span><br><span class="line">        performSystemServerDexOpt(systemServerClasspath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*ä»ä¹‹å‰å¯åŠ¨system_serverçš„å‚æ•°åˆ—è¡¨å¯ä»¥çœ‹å‡ºï¼ŒinvokeWithä¸ºnullï¼Œä¼šèµ°è¿›elseåˆ†æ”¯*/</span></span><br><span class="line">    <span class="keyword">if</span> (parsedArgs.invokeWith != <span class="keyword">null</span>) &#123;</span><br><span class="line">        String[] args = parsedArgs.remainingArgs;        </span><br><span class="line">        <span class="keyword">if</span> (systemServerClasspath != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String[] amendedArgs = <span class="keyword">new</span> String[args.length + <span class="number">2</span>];</span><br><span class="line">            amendedArgs[<span class="number">0</span>] = <span class="string">"-cp"</span>;</span><br><span class="line">            amendedArgs[<span class="number">1</span>] = systemServerClasspath;</span><br><span class="line">            System.arraycopy(parsedArgs.remainingArgs, <span class="number">0</span>, amendedArgs, <span class="number">2</span>, parsedArgs.remainingArgs.length);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        WrapperInit.execApplication(parsedArgs.invokeWith,</span><br><span class="line">                parsedArgs.niceName, parsedArgs.targetSdkVersion,</span><br><span class="line">                VMRuntime.getCurrentInstructionSet(), <span class="keyword">null</span>, args);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ClassLoader cl = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (systemServerClasspath != <span class="keyword">null</span>) &#123;</span><br><span class="line">            cl = <span class="keyword">new</span> PathClassLoader(systemServerClasspath, ClassLoader.getSystemClassLoader());</span><br><span class="line">            Thread.currentThread().setContextClassLoader(cl);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*è°ƒç”¨RuntimeInitç±»çš„zygoteInitæ–¹æ³•*/</span></span><br><span class="line">        RuntimeInit.zygoteInit(parsedArgs.targetSdkVersion, parsedArgs.remainingArgs, cl);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢è¿™æ®µä»£ç æœ€åä¼šè°ƒç”¨RuntimeInit.zygoteInit()ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//RuntimeInit.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">zygoteInit</span><span class="params">(<span class="keyword">int</span> targetSdkVersion, String[] argv, ClassLoader classLoader)</span></span><br><span class="line">        <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"RuntimeInit: Starting application from zygote"</span>);</span><br><span class="line"></span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"RuntimeInit"</span>);</span><br><span class="line">    redirectLogStreams();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*  ä¸€äº›å¸¸è§„çš„åˆå§‹åŒ–ï¼Œä¾‹å¦‚ï¼š</span><br><span class="line">        ä¸ºè™šæ‹Ÿæœºä¸­æ‰€æœ‰çº¿ç¨‹è®¾ç½®é»˜è®¤çš„UncaughtExceptionHandlerï¼›</span><br><span class="line">        è®¾ç½®æ—¶åŒºç›¸å…³ä¿¡æ¯ï¼›</span><br><span class="line">        è®¾ç½®HttpURLConnectionä½¿ç”¨çš„HTTP User-Agentä¿¡æ¯ ç­‰ç­‰  */</span></span><br><span class="line">    commonInit();</span><br><span class="line">    <span class="comment">/*nativeå±‚çš„åˆå§‹åŒ–*/</span></span><br><span class="line">    nativeZygoteInit();</span><br><span class="line">    <span class="comment">/*ä¸€äº›å…¶ä»–åˆå§‹åŒ–å·¥ä½œï¼Œå¹¶å¯åŠ¨SystemServerç±»çš„main()æ–¹æ³•*/</span></span><br><span class="line">    applicationInit(targetSdkVersion, argv, classLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç æœ€åä¸€å¥<code>applicationInit(targetSdkVersion, argv, classLoader)</code>ï¼Œå®ƒçš„å†…éƒ¨ä¼šè°ƒç”¨invokeStaticMain()æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//RuntimeInit.java</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeStaticMain</span><span class="params">(String className, String[] argv, ClassLoader classLoader)</span></span><br><span class="line">        <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller </span>&#123;</span><br><span class="line">    Class&lt;?&gt; cl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*è¿™é‡Œçš„classNameçš„å€¼ä¸º"com.android.server.SystemServer"*/</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        cl = Class.forName(className, <span class="keyword">true</span>, classLoader);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Missing class when invoking static main "</span> + className,</span><br><span class="line">                ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Method m;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">/*æ‰¾åˆ°SystemServerç±»çš„main()æ–¹æ³•*/</span></span><br><span class="line">        m = cl.getMethod(<span class="string">"main"</span>, <span class="keyword">new</span> Class[] &#123; String[].class &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Missing static main on "</span> + className, ex);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SecurityException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Problem getting static main on "</span> + className, ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> modifiers = m.getModifiers();</span><br><span class="line">    <span class="comment">/*åˆ¤æ–­ä¸Šé¢æ‰¾åˆ°çš„main()æ–¹æ³•æ˜¯ä¸æ˜¯è¢«"static"å’Œ"public"ä¿®é¥°*/</span></span><br><span class="line">    <span class="keyword">if</span> (! (Modifier.isStatic(modifiers) &amp;&amp; Modifier.isPublic(modifiers))) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Main method is not public and static on "</span> + className);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">     <span class="comment">/* </span><br><span class="line">        è¿™æ¡throwè¯­å¥ä¼šè¢«ZygoteInit.main()æ•è·å¹¶å¤„ç†ï¼Œ</span><br><span class="line">        å¤„ç†çš„æ•ˆæœå°±æ˜¯æ‰§è¡ŒSystermServerç±»çš„main()æ–¹æ³•ã€‚</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteInit.MethodAndArgsCaller(m, argv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„æ–¹æ³•æœ€åæ˜¯ä¸€æ¡throwè¯­å¥ï¼Œè¿˜è®°å¾—ã€Šzygoteå¯åŠ¨è¿‡ç¨‹ã€‹ä¸­ä»‹ç»çš„ZygoteInitç±»çš„main()æ–¹æ³•å—ï¼Œè¿™é‡Œthorwçš„å¯¹è±¡ä¼šåœ¨ZygoteInitç±»çš„main()ä¸­è¢«æ•è·ï¼Œåœ¨å›é¡¾ä¸€ä¸‹ç²¾ç®€çš„ZygoteInit.main()ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ZygoteInit.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String argv[])</span> </span>&#123;</span><br><span class="line">	......</span><br><span class="line">	<span class="keyword">try</span>&#123;</span><br><span class="line">		......</span><br><span class="line">		<span class="keyword">if</span> (startSystemServer) &#123;</span><br><span class="line">	            startSystemServer(abiList, socketName);</span><br><span class="line">	        &#125;</span><br><span class="line"></span><br><span class="line">	        ......</span><br><span class="line">	    &#125; <span class="keyword">catch</span> (MethodAndArgsCaller caller) &#123;</span><br><span class="line">	        caller.run();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒZygoteInit.main()åœ¨catchåˆ°MethodAndArgsCallerå¯¹è±¡åï¼Œä¼šè°ƒç”¨caller.run()æ–¹æ³•ï¼Œè¿™ä¸ªrun()æ–¹æ³•å®é™…å°±æ˜¯é€šè¿‡åå°„æ–¹å¼<code>mMethod.invoke(null, new Object[] { mArgs })</code>è°ƒç”¨methodï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨äº†å‰é¢ä¼ å…¥çš„SystemServerç±»çš„ç”±<code>public</code>å’Œ<code>static</code>ä¿®é¥°çš„main()æ–¹æ³•ã€‚</p>
<p>ä¸ºä»€ä¹ˆè¿™é‡Œè¦ç”¨æŠ›å‡ºå¼‚å¸¸åœ¨catchä¸­æ•è·ååˆ©ç”¨åå°„æ¥è°ƒç”¨SystemServerçš„main()æ–¹æ³•ï¼Œè€Œä¸æ˜¯åœ¨RuntimeInitçš„invokeStaticMain()æ–¹æ³•ä¸­ç›´æ¥è°ƒç”¨mainå‘¢ï¼ŸRuntimeInit.javaçš„æ³¨é‡Šå·²ç»è§£é‡Šçš„å¾ˆæ¸…æ¥šï¼š<strong>è®©è¿™é‡Œthrowçš„å¯¹è±¡åœ¨ZygoteInitçš„mainä¸­è¢«æ•è·åå†è°ƒç”¨SystemServerçš„mainæ–¹æ³•ï¼Œèƒ½å¤Ÿä½¿åˆšåˆšåˆ›å»ºçš„system_serverè¿›ç¨‹æ¸…ç©ºå®ƒé¡¶éƒ¨æ‰€æœ‰å› ä¸ºåˆå§‹åŒ–åˆ›å»ºsystem_serverè¿›ç¨‹è€Œç”Ÿæˆçš„æ ˆå¸§ï¼Œå› ä¸ºä»ZygoteInitçš„mainèµ°åˆ°å½“å‰çš„RuntimeInit.invokeStaticMain()å·²ç»è¿›è¡Œäº†å¾ˆæ·±å±‚æ¬¡çš„å‡½æ•°è°ƒç”¨ï¼Œæµªè´¹äº†ä¸å°‘å †æ ˆç©ºé—´ã€‚</strong></p>
<p>å‰é¢å¤§é‡çš„ä»£ç ï¼Œéƒ½æ˜¯ä¸ºäº†è®©ZygoteInitåˆ†è£‚å‡ºçš„system_serverè¿›ç¨‹èƒ½å¤Ÿè°ƒç”¨SystemServerçš„main()æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SystemServer.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">new</span> SystemServer().run();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°mainæ–¹æ³•å¾ˆç®€å•ï¼Œå°±æ˜¯åˆ›å»ºä¸€ä¸ªSystemServerå¯¹è±¡ï¼Œç„¶åè°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„run()æ–¹æ³•ï¼Œä¸‹é¢å†çœ‹çœ‹run()æ–¹æ³•çš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ......<span class="comment">/*ä¸runtimeç›¸å…³çš„å„ç§åˆå§‹åŒ–*/</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*åˆå§‹åŒ–ä¸»çº¿ç¨‹çš„Looper*/</span></span><br><span class="line">    Looper.prepareMainLooper();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*åŠ è½½libandroid_servers.soåº“*/</span></span><br><span class="line">    System.loadLibrary(<span class="string">"android_servers"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*	æ£€æŸ¥è¿™ä¹‹å‰æœ€åæ¬¡å°è¯•å…³æœºçš„æ“ä½œæ˜¯å¦å¤±è´¥äº†ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä¼šé‡å¯æˆ–å…³æœºã€‚</span><br><span class="line">    	ç”±æ­¤å¯çŸ¥ï¼ŒperformPendingShutdown()çš„è°ƒç”¨æœ‰å¯èƒ½ä¸ä¼šè¿”å›è¿™é‡Œç»§ç»­å‘ä¸‹æ‰§è¡Œã€‚*/</span></span><br><span class="line">    performPendingShutdown();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*	åˆå§‹åŒ–ç³»ç»Ÿcontextï¼Œä¸»è¦æ˜¯è®¾ç½®ç³»ç»Ÿä¸»é¢˜ï¼Œå½“å‰ç‰ˆæœ¬æºç </span><br><span class="line">    	æ˜¯æŠŠç³»ç»Ÿä¸»é¢˜è®¾ç½®ä¸º"android.R.style.Theme_DeviceDefault_Light_DarkActionBar"ã€‚*/</span></span><br><span class="line">    createSystemContext();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*åˆ›å»ºSystemServiceManager*/</span></span><br><span class="line">    mSystemServiceManager = <span class="keyword">new</span> SystemServiceManager(mSystemContext);</span><br><span class="line">    LocalServices.addService(SystemServiceManager.class, mSystemServiceManager);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*å¯åŠ¨å„ç§æœåŠ¡*/</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    	<span class="comment">/*</span><br><span class="line">	    	å¯åŠ¨å‡ ä¸ªå¿…é¡»éšç³»ç»Ÿå¯åŠ¨çš„æœåŠ¡ï¼ŒåŒ…æ‹¬ï¼š</span><br><span class="line">	    	ActivityManagerServiceã€PowerManagerServiceã€LightsServiceã€</span><br><span class="line">	    	DisplayManagerServiceã€PackageManagerServiceã€UserManagerServiceï¼Œ</span><br><span class="line">	    	ä»¥åŠå¯åŠ¨ä¼ æ„Ÿå™¨æœåŠ¡</span><br><span class="line">    	*/</span></span><br><span class="line">        startBootstrapServices();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span><br><span class="line">	    	å¯åŠ¨å‡ ä¸ªæ ¸å¿ƒæœåŠ¡ï¼ŒåŒ…æ‹¬ï¼š</span><br><span class="line">	    	BatteryServiceã€UsageStatsServiceã€WebViewUpdateServiceç­‰</span><br><span class="line">    	*/</span></span><br><span class="line">        startCoreServices();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span><br><span class="line">			å¯åŠ¨å…¶ä»–æœåŠ¡ï¼ŒåŒ…æ‹¬ï¼š</span><br><span class="line">			AccountManagerServiceã€ContentServiceã€VibratorServiceã€</span><br><span class="line">			TelecomLoaderServiceã€CameraServiceç­‰ä¼—å¤šserviceã€‚</span><br><span class="line">			å¾ˆå…³é”®çš„æ˜¯ï¼ŒstartOtherServices()å‡½æ•°å†…éƒ¨å¯åŠ¨äº†Watchdogï¼Œç”¨æ¥ç›‘æ§ç³»ç»Ÿçš„è¿è¡ŒçŠ¶æ€å¹¶åœ¨å¿…è¦æ—¶é‡å¯ç³»ç»Ÿã€‚</span><br><span class="line">        */</span></span><br><span class="line">        startOtherServices();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        Slog.e(<span class="string">"System"</span>, <span class="string">"******************************************"</span>);</span><br><span class="line">        Slog.e(<span class="string">"System"</span>, <span class="string">"************ Failure starting system services"</span>, ex);</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*è¿›å…¥æ°¸ä¹…å¾ªç¯*/</span></span><br><span class="line">    Looper.loop();</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Main thread loop unexpectedly exited"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢è¿™æ®µè·‘åœ¨system_serverè¿›ç¨‹ä¸­çš„ä»£ç è´Ÿè´£åˆå§‹åŒ–ä¸»çº¿ç¨‹çš„Looperï¼Œå¹¶å¯åŠ¨å„ç§é‡è¦æœåŠ¡ï¼Œå¯åŠ¨çœ‹é—¨ç‹—ä»¥åœ¨å¿…è¦æ—¶é‡å¯ç³»ç»Ÿï¼Œç”±æ­¤å¯ä»¥çœ‹å‡ºsysterm_serverçš„é‡è¦æ€§ã€‚è‡³æ­¤ï¼Œsystem_serverå¯åŠ¨å®Œæˆã€‚</p>
<p>system_serverå¯åŠ¨çš„å¤§è‡´æµç¨‹å¯ä»¥ç”¨ä¸‹å›¾æ¦‚æ‹¬ï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-5-25/43203856.jpg" alt=""></p>
]]></content>
    <summary type="html">
    <![CDATA[<p><code>Zygote</code>å’Œ<code>system_server</code>æ˜¯Androidç³»ç»Ÿä¸­æœ€é‡è¦çš„ä¸¤ä¸ªè¿›ç¨‹ï¼Œä»»ä½•ä¸€ä¸ªè¿›ç¨‹çš„æ­»äº¡éƒ½ä¼šå¯¼è‡´Javaä¸–ç•Œçš„å´©æºƒã€‚<br>ä¹‹å‰åœ¨ã€Šzygoteå¯åŠ¨è¿‡ç¨‹ã€‹ä¸­ä»‹ç»äº†zygoteçš„å¯åŠ¨è¿‡ç¨‹ï¼Œæœ¬æ–‡ç»§ç»­åˆ†æsystem_serverå¯åŠ¨è¿‡ç¨‹ã€‚  </p>]]>
    
    </summary>
    
      <category term="Android" scheme="http://www.carrotsight.com/tags/Android/"/>
    
      <category term="system_server" scheme="http://www.carrotsight.com/tags/system-server/"/>
    
      <category term="zygote" scheme="http://www.carrotsight.com/tags/zygote/"/>
    
      <category term="æºç åˆ†æ" scheme="http://www.carrotsight.com/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
      <category term="Android" scheme="http://www.carrotsight.com/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Zygoteå¯åŠ¨è¿‡ç¨‹]]></title>
    <link href="http://www.carrotsight.com/2016/05/24/Zygote%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B.html"/>
    <id>http://www.carrotsight.com/2016/05/24/Zygoteå¯åŠ¨è¿‡ç¨‹.html</id>
    <published>2016-05-24T12:36:52.000Z</published>
    <updated>2016-05-27T03:32:51.000Z</updated>
    <content type="html"><![CDATA[<p><code>Zygote</code>å’Œ<code>system_server</code>æ˜¯Androidç³»ç»Ÿä¸­æœ€é‡è¦çš„ä¸¤ä¸ªè¿›ç¨‹ï¼Œä»»ä½•ä¸€ä¸ªè¿›ç¨‹çš„æ­»äº¡éƒ½ä¼šå¯¼è‡´Javaä¸–ç•Œçš„å´©æºƒã€‚å…¶ä¸­ï¼Œzygoteç”±linuxç³»ç»Ÿçš„1å·è¿›ç¨‹initç›´æ¥forkè€Œæ¥ï¼Œè€Œsystem_serverè¿›ç¨‹ç”±zygoteè¿›ç¨‹forkè€Œæ¥ã€‚<br>é€šè¿‡adb shellè¿æ¥åˆ°è®¾å¤‡ï¼Œå¯ä»¥è¿›è¡ŒéªŒè¯ï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-5-25/77168217.jpg" alt=""></p>
<p>Zygoteæœ¬èº«æ˜¯ä¸€ä¸ªNativeåº”ç”¨ç¨‹åºï¼Œä¸é©±åŠ¨ã€å†…æ ¸ç­‰å‡æ— å…³ç³»ã€‚<br><a id="more"></a></p>
<p>Zygoteæ˜¯initè¿›ç¨‹æ ¹æ®init.rcæ–‡ä»¶ä¸­çš„é…ç½®é¡¹åˆ›å»ºçš„ï¼Œåœ¨å½“å‰æœ€æ–°çš„Androidæºç ä¸­ï¼Œä¸zygoteå¯åŠ¨ç›¸å…³çš„ä»£ç ä¸å†æ˜¯ç›´æ¥å†™åœ¨init.rcä¸­ï¼Œè€Œæ˜¯åœ¨init.rcæ–‡ä»¶å¼€å¤´ä»¥<code>import /init.${ro.zygote}.rc</code>çš„æ–¹å¼å¼•å…¥ï¼Œå¯¹äºä¸åŒçš„å¹³å°ï¼Œå¼•å…¥çš„{ro.zygote}.rcæ–‡ä»¶æ˜¯ä¸åŒçš„ï¼Œå¦‚å›¾ï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-5-23/35686446.jpg" alt=""></p>
<p>è¿™4ä¸ªæ–‡ä»¶çš„åŒºåˆ«å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>â‘ init.zygote32.rcï¼šzygote è¿›ç¨‹å¯¹åº”çš„æ‰§è¡Œç¨‹åºæ˜¯ <code>app_process</code> (çº¯ 32bit æ¨¡å¼)<br>â‘¡init.zygote64.rcï¼šzygote è¿›ç¨‹å¯¹åº”çš„æ‰§è¡Œç¨‹åºæ˜¯ <code>app_process64</code> (çº¯ 64bit æ¨¡å¼)<br>â‘¢init.zygote32_64.rcï¼šå¯åŠ¨ä¸¤ä¸ª zygote è¿›ç¨‹ (åä¸º zygote å’Œ zygote_secondary)ï¼Œå¯¹åº”çš„æ‰§è¡Œç¨‹åºåˆ†åˆ«æ˜¯ <code>app_process32</code> (ä¸»æ¨¡å¼)ã€<code>app_process64</code>ã€‚<br>â‘£init.zygote64_32.rcï¼šå¯åŠ¨ä¸¤ä¸ª zygote è¿›ç¨‹ (åä¸º zygote å’Œ zygote_secondary)ï¼Œå¯¹åº”çš„æ‰§è¡Œç¨‹åºåˆ†åˆ«æ˜¯ <code>app_process64</code> (ä¸»æ¨¡å¼)ã€<code>app_process32</code>ã€‚</p>
</blockquote>
<p>æ‰“å¼€<code>init.zygote64.rc</code>æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">service zygote /<span class="keyword">system</span>/bin/app_process64 -Xzygote /<span class="keyword">system</span>/bin <span class="comment">--zygote --start-system-server</span></span><br><span class="line">    class main</span><br><span class="line">    <span class="built_in">socket</span> zygote stream <span class="number">660</span> root <span class="keyword">system</span></span><br><span class="line">    onrestart <span class="built_in">write</span> /sys/android_power/request_state wake</span><br><span class="line">    onrestart <span class="built_in">write</span> /sys/power/state <span class="command"><span class="keyword">on</span></span></span><br><span class="line">    onrestart restart media</span><br><span class="line">    onrestart restart netd</span><br><span class="line">    writepid /dev/cpuset/foreground/tasks /sys/fs/cgroup/stune/foreground/tasks</span><br></pre></td></tr></table></figure>
<p>è€Œ<code>init.zygote32_64.rc</code>çš„å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">service zygote /<span class="keyword">system</span>/bin/app_process32 -Xzygote /<span class="keyword">system</span>/bin <span class="comment">--zygote --start-system-server --socket-name=zygote</span></span><br><span class="line">    class main</span><br><span class="line">    <span class="built_in">socket</span> zygote stream <span class="number">660</span> root <span class="keyword">system</span></span><br><span class="line">    onrestart <span class="built_in">write</span> /sys/android_power/request_state wake</span><br><span class="line">    onrestart <span class="built_in">write</span> /sys/power/state <span class="command"><span class="keyword">on</span></span></span><br><span class="line">    onrestart restart media</span><br><span class="line">    onrestart restart netd</span><br><span class="line">    writepid /dev/cpuset/foreground/tasks /sys/fs/cgroup/stune/foreground/tasks</span><br><span class="line"></span><br><span class="line">service zygote_secondary /<span class="keyword">system</span>/bin/app_process64 -Xzygote /<span class="keyword">system</span>/bin <span class="comment">--zygote --socket-name=zygote_secondary</span></span><br><span class="line">    class main</span><br><span class="line">    <span class="built_in">socket</span> zygote_secondary stream <span class="number">660</span> root <span class="keyword">system</span></span><br><span class="line">    onrestart restart zygote</span><br><span class="line">    writepid /dev/cpuset/foreground/tasks /sys/fs/cgroup/stune/foreground/tasks</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸¤ä¸ªæ–‡ä»¶æ¯ä¸ªserviceç¬¬ä¸€è¡Œ<code>service zygote</code>åé¢çš„è·¯å¾„æ˜¯æœ‰åŒºåˆ«çš„ï¼Œåˆ†åˆ«æ˜¯<code>/system/bin/app_process64</code>æˆ–æ˜¯<code>/system/bin/app_process32</code>ã€‚è¿™æ®µä»£ç è¡¨æ˜ï¼Œåœ¨ä¸åŒçš„å¹³å°ä¸Šzygoteå¯¹åº”çš„å¯æ‰§è¡Œæ–‡ä»¶æ˜¯ä¸åŒçš„ï¼Œåœ¨è¿è¡Œè¿‡ç¨‹ä¸­app_processXXé€šè¿‡Linuxä¸‹çš„pctrlç³»ç»Ÿè°ƒç”¨å°†è‡ªå·±çš„åå­—æ¢æˆäº†<code>zygote</code>ã€‚</p>
<p>app_processXXå¯¹åº”çš„æºæ–‡ä»¶æ˜¯<code>frameworks/base/cmds/app_process/App_main.cpp</code>ï¼Œéƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc, char* const argv[])</span><br><span class="line">&#123;</span><br><span class="line">    /*è®¾ç½®å½“å‰è¿›ç¨‹å’Œå­è¿›ç¨‹ä¸èƒ½è·å–æ›´å¤šæƒé™*/</span><br><span class="line">    if (prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0) &lt; 0) &#123;</span><br><span class="line">        // Older kernels don't understand PR_SET_NO_NEW_PRIVS and return</span><br><span class="line">        // EINVAL. Don't die on such kernels.</span><br><span class="line">        if (errno != EINVAL) &#123;</span><br><span class="line">            LOG_ALWAYS_FATAL("PR_SET_NO_NEW_PRIVS failed: %s", strerror(errno));</span><br><span class="line">            return 12;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /*  </span><br><span class="line">        å¯»æ‰¾è™šæ‹Ÿæœºç›¸å…³å‚æ•°ï¼Œargv[0]è‚¯å®šä¸æ˜¯ï¼Œæ‰€ä»¥ç›´æ¥å¿½ç•¥å®ƒã€‚</span><br><span class="line">        ç”±äºæˆ‘ä»¬åœ¨init.rcä¸­è®¾ç½®çš„å¯åŠ¨å‚æ•°ä¸º</span><br><span class="line">        -Xzygote /system/bin --zygote --start-system-server</span><br><span class="line">        æ‰€ä»¥ï¼Œè¿™é‡Œæ‰¾åˆ°çš„è™šæ‹Ÿæœºå‚æ•°å°±æ˜¯-Xzygote</span><br><span class="line">    */</span><br><span class="line">    AppRuntime runtime(argv[0], computeArgBlockSize(argc, argv));    </span><br><span class="line">    argc--;</span><br><span class="line">    argv++;    </span><br><span class="line">    int i;</span><br><span class="line">    for (i = 0; i &lt; argc; i++) &#123;</span><br><span class="line">        if (argv[i][0] != '-') &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        if (argv[i][1] == '-' &amp;&amp; argv[i][2] == 0) &#123;</span><br><span class="line">            ++i; // Skip --.</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        runtime.addOption(strdup(argv[i]));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    bool zygote = false;</span><br><span class="line">    bool startSystemServer = false;</span><br><span class="line">    bool application = false;</span><br><span class="line">    String8 niceName;</span><br><span class="line">    String8 className;</span><br><span class="line"></span><br><span class="line">    ++i;  /*      `/system/bin`æ˜¯parent dirï¼Œè¿™ä¸ªå‚æ•°æš‚æ—¶æ²¡æœ‰ç”¨å¤„ï¼Œç›´æ¥è·³è¿‡   */</span><br><span class="line">    while (i &lt; argc) &#123;</span><br><span class="line">        /* è®¾ç½®internal arguments */</span><br><span class="line">        const char* arg = argv[i++];</span><br><span class="line">        if (strcmp(arg, "--zygote") == 0) &#123;</span><br><span class="line">            zygote = true;</span><br><span class="line">            niceName = ZYGOTE_NICE_NAME;</span><br><span class="line">        &#125; else if (strcmp(arg, "--start-system-server") == 0) &#123;</span><br><span class="line">            startSystemServer = true;</span><br><span class="line">        &#125; else if (strcmp(arg, "--application") == 0) &#123;</span><br><span class="line">            application = true;</span><br><span class="line">        &#125; else if (strncmp(arg, "--nice-name=", 12) == 0) &#123;</span><br><span class="line">            niceName.setTo(arg + 12);</span><br><span class="line">        &#125; else if (strncmp(arg, "--", 2) != 0) &#123;</span><br><span class="line">            className.setTo(arg);</span><br><span class="line">            break;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            --i;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Vector&lt;String8&gt; args;</span><br><span class="line">    if (!className.isEmpty()) &#123;</span><br><span class="line">        // We're not in zygote mode, the only argument we need to pass</span><br><span class="line">        // to RuntimeInit is the application argument.</span><br><span class="line">        //</span><br><span class="line">        // The Remainder of args get passed to startup class main(). Make</span><br><span class="line">        // copies of them before we overwrite them with the process name.</span><br><span class="line">        args.add(application ? String8("application") : String8("tool"));</span><br><span class="line">        runtime.setClassNameAndArgs(className, argc - i, argv + i);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // We're in zygote mode.</span><br><span class="line">        maybeCreateDalvikCache();</span><br><span class="line"></span><br><span class="line">        if (startSystemServer) &#123;</span><br><span class="line">            args.add(String8("start-system-server"));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        char prop[PROP_VALUE_MAX];</span><br><span class="line">        if (property_get(ABI_LIST_PROPERTY, prop, NULL) == 0) &#123;</span><br><span class="line">            LOG_ALWAYS_FATAL("app_process: Unable to determine ABI list from property %s.",</span><br><span class="line">                ABI_LIST_PROPERTY);</span><br><span class="line">            return 11;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String8 abiFlag("--abi-list=");</span><br><span class="line">        abiFlag.append(prop);</span><br><span class="line">        args.add(abiFlag);</span><br><span class="line"></span><br><span class="line">        // In zygote mode, pass all remaining arguments to the zygote</span><br><span class="line">        // main() method.</span><br><span class="line">        for (; i &lt; argc; ++i) &#123;</span><br><span class="line">            args.add(String8(argv[i]));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!niceName.isEmpty()) &#123;</span><br><span class="line">        /*  å°†ä¼ é€’ç»™runtimeå¯¹è±¡çš„å¯åŠ¨å‚æ•°app_processæˆ–app_process64æ›¿æ¢ä¸º"zygote"ï¼Œ</span><br><span class="line">            å¹¶æŠŠè¿›ç¨‹åä¹Ÿè®¾ç½®ä¸º"zygote" */</span><br><span class="line">        runtime.setArgv0(niceName.string());        </span><br><span class="line">        set_process_name(niceName.string());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (zygote) &#123;</span><br><span class="line">        InitializeNativeLoader();</span><br><span class="line"></span><br><span class="line">        /*  å¯åŠ¨javaç±»ZygoteInitï¼Œå¹¶ä¼ å…¥å‚æ•°args</span><br><span class="line">            zygoteä»…ç”¨æ¥åœ¨runtime.startï¼ˆï¼‰å‡½æ•°ä¸­åŒºåˆ†æ˜¯å¦ä»¥zygoteæ¨¡å¼å¯åŠ¨ */</span><br><span class="line">        runtime.start("com.android.internal.os.ZygoteInit", args, zygote);</span><br><span class="line">    &#125; else if (className) &#123;</span><br><span class="line">        runtime.start("com.android.internal.os.RuntimeInit", args, zygote);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        fprintf(stderr, "Error: no class name or --zygote supplied.\n");</span><br><span class="line">        app_usage();</span><br><span class="line">        LOG_ALWAYS_FATAL("app_process: no class name or --zygote supplied.");</span><br><span class="line">        return 10;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå¾ˆå…³é”®çš„å°±æ˜¯<code>runtime.start()</code>æ–¹æ³•ï¼Œruntimeæ˜¯ä¸€ä¸ªAppRuntimeå¯¹è±¡ï¼Œè€ŒAppRuntimeç±»çš„å¤§è‡´ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> AppRuntime : <span class="keyword">public</span> AndroidRuntime</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    AppRuntime(<span class="keyword">char</span>* argBlockStart, <span class="keyword">const</span> <span class="keyword">size_t</span> argBlockLength)</span><br><span class="line">        : AndroidRuntime(argBlockStart, argBlockLength)&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setClassNameAndArgs</span><span class="params">(<span class="keyword">const</span> String8&amp; className, <span class="keyword">int</span> argc, <span class="keyword">char</span> * <span class="keyword">const</span> *argv)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onVmCreated</span><span class="params">(JNIEnv* env)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onStarted</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onZygoteInit</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onExit</span><span class="params">(<span class="keyword">int</span> code)</span></span>;    </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒAppRuntimeå®é™…ä¸Šæ˜¯ç»§æ‰¿è‡ªAndroidRuntimeï¼Œå¹¶ä¸”æ²¡æœ‰overrideçˆ¶ç±»çš„start()æ–¹æ³•ï¼Œè¯´æ˜ä¸Šé¢æåˆ°çš„<code>runtime.start()</code>å®é™…æ˜¯ç›´æ¥è°ƒç”¨äº†AndroidRuntimeçš„start()æ–¹æ³•ã€‚  </p>
<p>æ‰¾åˆ°AndroidRuntime.cppæ–‡ä»¶ï¼Œå®ƒçš„start()æ–¹æ³•éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> AndroidRuntime::start(<span class="keyword">const</span> <span class="keyword">char</span>* className, <span class="keyword">const</span> Vector&lt;String8&gt;&amp; options, <span class="keyword">bool</span> zygote)</span><br><span class="line">&#123;</span><br><span class="line">    ALOGD(<span class="string">"&gt;&gt;&gt;&gt;&gt;&gt; START %s uid %d &lt;&lt;&lt;&lt;&lt;&lt;\n"</span>,</span><br><span class="line">            className != <span class="literal">NULL</span> ? className : <span class="string">"(unknown)"</span>, getuid());</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">const</span> String8 <span class="title">startSystemServer</span><span class="params">(<span class="string">"start-system-server"</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span><br><span class="line">     * 'startSystemServer == true' means runtime is obsolete and not run from</span><br><span class="line">     * init.rc anymore, so we print out the boot start event here.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; options.size(); ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (options[i] == startSystemServer) &#123;</span><br><span class="line">           <span class="comment">/* track our progress through the boot sequence */</span></span><br><span class="line">           <span class="keyword">const</span> <span class="keyword">int</span> LOG_BOOT_PROGRESS_START = <span class="number">3000</span>;</span><br><span class="line">           LOG_EVENT_LONG(LOG_BOOT_PROGRESS_START,  ns2ms(systemTime(SYSTEM_TIME_MONOTONIC)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å¦‚æœæ‰¾ä¸åˆ°ç¯å¢ƒå˜é‡ANDROID_ROOTï¼Œåˆ™æ–°å¢ç¯å¢ƒå˜é‡ANDROID_ROOTå€¼ä¸º"/system" */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* rootDir = getenv(<span class="string">"ANDROID_ROOT"</span>);</span><br><span class="line">    <span class="keyword">if</span> (rootDir == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        rootDir = <span class="string">"/system"</span>;</span><br><span class="line">        <span class="keyword">if</span> (!hasDir(<span class="string">"/system"</span>)) &#123;</span><br><span class="line">            LOG_FATAL(<span class="string">"No root directory specified, and /android does not exist."</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        setenv(<span class="string">"ANDROID_ROOT"</span>, rootDir, <span class="number">1</span>);</span><br><span class="line">    &#125;    </span><br><span class="line"></span><br><span class="line">    <span class="comment">/* â‘ åˆ›å»ºè™šæ‹Ÿæœº */</span></span><br><span class="line">    JniInvocation jni_invocation;</span><br><span class="line">    jni_invocation.Init(<span class="literal">NULL</span>);</span><br><span class="line">    JNIEnv* env;</span><br><span class="line">    <span class="keyword">if</span> (startVm(&amp;mJavaVM, &amp;env, zygote) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    onVmCreated(env);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* â‘¡æ³¨å†ŒJNIå‡½æ•° */</span></span><br><span class="line">    <span class="keyword">if</span> (startReg(env) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"Unable to register all android natives\n"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* åˆ›å»ºä¸€ä¸ªStringæ•°ç»„æ¥å­˜æ”¾å¯åŠ¨å‚æ•° */</span></span><br><span class="line">    jclass stringClass;</span><br><span class="line">    jobjectArray strArray;</span><br><span class="line">    jstring classNameStr;</span><br><span class="line"></span><br><span class="line">    stringClass = env-&gt;FindClass(<span class="string">"java/lang/String"</span>);</span><br><span class="line">    assert(stringClass != <span class="literal">NULL</span>);</span><br><span class="line">    strArray = env-&gt;NewObjectArray(options.size() + <span class="number">1</span>, stringClass, <span class="literal">NULL</span>);</span><br><span class="line">    assert(strArray != <span class="literal">NULL</span>);</span><br><span class="line">    classNameStr = env-&gt;NewStringUTF(className);</span><br><span class="line">    assert(classNameStr != <span class="literal">NULL</span>);</span><br><span class="line">    env-&gt;SetObjectArrayElement(strArray, <span class="number">0</span>, classNameStr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; options.size(); ++i) &#123;</span><br><span class="line">        jstring optionsStr = env-&gt;NewStringUTF(options.itemAt(i).<span class="built_in">string</span>());</span><br><span class="line">        assert(optionsStr != <span class="literal">NULL</span>);</span><br><span class="line">        env-&gt;SetObjectArrayElement(strArray, i + <span class="number">1</span>, optionsStr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* </span><br><span class="line">         â‘¢è¿™é‡Œçš„classNameå€¼ä¸º"com.android.internal.os.ZygoteInit"ã€‚</span><br><span class="line">         é¦–å…ˆä½¿ç”¨GetStaticMethodIDï¼ˆï¼‰æ–¹æ³•æŸ¥æ‰¾ZygoteInitç±»çš„main()æ–¹æ³•ï¼Œ</span><br><span class="line">         å¦‚æœmain()æ–¹æ³•å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨CallStaticVoidMethod()æ–¹æ³•æ¥è°ƒç”¨ZygoteInitç±»çš„main()æ–¹æ³•ï¼Œ</span><br><span class="line">         ä»æ­¤ï¼Œæˆ‘ä»¬ä»Navtiveä¸–ç•Œè¿›å…¥javaä¸–ç•Œã€‚</span><br><span class="line">         æœ¬çº¿ç¨‹ä¼šæˆä¸ºè™šæ‹Ÿæœºä¸»çº¿ç¨‹ï¼Œå¹¶ä¸”ä¸ä¼šreturnï¼Œç›´åˆ°è™šæ‹Ÿæœºé€€å‡ºã€‚</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">char</span>* slashClassName = toSlashClassName(className);</span><br><span class="line">    jclass startClass = env-&gt;FindClass(slashClassName);</span><br><span class="line">    <span class="keyword">if</span> (startClass == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"JavaVM unable to locate class '%s'\n"</span>, slashClassName);</span><br><span class="line">        <span class="comment">/* keep going */</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        jmethodID startMeth = env-&gt;GetStaticMethodID(startClass, <span class="string">"main"</span>,</span><br><span class="line">            <span class="string">"([Ljava/lang/String;)V"</span>);</span><br><span class="line">        <span class="keyword">if</span> (startMeth == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            ALOGE(<span class="string">"JavaVM unable to find main() in '%s'\n"</span>, className);</span><br><span class="line">            <span class="comment">/* keep going */</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            env-&gt;CallStaticVoidMethod(startClass, startMeth, strArray);</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(slashClassName);</span><br><span class="line"></span><br><span class="line">    ALOGD(<span class="string">"Shutting down VM\n"</span>);</span><br><span class="line">    <span class="keyword">if</span> (mJavaVM-&gt;DetachCurrentThread() != JNI_OK)</span><br><span class="line">        ALOGW(<span class="string">"Warning: unable to detach main thread\n"</span>);</span><br><span class="line">    <span class="keyword">if</span> (mJavaVM-&gt;DestroyJavaVM() != <span class="number">0</span>)</span><br><span class="line">        ALOGW(<span class="string">"Warning: VM did not shut down cleanly\n"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç åŒ…å«äº†3ä¸ªå…³é”®æ­¥éª¤ï¼Œå³ï¼š<br>â‘ åˆ›å»ºè™šæ‹Ÿæœº<br>â‘¡æ³¨å†ŒJNIå‡½æ•°<br>â‘¢è°ƒç”¨com.android.internal.os.ZygoteInitçš„main()æ–¹æ³•ï¼Œè¿›å…¥Javaä¸–ç•Œ  </p>
<p>com.android.internal.os.ZygoteInitçš„main()æ–¹æ³•æ˜¯ä»nativeä¸–ç•Œè¿›å…¥Javaä¸–ç•Œçš„èµ·ç‚¹ã€‚æ—¢ç„¶æ­¤æ–¹æ³•å¦‚æ­¤é‡è¦ï¼Œé‚£ä¹ˆå°±çœ‹çœ‹å®ƒçš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ZygoteInit.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* â‘ æ³¨å†Œzygoteä½¿ç”¨çš„socket */</span></span><br><span class="line">        registerZygoteSocket(socketName);</span><br><span class="line">        EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_START,</span><br><span class="line">            SystemClock.uptimeMillis());</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* â‘¡é¢„åŠ è½½ç±»å’Œèµ„æº */</span></span><br><span class="line">        preload();</span><br><span class="line">        </span><br><span class="line">        ......</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* â‘¢å¯åŠ¨system_serverè¿›ç¨‹ */</span></span><br><span class="line">        <span class="keyword">if</span> (startSystemServer) &#123;</span><br><span class="line">            startSystemServer(abiList, socketName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* â‘£è¿è¡Œzygoteè¿›ç¨‹çš„selectå¾ªç¯ï¼Œå½“æœ‰æ–°çš„è¿æ¥è¯·æ±‚æ—¶å°±æ¥å— */</span></span><br><span class="line">        runSelectLoop(abiList);</span><br><span class="line"></span><br><span class="line">        closeServerSocket();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (MethodAndArgsCaller caller) &#123;</span><br><span class="line">        <span class="comment">/* â‘¤åœ¨system_sererè¿›ç¨‹ä¸­ï¼Œä»¥åå°„æ–¹å¼è°ƒç”¨SystemServerç±»çš„mainæ–¹æ³• */</span></span><br><span class="line">        caller.run();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">"Zygote died with exception"</span>, ex);</span><br><span class="line">        closeServerSocket();</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç æœ‰5ä¸ªå…³é”®æ­¥éª¤éƒ½å·²æ ‡å‡ºã€‚<br>â‘ æ³¨å†Œsocketçš„ä»£ç æ¯”è¾ƒç®€å•ï¼Œå¦‚ä¸‹ï¼š  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerZygoteSocket</span><span class="params">(String socketName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sServerSocket == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> fileDesc;</span><br><span class="line">        <span class="keyword">final</span> String fullSocketName = ANDROID_SOCKET_PREFIX + socketName;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String env = System.getenv(fullSocketName);</span><br><span class="line">            fileDesc = Integer.parseInt(env);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(fullSocketName + <span class="string">" unset or invalid"</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileDescriptor fd = <span class="keyword">new</span> FileDescriptor();</span><br><span class="line">            fd.setInt$(fileDesc);</span><br><span class="line">            sServerSocket = <span class="keyword">new</span> LocalServerSocket(fd);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">"Error binding to local socket '"</span> + fileDesc + <span class="string">"'"</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>â‘¡é¢„åŠ è½½ç±»çš„preload()æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">preload</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Log.d(TAG, <span class="string">"begin preload"</span>);</span><br><span class="line">    preloadClasses();</span><br><span class="line">    preloadResources();</span><br><span class="line">    preloadOpenGL();</span><br><span class="line">    preloadSharedLibraries();</span><br><span class="line">    preloadTextResources();</span><br><span class="line">    <span class="comment">// Ask the WebViewFactory to do any initialization that must run in the zygote process,</span></span><br><span class="line">    <span class="comment">// for memory sharing purposes.</span></span><br><span class="line">    WebViewFactory.prepareWebViewInZygote();</span><br><span class="line">    Log.d(TAG, <span class="string">"end preload"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæ–¹æ³•çš„å·¥ä½œä¸å°‘ï¼ŒåŒ…æ‹¬é¢„åŠ è½½ç±»ã€èµ„æºã€OpenGLã€å…±äº«åº“ã€æ–‡æœ¬èµ„æºã€WebViewç­‰ã€‚<br>å…¶ä¸­ï¼Œé¢„åŠ è½½ç±»è¿™ä¸€æ­¥ä¼šå»åŠ è½½<code>/system/etc/preloaded-classes</code>æ–‡ä»¶ä¸­çš„ç±»ï¼Œè¯¥æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>â€¦<br>android.graphics.Bitmap<br>android.graphics.Bitmap$1<br>android.graphics.Bitmap$BitmapFinalizer<br>android.graphics.Bitmap$Config<br>android.graphics.BitmapFactory<br>android.graphics.BitmapFactory$Options<br>android.graphics.BitmapRegionDecoder<br>android.graphics.BitmapShader<br>android.graphics.BlurMaskFilter<br>android.graphics.Camera<br>android.graphics.Canvas<br>android.graphics.Canvas$CanvasFinalizer<br>android.graphics.Canvas$EdgeType<br>android.graphics.CanvasProperty<br>android.graphics.Color<br>android.graphics.ColorFilter<br>android.graphics.ColorMatrixColorFilter<br>android.graphics.ComposePathEffect<br>android.graphics.ComposeShader<br>android.graphics.CornerPathEffect<br>android.graphics.DashPathEffect<br>â€¦</p>
</blockquote>
<p>è€Œè¿™ä¸ªpreloaded-classesæ–‡ä»¶æ€»å…±æœ‰3825è¡Œï¼Œå¯è§é¢„åŠ è½½è¿™ä¸€æ­¥ä¼šéå¸¸è€—æ—¶ã€‚</p>
<p>â‘¢è°ƒç”¨startSystemServer(abiList, socketName)æ–¹æ³•åˆ›å»ºsystem_serverè¿›ç¨‹ã€‚system_serveræ˜¯frameworkçš„æ ¸å¿ƒï¼Œå¦‚æœå®ƒæ­»äº†ï¼Œå°±ä¼šå¯¼è‡´zygoteè‡ªæ€ã€‚ä¸‹é¢æ˜¯startSystemServer()æ–¹æ³•çš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">startSystemServer</span><span class="params">(String abiList, String socketName)</span></span><br><span class="line">        <span class="keyword">throws</span> MethodAndArgsCaller, RuntimeException </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> capabilities = posixCapabilitiesAsBits(</span><br><span class="line">        OsConstants.CAP_BLOCK_SUSPEND,</span><br><span class="line">        OsConstants.CAP_KILL,</span><br><span class="line">        OsConstants.CAP_NET_ADMIN,</span><br><span class="line">        OsConstants.CAP_NET_BIND_SERVICE,</span><br><span class="line">        OsConstants.CAP_NET_BROADCAST,</span><br><span class="line">        OsConstants.CAP_NET_RAW,</span><br><span class="line">        OsConstants.CAP_SYS_MODULE,</span><br><span class="line">        OsConstants.CAP_SYS_NICE,</span><br><span class="line">        OsConstants.CAP_SYS_RESOURCE,</span><br><span class="line">        OsConstants.CAP_SYS_TIME,</span><br><span class="line">        OsConstants.CAP_SYS_TTY_CONFIG</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">/* ç¡¬ç¼–ç ç›¸å…³å¯åŠ¨å‚æ•° */</span></span><br><span class="line">    String args[] = &#123;</span><br><span class="line">        <span class="string">"--setuid=1000"</span>,</span><br><span class="line">        <span class="string">"--setgid=1000"</span>,</span><br><span class="line">        <span class="string">"--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1032,3001,3002,3003,3006,3007"</span>,</span><br><span class="line">        <span class="string">"--capabilities="</span> + capabilities + <span class="string">","</span> + capabilities,</span><br><span class="line">        <span class="string">"--nice-name=system_server"</span>,<span class="comment">//è®¾ç½®è¿›ç¨‹åä¸ºsystem_server</span></span><br><span class="line">        <span class="string">"--runtime-args"</span>,</span><br><span class="line">        <span class="string">"com.android.server.SystemServer"</span>,<span class="comment">//å®é™…å¯åŠ¨çš„ç±»</span></span><br><span class="line">    &#125;;</span><br><span class="line">    ZygoteConnection.Arguments parsedArgs = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> pid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        parsedArgs = <span class="keyword">new</span> ZygoteConnection.Arguments(args);</span><br><span class="line">        ZygoteConnection.applyDebuggerSystemProperty(parsedArgs);</span><br><span class="line">        ZygoteConnection.applyInvokeWithSystemProperty(parsedArgs);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* forkä¸€ä¸ªå­è¿›ç¨‹ï¼Œä¹Ÿå°±æ˜¯system_serverè¿›ç¨‹ */</span></span><br><span class="line">        pid = Zygote.forkSystemServer(</span><br><span class="line">                parsedArgs.uid, parsedArgs.gid,</span><br><span class="line">                parsedArgs.gids,</span><br><span class="line">                parsedArgs.debugFlags,</span><br><span class="line">                <span class="keyword">null</span>,</span><br><span class="line">                parsedArgs.permittedCapabilities,</span><br><span class="line">                parsedArgs.effectiveCapabilities);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å¯¹äºå­è¿›ç¨‹ï¼Œä¹Ÿå°±æ˜¯system_serverï¼Œè¿›å…¥ä¸‹é¢çš„ä»£ç  */</span></span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* å‚è€ƒæœ¬æ–‡æœ€å¼€å¤´çš„init.zygote32_64.rcæ–‡ä»¶ï¼Œä¼šå¯åŠ¨2ä¸ªzygoteï¼Œç¬¬äºŒä¸ªçš„åå­—æ˜¯"zygote_secondary" */</span></span><br><span class="line">        <span class="keyword">if</span> (hasSecondZygote(abiList)) &#123; </span><br><span class="line">            waitForSecondaryZygote(socketName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* æŠŠå‰©ä¸‹çš„å·¥ä½œäº¤ç»™system_serverè¿›ç¨‹å¤„ç† */</span></span><br><span class="line">        handleSystemServerProcess(parsedArgs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡è°ƒç”¨<code>Zygote.forkSystemServer()</code>æ–¹æ³•ï¼Œzygoteåˆ†è£‚å‡ºäº†ä¸€ä¸ªsystem_serverè¿›ç¨‹ã€‚</p>
<p>â‘£zygoteä»startSystemServer()æ–¹æ³•è¿”å›åï¼Œæ¥ç€ä¼šè°ƒç”¨runSelectLoop()æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runSelectLoop</span><span class="params">(String abiList)</span> <span class="keyword">throws</span> MethodAndArgsCaller </span>&#123;</span><br><span class="line">    ArrayList&lt;FileDescriptor&gt; fds = <span class="keyword">new</span> ArrayList&lt;FileDescriptor&gt;();</span><br><span class="line">    ArrayList&lt;ZygoteConnection&gt; peers = <span class="keyword">new</span> ArrayList&lt;ZygoteConnection&gt;();</span><br><span class="line"></span><br><span class="line">    fds.add(sServerSocket.getFileDescriptor());</span><br><span class="line">    peers.add(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        StructPollfd[] pollFds = <span class="keyword">new</span> StructPollfd[fds.size()];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pollFds.length; ++i) &#123;</span><br><span class="line">            pollFds[i] = <span class="keyword">new</span> StructPollfd();</span><br><span class="line">            pollFds[i].fd = fds.get(i);</span><br><span class="line">            pollFds[i].events = (<span class="keyword">short</span>) POLLIN;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Os.poll(pollFds, -<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ErrnoException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"poll failed"</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = pollFds.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((pollFds[i].revents &amp; POLLIN) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">/* ç­‰å¾…å¹¶æ¥å—å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ */</span></span><br><span class="line">                ZygoteConnection newPeer = acceptCommandPeer(abiList);</span><br><span class="line">                peers.add(newPeer);</span><br><span class="line">                fds.add(newPeer.getFileDesciptor());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/* å°†å®¢æˆ·ç«¯çš„åç»­è¯·æ±‚äº¤ç»™ZygoteConnectionçš„runOnce()æ–¹æ³•å¤„ç† */</span></span><br><span class="line">                <span class="keyword">boolean</span> done = peers.get(i).runOnce();</span><br><span class="line">                <span class="keyword">if</span> (done) &#123;</span><br><span class="line">                    peers.remove(i);</span><br><span class="line">                    fds.remove(i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>â‘¤åœ¨catchåˆ°MethodAndArgsCallerå¼‚å¸¸åï¼Œæ­¤æ—¶ä¼šå¤„äºsystem_sererè¿›ç¨‹ä¸­ï¼Œä»¥åå°„æ–¹å¼è°ƒç”¨SystemServerç±»çš„mainæ–¹æ³•ã€‚è¿™ä¸€æ­¥å¯¹äºsystem_serverçš„å¯åŠ¨æ˜¯è‡³å…³é‡è¦çš„ä¸€æ­¥ï¼Œä¼šåœ¨ä¸‹ä¸€ç¯‡ã€Šsystem_serverå¯åŠ¨è¿‡ç¨‹ã€‹ä¸­è¯¦ç»†åˆ†æã€‚</p>
<p>ã€Šæ·±å…¥ç†è§£Androidï¼šå·Iã€‹å¯¹zygoteçš„æ€»ç»“éå¸¸ç²¾è¾Ÿï¼š</p>
<blockquote>
<p>zygoteæ˜¯åœ¨Androidç³»ç»Ÿä¸­åˆ›å»ºjavaä¸–ç•Œçš„ç›˜å¤ï¼Œå®ƒåˆ›å»ºäº†ç¬¬ä¸€ä¸ªjavaè™šæ‹Ÿæœºï¼ŒåŒæ—¶å®ƒåˆæ˜¯å¥³å¨²ï¼Œå®ƒæˆåŠŸåœ°ç¹æ®–äº†frameworkçš„æ ¸å¿ƒsystem_serverè¿›ç¨‹ï¼Œä¸‹é¢æ˜¯zygoteåˆ›å»ºjavaä¸–ç•Œçš„æ­¥éª¤ï¼š<br>â—¼ï¸ç¬¬ä¸€å¤©ï¼šåˆ›å»ºAppRuntimeå¯¹è±¡ï¼Œå¹¶è°ƒç”¨å®ƒçš„startã€‚æ­¤åçš„æ´»åŠ¨åˆ™ç”±AppRuntimeæ¥æ§åˆ¶ã€‚<br>â—¼ï¸ç¬¬äºŒå¤©ï¼šè°ƒç”¨startVmåˆ›å»ºJavaè™šæ‹Ÿæœºï¼Œç„¶åè°ƒç”¨startRegæ¥æ³¨å†ŒJNIå‡½æ•°ã€‚<br>â—¼ï¸ç¬¬ä¸‰å¤©ï¼šé€šè¿‡JNIè°ƒç”¨com.android.internal.os.ZygoteInitç±»çš„mainå‡½æ•°ï¼Œä»æ­¤è¿›å…¥javaä¸–ç•Œã€‚ç„¶è€Œåœ¨è¿™ä¸ªä¸–ç•Œåˆšå¼€åˆ›çš„æ—¶å€™ï¼Œä»€ä¹ˆä¸œè¥¿éƒ½æ²¡æœ‰ã€‚<br>â—¼ï¸ç¬¬å››å¤©ï¼šè°ƒç”¨registerZygoteSocketã€‚é€šè¿‡è¿™ä¸ªå‡½æ•°ï¼Œå®ƒå¯ä»¥ç›¸åº”å­å­™åä»£çš„è¯·æ±‚ã€‚åŒæ—¶zygoteè°ƒç”¨prelaod()ä¸ºJavaä¸–ç•Œæ·»ç –åŠ ç“¦ã€‚<br>â—¼ï¸ç¬¬äº”å¤©ï¼šzygoteè§‰å¾—è‡ªå·±çš„å·¥ä½œå‹åŠ›å¤ªå¤§ï¼Œä¾¿é€šè¿‡è°ƒç”¨startSystemServeråˆ†è£‚ä¸€ä¸ªå­è¿›ç¨‹system_serveræ¥ä¸ºJavaä¸–ç•ŒæœåŠ¡ã€‚<br>â—¼ï¸ç¬¬å…­å¤©ï¼šzygoteå®Œæˆäº†Javaä¸–ç•Œçš„åˆåˆ›å·¥ä½œï¼Œå®ƒå·²ç»å¾ˆæ»¡è¶³äº†ã€‚ä¸‹ä¸€æ­¥è¯¥åšçš„å°±æ˜¯è°ƒç”¨runSelectLoopModeåï¼Œä¾¿æ²‰æ²‰ç¡å»äº†ã€‚<br>ä»¥åçš„æ—¥å­ï¼šzygoteéšæ—¶å®ˆæŠ¤åœ¨æˆ‘ä»¬çš„å‘¨å›´ï¼Œå½“æ¥æ”¶åˆ°å­å­™åä»£çš„è¯·æ±‚æ—¶ï¼Œå®ƒä¼šéšæ—¶é†’æ¥ï¼Œä¸ºå®ƒä»¬å·¥ä½œã€‚</p>
</blockquote>
]]></content>
    <summary type="html">
    <![CDATA[<p><code>Zygote</code>å’Œ<code>system_server</code>æ˜¯Androidç³»ç»Ÿä¸­æœ€é‡è¦çš„ä¸¤ä¸ªè¿›ç¨‹ï¼Œä»»ä½•ä¸€ä¸ªè¿›ç¨‹çš„æ­»äº¡éƒ½ä¼šå¯¼è‡´Javaä¸–ç•Œçš„å´©æºƒã€‚å…¶ä¸­ï¼Œzygoteç”±linuxç³»ç»Ÿçš„1å·è¿›ç¨‹initç›´æ¥forkè€Œæ¥ï¼Œè€Œsystem_serverè¿›ç¨‹ç”±zygoteè¿›ç¨‹forkè€Œæ¥ã€‚<br>é€šè¿‡adb shellè¿æ¥åˆ°è®¾å¤‡ï¼Œå¯ä»¥è¿›è¡ŒéªŒè¯ï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-5-25/77168217.jpg" alt=""></p>
<p>Zygoteæœ¬èº«æ˜¯ä¸€ä¸ªNativeåº”ç”¨ç¨‹åºï¼Œä¸é©±åŠ¨ã€å†…æ ¸ç­‰å‡æ— å…³ç³»ã€‚<br>]]>
    
    </summary>
    
      <category term="Android" scheme="http://www.carrotsight.com/tags/Android/"/>
    
      <category term="zygote" scheme="http://www.carrotsight.com/tags/zygote/"/>
    
      <category term="æºç åˆ†æ" scheme="http://www.carrotsight.com/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"/>
    
      <category term="Android" scheme="http://www.carrotsight.com/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[å­¦ä¹ ç¬”è®°ï¼šAndroidä¸­çš„View]]></title>
    <link href="http://www.carrotsight.com/2016/04/01/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%9AAndroid%E4%B8%AD%E7%9A%84View.html"/>
    <id>http://www.carrotsight.com/2016/04/01/å­¦ä¹ ç¬”è®°ï¼šAndroidä¸­çš„View.html</id>
    <published>2016-04-01T06:59:47.000Z</published>
    <updated>2016-04-12T12:49:55.000Z</updated>
    <content type="html"><![CDATA[<h1 align="center" class="root"><br><a name="3havsr3p3t101hrdlbi9m7usv6">å­¦ä¹ ç¬”è®°ï¼šAndroidä¸­çš„View</a><br></h1>

<p><a href="http://www.carrotsight.com">è¿”å›æœ¬ç«™é¦–é¡µ</a></p>
<p>â€œAndroidä¸­çš„Viewâ€ çŸ¥è¯†ç‚¹å­¦ä¹ æ¢³ç†ï¼ŒåŒ…æ‹¬äº†Viewäº‹ä»¶çš„å¤„ç†ã€Viewç»˜åˆ¶3å¤§æµç¨‹ç­‰å†…å®¹ã€‚</p>
<p>ç”¨XMindç”»çš„æ€ç»´å¯¼å›¾ï¼Œå¯¼å‡ºä¸ºHTMLæ ¼å¼äº†ï¼Œç‚¹å¼€é¡µé¢å¯ä»¥æŸ¥çœ‹æ¸…æ™°çš„å›¾ç‰‡ï¼Œä»¥åŠå„éƒ¨åˆ†çš„å¯¼å‡ºæ–‡å­—ã€‚  </p>
<p><a href="http://7xle8x.com1.z0.glb.clouddn.com/16-4-1/43527743-Androidä¸­çš„View.xmind" target="_blank" rel="external">ç‚¹å‡»è¿™é‡Œä¸‹è½½ ViewçŸ¥è¯†ç‚¹ XMindåŸå§‹æ–‡ä»¶</a></p>
<a id="more"></a>
<p>å› ä¸ºå›¾ç‰‡å¤ªå¤§ï¼Œå¦‚æœæ¸²æŸ“ä¸ºä¸æœ¬ç«™ä¸€è‡´çš„ä¸»é¢˜ä¼šå¯¼è‡´å›¾ç‰‡çœ‹ä¸æ¸…ï¼Œæ‰€ä»¥æœ¬é¡µé¢æœªè¿›è¡Œæ ·å¼æ¸²æŸ“ï¼Œæ¯”è¾ƒä¸‘ï¼Œå‡‘åˆç€çœ‹å§ã€‚ğŸ˜Š</p>
<p><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-4-1/742250.jpg" alt=""></p>
<html><br><head><br><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><br><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><br><meta content="text/css" http-equiv="Content-Style-Type"><br><title>Androidä¸­çš„View</title><br></head><br><body><br><h2 class="topic"><br><a name="1resht2taubqmns7669bqo6aa4">Viewç‚¹å‡»ã€æ»‘åŠ¨äº‹ä»¶ç›¸å…³</a><br></h2><br><h3 class="topic"><br><a name="5qk4p9ddfq64uovv6am7sl871h">&nbsp;åŸºç¡€çŸ¥è¯†</a><br></h3><br><h3 class="topic"><br><a name="782mmr5phdmtjhrs4o1mfcfgsk">&nbsp;&nbsp;viewåæ ‡</a><br></h3><br><h3 class="topic"><br><a name="19t9d50furj2p0icv9oha24f2k">&nbsp;&nbsp;&nbsp;topã€leftã€rightã€bottomï¼š<br>åˆ†åˆ«æ˜¯viewå·¦ä¸Šè§’çš„çºµåæ ‡ã€æ¨ªåæ ‡ï¼Œå³ä¸‹è§’çš„æ¨ªåæ ‡ã€çºµåæ ‡ã€‚å®ƒä»¬éƒ½æ˜¯ç›¸å¯¹äºçˆ¶å®¹å™¨çš„ï¼Œå¹¶ä¸”åœ¨viewå¹³ç§»è¿‡ç¨‹ä¸­ï¼Œè¿™4ä¸ªå€¼ä¸ä¼šæ”¹å˜ã€‚</a><br></h3><br><h3 class="topic"><br><a name="1jr1avvtivcqg4uqr3p28jd4kv">&nbsp;&nbsp;&nbsp;xã€yï¼š<br>viewçš„å·¦ä¸Šè§’åæ ‡ï¼Œå½“viewç§»åŠ¨æ—¶è¿™ä¸¤ä¸ªå€¼ä¼šæ”¹å˜ã€‚</a><br></h3><br><h3 class="topic"><br><a name="1kc34kaeeei4tnuusi6q6il62d">&nbsp;&nbsp;&nbsp;translationXã€translationY:<br>viewå·¦ä¸Šè§’ç›¸å¯¹äºçˆ¶å®¹å™¨çš„åç§»é‡ï¼Œä¼šéšç€viewçš„ç§»åŠ¨è¿‡è€Œæ”¹å˜ã€‚</a><br></h3><br><h3 class="topic"><br><a name="1f93vai0vme8hn81fuom4lj2rf">&nbsp;&nbsp;&nbsp;3è€…çš„è”ç³»ï¼š<br>x = left + translationX<br>y = top + translationY</a><br></h3><br><p class="summary">(<a href="#19t9d50furj2p0icv9oha24f2k">topã€leftã€rightã€bottomï¼š<br>åˆ†åˆ«æ˜¯viewå·¦ä¸Šè§’çš„çºµåæ ‡ã€æ¨ªåæ ‡ï¼Œå³ä¸‹è§’çš„æ¨ªåæ ‡ã€çºµåæ ‡ã€‚å®ƒä»¬éƒ½æ˜¯ç›¸å¯¹äºçˆ¶å®¹å™¨çš„ï¼Œå¹¶ä¸”åœ¨viewå¹³ç§»è¿‡ç¨‹ä¸­ï¼Œè¿™4ä¸ªå€¼ä¸ä¼šæ”¹å˜ã€‚</a>, <a href="#1jr1avvtivcqg4uqr3p28jd4kv">xã€yï¼š<br>viewçš„å·¦ä¸Šè§’åæ ‡ï¼Œå½“viewç§»åŠ¨æ—¶è¿™ä¸¤ä¸ªå€¼ä¼šæ”¹å˜ã€‚</a>, <a href="#1kc34kaeeei4tnuusi6q6il62d">translationXã€translationY:<br>viewå·¦ä¸Šè§’ç›¸å¯¹äºçˆ¶å®¹å™¨çš„åç§»é‡ï¼Œä¼šéšç€viewçš„ç§»åŠ¨è¿‡è€Œæ”¹å˜ã€‚</a>)</p><br><h3 class="topic"><br><a name="59ocgvb6tesnldosiv2e6udet3">&nbsp;&nbsp;è§¦æ‘¸äº‹ä»¶åæ ‡ï¼š<br>é€šè¿‡MotionEventå¯¹è±¡è·å–åæ ‡</a><br></h3><br><h3 class="topic"><br><a name="71h9kgnpjq26c6lea0ko327u2u">&nbsp;&nbsp;&nbsp;getX/getYè¿”å›çš„æ˜¯ç›¸å¯¹äºå½“å‰Viewå·¦ä¸Šè§’çš„xå’Œyåæ ‡</a><br></h3><br><h3 class="topic"><br><a name="7g0do8hg7jql1sbqnvl0rn0193">&nbsp;&nbsp;&nbsp;getRawX/getRawYè¿”å›çš„æ˜¯ç›¸å¯¹äºæ‰‹æœºå±å¹•å·¦ä¸Šè§’çš„xå’Œyåæ ‡</a><br></h3><br><h3 class="topic"><br><a name="4hlg21g8c0lgs286m5e8smuors">&nbsp;&nbsp;å·¥å…·ç±»</a><br></h3><br><h3 class="topic"><br><a name="3606ubdi6gnl8lpv6a7tgml5hd">&nbsp;&nbsp;&nbsp;VelocityTrackerï¼šé€Ÿåº¦è¿½è¸ª</a><br></h3><br><h3 class="topic"><br><a name="70auaotp1nojdl336u3rce8ggi">&nbsp;&nbsp;&nbsp;GestureDectectorï¼šæ‰‹åŠ¿æ£€æµ‹ï¼Œå¯ç”¨äºæ£€æµ‹å•å‡»ã€æ»‘åŠ¨ã€é•¿æŒ‰ã€åŒå‡»ç­‰</a><br></h3><br><h3 class="topic"><br><a name="5jloe2p330eood9njf5hfngtrc">&nbsp;&nbsp;&nbsp;Scrollerï¼šå¼¹æ€§æ»‘åŠ¨</a><br></h3><br><h3 class="topic"><br><a name="57fgc7uolode36ng81n7l2l69e">&nbsp;Viewçš„æ»‘åŠ¨</a><br></h3><br><h3 class="topic"><br><a name="3gnmo7ahstcuspe0p6kke33oj5">&nbsp;&nbsp;ä½¿ç”¨scrollTo/scrollBy</a><br></h3><br><h3 class="topic"><br><a name="5032dbp1kqt4hsl8jpvu9ge5hn">&nbsp;&nbsp;&nbsp;åœ¨æ»‘åŠ¨è¿‡ç¨‹ä¸­ï¼ŒmScrollXçš„å€¼æ€»æ˜¯ç­‰äºViewå·¦è¾¹ç¼˜å’ŒViewå†…å®¹å·¦è¾¹ç¼˜åœ¨æ°´å¹³æ–¹å‘çš„è·ç¦»ï¼ŒmScrollYäº¦ç„¶ã€‚<br>Viewè¾¹ç¼˜æ˜¯æŒ‡Viewçš„ä½ç½®ï¼Œç”±å››ä¸ªé¡¶ç‚¹ç»„æˆï¼Œè€ŒViewå†…å®¹è¾¹ç¼˜æ˜¯æŒ‡Viewä¸­çš„å†…å®¹çš„è¾¹ç¼˜ã€‚scrollToå’ŒscrollByåªèƒ½æ”¹å˜Viewå†…å®¹çš„ä½ç½®è€Œä¸èƒ½æ”¹å˜Viewåœ¨å¸ƒå±€ä¸­çš„ä½ç½®ã€‚å½“Viewå·¦è¾¹ç¼˜åœ¨Viewå†…å®¹å·¦è¾¹ç¼˜çš„å³è¾¹æ—¶ï¼ŒmScrollXä¸ºæ­£å€¼ï¼Œåä¹‹ä¸ºè´Ÿå€¼ã€‚æ¢å¥è¯è¯´ï¼Œå¦‚æœä»å·¦å‘å³æ»‘åŠ¨ï¼Œé‚£ä¹ˆmScrollXä¸ºè´Ÿå€¼ï¼Œåä¹‹ä¸ºæ­£å€¼ã€‚mScrollYäº¦ç„¶ã€‚</a><br></h3><br><h3 class="topic"><br><a name="5ss75qr84lg9j0qd4are88qvr2">&nbsp;&nbsp;ä½¿ç”¨åŠ¨ç”»</a><br></h3><br><h3 class="topic"><br><a name="48ajgv6dinj1v90n4ipt5gqpju">&nbsp;&nbsp;&nbsp;ViewåŠ¨ç”»ï¼šåªèƒ½ç§»åŠ¨å½±åƒï¼Œå®é™…viewçš„ä½ç½®å¹¶æ²¡æœ‰å˜åŒ–ã€‚è¿™å°±å¯¼è‡´ï¼Œç”¨viewåŠ¨ç”»ä½¿ä¸€ä¸ªæŒ‰é’®å‘å³ç§»åŠ¨äº†100dpï¼Œä½†å®é™…å»ç‚¹å‡»æŒ‰é’®æ‰€åœ¨çš„æ–°ä½ç½®æ—¶å¹¶ä¸ä¼šæœ‰å“åº”ï¼Œè€Œç‚¹å‡»æŒ‰é’®åŸæ¥çš„ä½ç½®ï¼ˆç°åœ¨å·²è¿‘ä¸å†æ­¤ä½ç½®ï¼‰å´ä¼šæœ‰å“åº”ã€‚</a><br></h3><br><h3 class="topic"><br><a name="4uoffd75ed0uh0j1m4lq692ve3">&nbsp;&nbsp;&nbsp;å±æ€§åŠ¨ç”»ï¼šå¯ä»¥è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œä½†ä»Android3.0æ‰æ”¯æŒå±æ€§åŠ¨ç”»ã€‚</a><br></h3><br><h3 class="topic"><br><a name="4u34hum0ornlb9400noatq3sa0">&nbsp;&nbsp;æ”¹å˜å¸ƒå±€å‚æ•°ã€‚å³ä¿®æ”¹LayoutParamsã€‚</a><br></h3><br><h3 class="topic"><br><a name="36idpon9s8lt7tn4kgqbobe9a3">&nbsp;Viewçš„äº‹ä»¶åˆ†å‘æœºåˆ¶</a><br></h3><br><h3 class="topic"><br><a name="09tpevpdagubhjr5hirfai33vn">&nbsp;&nbsp;ç‚¹å‡»äº‹ä»¶äº§ç”ŸåæŒ‰ç…§å¦‚ä¸‹é¡ºåºä¼ é€’ï¼š<br>Activity -&gt; Window -&gt; View</a><br></h3><br><h3 class="topic"><br><a name="08lj9ve89onakmjil2sav9k4dr">&nbsp;&nbsp;Viewç‚¹å‡»äº‹ä»¶ä¼ é€’é¡ºåºï¼š<br>dispatchTouchEvent -&gt; onInterceptTouchEvent -&gt; onTouchEvent</a><br></h3><br><h3 class="topic"><br><a name="5eufps6ujaitmv6mnsgdv23tpc">&nbsp;&nbsp;é¡¶çº§Viewå¯¹ç‚¹å‡»äº‹ä»¶çš„è¯¦ç»†åˆ†å‘è¿‡ç¨‹å¦‚å›¾æ‰€ç¤º</a><br></h3><br><p class="relationships">å‚è§: <a href="#79356njloh9d8scukv9qe3cdbp">ä»é¡¶çº§Viewå¼€å§‹çš„åˆ†å‘è¿‡ç¨‹</a><br></p><br><h3 class="topic"><br><a name="590khfsjck8jvjt2626g8q3eo2">&nbsp;&nbsp;Viewæ²¡æœ‰onInterceptTouchEventæ–¹æ³•ï¼ŒViewGroupæ‰æœ‰æ­¤æ–¹æ³•ã€‚<br>ä¸€æ—¦æœ‰ç‚¹å‡»äº‹ä»¶ä¼ é€’ç»™Viewï¼Œå®ƒçš„onTouchEventæ–¹æ³•å°±ä¼šè¢«è°ƒç”¨ã€‚</a><br></h3><br><h3 class="topic"><br><a name="2a091g4hr1t759audi67l87937">&nbsp;&nbsp;å½“å‰ç•Œé¢çš„åº•å±‚å®¹å™¨æ˜¯decor viewï¼Œå³setContentViewæ‰€è®¾ç½®çš„Viewçš„çˆ¶å®¹å™¨ï¼Œé€šè¿‡Activity.getWindow.getDecorViewï¼ˆï¼‰å¯ä»¥è·å¾—ã€‚</a><br></h3><br><h3 class="topic"><br><a name="6cjp4vqge3rct2cb8bb02jj4ub">&nbsp;&nbsp;å½“ViewGroupå†³å®šæ‹¦æˆªäº‹ä»¶åï¼Œåç»­çš„ç‚¹å‡»äº‹ä»¶å°†ä¼šé»˜è®¤äº¤ç»™å®ƒå¤„ç†å¹¶ä¸”ä¸å†è°ƒç”¨å®ƒçš„onInterceptTouchEventæ–¹æ³•ã€‚</a><br></h3><br><h2 class="topic"><br><a name="340ou1tk43ip16lljimds5gaf1">Viewå·¥ä½œåŸç†</a><br></h2><br><h3 class="topic"><br><a name="4ug6t9krtqj98c1m4reb0klb63">&nbsp;Viewç»˜åˆ¶ç›¸å…³</a><br></h3><br><h3 class="topic"><br><a name="687jro87pe54m0j9fbov1sf1ap">&nbsp;&nbsp;Viewçš„å·¥ä½œæµç¨‹ï¼š<br>measure â€“&gt; layout â€“&gt; draw<br>å…¶ä¸­measureç¡®å®šViewçš„æµ‹é‡å®½/é«˜ï¼Œlayoutç¡®å®šViewçš„æœ€ç»ˆå®½/é«˜å’Œå››ä¸ªé¡¶ç‚¹çš„ä½ç½®ï¼Œè€Œdrawå°†Viewç»˜åˆ¶åˆ°å±å¹•ä¸Šã€‚</a><br></h3><br><h3 class="topic"><br><a name="0genorlinv84o48hrhbv112hkc">&nbsp;&nbsp;DecorViewæ˜¯é¡¶çº§Viewï¼Œæœ¬è´¨æ˜¯ä¸€ä¸ªFrameLayoutï¼Œä¸€èˆ¬åŒ…å«ä¸€ä¸ªç«–ç›´æ–¹å‘çš„LinearLayoutï¼Œè¿™ä¸ªLinearLayoutæœ‰ä¸Šä¸‹ä¸¤éƒ¨åˆ†ï¼ˆä¸Androidç‰ˆæœ¬å’Œä¸»é¢˜æœ‰å…³ï¼‰ï¼Œä¸Šé¢æ˜¯æ ‡é¢˜æ ï¼Œä¸‹é¢æ˜¯å†…å®¹æ ã€‚åœ¨Activityä¸­æˆ‘ä»¬é€šè¿‡setContentViewæ‰€è®¾ç½®çš„å¸ƒå±€æ–‡ä»¶å°±æ˜¯è¢«åŠ å…¥åˆ°å†…å®¹æ ä¸­ï¼Œå†…å®¹æ å¯ä»¥é€šè¿‡findViewById(android.R.id.content)æ¥è·å¾—ã€‚</a><br></h3><br><h3 class="topic"><br><a name="2j4e1hadvgv1hm8e9bqj7sqmk2">&nbsp;&nbsp;MeasureSpec</a><br></h3><br><h3 class="topic"><br><a name="6kvqr1adbbacnnnrq8um8657cl">&nbsp;&nbsp;&nbsp;MeasureSpecæ˜¯ä¸€ä¸ª32ä½å€¼ï¼Œé«˜2ä½ä»£è¡¨SpecModeï¼Œä½30ä½ä»£è¡¨SpecSizeã€‚</a><br></h3><br><h3 class="topic"><br><a name="4qbihga477mp3hdr9o05pcjtpe">&nbsp;&nbsp;&nbsp;SpecModeæœ‰3ç±»</a><br></h3><br><h3 class="topic"><br><a name="5d66fqnac009l3p8f3po32s4t6">&nbsp;&nbsp;&nbsp;&nbsp;UNSPECIFIEDï¼šçˆ¶å®¹å™¨ä¸å¯¹Viewæœ‰ä»»ä½•é™åˆ¶ï¼Œè¦å¤šå¤§ç»™å¤šå¤§ï¼Œè¿™ç§æƒ…å†µä¸€èˆ¬ç”¨äºç³»ç»Ÿå†…éƒ¨ï¼Œè¡¨ç¤ºä¸€ç§æµ‹é‡çŠ¶æ€ã€‚</a><br></h3><br><h3 class="topic"><br><a name="2loimqj796hoobu72356ugec3s">&nbsp;&nbsp;&nbsp;&nbsp;EXACTLYï¼šçˆ¶å®¹å™¨å·²ç»æ£€æµ‹å‡ºViewæ‰€éœ€çš„ç²¾ç¡®å¤§å°ï¼Œè¿™ä¸ªæ—¶å€™Viewçš„æœ€ç»ˆå¤§å°å°±æ˜¯SpecSizeæ‰€æŒ‡å®šçš„å€¼ã€‚å®ƒå¯¹åº”äºLayoutParamsä¸­çš„match_parentå’Œå…·ä½“çš„æ•°å€¼è¿™ä¸¤ç§æ¨¡å¼ã€‚</a><br></h3><br><h3 class="topic"><br><a name="4s8sg3sgjln99edq1er0nbp4sf">&nbsp;&nbsp;&nbsp;&nbsp;AT_MOSTï¼šçˆ¶å®¹å™¨åˆ¶å®šäº†ä¸€ä¸ªå¯ç”¨å¤§å°å³SpecSizeï¼ŒViewçš„å¤§å°ä¸èƒ½å¤§äºè¿™ä¸ªå€¼ï¼Œå…·ä½“æ˜¯ä»€ä¹ˆå€¼è¦çœ‹ä¸åŒViewçš„å…·ä½“å®ç°ã€‚å®ƒå¯¹åº”äºLayoutParamsä¸­çš„wrap_contentã€‚</a><br></h3><br><h3 class="topic"><br><a name="5pkce1f17n6kk6dntjak41vt9m">&nbsp;&nbsp;&nbsp;MeasureSpecè½¬æ¢è¿‡ç¨‹</a><br></h3><br><h3 class="topic"><br><a name="1nh6u4ecp2qcgqegvpidr6qdrm">&nbsp;&nbsp;&nbsp;&nbsp;é¡¶çº§Viewï¼ˆDecorViewï¼‰ï¼šMeasureSpecç”±çª—å£çš„å°ºå¯¸å’Œå…¶è‡ªèº«çš„LayoutParamsæ¥å…±åŒç¡®å®šã€‚</a><br></h3><br><h3 class="topic"><br><a name="5an2rbd3ag65ef1kdkpb9c3sit">&nbsp;&nbsp;&nbsp;&nbsp;æ™®é€šViewï¼šMeasureSpecç”±çˆ¶å®¹å™¨çš„MeasureSpecå’Œè‡ªèº«çš„LayoutParamsæ¥å…±åŒå†³å®š</a><br></h3><br><p class="relationships">å‚è§: <a href="#7cnj3boadme47rhlfsb6sl5mre">æ™®é€šViewçš„MeasureSpecåˆ›å»ºè§„åˆ™</a><br></p><br><h3 class="topic"><br><a name="2nlj7ajav48akv13evm3a20f7q">&nbsp;&nbsp;&nbsp;&nbsp;MeasureSpecä¸€æ—¦ç¡®å®šï¼ŒonMeasureä¸­å°±å¯ä»¥ç¡®å®šViewçš„æµ‹é‡å®½/é«˜ã€‚</a><br></h3><br><p class="summary">(<a href="#1nh6u4ecp2qcgqegvpidr6qdrm">é¡¶çº§Viewï¼ˆDecorViewï¼‰ï¼šMeasureSpecç”±çª—å£çš„å°ºå¯¸å’Œå…¶è‡ªèº«çš„LayoutParamsæ¥å…±åŒç¡®å®šã€‚</a>, <a href="#5an2rbd3ag65ef1kdkpb9c3sit">æ™®é€šViewï¼šMeasureSpecç”±çˆ¶å®¹å™¨çš„MeasureSpecå’Œè‡ªèº«çš„LayoutParamsæ¥å…±åŒå†³å®š</a>)</p><br><h3 class="topic"><br><a name="6inc3gjf956208hrrj0vene214">&nbsp;&nbsp;&nbsp;ç›´æ¥ç»§æ‰¿Viewçš„è‡ªå®šä¹‰æ§ä»¶éœ€è¦é‡å†™onMeasureæ–¹æ³•å¹¶è®¾ç½®wrap_contentæ—¶è‡ªèº«å¤§å°ï¼Œå¦åˆ™åœ¨å¸ƒå±€ä¸­ä½¿ç”¨wrap_contentå°±ç›¸å½“äºä½¿ç”¨match_parentã€‚</a><br></h3><br><h3 class="topic"><br><a name="5knaeh275099jjepfg685kcbf4">&nbsp;&nbsp;å¦‚æœæƒ³åœ¨Activityä¸€å¯åŠ¨çš„æ—¶å€™å°±åšä¸€ä»¶ä»»åŠ¡ï¼Œä½†è¿™ä¸€ä»»åŠ¡éœ€è¦è·å–æŸä¸ªViewçš„å®½/é«˜ï¼Œç”±äºViewçš„measureè¿‡ç¨‹å’ŒActivityçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸æ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼Œå› æ­¤æ— æ³•ä¿è¯Activityæ‰§è¡Œäº†onCreateã€onStartã€onResumeæ—¶æŸä¸ªViewå·²ç»æµ‹é‡å®Œæ¯•äº†ï¼Œé‚£ä¹ˆè·å¾—çš„å®½/é«˜å°±æ˜¯0ã€‚æœ‰ä»¥ä¸‹4ç§æ–¹æ³•å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</a><br></h3><br><h3 class="topic"><br><a name="4igis2jrnumpkp3rrd65v5lgbn">&nbsp;&nbsp;&nbsp;Activity/View#onWindowFocusChangedï¼šæ­¤æ–¹æ³•ä¼šè¢«è°ƒç”¨å¤šæ¬¡ï¼Œå½“Activityçš„windowå¾—åˆ°æˆ–å¤±å»ç„¦ç‚¹æ—¶å‡ä¼šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚</a><br></h3><br><h3 class="topic"><br><a name="7i8je36tdkbc1c73sie1b56qq7">&nbsp;&nbsp;&nbsp;view.post(runnable)ï¼šé€šè¿‡postå¯ä»¥å°†ä¸€ä¸ªrunnableæŠ•é€’åˆ°æ¶ˆæ¯é˜Ÿåˆ—å°¾éƒ¨ï¼Œç­‰å¾…Looperè°ƒç”¨æ­¤runnableçš„æ—¶å€™ï¼ŒViewå·²ç»åˆå§‹åŒ–å¥½äº†ï¼Œåœ¨runæ–¹æ³•ä½“ä¸­è·å–å®½/é«˜ã€‚</a><br></h3><br><h3 class="topic"><br><a name="10gpl5cfjkmspt1j0r9fjvv2dr">&nbsp;&nbsp;&nbsp;ViewTreeObserverï¼šä½¿ç”¨ViewTreeObserverçš„ä¼—å¤šå›è°ƒéƒ½å¯ä»¥å®ç°ã€‚æ¯”å¦‚ä½¿ç”¨OnGlobalLayoutListeneræ¥å£ï¼Œå½“Viewæ ‘çŠ¶æ€å‘ç”Ÿæ”¹å˜æˆ–è€…Viewæ ‘å†…éƒ¨çš„Viewçš„å¯è§æ€§å‘ç”Ÿæ”¹å˜æ—¶ï¼ŒonGlobalLayoutä¼šè¢«å›è°ƒï¼Œå¯åœ¨è¿™é‡Œè·å–Viewçš„å®½/é«˜ï¼Œä¼šè¢«å›è°ƒå¤šæ¬¡ã€‚</a><br></h3><br><h3 class="topic"><br><a name="7bc635itlulqdjjderaehiero5">&nbsp;&nbsp;&nbsp;view.measureï¼šæ ¹æ®Viewçš„LayoutParamsçš„ç±»å‹æ¥åˆ†åˆ«å¤„ç†ï¼Œè¾ƒå¤æ‚ã€‚</a><br></h3><br><h3 class="topic"><br><a name="4p6ua1ldf4m7huos08g484j5f4">&nbsp;&nbsp;Viewé»˜è®¤æ²¡æœ‰å¯ç”¨setWillNotDrawï¼Œè€ŒViewGroupé»˜è®¤å¯ç”¨äº†ã€‚</a><br></h3><br><h3 class="topic"><br><a name="1hfh724fgv1qbu4m77vbap14vk">&nbsp;è‡ªå®šä¹‰View</a><br></h3><br><h3 class="topic"><br><a name="0v4s3djs9ba5ogl68eh3ef64km">&nbsp;&nbsp;å°½é‡ä¸è¦åœ¨Viewä¸­ä½¿ç”¨Handlerï¼Œå› ä¸ºViewå†…éƒ¨æœ¬èº«æä¾›äº†postç³»åˆ—çš„æ–¹æ³•ï¼Œå®Œå…¨å¯ä»¥æ›¿ä»£Handlerçš„ä½œç”¨ï¼Œé™¤éä½ å¾ˆæ˜ç¡®åœ°è¦ä½¿ç”¨Handleræ¥å‘é€æ¶ˆæ¯ã€‚</a><br></h3><br><h3 class="topic"><br><a name="6cmdthqk8ojupqmq175rqekbaq">&nbsp;&nbsp;Viewå¦‚æœæœ‰ç°æˆæˆ–è€…åŠ¨ç”»éœ€è¦åœæ­¢æ—¶ï¼Œé‚£ä¹ˆonDetachedFromWindowæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ—¶æœºã€‚</a><br></h3><br><p class="relationships">å‚è§: <a href="#5i2nm3uv9432n5utarufuk55em">å½“åŒ…å«æ­¤Viewçš„Activityé€€å‡ºæˆ–è€…å½“å‰Viewè¢«removeæ—¶ï¼ŒViewçš„onDetachedFromWindowæ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œå’Œæ­¤æ–¹æ³•å¯¹åº”çš„æ˜¯onAttachedToWindowæ–¹æ³•ä¼šè¢«è°ƒç”¨ã€‚åŒæ—¶ï¼Œå½“Viewå˜å¾—ä¸å¯è§æ—¶æˆ‘ä»¬ä¹Ÿéœ€è¦åœæ­¢çº¿ç¨‹å’ŒåŠ¨ç”»ï¼Œå¦‚æœä¸åŠæ—¶å¤„ç†è¿™ç§é—®é¢˜ï¼Œæœ‰å¯èƒ½ä¼šé€ æˆå†…å­˜æ³„éœ²ã€‚<br></a><br></p><br><h2 class="topic"><br><a name="79356njloh9d8scukv9qe3cdbp">ä»é¡¶çº§Viewå¼€å§‹çš„åˆ†å‘è¿‡ç¨‹</a><br></h2><br><p class="topicImage"><br><img height="616" src="http://7xle8x.com1.z0.glb.clouddn.com/16-4-1/77356076.jpg" width="620"></p><br><p class="relationships">å‚è§: <a href="#5eufps6ujaitmv6mnsgdv23tpc">é¡¶çº§Viewå¯¹ç‚¹å‡»äº‹ä»¶çš„è¯¦ç»†åˆ†å‘è¿‡ç¨‹å¦‚å›¾æ‰€ç¤º</a><br></p><br><h2 class="topic"><br><a name="7cnj3boadme47rhlfsb6sl5mre">æ™®é€šViewçš„MeasureSpecåˆ›å»ºè§„åˆ™</a><br></h2><br><p class="topicImage"><br><img height="155" src="http://7xle8x.com1.z0.glb.clouddn.com/16-4-1/62979652.jpg" width="568"></p><br><p class="relationships">å‚è§: <a href="#5an2rbd3ag65ef1kdkpb9c3sit">æ™®é€šViewï¼šMeasureSpecç”±çˆ¶å®¹å™¨çš„MeasureSpecå’Œè‡ªèº«çš„LayoutParamsæ¥å…±åŒå†³å®š</a><br></p><br><h2 class="topic"><br><a name="5i2nm3uv9432n5utarufuk55em">å½“åŒ…å«æ­¤Viewçš„Activityé€€å‡ºæˆ–è€…å½“å‰Viewè¢«removeæ—¶ï¼ŒViewçš„onDetachedFromWindowæ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œå’Œæ­¤æ–¹æ³•å¯¹åº”çš„æ˜¯onAttachedToWindowæ–¹æ³•ä¼šè¢«è°ƒç”¨ã€‚åŒæ—¶ï¼Œå½“Viewå˜å¾—ä¸å¯è§æ—¶æˆ‘ä»¬ä¹Ÿéœ€è¦åœæ­¢çº¿ç¨‹å’ŒåŠ¨ç”»ï¼Œå¦‚æœä¸åŠæ—¶å¤„ç†è¿™ç§é—®é¢˜ï¼Œæœ‰å¯èƒ½ä¼šé€ æˆå†…å­˜æ³„éœ²ã€‚<br></a><br></h2><br><p class="relationships">å‚è§: <a href="#6cmdthqk8ojupqmq175rqekbaq">Viewå¦‚æœæœ‰ç°æˆæˆ–è€…åŠ¨ç”»éœ€è¦åœæ­¢æ—¶ï¼Œé‚£ä¹ˆonDetachedFromWindowæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ—¶æœºã€‚</a><br></p><br></body><br></html>
]]></content>
    <summary type="html">
    <![CDATA[<h1 align="center" class="root"><br><a name="3havsr3p3t101hrdlbi9m7usv6">å­¦ä¹ ç¬”è®°ï¼šAndroidä¸­çš„View</a><br></h1>

<p><a href="http://www.carrotsight.com">è¿”å›æœ¬ç«™é¦–é¡µ</a></p>
<p>â€œAndroidä¸­çš„Viewâ€ çŸ¥è¯†ç‚¹å­¦ä¹ æ¢³ç†ï¼ŒåŒ…æ‹¬äº†Viewäº‹ä»¶çš„å¤„ç†ã€Viewç»˜åˆ¶3å¤§æµç¨‹ç­‰å†…å®¹ã€‚</p>
<p>ç”¨XMindç”»çš„æ€ç»´å¯¼å›¾ï¼Œå¯¼å‡ºä¸ºHTMLæ ¼å¼äº†ï¼Œç‚¹å¼€é¡µé¢å¯ä»¥æŸ¥çœ‹æ¸…æ™°çš„å›¾ç‰‡ï¼Œä»¥åŠå„éƒ¨åˆ†çš„å¯¼å‡ºæ–‡å­—ã€‚  </p>
<p><a href="http://7xle8x.com1.z0.glb.clouddn.com/16-4-1/43527743-Androidä¸­çš„View.xmind">ç‚¹å‡»è¿™é‡Œä¸‹è½½ ViewçŸ¥è¯†ç‚¹ XMindåŸå§‹æ–‡ä»¶</a></p>]]>
    
    </summary>
    
      <category term="Android" scheme="http://www.carrotsight.com/tags/Android/"/>
    
      <category term="View" scheme="http://www.carrotsight.com/tags/View/"/>
    
      <category term="Android" scheme="http://www.carrotsight.com/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[å­¦ä¹ ç¬”è®°ï¼šAndroidä¸­çš„IPCæœºåˆ¶]]></title>
    <link href="http://www.carrotsight.com/2016/03/29/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%9AAndroid%E7%9A%84IPC%E6%9C%BA%E5%88%B6.html"/>
    <id>http://www.carrotsight.com/2016/03/29/å­¦ä¹ ç¬”è®°ï¼šAndroidçš„IPCæœºåˆ¶.html</id>
    <published>2016-03-29T09:57:02.000Z</published>
    <updated>2016-04-12T12:49:55.000Z</updated>
    <content type="html"><![CDATA[<h1 align="center" class="root"><br><a name="3havsr3p3t101hrdlbi9m7usv6">å­¦ä¹ ç¬”è®°ï¼šAndroidä¸­çš„IPCæœºåˆ¶</a><br></h1>

<p><a href="http://www.carrotsight.com">è¿”å›æœ¬ç«™é¦–é¡µ</a></p>
<p>â€œAndroidä¸­çš„IPCæœºåˆ¶â€ çŸ¥è¯†ç‚¹å­¦ä¹ æ¢³ç†ï¼ŒåŒ…æ‹¬äº†Androidä¸­å¸¸è§çš„å‡ ç§IPCçš„æ€»ç»“å’Œå¯¹æ¯”ã€‚</p>
<p>ç”¨XMindç”»çš„æ€ç»´å¯¼å›¾ï¼Œå¯¼å‡ºä¸ºHTMLæ ¼å¼äº†ï¼Œç‚¹å¼€é¡µé¢å¯ä»¥æŸ¥çœ‹æ¸…æ™°çš„å›¾ç‰‡ï¼Œä»¥åŠå„éƒ¨åˆ†çš„å¯¼å‡ºæ–‡å­—ã€‚<br>å› ä¸ºå›¾ç‰‡å¤ªå¤§ï¼Œå¦‚æœæ¸²æŸ“ä¸ºä¸æœ¬ç«™ä¸€è‡´çš„ä¸»é¢˜ä¼šå¯¼è‡´å›¾ç‰‡çœ‹ä¸æ¸…ï¼Œæ‰€ä»¥æœ¬é¡µé¢æœªè¿›è¡Œæ ·å¼æ¸²æŸ“ï¼Œæ¯”è¾ƒä¸‘ï¼Œå‡‘åˆç€çœ‹å§ã€‚ğŸ˜Š</p>
<p><a href="http://7xle8x.com1.z0.glb.clouddn.com/16-4-1/99061779-Android IPCæœºåˆ¶.xmind" target="_blank" rel="external">ç‚¹å‡»è¿™é‡Œä¸‹è½½ Androidä¸­çš„IPCæœºåˆ¶ XMindåŸå§‹æ–‡ä»¶</a></p>
<a id="more"></a>
<p><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-4-1/91760175.jpg" alt=""></p>
<html><br><head><br><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><br><meta content="text/html; charset=utf-8" http-equiv="Content-Type"><br><meta content="text/css" http-equiv="Content-Style-Type"><br><title>Android IPCæœºåˆ¶</title><br></head><br><body><br><h2 class="topic"><br><a name="0mb3b2g8hcajd4rto2fvk8o632">å¤šè¿›ç¨‹æœºåˆ¶</a><br></h2><br><h3 class="topic"><br><a name="3ci0d2dg7v55clq5vggf3f9rbi">&nbsp;å¼€å¯å¤šè¿›ç¨‹æ–¹æ³•ï¼šä¸ºå››å¤§ç»„ä»¶åœ¨AndroidManifestä¸­æŒ‡å®šandroid:processå±æ€§</a><br></h3><br><h3 class="topic"><br><a name="1i8m6oc30ir3nkfga3in2crr8j">&nbsp;&nbsp;æŒ‡å®šå®Œæ•´è¿›ç¨‹åï¼Œå¦‚com.google.zxing.myprocæˆ–com.google.zxing.remoteç­‰ã€‚</a><br></h3><br><h3 class="topic"><br><a name="768bo96b7njn23gn5uqitu4o4o">&nbsp;&nbsp;ä»¥&ldquo;:&rdquo;å¼€å¤´ï¼Œæ¯”å¦‚è®¾ç½®ä¸º&ldquo;:remote&rdquo;ã€‚<br>åˆ™ç³»ç»Ÿä¼šåœ¨å®é™…è¿è¡Œçš„è¿›ç¨‹åå‰åŠ ä¸Šåº”ç”¨ç¨‹åºçš„åŒ…åï¼Œå³å˜æˆ&ldquo;com.google.zxing:remote&rdquo;ã€‚</a><br></h3><br><h3 class="topic"><br><a name="0b7bhfoq90k3vhbivbt0pd7u0d">&nbsp;Androidä¸ºæ¯ä¸ªè¿›ç¨‹åˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„è™šæ‹Ÿæœºï¼Œä¸åŒçš„è™šæ‹Ÿæœºæœ‰ä¸åŒçš„å†…å­˜ç©ºé—´ã€‚<br>ä½¿ç”¨å¤šè¿›ç¨‹ä¸€èˆ¬ä¼šé€ æˆä»¥ä¸‹4ä¸ªé—®é¢˜</a><br></h3><br><h3 class="topic"><br><a name="32u55odoap188qhgkdcrnaddom">&nbsp;&nbsp;é™æ€æˆå‘˜å’Œå•ä¾‹æ¨¡å¼å®Œå…¨å¤±æ•ˆ</a><br></h3><br><h3 class="topic"><br><a name="3vikfej7r467kfa6u6k5f30rmn">&nbsp;&nbsp;çº¿ç¨‹åŒæ­¥æœºåˆ¶å®Œå…¨å¤±æ•ˆ</a><br></h3><br><h3 class="topic"><br><a name="06bcffr0je0f1f484o233srklp">&nbsp;&nbsp;SharedPreferencesçš„å¯é æ€§ä¸‹é™ï¼šæœ¬è´¨æ˜¯è¯»/å†™XMLæ–‡ä»¶</a><br></h3><br><h3 class="topic"><br><a name="6s0mlskuoeci80fat7qie4qqoq">&nbsp;&nbsp;Applicationä¼šå¤šæ¬¡åˆ›å»ºï¼šæ¯ä¸ªè¿›ç¨‹æ˜¯ä¸€ä¸ªæ–°çš„Application</a><br></h3><br><h2 class="topic"><br><a name="2588unjj883f4f39pi9th7gfag">IPCæ¦‚å¿µ</a><br></h2><br><h3 class="topic"><br><a name="266c8f5b2mug8gh2sba6505658">&nbsp;åºåˆ—åŒ–</a><br></h3><br><h3 class="topic"><br><a name="04lqcah899i2s6863pn2ol57tn">&nbsp;&nbsp;Serializableæ¥å£</a><br></h3><br><h3 class="topic"><br><a name="25h1fuid01qp984cahn4rtmfeg">&nbsp;&nbsp;&nbsp;æœ€å¥½æŒ‡å®šserialVersionUIDï¼Œä»¥é˜²æ­¢å¯èƒ½ç”±äºç±»å˜åŠ¨è€Œå¼•èµ·çš„ååºåˆ—åŒ–å¤±è´¥</a><br></h3><br><h3 class="topic"><br><a name="0a8b461v8simdrjrrjieeml4db">&nbsp;&nbsp;&nbsp;é™æ€æˆå‘˜å˜é‡å±äºç±»ä¸å±äºå¯¹è±¡ï¼Œæ‰€ä»¥ä¸å‚ä¸åºåˆ—åŒ–è¿‡ç¨‹</a><br></h3><br><h3 class="topic"><br><a name="13952etusegdid82s78e0ttoit">&nbsp;&nbsp;&nbsp;ç”¨transientå…³é”®å­—æ ‡è®°çš„æˆå‘˜å˜é‡ä¸å‚ä¸åºåˆ—åŒ–è¿‡ç¨‹</a><br></h3><br><h3 class="topic"><br><a name="3peno6e8imth4uq0map43gmn66">&nbsp;&nbsp;Parcelableæ¥å£</a><br></h3><br><h3 class="topic"><br><a name="139bp54lcolaalo7lofea5ki87">&nbsp;&nbsp;&nbsp;åºåˆ—åŒ–åŠŸèƒ½ç”±writeToParcelæ–¹æ³•æ¥å®Œæˆï¼›ååºåˆ—åŒ–åŠŸèƒ½ç”±CREATORæ¥å®Œæˆï¼›å†…å®¹æè¿°åŠŸèƒ½ç”±describeContentsæ–¹æ³•æ¥å®Œæˆï¼Œå‡ ä¹æ‰€æœ‰æ—¶å€™éƒ½è¿”å›0ï¼Œé™¤éå½“å‰å¯¹è±¡ä¸­å­˜åœ¨æ–‡ä»¶æè¿°ç¬¦æ—¶æ‰è¿”å›1</a><br></h3><br><h3 class="topic"><br><a name="3e2l071mvgh4j2odj3fh84fjri">&nbsp;&nbsp;Serializableæ˜¯Javaä¸­çš„åºåˆ—åŒ–æ¥å£ï¼Œä½¿ç”¨ç®€å•ä½†æ˜¯å¼€é”€å¾ˆå¤§ï¼Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–è¿‡ç¨‹éœ€è¦å¤§é‡I/Oæ“ä½œã€‚<br>Parcelableæ˜¯Androidä¸­çš„åºåˆ—åŒ–æ–¹å¼ï¼Œæ›´é€‚åˆç”¨Androidå¹³å°ä¸Šï¼Œä½¿ç”¨èµ·æ¥ç¨å¾®éº»çƒ¦ï¼Œä½†æ˜¯æ•ˆç‡é«˜ï¼Œæ˜¯Androidæ¨èçš„åºåˆ—åŒ–æ–¹å¼ï¼Œå› æ­¤é¦–é€‰Parcelableã€‚<br><br>Parcelableä¸»è¦ç”¨åœ¨å†…å­˜åºåˆ—åŒ–ä¸Šï¼Œä½†æ˜¯æŠŠå®ƒç”¨åœ¨ åºåˆ—åŒ–åˆ°è®¾å¤‡ æˆ– é€šè¿‡ç½‘ç»œä¼ è¾“ ä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œè¿™ä¸¤ç§åœºæ™¯ä¸‹å»ºè®®ä½¿ç”¨Serializableã€‚</a><br></h3><br><p class="summary">(<a href="#04lqcah899i2s6863pn2ol57tn">Serializableæ¥å£</a>, <a href="#3peno6e8imth4uq0map43gmn66">Parcelableæ¥å£</a>)</p><br><h3 class="topic"><br><a name="6ltefd9f79eeodhe571srj0gnv">&nbsp;Binder</a><br></h3><br><h3 class="topic"><br><a name="1th1qp17dlq5csjpkl12p8mjcu">&nbsp;&nbsp;ä»€ä¹ˆæ˜¯Binder</a><br></h3><br><h3 class="topic"><br><a name="18ctpi5vprerqii3q8nk04h7n9">&nbsp;&nbsp;&nbsp;Binderæ˜¯Androidä¸­çš„ä¸€ä¸ªç±»ï¼Œå®ƒå®ç°äº†IBinderæ¥å£</a><br></h3><br><h3 class="topic"><br><a name="50pasqgo9a18asm40dgggri2u6">&nbsp;&nbsp;&nbsp;ä»IPCè§’åº¦æ¥è¯´ï¼ŒBinderæ˜¯Androidä¸­çš„ä¸€ç§è·¨è¿›ç¨‹é€šä¿¡æ–¹å¼</a><br></h3><br><h3 class="topic"><br><a name="00hh02ka1v1iq2aud6rg2cub5l">&nbsp;&nbsp;&nbsp;Binderè¿˜å¯ä»¥ç†è§£ä¸ºä¸€ç§è™šæ‹Ÿçš„ç‰©ç†è®¾å¤‡ï¼Œå®ƒçš„è®¾å¤‡é©±åŠ¨æ˜¯/dev/binderï¼Œè¯¥é€šä¿¡æ–¹å¼åœ¨Linuxä¸­æ²¡æœ‰</a><br></h3><br><h3 class="topic"><br><a name="0s6d1r81po9sla9l1208ddogev">&nbsp;&nbsp;&nbsp;ä»Android Frameworkè§’åº¦æ¥è¯´ï¼ŒBinderæ˜¯ServiceManagerè¿æ¥å„ç§Managerï¼ˆActivityManagerã€WindowsManagerç­‰ç­‰ï¼‰å’Œç›¸åº”ManagerServiceçš„æ¡¥æ¢</a><br></h3><br><h3 class="topic"><br><a name="1t4l3pblm1s1oh7uiq76crq1h3">&nbsp;&nbsp;&nbsp;ä»Androidåº”ç”¨å±‚æ¥è¯´ï¼ŒBinderæ˜¯å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯è¿›è¡Œé€šä¿¡çš„åª’ä»‹ï¼Œå½“binderServiceçš„æ—¶å€™ï¼ŒæœåŠ¡ç«¯ä¼šè¿”å›ä¸€ä¸ªåŒ…å«äº†æœåŠ¡ç«¯ä¸šåŠ¡è°ƒç”¨çš„Binderå¯¹è±¡ï¼Œé€šè¿‡è¿™ä¸ªBinderå¯¹è±¡ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥è·å–æœåŠ¡ç«¯æä¾›çš„æœåŠ¡æˆ–è€…æ•°æ®ï¼Œè¿™é‡Œçš„æœåŠ¡åŒ…æ‹¬æ™®é€šæœåŠ¡å’ŒåŸºäºAIDLçš„æœåŠ¡ã€‚</a><br></h3><br><h3 class="topic"><br><a name="4ho21ld829blpuj81ss02s543b">&nbsp;&nbsp;å·¥ä½œæœºåˆ¶å¦‚å›¾<br>ç”¨AIDLåªæ˜¯ç®€åŒ–äº†Binderçš„å¼€å‘æµç¨‹ï¼Œè®©ç³»ç»Ÿå¸®æˆ‘ä»¬ç”Ÿæˆäº†å¾ˆå¤šä»£ç ã€‚å…¶å®æˆ‘ä»¬å®Œå…¨å¯ä»¥ä¸å†™AIDLï¼Œè€Œçº¯æ‰‹å†™Binderï¼Œå¹¶åœ¨æœåŠ¡ç«¯çš„Serviceçš„onBindeæ–¹æ³•ä¸­è¿”å›æ­£ç¡®çš„å¯¹è±¡ã€‚</a><br></h3><br><p class="topicImage"><br><img height="155" src="http://7xle8x.com1.z0.glb.clouddn.com/16-4-1/18612354.jpg" width="400"></p><br><h3 class="topic"><br><a name="1268nhvf96u3q6bv63er8g468t">&nbsp;&nbsp;&nbsp;å½“å®¢æˆ·ç«¯å‘èµ·è¿œç¨‹è¯·æ±‚æ—¶ï¼Œç”±äºå½“å‰çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ç›´åˆ°æœåŠ¡ç«¯è¿›ç¨‹è¿”å›æ•°æ®ï¼Œæ‰€ä»¥å¦‚æœä¸€ä¸ªè¿œç¨‹æ–¹æ³•å¾ˆè€—æ—¶ï¼Œé‚£ä¹ˆå°±ä¸èƒ½åœ¨UIçº¿ç¨‹ä¸­å‘èµ·æ­¤æ¬¡è¿œç¨‹è¯·æ±‚</a><br></h3><br><h3 class="topic"><br><a name="7f5fl08fujtj17j7ack50rilog">&nbsp;&nbsp;&nbsp;ç”±äºæœåŠ¡ç«¯Binderæ–¹æ³•è¿è¡Œåœ¨Binderçš„çº¿ç¨‹æ± ä¸­ï¼Œæ‰€ä»¥Binderæ–¹æ³•ä¸ç®¡æ˜¯å¦è€—æ—¶éƒ½åº”è¯¥é‡‡ç”¨åŒæ­¥çš„æ–¹å¼å»å®ç°ã€‚</a><br></h3><br><h3 class="topic"><br><a name="68sfdoug397g23f5i8c5p0cgc9">&nbsp;å„ç§IPCæ–¹å¼</a><br></h3><br><h3 class="topic"><br><a name="2co032sm0ra5paph2ms2h168qe">&nbsp;&nbsp;ä½¿ç”¨Bundleã€‚å››å¤§ç»„ä»¶ä¸­çš„ä¸‰å¤§ç»„ä»¶ï¼ˆActivityã€Serviceã€Receiverï¼‰éƒ½æ”¯æŒåœ¨Intentä¸­ä¼ é€’Bundleæ•°æ®ã€‚</a><br></h3><br><h3 class="topic"><br><a name="30ut5i6ddu3l6i27fqnqm0n84g">&nbsp;&nbsp;ä½¿ç”¨æ–‡ä»¶å…±äº«ã€‚</a><br></h3><br><h3 class="topic"><br><a name="1jhe9m57jglcurhj6u2pit4i6o">&nbsp;&nbsp;&nbsp;å­˜åœ¨å¹¶å‘è¯»å†™é—®é¢˜</a><br></h3><br><h3 class="topic"><br><a name="59o0k4isrmn4pd2uqqlpunujgc">&nbsp;&nbsp;&nbsp;SharedPreferencesæ˜¯ä¸ªç‰¹ä¾‹ï¼Œè™½ç„¶å®ƒåº•å±‚æ˜¯ä¸€ä¸ªXMLæ–‡ä»¶ï¼Œä½†æ˜¯ç³»ç»Ÿå¯¹å®ƒçš„è¯»/å†™æœ‰ä¸€å®šçš„ç¼“å­˜ç­–ç•¥ï¼Œå³åœ¨å†…å­˜ä¸­æœ‰ä¸€ä»½SharedPreferenceæ–‡ä»¶çš„ç¼“å­˜ï¼Œå› æ­¤åœ¨å¤šè¿›ç¨‹æ¨¡å¼ä¸‹ç³»ç»Ÿå¯¹å®ƒçš„è¯»/å†™å˜å¾—ä¸å¯é ï¼Œæœ‰å¾ˆå¤§çš„å‡ ç‡ä¼šä¸¢å¤±æ•°æ®ï¼Œæ‰€ä»¥ä¸å»ºè®®åœ¨è¿›ç¨‹é—´é€šä¿¡ä¸­ä½¿ç”¨SharedPreferencesã€‚</a><br></h3><br><h3 class="topic"><br><a name="15g0uikmfj3bso8lv90fvmj4ma">&nbsp;&nbsp;ä½¿ç”¨Messengerã€‚<br>å®ƒå®é™…æ˜¯å¯¹AIDLåšäº†å°è£…ï¼Œåº•å±‚å®ç°å…¶å®æ˜¯ä¸€ä¸ªBinderã€‚ç”±äºå®ƒä¸€æ¬¡å¤„ç†ä¸€ä¸ªè¯·æ±‚ï¼Œå› æ­¤åœ¨æœåŠ¡ç«¯ä¸ç”¨è€ƒè™‘çº¿ç¨‹åŒæ­¥çš„é—®é¢˜ï¼Œå› ä¸ºæœåŠ¡ç«¯ä¸­ä¸å­˜åœ¨å¹¶å‘æ‰§è¡Œçš„æƒ…å½¢ã€‚</a><br></h3><br><p class="topicImage"><br><img height="142" src="http://7xle8x.com1.z0.glb.clouddn.com/16-4-1/98880000.jpg" width="400"></p><br><h3 class="topic"><br><a name="1nc9sk9kf5mociba2d56lj3ps7">&nbsp;&nbsp;&nbsp;æœåŠ¡ç«¯è¿›ç¨‹</a><br></h3><br><h3 class="topic"><br><a name="255f071r95hcpjip3ido0tr0ap">&nbsp;&nbsp;&nbsp;&nbsp;Serviceï¼šå¤„ç†å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚</a><br></h3><br><h3 class="topic"><br><a name="3ghsq10q0k321kleega49c1q2k">&nbsp;&nbsp;&nbsp;&nbsp;Handlerï¼šé€šè¿‡å®ƒæ¥åˆ›å»ºä¸€ä¸ªMessengerå¯¹è±¡ï¼Œç„¶ååœ¨Serviceçš„onBindä¸­è¿”å›è¿™ä¸ªMessengerå¯¹è±¡åº•å±‚çš„Binderå³å¯ã€‚</a><br></h3><br><h3 class="topic"><br><a name="2v4s4fhffa8pj4kfhsiusb5mnu">&nbsp;&nbsp;&nbsp;å®¢æˆ·ç«¯è¿›ç¨‹</a><br></h3><br><h3 class="topic"><br><a name="5gqml5qspn62h51a6gjmvf7iht">&nbsp;&nbsp;&nbsp;&nbsp;ç»‘å®šæœåŠ¡ç«¯çš„Serviceï¼Œç»‘å®šæˆåŠŸåç”¨æœåŠ¡ç«¯è¿”å›çš„IBinderå¯¹è±¡åˆ›å»ºä¸€ä¸ªMessengerï¼Œé€šè¿‡è¿™ä¸ªMessengerå°±å¯ä»¥å‘æœåŠ¡ç«¯å‘é€æ¶ˆæ¯ã€‚</a><br></h3><br><h3 class="topic"><br><a name="338jjc5cgpl3mpk84uju860e8f">&nbsp;&nbsp;&nbsp;&nbsp;å¦‚æœéœ€è¦æœåŠ¡ç«¯èƒ½å¤Ÿå›åº”å®¢æˆ·ç«¯ï¼Œåˆ™ä¸æœåŠ¡ç«¯ç±»ä¼¼ï¼Œåœ¨å®¢æˆ·ç«¯åˆ›å»ºä¸€ä¸ªHandlerå’Œä¸€ä¸ªæ–°çš„Messengerï¼ŒæŠŠè¿™ä¸ªMessengerå¯¹è±¡é€šè¿‡Messageçš„replyToå‚æ•°ä¼ é€’ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯å°±å¯ä»¥é€šè¿‡è¿™ä¸ªreplyToå‚æ•°å›åº”å®¢æˆ·ç«¯äº†ã€‚</a><br></h3><br><h3 class="topic"><br><a name="6a92lspgogqqj69vvh6097er0u">&nbsp;&nbsp;ä½¿ç”¨AIDLã€‚</a><br></h3><br><h3 class="topic"><br><a name="3gh1fh567l9nc60ievdvdto0cp">&nbsp;&nbsp;&nbsp;æœåŠ¡ç«¯ï¼šåˆ›å»ºServiceç›‘å¬å®¢æˆ·ç«¯è¯·æ±‚ï¼Œåˆ›å»ºAIDLæ–‡ä»¶å£°æ˜éœ€è¦æš´éœ²ç»™å®¢æˆ·ç«¯çš„æ¥å£ï¼Œåœ¨Serviceä¸­å®ç°è¿™ä¸ªAIDLæ¥å£ã€‚</a><br></h3><br><h3 class="topic"><br><a name="7n3p971jogp8gjickj5dm7kgh3">&nbsp;&nbsp;&nbsp;å®¢æˆ·ç«¯ï¼šç»‘å®šæœåŠ¡ç«¯Serviceï¼Œå°†æœåŠ¡ç«¯è¿”å›çš„Binderå¯¹è±¡è½¬æˆAIDLæ¥å£æ‰€å±ç±»å‹ï¼Œå°±å¯ä»¥è°ƒç”¨AIDLä¸­çš„æ–¹æ³•äº†ã€‚</a><br></h3><br><h3 class="topic"><br><a name="7lu7cc6i7pjru7tlugab7l42fm">&nbsp;&nbsp;&nbsp;AIDLæ”¯æŒçš„æ•°æ®ç±»å‹æœ‰é™</a><br></h3><br><h3 class="topic"><br><a name="5l91rftiseahaseoqika9c2jhc">&nbsp;&nbsp;&nbsp;è‡ªå®šä¹‰çš„Parcelableå’ŒAIDLå¯¹è±¡å¿…é¡»æ˜¾ç¤ºimportï¼Œä¸ç®¡æ˜¯ä¸æ˜¯ä¸å½“å‰AIDLåœ¨åŒä¸€ä¸ªåŒ…ä¸­ã€‚</a><br></h3><br><h3 class="topic"><br><a name="06u6at9067q3b5rld6odujtdcq">&nbsp;&nbsp;&nbsp;å¦‚æœAIDLä¸­ç”¨åˆ°äº†è‡ªå®šä¹‰Parcelableå¯¹è±¡ï¼Œé‚£ä¹ˆå¿…é¡»åˆ›å»ºä¸€ä¸ªå’Œå®ƒåŒåçš„AIDLæ–‡ä»¶ï¼Œå¹¶å£°æ˜æ‹“ä¸ºParcelableç±»å‹ã€‚æ¯”å¦‚ç”¨åˆ°äº†Bookç±»ï¼Œåˆ™å¿…é¡»åˆ›å»ºBook.aidlæ–‡ä»¶ã€‚</a><br></h3><br><h3 class="topic"><br><a name="3hifqtlcdi8md4id14htt4euai">&nbsp;&nbsp;&nbsp;AIDLä¸­é™¤äº†åŸºæœ¬æ•°æ®ç±»å‹ï¼Œå…¶ä»–ç±»å‹çš„å‚æ•°å¿…é¡»æ ‡æ˜æ–¹å‘ï¼šinã€outæˆ–è€…inoutã€‚<br>è¦æ ¹æ®å®é™…æƒ…å†µæŒ‡å®šï¼Œä¸è¦ä¸€æ¦‚ä½¿ç”¨outæˆ–inoutï¼Œå› ä¸ºåº•å±‚å®ç°æœ‰å¼€é”€ã€‚</a><br></h3><br><h3 class="topic"><br><a name="6t2vso092ub1dm939905pucmig">&nbsp;&nbsp;&nbsp;ä¸ºäº†æ–¹ä¾¿æŠŠAIDLæ–‡ä»¶ä»æœåŠ¡ç«¯æ‹·åˆ°å®¢æˆ·ç«¯ï¼Œåº”è¯¥åœ¨å¼€å‘æ—¶æŠŠæ‰€æœ‰å’ŒAIDLç›¸å…³çš„ç±»å’Œæ–‡ä»¶æ”¾å…¥åŒä¸€ä¸ªåŒ…ã€‚</a><br></h3><br><h3 class="topic"><br><a name="2pnsfn836o6u401n30ii0fgi1m">&nbsp;&nbsp;&nbsp;åœ¨æœåŠ¡ç«¯ï¼ŒAIDLçš„æ–¹æ³•åœ¨Binderçº¿ç¨‹æ± ä¸­æ‰§è¡Œï¼Œå½“å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶è¿æ¥æ—¶ï¼Œå­˜åœ¨å¤šçº¿ç¨‹åŒæ—¶è®¿é—®çš„æƒ…å½¢ï¼Œè¦åšå¥½çº¿ç¨‹åŒæ­¥ã€‚</a><br></h3><br><h3 class="topic"><br><a name="4dqfrbp65q9uue1hc230ddvuuf">&nbsp;&nbsp;&nbsp;å¦‚æœè¦é€šè¿‡AIDLå®ç°è§‚å¯Ÿè€…æ¨¡å¼ï¼Œè®©æœåŠ¡ç«¯åœ¨æ•°æ®å˜åŒ–æ—¶é€šçŸ¥å®¢æˆ·ç«¯ï¼Œéœ€è¦å®¢æˆ·ç«¯åˆ©ç”¨Binderè°ƒç”¨æ¥å£çš„æ³¨å†Œæ–¹æ³•æ¥å‘æœåŠ¡ç«¯æ³¨å†Œè‡ªå·±çš„å›è°ƒå‡½æ•°ã€‚ä½†è¿™æ ·ä¼šå¯¼è‡´ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æœåŠ¡ç«¯æ— æ³•unregisterè¿™äº›å›è°ƒå‡½æ•°ï¼Œå› ä¸ºåœ¨è·¨è¿›ç¨‹ä¼ è¾“æ—¶interfaceæ˜¯è¢«åºåˆ—åŒ–æ•°æ®é‡å»ºçš„ï¼Œåœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡ã€‚å› æ­¤ï¼Œè¦é€šè¿‡AIDLåœ¨æœåŠ¡ç«¯ä½¿ç”¨å®¢æˆ·ç«¯çš„å›è°ƒå‡½æ•°ï¼Œå°±éœ€è¦ç”¨åˆ°RemoteCallbackListç±»æ¥æ³¨å†Œå’Œåæ³¨å†Œã€‚<br>å¯¹RemoteCallbackListä¸­ä»»ä½•æ•°æ®è®¿é—®ï¼Œéƒ½å¿…é¡»é…å¯¹ä½¿ç”¨beginBroadcastå’ŒfinishBroadcastæ–¹æ³•ï¼Œå³ä½¿æ˜¯è·å–å…¶ä¸­çš„å…ƒç´ ä¸ªæ•°ã€‚</a><br></h3><br><h3 class="topic"><br><a name="03ujd6lb6u27mqk1q25tnu4bof">&nbsp;&nbsp;&nbsp;åœ¨ç”¨Binderç»‘å®šè¿œç¨‹æœåŠ¡æ—¶ï¼Œå®¢æˆ·ç«¯çš„onServiceConnectedå’ŒonServiceDisconnectedæ–¹æ³•éƒ½è¿è¡Œåœ¨UIçº¿ç¨‹ä¸­ï¼Œä¸èƒ½åœ¨é‡Œé¢ç›´æ¥è°ƒç”¨æœåŠ¡ç«¯çš„è€—æ—¶æ–¹æ³•ï¼Œå› ä¸ºå®¢æˆ·ç«¯ä¼šæŒ‚èµ·ç­‰å¾…ç»“æœã€‚<br>æœåŠ¡ç«¯çš„æ–¹æ³•æœ¬èº«å°±è¿è¡Œåœ¨æœåŠ¡ç«¯çš„Binderçº¿ç¨‹æ± ä¸­ï¼Œæ‰€ä»¥æœåŠ¡ç«¯æœ¬æ¥å°±å¯ä»¥æ‰§è¡Œå¤§é‡è€—æ—¶æ“ä½œï¼Œä¸è¦åœ¨æœåŠ¡ç«¯æ–¹æ³•ä¸­å¼€çº¿ç¨‹å»è¿›è¡Œå¼‚æ­¥ä»»åŠ¡ã€‚<br>æœåŠ¡ç«¯å¦‚æœå›è°ƒå®¢æˆ·ç«¯çš„æŸä¸ªæ–¹æ³•ï¼Œä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œå¦‚æœæœåŠ¡ç«¯ç›´æ¥åœ¨UIçº¿ç¨‹å›è°ƒå®¢æˆ·ç«¯çš„è€—æ—¶æ–¹æ³•ï¼Œä¼šå¯¼è‡´æœåŠ¡ç«¯æ— æ³•å“åº”ã€‚<br>æ€»ä¹‹ï¼Œé€šè¿‡Binderè°ƒç”¨è¿œç¨‹æ–¹æ³•ï¼Œè°ƒç”¨è€…æ˜¯åŒæ­¥æ‰§è¡Œï¼Œä¼šæŒ‚èµ·çº¿ç¨‹ç­‰å¾…ç»“æœï¼›è¢«è°ƒç”¨è€…æ˜¯è‡ªåŠ¨åœ¨Binderçº¿ç¨‹æ± ä¸­å¼‚æ­¥æ‰§è¡Œã€‚</a><br></h3><br><h3 class="topic"><br><a name="67s5ng6v9udlbiak2tic93ra0q">&nbsp;&nbsp;ä½¿ç”¨ContentProviderã€‚<br>åº•å±‚å®ç°å…¶å®æ˜¯Binderã€‚</a><br></h3><br><h3 class="topic"><br><a name="2j6lnbvgqhug8t8l7m92ohs9j0">&nbsp;&nbsp;&nbsp;éœ€è¦å®ç°6ä¸ªæŠ½è±¡æ–¹æ³•ï¼š<br>onCreateï¼šç”±ç³»ç»Ÿå›è°ƒï¼Œå¹¶è¿è¡Œåœ¨ä¸»çº¿ç¨‹ã€‚<br>queryã€updateã€insertã€deleteã€getTypeï¼šç”±å¤–ç•Œå›è°ƒï¼Œå¹¶è¿è¡Œåœ¨Binderçº¿ç¨‹æ± ä¸­ã€‚</a><br></h3><br><h3 class="topic"><br><a name="3hggr7s2h037u1bv34h3gkhnbc">&nbsp;&nbsp;&nbsp;updateã€insertã€deleteæ–¹æ³•ä¼šå¼•èµ·æ•°æ®æºçš„æ”¹å˜ï¼Œè¿™æ—¶éœ€è¦é€šè¿‡ContentProviderçš„notifyChangeæ–¹æ³•æ¥é€šçŸ¥å¤–ç•Œå½“å‰ContentProviderä¸­çš„æ•°æ®å·²ç»å‘ç”Ÿæ”¹å˜ã€‚</a><br></h3><br><h3 class="topic"><br><a name="2ds8us1i5bhgclnffsmdclkoso">&nbsp;&nbsp;&nbsp;è¦è§‚å¯Ÿä¸€ä¸ªContentProviderä¸­çš„æ•°æ®æ”¹å˜æƒ…å†µï¼Œå¯ä»¥é€šè¿‡ContentResolverçš„registerContentObserveræ–¹æ³•æ¥æ³¨å†Œè§‚å¯Ÿè€…ï¼Œé€šè¿‡unregisterContentObserveræ–¹æ³•æ¥è§£é™¤è§‚å¯Ÿè€…ã€‚</a><br></h3><br><h3 class="topic"><br><a name="7e8bjflilurkhqddv6h5a3icpg">&nbsp;&nbsp;ä½¿ç”¨Socketã€‚<br>åˆ†ä¸ºTCPå’ŒUDPã€‚</a><br></h3><br><h2 class="topic"><br><a name="5mc1s7fglmg525281tsm188rsc">è¿›ç¨‹åä»¥&ldquo;:&rdquo;å¼€å¤´çš„è¿›ç¨‹å±äºå½“å‰åº”ç”¨çš„ç§æœ‰è¿›ç¨‹ï¼Œå…¶ä»–åº”ç”¨çš„ç»„ä»¶ä¸å¯ä»¥å’Œå®ƒè·‘åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œè€Œè¿›ç¨‹åä¸ä»¥&ldquo;:&rdquo;å¼€å¤´çš„è¿›ç¨‹å±äºå…¨å±€è¿›ç¨‹ï¼Œå…¶ä»–åº”ç”¨é€šè¿‡ShareUIDæ–¹å¼å¯ä»¥å’Œå®ƒè·‘åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ã€‚</a><br></h2><br><h2 class="topic"><br><a name="3skn58ts3790c27ofbloe32no5">Androidç³»ç»Ÿä¸ºæ¯ä¸ªåº”ç”¨åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„UIDï¼Œå…·æœ‰ç›¸åŒUIDçš„åº”ç”¨æ‰èƒ½å…±äº«æ•°æ®ã€‚<br>ä¸¤ä¸ªåº”ç”¨é€šè¿‡ShareUIDè·‘åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­æ˜¯æœ‰è¦æ±‚çš„ï¼Œéœ€è¦è¿™ä¸¤ä¸ªåº”ç”¨æœ‰ç›¸åŒçš„ShareUIDå¹¶ä¸”ç­¾åç›¸åŒæ‰å¯ä»¥ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒä»¬å¯ä»¥ç›¸äº’è®¿é—®å¯¹æ–¹çš„ç§æœ‰æ•°æ®ï¼Œæ¯”å¦‚dataç›®å½•ã€ç»„ä»¶ä¿¡æ¯ç­‰ï¼Œä¸ç®¡å®ƒä»¬æ˜¯å¦è·‘åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ã€‚å½“ç„¶å¦‚æœå®ƒä»¬è·‘åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œé‚£ä¹ˆé™¤äº†èƒ½å…±äº«dataç›®å½•ã€ç»„ä»¶ä¿¡æ¯ï¼Œè¿˜å¯ä»¥å…±äº«å†…å­˜æ•°æ®ï¼Œæˆ–è€…è¯´å®ƒä»¬çœ‹èµ·æ¥å°±åƒæ˜¯ä¸€ä¸ªåº”ç”¨çš„ä¸¤ä¸ªéƒ¨åˆ†ã€‚</a><br></h2><br><h2 class="topic"><br><a name="5sf554jre0cs9974jsaipir9to">6ç§IPCæ–¹å¼å¯¹æ¯”å›¾</a><br></h2><br><p class="topicImage"><br><img height="311" src="http://7xle8x.com1.z0.glb.clouddn.com/16-4-1/31827144.jpg" width="515"></p><br></body><br></html>
]]></content>
    <summary type="html">
    <![CDATA[<h1 align="center" class="root"><br><a name="3havsr3p3t101hrdlbi9m7usv6">å­¦ä¹ ç¬”è®°ï¼šAndroidä¸­çš„IPCæœºåˆ¶</a><br></h1>

<p><a href="http://www.carrotsight.com">è¿”å›æœ¬ç«™é¦–é¡µ</a></p>
<p>â€œAndroidä¸­çš„IPCæœºåˆ¶â€ çŸ¥è¯†ç‚¹å­¦ä¹ æ¢³ç†ï¼ŒåŒ…æ‹¬äº†Androidä¸­å¸¸è§çš„å‡ ç§IPCçš„æ€»ç»“å’Œå¯¹æ¯”ã€‚</p>
<p>ç”¨XMindç”»çš„æ€ç»´å¯¼å›¾ï¼Œå¯¼å‡ºä¸ºHTMLæ ¼å¼äº†ï¼Œç‚¹å¼€é¡µé¢å¯ä»¥æŸ¥çœ‹æ¸…æ™°çš„å›¾ç‰‡ï¼Œä»¥åŠå„éƒ¨åˆ†çš„å¯¼å‡ºæ–‡å­—ã€‚<br>å› ä¸ºå›¾ç‰‡å¤ªå¤§ï¼Œå¦‚æœæ¸²æŸ“ä¸ºä¸æœ¬ç«™ä¸€è‡´çš„ä¸»é¢˜ä¼šå¯¼è‡´å›¾ç‰‡çœ‹ä¸æ¸…ï¼Œæ‰€ä»¥æœ¬é¡µé¢æœªè¿›è¡Œæ ·å¼æ¸²æŸ“ï¼Œæ¯”è¾ƒä¸‘ï¼Œå‡‘åˆç€çœ‹å§ã€‚ğŸ˜Š</p>
<p><a href="http://7xle8x.com1.z0.glb.clouddn.com/16-4-1/99061779-Android IPCæœºåˆ¶.xmind">ç‚¹å‡»è¿™é‡Œä¸‹è½½ Androidä¸­çš„IPCæœºåˆ¶ XMindåŸå§‹æ–‡ä»¶</a></p>]]>
    
    </summary>
    
      <category term="Android" scheme="http://www.carrotsight.com/tags/Android/"/>
    
      <category term="IPC" scheme="http://www.carrotsight.com/tags/IPC/"/>
    
      <category term="Android" scheme="http://www.carrotsight.com/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[æµ…è°ˆAndroidè‡ªå®šä¹‰Lintè§„åˆ™çš„å®ç° ï¼ˆäºŒï¼‰]]></title>
    <link href="http://www.carrotsight.com/2016/02/01/%E6%B5%85%E8%B0%88Android%E8%87%AA%E5%AE%9A%E4%B9%89Lint%E8%A7%84%E5%88%99%E7%9A%84%E5%AE%9E%E7%8E%B0%20%EF%BC%88%E4%BA%8C%EF%BC%89.html"/>
    <id>http://www.carrotsight.com/2016/02/01/æµ…è°ˆAndroidè‡ªå®šä¹‰Lintè§„åˆ™çš„å®ç° ï¼ˆäºŒï¼‰.html</id>
    <published>2016-02-01T03:30:35.000Z</published>
    <updated>2016-02-01T03:45:24.000Z</updated>
    <content type="html"><![CDATA[<p>ä¸Šä¸€ç¯‡æ–‡ç« é’ˆå¯¹Androidè‡ªå®šä¹‰Lintè§„åˆ™çš„æ€»ä½“å¼€å‘æµç¨‹åšäº†ä»‹ç»ï¼Œæœ¬æ–‡é’ˆå¯¹javaæºä»£ç Lintæ£€æµ‹æ–¹æ³•åšç»†èŠ‚ä»‹ç»ã€‚ç”±äºç½‘ä¸Šå…³äºè‡ªå®šä¹‰Lintè§„åˆ™çš„æ–‡ç« æ¯”è¾ƒæœ‰é™ï¼Œä¸”å¯¹äºlombok.aståº“çš„ç›¸å…³ç»†èŠ‚å‡ ä¹æ²¡æœ‰æ–‡æ¡£å¯ç”¨ï¼Œæ‰€ä»¥æœ¬æ–‡å†…å®¹ä¸»è¦æ˜¯æ ¹æ®è‡ªèº«å¼€å‘ç»éªŒåšçš„æ€»ç»“ï¼Œéš¾å…ä¼šæœ‰ç–æ¼æˆ–é”™è¯¯ï¼Œè¿˜è¯·å„ä½å¤§ç¥æ‰¹è¯„æŒ‡æ­£ã€‚</p>
<a id="more"></a>
<h2 id="æ£€æµ‹Javaæºä»£ç ">æ£€æµ‹Javaæºä»£ç </h2><p>é’ˆå¯¹Javaæºä»£ç åšLintæ£€æµ‹ï¼Œæˆ‘ä»¬éœ€è¦è®©è‡ªå®šä¹‰çš„XXXDetectorç±»ç»§æ‰¿com.android.tools.lint.detector.api.Detectorç±»ï¼Œå¹¶å®ç°com.android.tools.lint.detector.api.Detector.JavaScanneræ¥å£ï¼ŒåŒæ—¶åœ¨è¯¥XXXDetectorå¯¹åº”çš„Issueä¸­å®šä¹‰æ£€æµ‹çš„èŒƒå›´ä¸ºcom.android.tools.lint.detector.api.Scope.JAVA_FILE_SCOPEï¼Œå¦‚å›¾ï¼š  </p>
<p><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-1-29/14308921.jpg" alt="">  </p>
<p>å…¶å®æˆ‘ä»¬æŸ¥çœ‹Detectorç±»çš„æºç ä¼šå‘ç°ï¼ŒJavaScanneræ˜¯åœ¨Detectorä¸­å®šä¹‰çš„å†…éƒ¨æ¥å£ï¼ŒJavaScanneræ¥å£ä¸­å®šä¹‰çš„10ä¸ªæ–¹æ³•ï¼Œéƒ½ä»¥å®Œå…¨ç›¸åŒçš„ç­¾ååœ¨Detectorä¸­é‡æ–°å®šä¹‰äº†ä¸€éã€‚æ‰€ä»¥ï¼ŒDetectorç›¸å½“äºæ˜¯JavaScanneræ¥å£çš„é€‚é…å™¨ï¼Œä¸Šå›¾ä¸­æˆ‘ä»¬è‡ªå®šä¹‰çš„ActivityFragmentLayoutNameDetectorç±»å¯ä»¥æ ¹æ®éœ€è¦åªå®ç°JavaScanneræ¥å£çš„éƒ¨åˆ†æ–¹æ³•ï¼Œè€Œä¸éœ€è¦å®ç°å…¨éƒ¨10ä¸ªæ–¹æ³•ã€‚<br>ä½œä¸º7ä¸ªScannerï¼ˆè¿™7ä¸ªScanneråœ¨ä¸Šä¸€ç¯‡ä¸­æœ‰ä»‹ç»ï¼Œè¿™é‡Œçš„JavaScannerå°±æ˜¯å…¶ä¸­ä¸€ä¸ªï¼‰çš„å¤–éƒ¨ç±»ï¼ŒDetectorå®é™…ä¸Šæ˜¯å®ƒä»¬å…±åŒçš„é€‚é…å™¨ã€‚  </p>
<p>JavaScanneræ¥å£å®šä¹‰çš„10ä¸ªæ–¹æ³•å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-1-7/55021440.jpg" alt="">  </p>
<p>ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼ŒJavaScannerå®šä¹‰çš„å¾ˆå¤šæ–¹æ³•éƒ½ç”¨åˆ°äº†Nodeç±»ï¼Œè¿˜å‡ºç°äº†ConstructorInvocationã€MethodInvocationç­‰ç±»ã€‚é‚£ä¹ˆè¿™äº›ç±»åˆ°åº•ä»£è¡¨ä»€ä¹ˆï¼Œæˆ‘ä»¬å¦‚ä½•åœ¨javaæºä»£ç çš„åˆ†æä¸­ä½¿ç”¨è¿™äº›ç±»å‘¢ï¼Ÿè¦ææ¸…æ¥šè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬é¦–å…ˆè¦ä»‹ç»ä¸€ä¸‹Abstract Syntax Treeã€‚</p>
<h3 id="Abstract_Syntax_Treeæ˜¯ä»€ä¹ˆ">Abstract Syntax Treeæ˜¯ä»€ä¹ˆ</h3><p>åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼ŒAbstract Syntax Treeï¼ˆç®€ç§°ASTï¼‰æ˜¯å¯¹ç¨‹åºè®¾è®¡è¯­è¨€å†™æˆçš„æºä»£ç çš„ä¸€ç§æ ‘å‹è¡¨ç¤ºã€‚æ ‘ä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆnodeï¼‰ä»£è¡¨åœ¨æºä»£ç ä¸­å­˜åœ¨çš„ä¸€ä¸ªæ„å»ºä½“ã€‚ä¹‹è¯´ä»¥è¯´è¯­æ³•æ ‘æ˜¯â€œæŠ½è±¡çš„â€ï¼ˆAbstractï¼‰æ˜¯å› ä¸ºå®ƒå¹¶æ²¡æœ‰æŠŠçœŸå®è¯­æ³•çš„æ‰€æœ‰ç»†èŠ‚éƒ½è¡¨è¾¾å‡ºæ¥ï¼Œæ¯”å¦‚æˆå¯¹åŒ¹é…çš„æ‹¬å·å°±éšå¼çš„ç”¨æ ‘ç»“æ„æ¥è¡¨è¾¾ï¼Œä¸€æ¡if-condition-thenè¯­å¥å¯èƒ½å°±ç”¨ä¸€ä¸ªå…·æœ‰3ä¸ªåˆ†æ”¯çš„èŠ‚ç‚¹æ¥è¡¨è¾¾ã€‚  </p>
<p>åœ¨Javaå’ŒAndroidå¼€å‘å·¥ä½œä¸­ï¼ŒIDEå·¥å…·å¸¦ç»™æˆ‘ä»¬çš„å¾ˆå¤šä¾¿åˆ©åŠŸèƒ½éƒ½æ˜¯é€šè¿‡ASTæ¥å®ç°çš„ï¼Œæ¯”å¦‚Quick Fixã€Quick Assistã€ä¿®æ”¹ä¸€ä¸ªå˜é‡åæ—¶è‡ªåŠ¨æŠŠæ‰€æœ‰å¯¹è¯¥å˜é‡çš„å¼•ç”¨éƒ½åŒæ­¥ä¿®æ”¹ã€ä»¥åŠåœ¨Android Studioä¸­æ‘ä½<code>âŒ˜</code>é”®çš„åŒæ—¶ç‚¹å‡»ä¸€ä¸ªç±»åä¼šè·³è½¬åˆ°é‚£ä¸ªç±»çš„å®šä¹‰æ–‡ä»¶ç­‰ã€‚  </p>
<p>ASTä¸XMLæ–‡ä»¶çš„DOMæ¨¡å‹ç±»ä¼¼ï¼Œå…è®¸ä½ é€šè¿‡ä¿®æ”¹æ ‘æ¨¡å‹æ¥æŠŠè¿™äº›ä¿®æ”¹åæ˜ åˆ°Javaæºä»£ç ä¸­ã€‚ä¸è¿‡æˆ‘ä»¬åœ¨è‡ªå®šä¹‰Lintä½¿ç”¨ASTçš„è¿‡ç¨‹ä¸­ä¸€èˆ¬ä¸æ¶‰åŠä¿®æ”¹èŠ‚ç‚¹ã€‚ä¸€ä¸ªASTçš„ä¾‹å­å¦‚ä¸‹å›¾:  </p>
<p><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-1-29/67433168.jpg" alt=""></p>
<p>åœ¨æŸ¥çœ‹Android Lintæºç çš„è¿‡ç¨‹ä¸­å¯ä»¥å‘ç°ï¼Œå®ƒæ¶‰åŠåˆ°ä¸¤å¥—ASTçš„å®ç°APIï¼Œä¸€å¥—æ˜¯<code>Ecjï¼ˆEclipse Java development toolsï¼‰</code>çš„ï¼Œåœ¨åŒ…<code>org.eclipse.jdt.internal.compiler.ast</code>ä¸­ï¼›å¦ä¸€å¥—æ˜¯<code>lombok.ast</code>çš„ã€‚ç³»ç»Ÿæš´éœ²ç»™æˆ‘ä»¬å…è®¸æˆ‘ä»¬ç›´æ¥ç”¨æ¥æ‰©å±•Lintè§„åˆ™çš„æ˜¯lombok.astçš„AST APIã€‚JavaScannerå®šä¹‰çš„10ä¸ªæ–¹æ³•ä¸­çš„NodeæŒ‡çš„å°±æ˜¯lombok.ast.Nodeï¼Œè€ŒConstructorInvocationã€MethodInvocationéƒ½æ˜¯lombok.ast.Nodeçš„å­ç±»ã€‚</p>
<p>å¦‚æœä½ å¯¹ASTæ„Ÿå…´è¶£ï¼Œå¯ä»¥æŸ¥çœ‹<a href="http://www.eclipse.org/articles/Article-JavaCodeManipulation_AST/" target="_blank" rel="external">Eclipseç½‘ç«™çš„ASTä»‹ç»æ–‡æ¡£</a>ã€‚</p>
<h3 id="JavaScanneræ¥å£æ–¹æ³•çš„ä½¿ç”¨">JavaScanneræ¥å£æ–¹æ³•çš„ä½¿ç”¨</h3><p>å‰é¢çš„å›¾ç‰‡æ˜¾ç¤ºäº†JavaScanneræ¥å£å®šä¹‰çš„10ä¸ªæ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•æœ‰äº›å¯ä»¥å•ç‹¬ä½¿ç”¨ï¼Œæœ‰äº›éœ€è¦é…åˆä½¿ç”¨ï¼Œè¿™é‡Œä»‹ç»å¸¸è§çš„ç”¨æ³•ã€‚  </p>
<p>ã€1ã€‘getApplicableNodeTypesï¼ˆï¼‰éœ€è¦ä¸createJavaVisitorï¼ˆï¼‰é…åˆä½¿ç”¨ã€‚  </p>
<p>getApplicableNodeTypesï¼ˆï¼‰è¿”å›æˆ‘ä»¬æ„Ÿå…´è¶£çš„Nodeåˆ—è¡¨ï¼Œç„¶ååœ¨createJavaVisitorï¼ˆï¼‰è¿”å›çš„AstVisitorä¸­å»å¤„ç†è¿™äº›Nodeã€‚<br>æ¯”å¦‚ï¼Œæˆ‘ä»¬æƒ³å¯¹javaæºä»£ç ä¸­çš„ifã€tryã€forè¯­å¥è¿›è¡Œæ£€æµ‹ï¼Œå°±å¯ä»¥è¿™æ ·å®ç°getApplicableNodeTypesï¼ˆï¼‰ï¼š</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"><span class="keyword">public</span> List&lt;<span class="keyword">Class</span>&lt;? <span class="keyword">extends</span> Node&gt;&gt; getApplicableNodeTypes() &#123;</span><br><span class="line">    <span class="keyword">return</span> Arrays.<span class="keyword">asList</span>(<span class="keyword">Try</span>.<span class="keyword">class</span>, <span class="keyword">If</span>.<span class="keyword">class</span>, <span class="keyword">For</span>.<span class="keyword">class</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­çš„Tryã€Ifã€Foréƒ½æ˜¯lombok.ast.Nodeçš„å­ç±»ã€‚</p>
<p>ç„¶åå®šä¹‰ä¸€ä¸ªAstVisitorçš„å­ç±»ï¼Œå¹¶åœ¨createJavaVisitorï¼ˆï¼‰ä¸­è¿”å›å®ƒçš„ä¸€ä¸ªå®ä¾‹ï¼Œé‚£ä¹ˆåœ¨javaæºç ä¸­å‡ºç°çš„tryã€ifã€forè¯­å¥å¯¹åº”çš„nodeå°±ä¼šè§¦å‘ForIfTryBlockVisitorä¸­å¯¹åº”çš„å›è°ƒå‡½æ•°ï¼š</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function">AstVisitor <span class="title">createJavaVisitor</span><span class="params">(@NonNull JavaContext context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ForIfTryBlockVisitor(context);</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ForIfTryBlockVisitor</span> <span class="keyword">extends</span> <span class="title">ForwardingAstVisitor</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> JavaContext mContext;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ForIfTryBlockVisitor</span><span class="params">(JavaContext context)</span> </span>&#123;</span><br><span class="line">            mContext = context;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">visitTry</span><span class="params">(Try node)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//... åœ¨è¿™é‡Œå¯¹tryè¯­å¥åšä½ éœ€è¦çš„æ£€æŸ¥</span></span><br><span class="line">            </span><br><span class="line">            <span class="function"><span class="keyword">return</span> <span class="keyword">super</span>.<span class="title">visitTry</span><span class="params">(node)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">visitFor</span><span class="params">(For node)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//... åœ¨è¿™é‡Œå¯¹forè¯­å¥åšä½ éœ€è¦çš„æ£€æŸ¥</span></span><br><span class="line">            </span><br><span class="line">            <span class="function"><span class="keyword">return</span> <span class="keyword">super</span>.<span class="title">visitFor</span><span class="params">(node)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">visitIf</span><span class="params">(If node)</span> </span>&#123;</span><br><span class="line">            <span class="comment">//... åœ¨è¿™é‡Œå¯¹ifè¯­å¥åšä½ éœ€è¦çš„æ£€æŸ¥  </span></span><br><span class="line">                      </span><br><span class="line">            <span class="function"><span class="keyword">return</span> <span class="keyword">super</span>.<span class="title">visitIf</span><span class="params">(node)</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ã€2ã€‘getApplicableMethodNames()éœ€è¦ä¸void visitMethod(JavaContext context, AstVisitor visitor,  MethodInvocation node)é…åˆä½¿ç”¨ï¼Œæ­¤æ—¶createJavaVisitorï¼ˆï¼‰æ ¹æ®å®é™…éœ€æ±‚å¯æœ‰å¯æ— ã€‚  </p>
<p>è¿™é‡ŒgetApplicableMethodNames()ç”¨æ¥è¿”å›ä½ æ„Ÿå…´è¶£çš„é‚£äº›æ–¹æ³•è°ƒç”¨åˆ—è¡¨ï¼Œè¿™äº›æ–¹æ³•è°ƒç”¨å¯¹åº”çš„nodeæ¯ä¸€æ¬¡å‡ºç°éƒ½ä¼šè§¦å‘visitMethod(JavaContext context, AstVisitor visitor,  MethodInvocation node)æ–¹æ³•è¢«å›è°ƒã€‚  </p>
<p>ä¾‹å¦‚ï¼Œæˆ‘æƒ³é’ˆå¯¹javaæºä»£ç ä¸­æ‰€æœ‰è°ƒç”¨setContentViewï¼ˆï¼‰å’Œinflateï¼ˆï¼‰çš„ä»£ç è¿›è¡Œæ£€æŸ¥ï¼Œå¯ä»¥è¿™æ ·å®šä¹‰getApplicableMethodNamesï¼ˆï¼‰ï¼š</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;String&gt; getApplicableMethodNames() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">return</span> Arrays.<span class="title">asList</span><span class="params">(<span class="string">"setContentView"</span>, <span class="string">"inflate"</span>)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶ååœ¨visitMethodæ–¹æ³•ä¸­åšå…·ä½“å¤„ç†ï¼š</p>
<figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> visitMethod(<span class="keyword">@NonNull</span> JavaContext context, AstVisitor visitor, <span class="keyword">@NonNull</span> MethodInvocation node) &#123;</span><br><span class="line">    String methodName = node.astName().astValue();</span><br><span class="line">    <span class="keyword">if</span> (methodName.equals(<span class="string">"setContentView"</span>)) &#123;            </span><br><span class="line">        <span class="comment">//åœ¨è¿™é‡Œåšé’ˆå¯¹setContentViewï¼ˆï¼‰è°ƒç”¨çš„å…·ä½“æ£€æŸ¥</span></span><br><span class="line">           </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (methodName.equals(<span class="string">"inflate"</span>)) &#123;</span><br><span class="line">        <span class="comment">//åœ¨è¿™é‡Œåšé’ˆå¯¹inflateï¼ˆï¼‰è°ƒç”¨çš„å…·ä½“æ£€æŸ¥</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ã€3ã€‘getApplicableConstructorTypesï¼ˆï¼‰éœ€è¦ä¸visitConstructor(JavaContext context, AstVisitor visitor,ConstructorInvocation node,ResolvedMethod constructor)é…åˆä½¿ç”¨ï¼Œæ­¤æ—¶createJavaVisitorï¼ˆï¼‰æ ¹æ®å®é™…éœ€æ±‚å¯æœ‰å¯æ— ã€‚  </p>
<p>è¿™é‡ŒgetApplicableConstructorTypesï¼ˆï¼‰ç”¨æ¥è¿”å›ä½ æ„Ÿå…´è¶£çš„æ„é€ æ–¹æ³•çš„åˆ—è¡¨ï¼Œç³»ç»Ÿä¼šåœ¨ç¬¦åˆæ¡ä»¶çš„æ„é€ æ–¹æ³•çš„æ¯ä¸€æ¬¡å‡ºç°éƒ½å›è°ƒä¸€æ¬¡visitConstructoræ–¹æ³•ï¼Œè€Œä¼ å…¥çš„nodeå‚æ•°å°±æ˜¯å¯¹åº”çš„è°ƒç”¨æ„é€ å‡½æ•°åœ¨ASTä¸­çš„èŠ‚ç‚¹ã€‚</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line"><span class="keyword">public</span> List&lt;<span class="built_in">String</span>&gt; getApplicableConstructorTypes() &#123;</span><br><span class="line">    <span class="keyword">return</span> Arrays.asList(<span class="string">"com.ljfxyj2008.BlankFragment"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">void</span> visitConstructor(@NonNull JavaContext context, AstVisitor visitor, @NonNull ConstructorInvocation node, @NonNull JavaParser.ResolvedMethod <span class="constructor"><span class="keyword">constructor</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//åœ¨è¿™é‡Œåšé’ˆå¯¹æ„é€ å‡½æ•°è°ƒç”¨è¯­å¥çš„å…·ä½“æ£€æŸ¥</span></span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">"===visitConstructor node = "</span> + node</span><br><span class="line">            + <span class="string">"\nlocation = "</span> + context.getLocation(node).getStart().getLine());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ã€4ã€‘appliesToResourceRefsï¼ˆï¼‰éœ€è¦ä¸visitResourceReference(JavaContext context,AstVisitor visitor,Node node,String type,String name,boolean isFramework)é…åˆä½¿ç”¨ï¼Œç”¨æ¥å¯¹æ„Ÿå…´è¶£çš„èµ„æºæ–‡ä»¶å¼•ç”¨çš„ä»£ç è¿›è¡Œæ£€æŸ¥ï¼Œæ¯”å¦‚å¼•ç”¨äº†<code>R.layout.main</code>æˆ–è€…<code>R.string.app_name</code>çš„ä»£ç ã€‚</p>
<p>è¿™ä¸¤ä¸ªæ–¹æ³•çš„å®ç°æ­¥éª¤ä¸å‰é¢çš„å‡ å¯¹ç±»ä¼¼ï¼Œå°±ä¸å†è´´ä»£ç äº†ã€‚</p>
<p>åœ¨ä¸Šé¢ä»‹ç»çš„JavaScannerçš„æ‰€æœ‰ç›¸å…³APIä¸­ï¼Œæœ€é‡è¦çš„å°±æ˜¯createJavaVisitorï¼ˆï¼‰ä»¥åŠè¯¥æ–¹æ³•è¿”å›çš„AstVisitorã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥åªåˆ©ç”¨createJavaVisitorï¼ˆï¼‰æ–¹æ³•ä»¥åŠå¯¹åº”çš„AstVisitorï¼Œå°±å®Œæˆå¯¹javaæºä»£ç çš„æ‰€æœ‰æ£€æŸ¥å·¥ä½œã€‚ä¹‹æ‰€ä»¥Lintç³»ç»Ÿä¸ºJavaScanneræ¥å£å®šä¹‰äº†10ä¸ªæ–¹æ³•ï¼Œä»…ä»…æ˜¯ä¸ºäº†ä½¿å¾—å¯¹å¸¸è§çš„ä¸€äº›å¤„ç†éœ€æ±‚å®ç°èµ·æ¥æ›´åŠ ç®€æ´å’Œé«˜æ•ˆã€‚</p>
<h3 id="lombok-ast_APIä¸­é‡è¦çš„ç±»">lombok.ast APIä¸­é‡è¦çš„ç±»</h3><p>æ—¢ç„¶Lintåˆ†ææ˜¯å¤„ç†ASTä¸­çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆæœ€é‡è¦æœ€å¸¸ç”¨çš„ç±»å½“ç„¶å°±æ˜¯lombok.ast.Nodeäº†ã€‚<br>lombok.ast.Nodeå®é™…ä¸Šæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®šä¹‰äº†å¯¹äºASTèŠ‚ç‚¹çš„ä¸€ç³»åˆ—é€šç”¨æ“ä½œï¼Œæœ‰å¤šä¸ªæŠ½è±¡å­ç±»/æ¥å£éƒ½å®ç°/ç»§æ‰¿äº†å®ƒã€‚è€Œåœ¨è¿™äº›æŠ½è±¡å­ç±»/æ¥å£ä¸­æˆ‘ä»¬æœ€å¸¸ç”¨åˆ°çš„æ˜¯AbstractNodeã€‚AbstractNodeæ˜¯å®ç°äº†lombok.ast.Nodeæ¥å£çš„æŠ½è±¡ç±»ï¼Œå®ƒæœ‰ä¸ºæ•°ä¼—å¤šçš„å­ç±»ï¼Œè¿™äº›å­ç±»ç›´æ¥ä¸å„ç§è¯­å¥ç›´æ¥å¯¹åº”ï¼Œå¦‚å›¾ï¼š  </p>
<p><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-1-29/92067715.jpg" alt=""></p>
<p>å¯ä»¥çœ‹åˆ°å¸¸ç”¨çš„caseã€breakã€continueã€forã€ifç­‰è¯­å¥éƒ½ç›´æ¥è¢«æ˜ å°„ä¸ºè¿™é‡Œå…·ä½“çš„Nodeå­ç±»ï¼Œè€Œç±»æ„é€ å™¨çš„å£°æ˜ä¸è°ƒç”¨ï¼ˆå³ç”¨newå…³é”®å­—æ¥ç”Ÿæˆä¸€ä¸ªæ–°å¯¹è±¡ï¼‰ä¹Ÿèƒ½åœ¨è¿™é‡Œæ‰¾åˆ°å¯¹åº”çš„ç±»ï¼ˆå³ConstructorDeclarationå’ŒConstructorInvocationï¼‰ã€‚æœ‰äº†AbstractNodeå¦‚æ­¤ä¸°å¯Œçš„å­ç±»ï¼Œæˆ‘ä¹ˆå¯¹javaæºç çš„åˆ†æå°±æ–¹ä¾¿äº†å¾ˆå¤šï¼Œå¯¹äºè‡ªå·±æƒ³è¦åˆ†æçš„å…ƒç´ ï¼Œå…ˆæ‰¾åˆ°ä¸å®ƒå¯¹åº”çš„AbstractNodeå­ç±»ï¼Œç„¶ååœ¨å®šä¹‰è‡ªå·±çš„AstVisitoræ—¶å»åˆ†æè¿™ä¸ªå¯¹åº”ç±»å³å¯ã€‚  </p>
<p>ä¸‹é¢ç»™å‡ºä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œç›®çš„æ˜¯æ£€æŸ¥ç”¨æˆ·æœ‰æ²¡æœ‰ä½¿ç”¨<code>new Messageï¼ˆï¼‰</code>æ¥è·å–æ–°çš„android.os.Messageå¯¹è±¡ï¼Œå¦‚æœæœ‰è¿™ç§è°ƒç”¨ï¼Œæˆ‘ä»¬å°±æŠ›å‡ºä¸€ä¸ªissueï¼Œæç¤ºç”¨æˆ·åº”è¯¥ä½¿ç”¨æ•ˆç‡æ›´é«˜çš„<code>handler.obtainMessage</code>æˆ–è€…<code>Message.Obtain()</code>æ¥è·å–ï¼Œä»£ç å¦‚ä¸‹ï¼š  </p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">MessageObtainDetector</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">Detector</span></span><br><span class="line"></span>        implements <span class="type">Detector</span>.<span class="type">JavaScanner</span> &#123;</span><br><span class="line">    public static <span class="keyword">final</span> <span class="type">Issue</span> <span class="type">ISSUE</span> = <span class="type">Issue</span>.create(<span class="string">"MessageObtainNotUsed"</span>,</span><br><span class="line">            <span class="string">"You should not call `new Message()` directly."</span>,</span><br><span class="line">            <span class="string">"You should not call `new Message()` directly. Instead, you should use `handler.obtainMessage` or `Message.Obtain()`."</span>,</span><br><span class="line">            <span class="type">Category</span>.<span class="type">CORRECTNESS</span>,</span><br><span class="line">            <span class="number">9</span>,</span><br><span class="line">            <span class="type">Severity</span>.<span class="type">ERROR</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="type">Implementation</span>(<span class="type">MessageObtainDetector</span>.<span class="keyword">class</span>,</span><br><span class="line">                    <span class="type">Scope</span>.<span class="type">JAVA_FILE_SCOPE</span>));</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    public <span class="type">List</span>&lt;<span class="type">Class</span>&lt;? <span class="keyword">extends</span> <span class="type">Node</span>&gt;&gt; getApplicableNodeTypes() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">Collections</span>.&lt;<span class="type">Class</span>&lt;? <span class="keyword">extends</span> <span class="type">Node</span>&gt;&gt;singletonList(<span class="type">ConstructorInvocation</span>.<span class="keyword">class</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    public <span class="type">AstVisitor</span> createJavaVisitor(<span class="annotation">@NonNull</span> <span class="type">JavaContext</span> context) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">MessageObtainVisitor</span>(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageObtainVisitor</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">ForwardingAstVisitor</span> &#123;</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">JavaContext</span> mContext;</span><br><span class="line"></span><br><span class="line">        public <span class="type">MessageObtainVisitor</span>(<span class="type">JavaContext</span> context) &#123;</span><br><span class="line">            mContext = context;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        public boolean visitConstructorInvocation(<span class="type">ConstructorInvocation</span> node) &#123;</span><br><span class="line">            <span class="type">JavaParser</span>.<span class="type">ResolvedNode</span> resolvedType = mContext.resolve(node.astTypeReference());</span><br><span class="line">            <span class="type">JavaParser</span>.<span class="type">ResolvedClass</span> resolvedClass = (<span class="type">JavaParser</span>.<span class="type">ResolvedClass</span>) resolvedType;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (resolvedClass != <span class="literal">null</span></span><br><span class="line">                    &amp;&amp; resolvedClass.isSubclassOf(<span class="string">"android.os.Message"</span>, <span class="literal">false</span>))&#123;</span><br><span class="line">                mContext.report(<span class="type">ISSUE</span>,</span><br><span class="line">                        node,</span><br><span class="line">                        mContext.getLocation(node),</span><br><span class="line">                        <span class="string">"You should not call `new Message()` directly."</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.visitConstructorInvocation(node);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç ç»“æ„éå¸¸ç®€å•ï¼Œåœ¨getApplicableNodeTypes()æ–¹æ³•ä¸­è¿”å›ä¸€ä¸ªListè¡¨æ˜æˆ‘ä»¬åªå¯¹ConstructorInvocation.classæ„Ÿå…´è¶£ï¼Œç„¶ååœ¨createJavaVisitorï¼ˆï¼‰ä¸­è¿”å›ä¸€ä¸ªè‡ªå®šä¹‰çš„AstVisitorå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œçš„MessageObtainVisitorã€‚å› ä¸ºæ˜¯æ£€æµ‹å¯¹æ„é€ æ–¹æ³•çš„è°ƒç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨MessageObtainVisitorçš„å®šä¹‰ä¸­åªéœ€è¦é‡å†™visitConstructorInvocationï¼ˆï¼‰æ–¹æ³•ã€‚äº‹å®ä¸Šï¼Œå³ä½¿æˆ‘ä»¬æŠŠè¿™é‡Œå¯¹getApplicableNodeTypes()é‡å†™çš„ä»£ç æ®µåˆ é™¤ï¼Œä»ç„¶å¯ä»¥è¾¾åˆ°æ£€æµ‹<code>new Message()</code>çš„ç›®çš„ï¼Œå› ä¸ºåªè¦åœ¨MessageObtainVisitorï¼ˆï¼‰ä¸­é‡å†™äº†visitXXXï¼ˆï¼‰å°±å¯ä»¥ä¿è¯å®ƒè¢«è°ƒç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬é‡å†™getApplicableNodeTypes()å¯ä»¥ç¡®ä¿æ•ˆç‡æ›´é«˜ã€‚  </p>
<p>è®¤çœŸçœ‹è‡ªå®šä¹‰ç±»MessageObtainVisitorçš„visitConstructorInvocationï¼ˆï¼‰æ–¹æ³•ä½“ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸¤è¡Œä»£ç :</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JavaParser.ResolvedNode resolvedType = mContext.resolve(<span class="keyword">node</span>.<span class="identifier"></span><span class="title">astTypeReference</span>());</span><br><span class="line">JavaParser.ResolvedClass resolvedClass = (JavaParser.ResolvedClass) resolvedType;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸¤è¡Œä»£ç éå¸¸å…³é”®ï¼Œå®ƒæŠŠlombok.astä¸­çš„ç±»è½¬æ¢æˆäº†JavaParserä¸­çš„ç±»ï¼Œå¦‚æ­¤ä¸€æ¥æˆ‘ä»¬å°±å¯ä»¥è·å–ä¸æ­¤nodeå¯¹åº”çš„ç±»ã€å˜é‡ã€æ–¹æ³•æˆ–æ³¨è§£çš„è¯¦ç»†ä¿¡æ¯ã€‚æ¯”å¦‚è¿™é‡Œçš„nodeè¢«è½¬æ¢ä¸ºresolvedClassåï¼Œå°±å¯ä»¥è·å–ä¸æ­¤ç±»æœ‰å…³çš„ç±»ç»§æ‰¿å…³ç³»ã€‚  </p>
<p>ç”±äºlombok.astä¸­å„ç§å›è°ƒå‡½æ•°ï¼ˆå¦‚getApplicableNodeTypesã€visitConstructorInvocationç­‰ï¼‰çš„å‚æ•°éƒ½æ˜¯lombok.ast.Nodeç±»å‹ï¼Œå®ƒä»¬åŒ…å«çš„éƒ½æ˜¯ä¸ASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰ç›¸å…³çš„ç»“æ„æ€§ä¿¡æ¯ï¼Œè€Œè¿™äº›ä¿¡æ¯å¯¹äºæˆ‘ä»¬åˆ†æjavaæºç çš„å…·ä½“ä¸šåŠ¡æ¥è¯´è‚¯å®šæ˜¯è¿œè¿œä¸å¤Ÿçš„ï¼Œæ‰€ä»¥åœ¨åˆé€‚çš„æ—¶æœºæŠŠnodeè½¬æ¢æˆJavaParserä¸­å„ç§åˆé€‚çš„ç±»å‹å°±éå¸¸é‡è¦ã€‚é‚£ä¹ˆåœ¨lombok.astçš„å„ç§å›è°ƒå‡½æ•°ä¸­ä¼ å…¥çš„nodeèƒ½å¤Ÿè¢«è½¬æ¢æˆå“ªäº›ç±»å‹å‘¢ï¼Ÿçœ‹ä¸‹å›¾ï¼š</p>
<p><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-2-1/36527297.jpg" alt=""></p>
<p>å¯ä»¥çœ‹åˆ°ç±»å‹è¿˜æ˜¯ç›¸å½“ä¸°å¯Œçš„ï¼Œè¶³å¤Ÿæˆ‘ä»¬å¯¹ASTå„ç§èŠ‚ç‚¹è¿›è¡Œè¯¦ç»†åˆ†æäº†ã€‚</p>
<p>ç›¸ä¿¡ç»†å¿ƒçš„æœ‹å‹åº”è¯¥å‘ç°äº†ï¼Œä¸Šé¢MessageObtainDetectorè¿™ä¸ªç±»çš„ä»£ç ä¸­æ˜¯å¯¹ConstructorInvocation.classç±»å‹çš„èŠ‚ç‚¹è¿›è¡Œäº†åˆ†æï¼Œè€Œæˆ‘ä»¬åœ¨<code>JavaScanneræ¥å£æ–¹æ³•çš„ä½¿ç”¨</code>è¿™ä¸€èŠ‚çš„ç¬¬3æ¡ä»‹ç»äº†getApplicableConstructorTypesï¼ˆï¼‰å’ŒvisitConstructorï¼ˆï¼‰æ–¹æ³•ï¼Œå®ƒä»¬çœ‹èµ·æ¥å¾ˆç±»ä¼¼å•Šï¼Ÿæ²¡é”™ï¼Œå¯¹äºMessageObtainDetectorç±»ä¸­è¿›è¡Œçš„æ„é€ æ–¹æ³•è°ƒç”¨æ£€æŸ¥ï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥ç”¨getApplicableConstructorTypesï¼ˆï¼‰å’ŒvisitConstructorï¼ˆï¼‰æ¥å®ç°ï¼Œè¿™æ ·å°±ä¸éœ€è¦è‡ªå·±å»å®šä¹‰ä¸€ä¸ªMessageObtainVisitoräº†ã€‚æˆ‘ä»¬åœ¨å‰é¢ä¹Ÿæåˆ°è¿‡ï¼ŒJavaScannerä¸­çš„å®šä¹‰çš„10ä¸ªå›è°ƒæ–¹æ³•ï¼Œå…¶å®å¤§éƒ¨åˆ†éƒ½æ˜¯ä¸ºäº†ç®€åŒ–ä»£ç ç»“æ„ä¸æé«˜æ‰§è¡Œæ•ˆç‡ï¼Œå…¶å®å®Œå…¨å¯ä»¥åªç”¨è‡ªå®šä¹‰çš„ForwardingAstVisitoræ¥å®Œæˆæ‰€æœ‰æ£€æµ‹åŠŸèƒ½ã€‚  </p>
<p>è¿˜æœ‰ä¸€ç»„æ¯”è¾ƒæœ‰ç”¨çš„ç±»å‹è½¬æ¢æ–¹æ³•ä¸Šé¢æ²¡æœ‰æåˆ°ï¼š</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ClassDeclaration surroundingClass = JavaContext.findSurroundingClass(<span class="keyword">node</span><span class="identifier"></span><span class="title">);</span><br><span class="line">Node</span> surroundingMethod = JavaContext.findSurroundingMethod(<span class="keyword">node</span><span class="identifier"></span><span class="title">);</span></span><br></pre></td></tr></table></figure>
<p>ç”¨è¿™ç»„æ–¹æ³•å¯ä»¥è·å–åˆ°æ­¤nodeå¤–å›´åŒ…è£¹å®ƒçš„ç±»æˆ–æ–¹æ³•ï¼Œè¿™æ˜¯JavaContextç±»æä¾›çš„ä¸¤ä¸ªé™æ€æ–¹æ³•ï¼Œå¯ä»¥å°†è¿™ä¸¤ä¸ªæ–¹æ³•ä¸ä¸Šé¢ä»‹ç»çš„JavaParserä¸­çš„ResolvedXXXç±»å‹é…åˆä½¿ç”¨ã€‚</p>
<h2 id="å°ç»“">å°ç»“</h2><p>ä½¿ç”¨Lintæ¥åˆ†æjavaæºä»£ç ï¼Œéœ€è¦å®ç°JavaScannerä¸­åˆé€‚çš„å›è°ƒå‡½æ•°ã€‚è¿™äº›å›è°ƒå‡½æ•°å¤§éƒ¨åˆ†æ˜¯ä¸ºäº†ä½¿å¾—å¯¹å¸¸è§çš„ä¸€äº›å¤„ç†éœ€æ±‚å®ç°èµ·æ¥æ›´åŠ ç®€æ´å’Œé«˜æ•ˆï¼Œäº‹å®ä¸Šæˆ‘ä»¬å®Œå…¨å¯ä»¥åªç”¨è‡ªå®šä¹‰çš„<code>AstVisitor</code>æ¥å®Œæˆæ‰€æœ‰Lintæ£€æŸ¥å·¥ä½œï¼Œå¹¶åœ¨createJavaVisitorï¼ˆï¼‰ä¸­è¿”å›è¿™ä¸ªè‡ªå®šä¹‰AstVisitorçš„å®ä¾‹ã€‚<br>JavaScannerå›è°ƒå‡½æ•°çš„nodeåŒ…å«çš„éƒ½æ˜¯ä¸ASTç»“æ„ç›¸å…³çš„ä¿¡æ¯ï¼Œå¦‚æœè¦å¯¹nodeå¯¹åº”çš„javaç±»ã€æ–¹æ³•ç­‰è¿›è¡Œè¯¦ç»†çš„ä¸šåŠ¡åˆ†æï¼Œå°±éœ€è¦æŠŠnodeè½¬æ¢æˆJavaParserä¸­å®šä¹‰çš„åˆé€‚ç±»å‹ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>ä¸Šä¸€ç¯‡æ–‡ç« é’ˆå¯¹Androidè‡ªå®šä¹‰Lintè§„åˆ™çš„æ€»ä½“å¼€å‘æµç¨‹åšäº†ä»‹ç»ï¼Œæœ¬æ–‡é’ˆå¯¹javaæºä»£ç Lintæ£€æµ‹æ–¹æ³•åšç»†èŠ‚ä»‹ç»ã€‚ç”±äºç½‘ä¸Šå…³äºè‡ªå®šä¹‰Lintè§„åˆ™çš„æ–‡ç« æ¯”è¾ƒæœ‰é™ï¼Œä¸”å¯¹äºlombok.aståº“çš„ç›¸å…³ç»†èŠ‚å‡ ä¹æ²¡æœ‰æ–‡æ¡£å¯ç”¨ï¼Œæ‰€ä»¥æœ¬æ–‡å†…å®¹ä¸»è¦æ˜¯æ ¹æ®è‡ªèº«å¼€å‘ç»éªŒåšçš„æ€»ç»“ï¼Œéš¾å…ä¼šæœ‰ç–æ¼æˆ–é”™è¯¯ï¼Œè¿˜è¯·å„ä½å¤§ç¥æ‰¹è¯„æŒ‡æ­£ã€‚</p>]]>
    
    </summary>
    
      <category term="Android" scheme="http://www.carrotsight.com/tags/Android/"/>
    
      <category term="Lint" scheme="http://www.carrotsight.com/tags/Lint/"/>
    
      <category term="custom lint rules" scheme="http://www.carrotsight.com/tags/custom-lint-rules/"/>
    
      <category term="Android" scheme="http://www.carrotsight.com/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[æµ…è°ˆAndroidè‡ªå®šä¹‰Lintè§„åˆ™çš„å®ç° ï¼ˆä¸€ï¼‰]]></title>
    <link href="http://www.carrotsight.com/2016/01/29/%E6%B5%85%E8%B0%88Android%E8%87%AA%E5%AE%9A%E4%B9%89Lint%E8%A7%84%E5%88%99%E7%9A%84%E5%AE%9E%E7%8E%B0%20%EF%BC%88%E4%B8%80%EF%BC%89.html"/>
    <id>http://www.carrotsight.com/2016/01/29/æµ…è°ˆAndroidè‡ªå®šä¹‰Lintè§„åˆ™çš„å®ç° ï¼ˆä¸€ï¼‰.html</id>
    <published>2016-01-29T03:00:50.000Z</published>
    <updated>2016-04-01T09:08:49.000Z</updated>
    <content type="html"><![CDATA[<p>æœ€è¿‘åœ¨åšä¸€ä¸ªåŸºäºAndroid Lintçš„è‡ªå®šä¹‰é™æ€ä»£ç æ£€æŸ¥åŠŸèƒ½åº“ï¼Œè¿™é‡Œåšä¸€ä¸ªç®€å•çš„æ€»ç»“ã€‚å‰åŠéƒ¨åˆ†ä»‹ç»SDKè‡ªå¸¦Android Lintçš„åŠŸèƒ½ä¸é…ç½®ä½¿ç”¨æ–¹æ³•ï¼ŒååŠéƒ¨åˆ†ä»‹ç»æ‰©å±•è‡ªå®šä¹‰Lintè§„åˆ™åº“çš„å¼€å‘æµç¨‹ã€‚</p>
<h2 id="ä»€ä¹ˆæ˜¯Android_Lint">ä»€ä¹ˆæ˜¯Android Lint</h2><p>Android Lintæ˜¯ä¸€ä¸ªé™æ€ä»£ç åˆ†æå·¥å…·ï¼Œå®ƒèƒ½å¤Ÿå¯¹ä½ çš„Androidé¡¹ç›®ä¸­æ½œåœ¨çš„bugã€å¯ä¼˜åŒ–çš„ä»£ç ã€å®‰å…¨æ€§ã€æ€§èƒ½ã€å¯ç”¨æ€§ã€å¯è®¿é—®æ€§ã€å›½é™…åŒ–ç­‰è¿›è¡Œæ£€æŸ¥ã€‚  </p>
<p>åœ¨Android SDK Tools 16åŠæ›´é«˜çš„ç‰ˆæœ¬ä¸­ï¼ŒLintå·¥å…·ä¼šè‡ªåŠ¨å®‰è£…ã€‚é€šè¿‡å®ƒå¯¹Androidå·¥ç¨‹æºä»£ç è¿›è¡Œæ‰«æå’Œæ£€æŸ¥ï¼Œå¯å‘ç°æ½œåœ¨çš„é—®é¢˜ï¼Œä»¥ä¾¿ç¨‹åºå‘˜åŠæ—©ä¿®æ­£è¿™ä¸ªé—®é¢˜ã€‚Android Lintæä¾›äº†å‘½ä»¤è¡Œæ–¹å¼æ‰§è¡Œï¼Œè¿˜ä¸IDEï¼ˆå¦‚Android Studioï¼‰è¿›è¡Œäº†é›†æˆï¼Œå¹¶æä¾›äº†xmlå’Œhtmlå½¢å¼çš„è¾“å‡ºæŠ¥å‘Šã€‚  </p>
<p>çœ‹äº†ä¸Šé¢çš„ä»‹ç»å¯èƒ½å¤§å®¶ä¾ç„¶å¾ˆè¿·æƒ‘â€œè¿™è´§åˆ°åº•æœ‰å•¥ç”¨â€ï¼Œå…¶å®æˆ‘ä»¬å¹³æ—¶åœ¨Androidå¼€å‘è¿‡ç¨‹ä¸­ä¸€ç›´åœ¨äº«å—Lintå¸¦æ¥çš„ä¾¿åˆ©ã€‚æ¯”å¦‚ï¼Œä¸‹é¢å›¾ä¸­çš„è­¦å‘Šå’Œé”™è¯¯æç¤ºï¼Œç›¸ä¿¡å¤§å®¶åº”è¯¥å¾ˆç†Ÿæ‚‰å§ï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-1-29/23031672.jpg" alt=""></p>
<a id="more"></a>
<p><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-1-29/32957935.jpg" alt=""></p>
<p>ä¸Šé¢çš„ä¾‹å­åˆ†åˆ«æ˜¯javaæ–‡ä»¶ä¸Manifestæ–‡ä»¶åœ¨æ¥å—Lintæ£€æŸ¥åç»™å‡ºçš„ç®€è¦lintæŠ¥å‘Šï¼Œæ˜¯Lintä¸IDEé›†æˆåçš„ä¸€ç§è¡¨ç°å½¢å¼ã€‚äº‹å®ä¸Šï¼ŒAndroid Lintç›®å‰èƒ½æ£€æŸ¥çš„é¡¹ç›®å·²ç»å¤šè¾¾220é¡¹ï¼Œæ£€æŸ¥çš„èŒƒå›´æ¶µç›–äº†äºŒè¿›åˆ¶èµ„æºæ–‡ä»¶ã€javaæºä»£ç ã€classæ–‡ä»¶ã€gradleé…ç½®æ–‡ä»¶ã€xmlæ–‡ä»¶ã€resourceæ–‡ä»¶å¤¹ã€å…¶ä»–æ–‡ä»¶ç­‰ã€‚é™¤äº†å›¾ä¸­è¿™ç§ä¸IDEç»“åˆçš„ç®€æ´æŠ¥å‘Šå½¢å¼ä»¥å¤–ï¼Œä¹Ÿæä¾›æ›´è¯¦ç»†çš„htmlå’Œxmlå½¢å¼çš„æŠ¥å‘Šï¼Œè®©ä½ å¯¹è‡ªå·±ä»£ç è´¨é‡çš„æå‡ç©ºé—´æœ‰æ›´å…¨é¢çš„è®¤è¯†ã€‚  </p>
<p>åœ¨Android Studioä¸­ï¼Œæ¯ä¸€æ¬¡ç¼–è¯‘ç¨‹åºæ—¶éƒ½ä¼šè‡ªåŠ¨è¿è¡Œlintåˆ†æå·¥å…·ï¼Œä¹Ÿå¯ä»¥åœ¨éœ€è¦lintåˆ†æçš„æ–‡ä»¶å¤¹ã€åŒ…æˆ–æ–‡ä»¶ä¸Šç‚¹å‡»å³é”®é€‰æ‹©ã€Analyzeã€‘-&gt;ã€Inspect Codeã€‘ã€‚ ç”Ÿæˆçš„æŠ¥å‘ŠåŒ…å«äº†æ£€æŸ¥è¿‡ç¨‹ä¸­å‘ç°çš„é—®é¢˜ï¼Œå¹¶æŠŠè¿™äº›å†…å®¹æŒ‰ç…§ç±»åˆ«ã€ä¼˜å…ˆçº§ã€ä¸¥é‡ç¨‹åº¦è¿›è¡Œäº†åŒºåˆ†ã€‚  </p>
<p>Lintå·¥å…·çš„å¤„ç†æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="http://developer.android.com/images/tools/lint.png" alt="Lintå·¥ä½œæµ">  </p>
<p>å›¾ä¸­å„éƒ¨åˆ†å«ä¹‰å¦‚ä¸‹ï¼š  </p>
<ul>
<li>Application source filesï¼š æ„æˆä½ Android projectçš„æºæ–‡ä»¶ï¼ŒåŒ…å«Javaå’ŒXMLæ–‡ä»¶ï¼Œå›¾æ ‡ï¼Œä»¥åŠProGuardé…ç½®æ–‡ä»¶ã€‚</li>
<li>lint.xmlï¼š é…ç½®æ–‡ä»¶ï¼Œç”¨æ¥æŒ‡å®šä½ æƒ³ç¦ç”¨å“ªäº›lintæ£€æŸ¥åŠŸèƒ½ï¼Œä»¥åŠè‡ªå®šä¹‰é—®é¢˜ä¸¥é‡åº¦(problem severity levelsï¼‰ã€‚</li>
<li>lint Toolï¼š ä¸€ä¸ªå¯ä»¥ä»å‘½ä»¤è¡Œæˆ–Android Studioä¸­è¿è¡Œçš„é™æ€æ‰“ç æ‰«æå·¥å…·ã€‚</li>
<li>lint Outputï¼š lintæ£€æŸ¥çš„ç»“æœï¼Œå¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­é€šè¿‡lintæŸ¥çœ‹ï¼Œä¹Ÿå¯ä»¥åœ¨Android Studioçš„Event Logä¸­æŸ¥çœ‹ã€‚</li>
</ul>
<h2 id="Android_Lintæ£€æŸ¥å“ªäº›å†…å®¹">Android Lintæ£€æŸ¥å“ªäº›å†…å®¹</h2><p>Android Lintå†…ç½®äº†å¾ˆå¤šlintè§„åˆ™ï¼Œåˆ°ç°åœ¨ä¸ºæ­¢æ˜¯220é¡¹æ£€æŸ¥ï¼Œæ€»å…±å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š  </p>
<ul>
<li>Correctness æ­£ç¡®æ€§</li>
<li>Security å®‰å…¨æ€§</li>
<li>Performance æ€§èƒ½</li>
<li>Usability å¯ç”¨æ€§</li>
<li>Accessibility å¯è®¿é—®æ€§</li>
<li>Internationalization å›½é™…åŒ–</li>
</ul>
<p>ä¸‹é¢åˆ—ä¸¾ä¸€äº›å¸¸è§çš„lintä¼šæ£€æµ‹çš„ä»£ç é—®é¢˜ï¼š</p>
<ul>
<li>ç¼ºå°‘ç¿»è¯‘ï¼ˆå’Œæœªä½¿ç”¨çš„ç¿»è¯‘ï¼‰</li>
<li>å¸ƒå±€æ€§èƒ½é—®é¢˜ï¼ˆè€çš„layoutoptå·¥å…·ä¼šç”¨äºæŸ¥æ‰¾æ‰€æœ‰è¿™æ ·çš„é—®é¢˜ï¼Œå’Œé™¤æ­¤ä¹‹å¤–æ›´å¤šçš„é—®é¢˜ï¼‰</li>
<li>æœªä½¿ç”¨çš„èµ„æº</li>
<li>ä¸ä¸€è‡´çš„æ•°ç»„å¤§å°ï¼ˆå½“åœ¨å¤šä¸ªé…ç½®ä¸­å®šä¹‰æ•°ç»„ï¼‰</li>
<li>å¯è®¿é—®æ€§å’Œå›½é™…åŒ–é—®é¢˜ï¼ˆç¡¬ç¼–ç å­—ç¬¦ä¸²ï¼Œç¼ºå°‘contentDescriptionç­‰ï¼‰</li>
<li>å›¾æ ‡é—®é¢˜ ï¼ˆå¦‚ä¸¢å¤±å¯†åº¦ã€ é‡å¤å›¾æ ‡ã€ é”™è¯¯å°ºå¯¸ç­‰ï¼‰</li>
<li>å¯ç”¨æ€§é—®é¢˜ ï¼ˆå¦‚ä¸åœ¨æ–‡æœ¬å­—æ®µä¸ŠæŒ‡å®šè¾“å…¥çš„ç±»å‹ï¼‰</li>
<li>æ¸…å•é”™è¯¯</li>
</ul>
<blockquote>
<p>å¦‚æœè¦æŸ¥çœ‹lintå·¥å…·æ”¯æŒçš„issueçš„å®Œæ•´åˆ—è¡¨å’Œå®ƒä»¬æ‰€å¯¹åº”çš„issue IDï¼Œå¯ä»¥ä½¿ç”¨<code>lint --list</code>å‘½ä»¤ã€‚</p>
</blockquote>
<h2 id="é…ç½®Android_Lint">é…ç½®Android Lint</h2><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ä½ è¿è¡ŒLintæ‰«ææ—¶ï¼Œå®ƒä¼šå¯¹Lintæ”¯æŒçš„æ‰€æœ‰issueè¿›è¡Œæ£€æŸ¥ã€‚ä½ ä¹Ÿå¯ä»¥é™åˆ¶åªè®©lintæ£€æŸ¥ç‰¹å®šçš„issueï¼Œå¹¶ä¸ºæŸäº›issueåˆ†é…ä¸¥é‡åº¦ï¼ˆseverity levelï¼‰ã€‚<br>æ¯”å¦‚ï¼Œä½ å¯ä»¥ç¦æ­¢lintæ£€æŸ¥é‚£äº›ä¸ä½ çš„é¡¹ç›®æ— å…³çš„issueï¼Œå¹¶ä¸ºlinté…ç½®ä¸€ä¸ªæ›´ä½çš„severity levelæ¥è®©å®ƒæŠ¥å‘Šé‚£äº›ä¸æ˜¯éå¸¸ä¸¥é‡çš„issueã€‚  </p>
<p>ä½ å¯ä»¥ä¸ºlintæ£€æŸ¥é…ç½®ä¸åŒçš„levelï¼š</p>
<ul>
<li>å…¨å±€ï¼ˆå¯¹æ•´ä¸ªprojectï¼‰</li>
<li>æ¯ä¸ªproject module</li>
<li>æ¯ä¸ªproduction module</li>
<li>æ¯ä¸ªtest module</li>
<li>æ¯ä¸ªopen files</li>
<li>æ¯ä¸ªclass hierarchy</li>
<li>æ¯ä¸ªVersion Control System (VCS) scopes</li>
</ul>
<h3 id="åœ¨Android_Studioä¸­é…ç½®Lint">åœ¨Android Studioä¸­é…ç½®Lint</h3><p>Android Studioå…è®¸ä½ å¯¹lintæ¯é¡¹æ£€æŸ¥å•ç‹¬å¯ç”¨æˆ–ç¦ç”¨ï¼Œè¿˜å¯ä»¥å¯¹é¡¹ç›®å…¨å±€ã€ç‰¹å®šæ–‡ä»¶å¤¹ã€ç‰¹å®šæ–‡ä»¶è¿›è¡Œä¸“é—¨çš„linté…ç½®ã€‚æ–¹æ³•æ˜¯åœ¨Android Studioä¸­ç‚¹å‡»<code>File &gt; Settings &gt; Project Settings</code>èœå•æ‰“å¼€<code>Editor-&gt;Inspections</code>é¡µé¢ï¼Œé‡Œé¢æœ‰å®ƒæ”¯æŒçš„Profileså’ŒInspectionsåˆ—è¡¨ï¼Œå¦‚å›¾ï¼š<br><img src="http://developer.android.com/images/tools/studio-inspections-config.png" alt="Inspection Configuration"></p>
<h3 id="é…ç½®Lintæ–‡ä»¶">é…ç½®Lintæ–‡ä»¶</h3><p>ä½ å¯ä»¥åœ¨lint.xmlæ–‡ä»¶ä¸­æŒ‡å®šä½ å¯¹lintæ£€æŸ¥çš„åå¥½è®¾ç½®ã€‚å¦‚æœä½ è¦æ‰‹åŠ¨åˆ›å»ºè¿™ä¸ªæ–‡ä»¶ï¼Œå°±æŠŠå®ƒæ”¾åœ¨ä½ çš„Androidå·¥ç¨‹çš„æ ¹ç›®å½•ä¸­ã€‚å¦‚æœä½ æ˜¯åœ¨Android Studioä¸­é…ç½®lintåå¥½ï¼Œé‚£ä¹ˆlint.xmlæ–‡ä»¶ä¼šè‡ªåŠ¨åˆ›å»ºå¹¶æ·»åŠ åˆ°ä½ çš„Androidå·¥ç¨‹ä¸­ã€‚  </p>
<p>lint.xmlæ–‡ä»¶çš„ç»„æˆç»“æ„æ˜¯ï¼Œæœ€å¤–é¢æ˜¯ä¸€å¯¹é—­åˆçš„<lint>æ ‡ç­¾ï¼Œé‡Œé¢åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª<issue>å­å…ƒç´ ã€‚æ¯ä¸€ä¸ª<issue>è¢«å”¯ä¸€çš„idå±æ€§æ¥æ ‡è¯†ï¼Œæ•´ä½“ç»“æ„å¦‚ä¸‹ï¼š</issue></issue></lint></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">lint</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- list of issues to configure --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">lint</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>é€šè¿‡è®¾ç½®<issue>æ ‡ç­¾ä¸­çš„severityå±æ€§å€¼ï¼Œä½ å¯ä»¥å¯¹æŸä¸ªissueç¦ç”¨lintæ£€æŸ¥ï¼Œæˆ–è€…ä¿®æ”¹æŸä¸ªissueçš„ä¸¥é‡ç¨‹åº¦ï¼ˆseverity levelï¼‰ã€‚</issue></p>
<p>ä¸€ä¸ªå®ä¾‹lint.xmlæ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">lint</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Disable the given check in this project --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">issue</span> <span class="attribute">id</span>=<span class="value">"IconMissingDensityFolder"</span> <span class="attribute">severity</span>=<span class="value">"ignore"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Ignore the ObsoleteLayoutParam issue in the specified files --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">issue</span> <span class="attribute">id</span>=<span class="value">"ObsoleteLayoutParam"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">ignore</span> <span class="attribute">path</span>=<span class="value">"res/layout/activation.xml"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">ignore</span> <span class="attribute">path</span>=<span class="value">"res/layout-xlarge/activation.xml"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">issue</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Ignore the UselessLeaf issue in the specified file --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">issue</span> <span class="attribute">id</span>=<span class="value">"UselessLeaf"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">ignore</span> <span class="attribute">path</span>=<span class="value">"res/layout/main.xml"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">issue</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Change the severity of hardcoded strings to "error" --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">issue</span> <span class="attribute">id</span>=<span class="value">"HardcodedText"</span> <span class="attribute">severity</span>=<span class="value">"error"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">lint</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="åœ¨Javaæºæ–‡ä»¶æˆ–XMLæºæ–‡ä»¶ä¸­é…ç½®lintæ£€æŸ¥">åœ¨Javaæºæ–‡ä»¶æˆ–XMLæºæ–‡ä»¶ä¸­é…ç½®lintæ£€æŸ¥</h3><h4 id="åœ¨Javaä¸­é…ç½®lintæ£€æŸ¥">åœ¨Javaä¸­é…ç½®lintæ£€æŸ¥</h4><p>è¦å¯¹Androidé¡¹ç›®ä¸­æŸä¸ªJavaç±»æˆ–æ–¹æ³•ç¦ç”¨lintæ£€æŸ¥ï¼Œåªéœ€è¦å¯¹é‚£æ®µä»£ç æ·»åŠ <code>@SuppressLint</code>æ³¨è§£å³å¯ã€‚<br>ä¸‹é¢çš„ä¾‹å­æ˜¾ç¤ºäº†å¦‚ä½•å¯¹onCreateæ–¹æ³•å…³é—­NewApiè¿™ä¸ªissueçš„lintæ£€æŸ¥ã€‚lintå·¥å…·ä»ç„¶ä¼šå¯¹è¿™ä¸ªç±»çš„å…¶ä»–æ–¹æ³•è¿›è¡ŒNewApi issueçš„æ£€æŸ¥ã€‚ä¾‹å­å¦‚ä¸‹ï¼š</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@SuppressLint</span>(<span class="string">"NewApi"</span>)</span><br><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.main);</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢çš„ä¾‹å­æ˜¾ç¤ºå¦‚ä½•å¯¹FeedProviderç±»å…³é—­ParserError issueçš„lintæ£€æŸ¥ï¼š</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@SuppressLint</span>(<span class="string">"ParserError"</span>)</span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">FeedProvider</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">ContentProvider</span> &#123;</span></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœè¦åœ¨Javaæ–‡ä»¶ä¸­ç¦ç”¨æ‰€æœ‰issueçš„lintæ£€æŸ¥ï¼Œä½¿ç”¨<code>all</code>å…³é”®å­—ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@<span class="function"><span class="title">SuppressLint</span><span class="params">(<span class="string">"all"</span>)</span></span></span><br></pre></td></tr></table></figure>
<h4 id="åœ¨XMLä¸­é…ç½®lintæ£€æŸ¥">åœ¨XMLä¸­é…ç½®lintæ£€æŸ¥</h4><p>å¦‚æœè¦å¯¹XMLæ–‡ä»¶ä¸­æŸä¸€éƒ¨åˆ†ç¦ç”¨lintæ£€æŸ¥ï¼Œå¯ä»¥ä½¿ç”¨<code>tools:ignore</code>å±æ€§æ¥æ ‡è¯†ã€‚ä¸ºäº†è®©è¿™ä¸ªå±æ€§èƒ½å¤Ÿè¢«lintå·¥å…·è¯†åˆ«ï¼Œå¿…é¡»æŠŠä¸‹é¢çš„å‘½åç©ºé—´åŠ å…¥ä½ çš„XMLä¸­ï¼š</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">xmlns</span>:<span class="title">tools</span>=<span class="string">"http://schemas.android.com/tools"</span></span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢çš„ä¾‹å­æ˜¾ç¤ºäº†å¦‚ä½•å¯¹XMLå¸ƒå±€æ–‡ä»¶ä¸­çš„<linearlayout>å…ƒç´ ç¦ç”¨<code>UnusedResources</code> issueçš„lintæ£€æŸ¥ã€‚<code>ignore</code>å±æ€§ä¼šè¢«è¯¥å…ƒç´ ä¸‹çš„å­å…ƒç´ ç»§æ‰¿ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå­å…ƒç´ <textview>åŒæ ·è¢«ç¦ç”¨äº†lintæ£€æŸ¥ã€‚</textview></linearlayout></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">LinearLayout</span> </span><br><span class="line">    <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">    <span class="attribute">xmlns:tools</span>=<span class="value">"http://schemas.android.com/tools"</span></span><br><span class="line">    <span class="attribute">tools:ignore</span>=<span class="value">"UnusedResources"</span> &gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="title">TextView</span></span><br><span class="line">        <span class="attribute">android:text</span>=<span class="value">"@string/auto_update_prompt"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>è¦ç¦ç”¨å¤šä¸ªissueæ—¶ï¼Œç”¨é€—å·æŠŠå®ƒä»¬åˆ†éš”å¼€ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="label">tools:</span>ignore=<span class="string">"NewApi,StringFormatInvalid"</span></span><br></pre></td></tr></table></figure>
<p>è¦åœ¨æŸä¸ªXMLå…ƒç´ ä¸­å¯¹æ‰€æœ‰issueéƒ½ç¦ç”¨lintæ£€æŸ¥ï¼Œå¯ä»¥ä½¿ç”¨<code>all</code>å…³é”®å­—ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="label">tools:</span>ignore=<span class="string">"all"</span></span><br></pre></td></tr></table></figure>
<h2 id="è‡ªå®šä¹‰lint">è‡ªå®šä¹‰lint</h2><h3 id="ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰lint">ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰lint</h3><p>ç”±äºæ¯ä¸ªé¡¹ç›®è‡ªèº«çš„éœ€æ±‚ï¼ŒAndroid Linté»˜è®¤çš„æ£€æŸ¥é¡¹ç›®å¯èƒ½ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚<br>æ¯”å¦‚æˆ‘ä»¬è‡ªå·±å†™äº†ä¸€ä¸ªä¸‹æ‹‰åˆ·æ–°çš„åº“é¡¹ç›®ï¼Œå¯ä»¥è®©ç”¨æˆ·ç›´æ¥åœ¨xmlå¸ƒå±€æ–‡ä»¶ä¸­å»ä½¿ç”¨å®ƒï¼Œä½†æ˜¯æˆ‘ä»¬å¸Œæœ›ç”¨æˆ·å¿…é¡»åœ¨è¿™ä¸ªxmlå…ƒç´ ä¸­å®šä¹‰ä¸€ä¸ª<code>pullmode</code>å±æ€§ï¼Œå¦åˆ™ç»„ä»¶æ— æ³•æ­£å¸¸è¿è¡Œï¼Œæˆ‘ä»¬å¸Œæœ›lintèƒ½å¤Ÿå¯¹æ­¤è¿›è¡Œæ£€æŸ¥ï¼Œå¹¶åœ¨ç”¨æˆ·å¿˜è®°æ·»åŠ æ­¤å±æ€§æ—¶ç»™å‡ºæ˜ç¡®çš„é”™è¯¯æç¤ºã€‚å†æ¯”å¦‚ï¼Œæˆ‘ä»¬çš„é¡¹ç›®ä¸­ä½¿ç”¨äº†è‡ªå·±å°è£…çš„æ—¥å¿—åº“ï¼Œèƒ½å¤Ÿæ–¹ä¾¿çš„åœ¨releaseç‰ˆæœ¬ä¸­å…³é—­æ—¥å¿—è¾“å‡ºæ¥é˜²æ­¢appçš„æ•ˆç‡ä¸‹é™ï¼Œè¯¥æ—¥å¿—åº“è¿˜èƒ½å¤ŸæŠŠæ—¥å¿—è¾“å‡ºåˆ°æŒ‡å®šçš„æ–‡ä»¶ä¸­æ–¹ä¾¿äº‹ååˆ†æï¼Œè¿™æ—¶æœ‰ä¸€ä½æ–°æˆå‘˜åŠ å…¥äº†æˆ‘ä»¬çš„å¼€å‘ï¼Œä»–å¯èƒ½è¿˜æ˜¯ä¹ æƒ¯æ€§çš„ç”¨android.util.Logæ¥æ‰“å°æ—¥å¿—ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿæ£€æµ‹åˆ°æœ¬é¡¹ç›®ä¸­æ‰€æœ‰ä½¿ç”¨äº†android.util.Logçš„ä»£ç ï¼Œå¹¶å‘å‡ºè­¦å‘Šã€‚<br>è¦æ»¡è¶³è¿™äº›è‡ªå®šä¹‰éœ€æ±‚ï¼Œæˆ‘ä»¬å°±éœ€è¦é€šè¿‡Android Lintçš„æ‰©å±•æœºåˆ¶è‡ªå·±å®šåˆ¶lintè§„åˆ™ã€‚  </p>
<h3 id="è‡ªå®šä¹‰lintå¦‚ä½•ä½¿ç”¨">è‡ªå®šä¹‰lintå¦‚ä½•ä½¿ç”¨</h3><p>è‡ªå®šä¹‰lintæ˜¯ä¸€ä¸ªçº¯javaé¡¹ç›®ï¼Œä»¥jarçš„å½¢å¼è¾“å‡ºã€‚æœ‰äº†åŒ…å«lintè§„åˆ™çš„jaråï¼Œæœ‰ä¸¤ç§ä½¿ç”¨æ–¹æ¡ˆï¼š</p>
<ul>
<li>æ–¹æ¡ˆä¸€ï¼šæŠŠæ­¤jaræ‹·è´åˆ° ~/.android/lint/ ç›®å½•ä¸­ï¼ˆæ–‡ä»¶åä»»æ„ï¼‰ã€‚æ­¤æ—¶ï¼Œè¿™äº›lintè§„åˆ™é’ˆå¯¹æ‰€æœ‰é¡¹ç›®ç”Ÿæ•ˆã€‚</li>
<li>æ–¹æ¡ˆäºŒï¼šç»§ç»­åˆ›å»ºä¸€ä¸ªAndroid libraryé¡¹ç›®ï¼Œç”¨æ¥è¾“å‡ºåŒ…å«lint.jarçš„aarï¼›ç„¶åï¼Œè®©ç›®æ ‡é¡¹ç›®ä¾èµ–æ­¤aarå³å¯ä½¿è‡ªå®šä¹‰lintè§„åˆ™ç”Ÿæ•ˆã€‚</li>
</ul>
<p>ç”±äºæ–¹æ¡ˆä¸€æ˜¯å…¨å±€ç”Ÿæ•ˆçš„ç­–ç•¥ï¼Œæ— æ³•å•ç‹¬é’ˆå¯¹ç›®æ ‡é¡¹ç›®ï¼Œç”¨å¤„ä¸å¤§ã€‚åœ¨å·¥ç¨‹å®è·µä¸­ï¼Œæˆ‘ä»¬ä¸»è¦ä½¿ç”¨æ–¹æ¡ˆäºŒã€‚</p>
<p>AARæ˜¯Android Libraryçš„ä¸€ç§æ–°çš„äºŒè¿›åˆ¶åˆ†å‘æ ¼å¼ï¼Œå®ƒæŠŠèµ„æºä¹Ÿä¸€èµ·æ‰“åŒ…ï¼Œè¿™æ ·ä¸€æ¥å›¾ç‰‡å’Œå¸ƒå±€èµ„æºæ–‡ä»¶ä¹Ÿèƒ½å¤Ÿè¢«åŒæ—¶åˆ†å‘ã€‚AARæ ¼å¼æ–‡ä»¶èƒ½å¤ŸåŒ…å«ä¸€ä¸ªå¯é€‰çš„lint.jaræ–‡ä»¶ï¼Œå¦‚æœä¸€ä¸ªappä¾èµ–äº†ä¸€ä¸ªåŒ…å«lint.jarçš„aaræ–‡ä»¶ï¼Œé‚£ä¹ˆè¿™ä¸ªlint.jarä¸­çš„è§„åˆ™å°±ä¼šåœ¨appçš„lintä»»åŠ¡ä¸­è¢«ç”¨æ¥åšlintæ£€æŸ¥ã€‚</p>
<h3 id="è‡ªå®šä¹‰lintå®ç°åŸç†">è‡ªå®šä¹‰lintå®ç°åŸç†</h3><p>è‡ªå®šä¹‰lintè§„åˆ™æ˜¯ä»¥jarå½¢å¼å­˜åœ¨çš„ï¼Œä¸»è¦é€šè¿‡ç»§æ‰¿ä¸¤ç§ç±»æ¥å®ç°æ‰©å±•lintåŠŸèƒ½ï¼š<br>â‘ ç»§æ‰¿<code>IssueRegistry</code>ï¼šè¿™æ˜¯è‡ªå®šä¹‰Lintè§„åˆ™çš„ä¸»ç±»æˆ–è€…å«æ³¨å†Œç±»ï¼Œæœ‰ä¸”ä»…æœ‰ä¸€ä¸ªï¼Œç”¨æ¥æ³¨å†Œè¿™ä¸ªè‡ªå®šä¹‰Linté¡¹ç›®ä¸­æœ‰å“ªäº›è‡ªå®šä¹‰çš„issueï¼ˆissueå°±æ˜¯éœ€è¦lintæ£€æŸ¥å‡ºæ¥å¹¶æŠ¥å‘Šç»™ç”¨æˆ·çš„å„ç§é—®é¢˜ï¼‰éœ€è¦è¢«æ£€æµ‹ã€‚<br>â‘¡ç»§æ‰¿<code>Detector</code>å¹¶é€‰æ‹©Detectorä¸­åˆé€‚çš„<code>XXXScanner</code>æ¥å£æ¥å®ç°ï¼šåœ¨è¿™é‡Œæ ¹æ®è‡ªèº«ä¸šåŠ¡éœ€æ±‚ï¼Œå®ç°å„ç§è‡ªå®šä¹‰æ¢æµ‹å™¨ï¼ˆDetector),å¹¶å®šä¹‰å„ç§issueï¼Œæ ¹æ®è‡ªèº«éœ€æ±‚çš„ä¸åŒè¿™æ ·çš„ç±»å¯ä»¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªã€‚</p>
<p>äº‹å®ä¸Šï¼ŒAndroidç³»ç»Ÿé»˜è®¤çš„lintæ£€æŸ¥åŠŸèƒ½æ˜¯é€šè¿‡BuiltinIssueRegistryç±»æ¥å®šä¹‰çš„ï¼Œåœ¨è¿™ä¸ªç±»çš„æºç ä¸­å¯ä»¥çœ‹åˆ°å®šä¹‰çš„å„ç§issueã€detectorï¼Œå¦‚å›¾ï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-1-29/69265121.jpg" alt=""></p>
<p><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-1-29/59960096.jpg" alt="">  </p>
<p>com.android.tools.lint.detector.api.Detectoræä¾›äº†7ç§XXXScanneræ¥å£ï¼Œæ ¹æ®è‡ªèº«éœ€è¦é€‰æ‹©åˆé€‚çš„æ¥å£å»å®ç°ï¼Œä¸‹é¢æŠŠè¿™7ä¸ªæ¥å£çš„ä¿¡æ¯åˆ—å‡ºï¼š</p>
<p>1ã€JavaScanner<br>åŠŸèƒ½ï¼šSpecialized interface for detectors that scan Java source file parse trees<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-1-7/55021440.jpg" alt=""></p>
<p>2ã€ClassScanner<br>åŠŸèƒ½ï¼šSpecialized interface for detectors that scan Java class files<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-1-7/63801235.jpg" alt=""></p>
<p>3ã€BinaryResourceScanner<br>åŠŸèƒ½ï¼šSpecialized interface for detectors that scan binary resource files<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-1-7/31784308.jpg" alt=""></p>
<p>4ã€ResourceFolderScanner<br>åŠŸèƒ½ï¼šSpecialized interface for detectors that scan resource folders (the folder directory itself, not the individual files within itï¼‰<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-1-7/81593485.jpg" alt=""></p>
<p>5ã€XmlScanner<br>åŠŸèƒ½ï¼šSpecialized interface for detectors that scan XML files<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-1-7/1707982.jpg" alt=""></p>
<p>6ã€GradleScanner<br>åŠŸèƒ½ï¼šSpecialized interface for detectors that scan Gradle files<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-1-7/5157796.jpg" alt=""></p>
<p>7ã€OtherFileScanner<br>åŠŸèƒ½ï¼šSpecialized interface for detectors that scan other files<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-1-7/94526179.jpg" alt=""></p>
<p><strong>å®ç°è‡ªå®šä¹‰Lintè§„åˆ™çš„è¿‡ç¨‹ï¼Œå®é™…ä¸Šå°±æ˜¯å®ç°detectorçš„è¿‡ç¨‹ï¼Œæ¯ä¸ªdetectorèƒ½å¤Ÿå®šä¹‰1ä¸ªæˆ–å¤šä¸ªä¸åŒç±»å‹çš„issueã€‚</strong>ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªdetectorèƒ½å¤Ÿæ£€æµ‹å¤šç§issueï¼Œè¿™äº›issueåœ¨é€»è¾‘ä¸Šæ˜¯æœ‰å…³è”çš„ï¼Œä½†è¿™äº›issueå¯ä»¥æ‹¥æœ‰ä¸åŒçš„ä¸¥é‡ç¨‹åº¦ã€æè¿°ç­‰ï¼Œå¹¶èƒ½å¤Ÿç‹¬ç«‹åœ°è¢«æŠ‘åˆ¶(suppressï¼Œå³ç¦ç”¨å¯¹è¯¥issueçš„æ£€æŸ¥ï¼‰ã€‚</p>
<h2 id="è‡ªå®šä¹‰lintå®æˆ˜">è‡ªå®šä¹‰lintå®æˆ˜</h2><p>ä¸‹é¢ç®€å•æ¼”ç¤ºä¸€ä¸‹å¼€å‘ä¸€ä¸ªè‡ªå®šä¹‰Lintè§„åˆ™çš„å®Œæ•´æµç¨‹ã€‚  </p>
<p>ã€1ã€‘åœ¨Android Studioä¸­ï¼Œæ‰“å¼€æˆ–æ–°å»ºä¸€ä¸ªå·¥ç¨‹ï¼Œç„¶åç‚¹å‡»ã€File -&gt; New -&gt; New Moduleã€‘ï¼Œåœ¨å¼¹å‡ºçª—å£ä¸­é€‰æ‹©æ–°å»ºä¸€ä¸ªJava Libraryï¼Œå¦‚å›¾ï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-1-7/98524820.jpg" alt=""></p>
<p><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-1-7/27544737.jpg" alt=""></p>
<p>æˆ‘ä»¬è¿™é‡ŒæŠŠJava Libraryå‘½åä¸ºljflintrulesã€‚</p>
<p>ã€2ã€‘è‡ªå®šä¹‰lintè§„åˆ™éœ€è¦ç»§æ‰¿ä¸€äº›ç‰¹å®šçš„ç±»ï¼Œæ‰€ä»¥éœ€è¦åœ¨ljflintrulesçš„build.gradleä¸­æ·»åŠ ä¾èµ–:</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">compile</span> <span class="string">'com.android.tools.lint:lint-api:24.3.1'</span></span><br><span class="line"><span class="keyword">compile</span> <span class="string">'com.android.tools.lint:lint-checks:24.3.1'</span></span><br></pre></td></tr></table></figure>
<p>ã€3ã€‘åœ¨ljflintrulesä¸­æ–°å»ºä¸€ä¸ªLoggerUsageDetectorç±»ï¼Œç”¨æ¥æ£€æµ‹ç”¨æˆ·ä»£ç ä¸­æ˜¯å¦ä½¿ç”¨äº†<code>android.util.Log</code>ç±»ï¼Œå¦‚æœæœ‰ï¼Œå°±æŠ¥å‘Šä¸€ä¸ªissueï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">LoggerUsageDetector</span> <span class="keyword">extends</span> <span class="title">Detector</span></span><br><span class="line">        <span class="keyword">implements</span> <span class="title">Detector</span>.<span class="title">ClassScanner</span> </span>&#123;</span><br><span class="line">    public <span class="literal">static</span> <span class="keyword">final</span> Issue ISSUE = Issue.create(<span class="string">"LogUtilsNotUsed"</span>,</span><br><span class="line">            <span class="string">"You must use our `LogUtils`"</span>,</span><br><span class="line">            <span class="string">"Logging should be avoided in production for security and performance reasons. Therefore, we created a LogUtils that wraps all our calls to Logger and disable them for release flavor."</span>,</span><br><span class="line">            Category.MESSAGES,</span><br><span class="line">            <span class="number">9</span>,</span><br><span class="line">            Severity.ERROR,</span><br><span class="line">            <span class="keyword">new</span> Implementation(LoggerUsageDetector.<span class="keyword">class</span>,</span><br><span class="line">                    Scope.CLASS_FILE_SCOPE));</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    public <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; getApplicableCallNames() &#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(<span class="string">"v"</span>, <span class="string">"d"</span>, <span class="string">"i"</span>, <span class="string">"w"</span>, <span class="string">"e"</span>, <span class="string">"wtf"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    public <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; getApplicableMethodNames() &#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(<span class="string">"v"</span>, <span class="string">"d"</span>, <span class="string">"i"</span>, <span class="string">"w"</span>, <span class="string">"e"</span>, <span class="string">"wtf"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    public <span class="keyword">void</span> checkCall(<span class="annotation">@NonNull</span> ClassContext context,</span><br><span class="line">                          <span class="annotation">@NonNull</span> ClassNode classNode,</span><br><span class="line">                          <span class="annotation">@NonNull</span> MethodNode method,</span><br><span class="line">                          <span class="annotation">@NonNull</span> MethodInsnNode call) &#123;</span><br><span class="line">        <span class="built_in">String</span> owner = call.owner;</span><br><span class="line">        <span class="keyword">if</span> (owner.startsWith(<span class="string">"android/util/Log"</span>)) &#123;</span><br><span class="line">            context.report(ISSUE,</span><br><span class="line">                    method,</span><br><span class="line">                    call,</span><br><span class="line">                    context.getLocation(call),</span><br><span class="line">                    <span class="string">"You must use our `LogUtils`"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªISSUEï¼Œå®šä¹‰æ—¶ä¼ å…¥çš„6ä¸ªå‚æ•°æ„ä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>LogUtilsNotUseds</code>: æˆ‘ä»¬è¿™æ¡lintè§„åˆ™çš„idï¼Œè¿™ä¸ªidå¿…é¡»æ˜¯ç‹¬ä¸€æ— äºŒçš„ã€‚  </li>
<li><code>You must use our &#39;LogUtils&#39;</code>ï¼šå¯¹è¿™æ¡lintè§„åˆ™çš„ç®€çŸ­æè¿°ã€‚</li>
<li><code>Logging should be avoided in production for security and performance reasons. Therefore, we created a LogUtils that wraps all our calls to Logger and disable them for release flavor.</code>ï¼šå¯¹è¿™æ¡lintè§„åˆ™æ›´è¯¦ç»†çš„è§£é‡Šã€‚</li>
<li><code>Category.MESSAGES</code>ï¼šç±»åˆ«ã€‚</li>
<li><code>9</code>ï¼šä¼˜å…ˆçº§ï¼Œå¿…é¡»åœ¨1åˆ°10ä¹‹é—´ã€‚</li>
<li><code>Severity.ERROR</code>ï¼šä¸¥é‡ç¨‹åº¦ã€‚å…¶ä»–å¯ç”¨çš„ä¸¥é‡ç¨‹åº¦è¿˜æœ‰FATALã€WARNINGã€INFORMATIONALã€IGNOREã€‚</li>
<li><code>Implementation</code>ï¼šè¿™æ˜¯è¿æ¥Detectorä¸Scopeçš„æ¡¥æ¢ï¼Œå…¶ä¸­Detectorçš„åŠŸèƒ½æ˜¯å¯»æ‰¾issueï¼Œè€Œscopeå®šä¹‰äº†åœ¨ä»€ä¹ˆèŒƒå›´å†…æŸ¥æ‰¾issueã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å­—èŠ‚ç çº§åˆ«åˆ†æç”¨æˆ·æœ‰æ²¡æœ‰ä½¿ç”¨<code>android.util.Log</code>ã€‚</li>
</ul>
<p>è¿™ä¸ªç±»ä¸­é’ˆå¯¹å­—èŠ‚ç ä¸­çš„android/util/Logè¿›è¡Œäº†æ£€æŸ¥ï¼Œå¹¶åœ¨å‘ç°æ—¶æŠ¥å‘ŠLogUtilsNotUsedè¿™ä¸ªissueã€‚ä½ ä¹Ÿå¯ä»¥åœ¨è¿™ä¸ªç±»ä¸­å®šä¹‰å¤šä¸ªissueï¼Œç„¶ååœ¨ä»£ç é€»è¾‘ä¸­ï¼ˆæ¯”å¦‚checkCallæ–¹æ³•ä¸­ï¼‰é’ˆå¯¹ä¸åŒçš„æƒ…å†µï¼ŒæŠ›å‡ºä¸åŒçš„issueã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªXXXDetectoræ˜¯å¯ä»¥æŠ¥å‘Šå¤šç§issueçš„ã€‚<br>å¦‚æœéœ€è¦æ£€æµ‹æ›´å¤šé—®é¢˜ï¼Œä½ ä¹Ÿå¯ä»¥å®šä¹‰æ›´å¤šçš„XXXDetectorç±»ã€‚XXXDetectorç±»å¯ä»¥æœ‰å¤šä¸ªã€‚</p>
<p>ã€4ã€‘åœ¨ljflintrulesä¸­æ–°å»ºä¸€ä¸ªMyIssueRegistryç±»ï¼Œå®ƒç»§æ‰¿è‡ª<code>IssueRegistry</code>ã€‚è¿™ä¸ªç±»ç”¨æ¥æ³¨å†Œæˆ‘ä»¬è‡ªå·±å®šä¹‰äº†å“ªäº›issueï¼Œè¿™æ ·lintåœ¨æ£€æŸ¥ä»£ç æ—¶æ‰çŸ¥é“è¦é’ˆå¯¹å“ªäº›issueè¿›è¡Œæ£€æŸ¥ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">MyIssueRegistry</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">IssueRegistry</span> &#123;</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    public <span class="type">List</span>&lt;<span class="type">Issue</span>&gt; getIssues() &#123;</span><br><span class="line">        <span class="type">System</span>.out.println(<span class="string">"!!!!!!!!!!!!! ljf MyIssueRegistry lint rules works"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="type">Arrays</span>.asList(<span class="type">LoggerUsageDetector</span>.<span class="type">ISSUE</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªç±»ä¸­åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œå°±æ˜¯è¿”å›ä¸€ä¸ªListï¼Œå…¶ä¸­åŒ…å«äº†æˆ‘ä»¬è‡ªå®šä¹‰çš„æ‰€æœ‰issueã€‚<br>è¿™é‡Œæˆ‘ä»¬ä¸ºäº†èƒ½å¤Ÿåœ¨æ§åˆ¶å°ä¸­æ¸…æ¥šçš„çœ‹åˆ°æˆ‘ä»¬è‡ªå®šä¹‰çš„lintè§„åˆ™æ˜¯å¦è¢«è°ƒç”¨äº†ï¼Œæ‰€ä»¥æ‰“å°äº†ä¸€è¡Œæç¤ºä¿¡æ¯ã€‚    </p>
<p>ã€5ã€‘å¯¹äºè‡ªå®šä¹‰lintç”Ÿæˆçš„jarï¼Œæˆ‘ä»¬å¿…é¡»åœ¨å®ƒçš„æ¸…å•æ–‡ä»¶ä¸­æŒ‡æ˜å®ƒçš„ä¸»ç±»ã€‚è¿™é‡Œæˆ‘ä»¬é€šè¿‡é…ç½®ljflintrulesçš„build.gradleæ–‡ä»¶æ¥å®Œæˆè¿™é¡¹å·¥ä½œï¼š</p>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="name">jar</span> &#123;</span><br><span class="line">    <span class="literal">manifest</span> &#123;</span><br><span class="line">        attributes(<span class="string">'Lint-Registry'</span>: <span class="string">'com.ljf.lintrules.MyIssueRegistry'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨ï¼Œä½ å¯ä»¥åœ¨æ§åˆ¶å°ä¸­é€šè¿‡å‘½ä»¤<code>./gradlew ljflintrules:assemble</code>æ¥æ‰§è¡Œç¼–è¯‘ä»»åŠ¡ï¼Œå°±å¯ä»¥è¾“å‡ºæˆ‘ä»¬éœ€è¦çš„jaræ–‡ä»¶äº†ã€‚ä½ å¯ä»¥åœ¨ljflintruleså·¥ç¨‹ç›®å½•çš„<code>build/libs/</code>ä¸‹æ‰¾åˆ°ljflintrules.jarã€‚  </p>
<p>å¦‚æœä½ æƒ³éªŒè¯è¿™ä¸ªjaræ–‡ä»¶æ˜¯ä¸æ˜¯çœŸçš„æœ‰æ•ˆï¼Œå¯ä»¥æŠŠå®ƒæ‹·è´åˆ°<code>~/.android/lint/</code>ç›®å½•ä¸‹ï¼Œç„¶ååœ¨ç»ˆç«¯ä¸­è¾“å…¥<code>lint --show LogUtilsNotUsed</code>çœ‹çœ‹æœ‰æ²¡æœ‰è¾“å‡ºæˆ‘ä»¬å®šä¹‰çš„issueä¿¡æ¯ï¼Œæœ‰åˆ™è¡¨æ˜è‡ªå®šä¹‰lintæˆåŠŸï¼Œå¦‚å›¾ï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-1-8/27617933.jpg" alt=""></p>
<p>æµ‹è¯•å®Œåè®°å¾—æŠŠå®ƒä»<code>~/.android/lint/</code>ä¸­åˆ é™¤ã€‚</p>
<p>ã€6ã€‘ç”±äºæˆ‘ä»¬è¦æŠŠä¸Šä¸€æ­¥ç”Ÿæˆçš„jaræ–‡ä»¶åŒ…å«åˆ°ä¸€ä¸ªaarä¸­ä¾¿äºç”¨æˆ·ä½¿ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜è¦åœ¨ljflintrulesçš„build.gradleæ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹ä¿¡æ¯ï¼š</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">configurations</span> &#123;</span><br><span class="line">    <span class="title">lintJarOutput</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    <span class="title">lintJarOutput</span> files(jar)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">defaultTasks <span class="string">'assemble'</span></span><br></pre></td></tr></table></figure>
<p>ç»è¿‡ä»¥ä¸Šæ‰€æœ‰æ­¥éª¤ï¼Œç°åœ¨ljflintrulesçš„build.gradleæ–‡ä»¶çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">'java'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="keyword">compile</span> <span class="keyword">fileTree</span>(dir: <span class="string">'libs'</span>, <span class="keyword">include</span>: [<span class="string">'*.jar'</span>])</span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'com.android.tools.lint:lint-api:24.3.1'</span></span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'com.android.tools.lint:lint-checks:24.3.1'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">jar &#123;</span><br><span class="line">    manifest &#123;</span><br><span class="line">        attributes(<span class="string">'Lint-Registry'</span>: <span class="string">'com.ljf.lintrules.MyIssueRegistry'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">configurations</span> &#123;</span><br><span class="line">    lintJarOutput</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    lintJarOutput files(jar)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">defaultTasks <span class="string">'assemble'</span></span><br></pre></td></tr></table></figure>
<p>ã€7ã€‘æ–°å»ºä¸€ä¸ªAndroid Libraryé¡¹ç›®ï¼Œå‘½åä¸ºljflintrule_aarï¼Œç”¨æ¥è¾“å‡ºaarï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-1-7/98524820.jpg" alt=""></p>
<p><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-1-8/8544219.jpg" alt=""></p>
<p>åœ¨ljflintrule_aarçš„build.gradleçš„æ ¹èŠ‚ç‚¹åŠ å…¥ä»¥ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line"> * rules for including "lint.jar" in aar</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">configurations</span> &#123;</span><br><span class="line">    lintJarImport</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    lintJarImport <span class="keyword">project</span>(path: <span class="string">":ljflintrules"</span>, configuration: <span class="string">"lintJarOutput"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">task</span> copyLintJar(type: <span class="keyword">Copy</span>) &#123;</span><br><span class="line">    <span class="keyword">from</span> (<span class="keyword">configurations</span>.lintJarImport) &#123;</span><br><span class="line">        rename &#123;</span><br><span class="line">            String fileName -&gt;</span><br><span class="line">                <span class="string">'lint.jar'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">into</span> <span class="string">'build/intermediates/lint/'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">project</span>.afterEvaluate &#123;</span><br><span class="line">    <span class="keyword">def</span> compileLintTask = <span class="keyword">project</span>.tasks.<span class="keyword">find</span> &#123; it.name == <span class="string">'compileLint'</span> &#125;</span><br><span class="line">    compileLintTask.dependsOn(copyLintJar)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœè¿™æ—¶å†ç¼–è¯‘é¡¹ç›®ï¼Œå°±ä¼šåœ¨ljflintrule_aarçš„è¾“å‡ºç›®å½•ä¸­å¾—åˆ°ä¸€ä¸ªåŒ…å«lint.jarçš„aaræ–‡ä»¶ï¼Œè¿™é‡Œçš„lint.jarå°±æ˜¯æˆ‘ä»¬åœ¨ç¬¬5æ­¥ä¸­ç”Ÿæˆçš„ljflintrules.jarï¼Œåªæ˜¯æ¢äº†ä¸ªåå­—ã€‚</p>
<p>ã€8ã€‘åœ¨ç”¨æˆ·appä¸­ä½¿ç”¨æˆ‘ä»¬çš„è‡ªå®šä¹‰lintã€‚<br>åœ¨ç”¨æˆ·è‡ªå·±çš„åº”ç”¨ç¨‹åºmoduleä¸­ï¼ˆæˆ‘ä»¬è¿™é‡Œå°±ä½¿ç”¨app moduleï¼‰ï¼Œæ‰“å¼€appçš„build.gradleæ–‡ä»¶ï¼Œåœ¨dependenciesä¸­åŠ å…¥ä»¥ä¸‹ä¾èµ–ï¼š  </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="function"><span class="title">project</span><span class="params">(<span class="string">':ljflintrule_aar'</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ä»¬åœ¨appçš„MainActivityä¸­ä½¿ç”¨äº†androidè‡ªå¸¦çš„LogåŠŸèƒ½ï¼š</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">AppCompatActivity</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> void onCreate(<span class="type">Bundle</span> savedInstanceState) &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(<span class="type">R</span>.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="type">Log</span>.d(<span class="string">"tag"</span>, <span class="string">"dasfadsf"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ç»ˆç«¯ä¸­ï¼Œæˆ‘ä»¬æ‰§è¡Œ<code>./gradlew lint</code>æ¥æ‰§è¡Œlintä»»åŠ¡ï¼Œå¯ä»¥åœ¨ç»ˆç«¯ä¸­çœ‹åˆ°ä»¥ä¸‹è¾“å‡ºï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-1-8/11713429.jpg" alt=""></p>
<p>è¾“å‡ºä¸­æŒ‡å‡ºå‘ç°äº†1ä¸ªerrorå’Œ2ä¸ªwarningï¼Œå¹¶ç»™å‡ºäº†è¯¦ç»†æŠ¥å‘Šçš„åœ°å€ã€‚</p>
<p>æˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€htmlæ ¼å¼çš„è¯¦ç»†æŠ¥å‘Šï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-1-8/9825338.jpg" alt=""></p>
<p>ä»¥ä¸Š8ä¸ªæ­¥éª¤å®Œæ•´æ¼”ç¤ºäº†å¦‚ä½•è‡ªå®šä¹‰lintå¹¶ä½¿ç”¨å®ƒã€‚</p>
<h2 id="å°ç»“">å°ç»“</h2><p>æœ¬æ–‡å¯¹äºè‡ªå®šä¹‰Lintè§„åˆ™çš„ä»‹ç»ä¸»è¦æ˜¯é›†ä¸­åœ¨æ€»ä½“å¼€å‘æµç¨‹ï¼Œç»™å‡ºäº†ä¸€ä¸ªç®€å•çš„å®ä¾‹ã€‚åœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬æ¯”è¾ƒå¸¸è§çš„éœ€æ±‚æ˜¯é’ˆå¯¹xmlå¸ƒå±€æ–‡ä»¶ã€javaæºä»£ç ç­‰å†…å®¹è¿›è¡ŒæŸäº›æ£€æŸ¥ï¼Œå—Lintå¼€å‘APIçš„é™åˆ¶éœ€è¦ç”¨åˆ°ASTçš„ç›¸å…³çŸ¥è¯†ï¼Œä»¥åŠlombok.astå¼€æºåº“ã€‚ç”±äºlombok.astå¼€æºåº“å‡ ä¹æ— æ–‡æ¡£å¯ç”¨ï¼Œæ‰€ä»¥è¿˜æ˜¯éœ€è¦èŠ±ä¸€å®šæ—¶é—´æ¥é˜…è¯»è¿™ä¸ªåº“çš„æºç ï¼Œå¹¶ç†Ÿæ‚‰SDKè‡ªå¸¦çš„Lintæºç å¦‚ä½•ä½¿ç”¨è¿™ä¸ªåº“ã€‚å¦‚æœä½ å¯¹è‡ªå®šä¹‰Lintæ„Ÿå…´è¶£ï¼Œå¯ä»¥å…³æ³¨ä¸‹ä¸€ç¯‡æ–‡ç« çš„ç›¸å…³ä»‹ç»ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>æœ€è¿‘åœ¨åšä¸€ä¸ªåŸºäºAndroid Lintçš„è‡ªå®šä¹‰é™æ€ä»£ç æ£€æŸ¥åŠŸèƒ½åº“ï¼Œè¿™é‡Œåšä¸€ä¸ªç®€å•çš„æ€»ç»“ã€‚å‰åŠéƒ¨åˆ†ä»‹ç»SDKè‡ªå¸¦Android Lintçš„åŠŸèƒ½ä¸é…ç½®ä½¿ç”¨æ–¹æ³•ï¼ŒååŠéƒ¨åˆ†ä»‹ç»æ‰©å±•è‡ªå®šä¹‰Lintè§„åˆ™åº“çš„å¼€å‘æµç¨‹ã€‚</p>
<h2 id="ä»€ä¹ˆæ˜¯Android_Lint">ä»€ä¹ˆæ˜¯Android Lint</h2><p>Android Lintæ˜¯ä¸€ä¸ªé™æ€ä»£ç åˆ†æå·¥å…·ï¼Œå®ƒèƒ½å¤Ÿå¯¹ä½ çš„Androidé¡¹ç›®ä¸­æ½œåœ¨çš„bugã€å¯ä¼˜åŒ–çš„ä»£ç ã€å®‰å…¨æ€§ã€æ€§èƒ½ã€å¯ç”¨æ€§ã€å¯è®¿é—®æ€§ã€å›½é™…åŒ–ç­‰è¿›è¡Œæ£€æŸ¥ã€‚  </p>
<p>åœ¨Android SDK Tools 16åŠæ›´é«˜çš„ç‰ˆæœ¬ä¸­ï¼ŒLintå·¥å…·ä¼šè‡ªåŠ¨å®‰è£…ã€‚é€šè¿‡å®ƒå¯¹Androidå·¥ç¨‹æºä»£ç è¿›è¡Œæ‰«æå’Œæ£€æŸ¥ï¼Œå¯å‘ç°æ½œåœ¨çš„é—®é¢˜ï¼Œä»¥ä¾¿ç¨‹åºå‘˜åŠæ—©ä¿®æ­£è¿™ä¸ªé—®é¢˜ã€‚Android Lintæä¾›äº†å‘½ä»¤è¡Œæ–¹å¼æ‰§è¡Œï¼Œè¿˜ä¸IDEï¼ˆå¦‚Android Studioï¼‰è¿›è¡Œäº†é›†æˆï¼Œå¹¶æä¾›äº†xmlå’Œhtmlå½¢å¼çš„è¾“å‡ºæŠ¥å‘Šã€‚  </p>
<p>çœ‹äº†ä¸Šé¢çš„ä»‹ç»å¯èƒ½å¤§å®¶ä¾ç„¶å¾ˆè¿·æƒ‘â€œè¿™è´§åˆ°åº•æœ‰å•¥ç”¨â€ï¼Œå…¶å®æˆ‘ä»¬å¹³æ—¶åœ¨Androidå¼€å‘è¿‡ç¨‹ä¸­ä¸€ç›´åœ¨äº«å—Lintå¸¦æ¥çš„ä¾¿åˆ©ã€‚æ¯”å¦‚ï¼Œä¸‹é¢å›¾ä¸­çš„è­¦å‘Šå’Œé”™è¯¯æç¤ºï¼Œç›¸ä¿¡å¤§å®¶åº”è¯¥å¾ˆç†Ÿæ‚‰å§ï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/16-1-29/23031672.jpg" alt=""></p>]]>
    
    </summary>
    
      <category term="Android" scheme="http://www.carrotsight.com/tags/Android/"/>
    
      <category term="Lint" scheme="http://www.carrotsight.com/tags/Lint/"/>
    
      <category term="custom lint rules" scheme="http://www.carrotsight.com/tags/custom-lint-rules/"/>
    
      <category term="Android" scheme="http://www.carrotsight.com/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Javaä¸­çš„Pluggable Annotation Processing API]]></title>
    <link href="http://www.carrotsight.com/2016/01/13/2016-1-13-Java%E4%B8%AD%E7%9A%84Pluggable-Annotation-Processing-API.html"/>
    <id>http://www.carrotsight.com/2016/01/13/2016-1-13-Javaä¸­çš„Pluggable-Annotation-Processing-API.html</id>
    <published>2016-01-13T09:42:16.000Z</published>
    <updated>2016-04-21T07:09:17.000Z</updated>
    <content type="html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯Java_Annotation">ä»€ä¹ˆæ˜¯Java Annotation</h2><p>æ³¨è§£ï¼ˆAnnotationï¼‰æœºåˆ¶ä»Java 5å¼€å§‹è¢«å¼•å…¥ï¼Œå®ƒèƒ½å¤Ÿå‘æºä»£ç ä¸­æ·»åŠ å¥æ³•ï¼ˆsyntactic)å…ƒæ•°æ®ã€‚ç±»ã€æ–¹æ³•ã€å˜é‡ï¼ˆvariablesï¼‰ã€å‚æ•°ï¼ˆparametersï¼‰ã€åŒ…ï¼ˆpackagesï¼‰éƒ½å¯ä»¥è¢«æ³¨è§£ã€‚ä¸Javadocæ ‡ç­¾ä¸åŒï¼ŒJavaæ³¨è§£ï¼ˆAnnotationï¼‰èƒ½å¤Ÿè¢«åå°„ï¼Œå› ä¸ºå®ƒä»¬èƒ½å¤Ÿè¢«åµŒå…¥åœ¨ç¼–è¯‘å™¨ç”Ÿæˆçš„classæ–‡ä»¶ä¸­ï¼Œå¹¶ä¸”å¯ä»¥è¢«Javaè™šæ‹Ÿæœºä¿ç•™ä½¿å¾—åœ¨è¿è¡Œæ—¶ä¹Ÿå¯è·å–ã€‚  </p>
<a id="more"></a>
<p>Javaå®šä¹‰äº†ä¸€ç³»åˆ—å†…å»ºçš„æ³¨è§£ï¼Œåˆ†ä¸ºä¸¤ç±»ï¼š  </p>
<p>â‘ ç”¨äºJavaä»£ç çš„æ³¨è§£</p>
<ul>
<li>@Override</li>
<li>@Deprecated</li>
<li>@SuppressWarnings</li>
<li>@SafeVarargs</li>
<li>@FunctionalInterface</li>
</ul>
<p>â‘¡ç”¨äºå…¶ä»–æ³¨è§£çš„æ³¨è§£ï¼ˆä¹Ÿå°±æ˜¯â€œå…ƒæ³¨è§£â€ï¼ˆMeta Annotationï¼‰ï¼‰  </p>
<ul>
<li>@Retention</li>
<li>@Documented</li>
<li>@Target</li>
<li>@Inherited</li>
<li>@Repeatable</li>
</ul>
<h2 id="å¦‚ä½•å®ç°è‡ªå®šä¹‰æ³¨è§£">å¦‚ä½•å®ç°è‡ªå®šä¹‰æ³¨è§£</h2><p>è‡ªå®šä¹‰æ³¨è§£çš„å®ç°éå¸¸ç®€å•ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Same as: @Edible(value = true)</span></span><br><span class="line">  <span class="annotation">@Edible</span>(<span class="keyword">true</span>)</span><br><span class="line">  Item item = <span class="keyword">new</span> Carrot();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="annotation">@interface</span> Edible &#123;</span><br><span class="line">      <span class="function"><span class="keyword">boolean</span> <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@Author</span>(first = <span class="string">"Oompah"</span>, last = <span class="string">"Loompah"</span>)</span><br><span class="line">  Book book = <span class="keyword">new</span> Book();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="annotation">@interface</span> Author &#123;</span><br><span class="line">      <span class="function">String <span class="title">first</span><span class="params">()</span></span>;</span><br><span class="line">      <span class="function">String <span class="title">last</span><span class="params">()</span></span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç å®šä¹‰äº†2ä¸ªæ³¨è§£ï¼Œå¹¶ä½¿ç”¨äº†å®ƒä»¬ã€‚å½“æ³¨è§£ä¸­ä½¿ç”¨çš„å±æ€§åä¸ºvalueæ—¶ï¼Œå¯¹å…¶èµ‹å€¼æ—¶å¯ä»¥ä¸æŒ‡å®šå±æ€§çš„åç§°è€Œç›´æ¥å†™ä¸Šå±æ€§å€¼æ¥å£ï¼›é™¤äº†valueä»¥å¤–çš„å˜é‡åéƒ½éœ€è¦ä½¿ç”¨name=valueçš„æ–¹å¼èµ‹å€¼ã€‚  </p>
<p>å¦å¤–ï¼Œå¯ä»¥ç”¨@Retentionå’Œ@Targetå…ƒæ³¨è§£æ¥åˆ†åˆ«åˆ¶å®šè‡ªå®šä¹‰æ³¨è§£çš„ä¿ç•™ç­–ç•¥å’Œä½œç”¨èŒƒå›´ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Retention</span>(RetentionPolicy.RUNTIME) <span class="comment">// Make this annotation accessible at runtime via reflection.</span></span><br><span class="line"><span class="annotation">@Target</span>(&#123;ElementType.METHOD&#125;)       <span class="comment">// This annotation can only be applied to class methods.</span></span><br><span class="line"><span class="keyword">public</span> <span class="annotation">@interface</span> Tweezable &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>@Retentionå…ƒæ³¨è§£çš„å¯ä»¥å–ä»¥ä¸‹å€¼ï¼š</p>
<blockquote>
<p>CLASS:<br>ç¼–è¯‘å™¨å°†æŠŠæ³¨é‡Šè®°å½•åœ¨ç±»æ–‡ä»¶ä¸­ï¼Œä½†åœ¨è¿è¡Œæ—¶ VM ä¸éœ€è¦ä¿ç•™æ³¨é‡Šã€‚<br>RUNTIME:<br>ç¼–è¯‘å™¨å°†æŠŠæ³¨é‡Šè®°å½•åœ¨ç±»æ–‡ä»¶ä¸­ï¼Œåœ¨è¿è¡Œæ—¶ VM å°†ä¿ç•™æ³¨é‡Šï¼Œå› æ­¤å¯ä»¥åå°„æ€§åœ°è¯»å–ã€‚<br>SOURCE:<br>ç¼–è¯‘å™¨è¦ä¸¢å¼ƒçš„æ³¨é‡Šã€‚</p>
</blockquote>
<p>@Targetå¯ä»¥å–ä»¥ä¸‹å€¼ï¼š</p>
<blockquote>
<p>TYPE:Class, interface or enum declaration.<br>    FIELD:Field declaration.<br>    METHOD:Method declaration.<br>    PARAMETER:Parameter declaration.<br>    CONSTRUCTOR:Constructor declaration.<br>    LOCAL_VARIABLE:Local variable declaration.<br>    ANNOTATION_TYPE:Annotation type declaration.<br>    PACKAGE:Package declaration.</p>
</blockquote>
<p>å®šä¹‰å¹¶ä½¿ç”¨äº†æ³¨è§£åï¼Œæˆ‘ä»¬è¦å–åˆ°æ³¨è§£ä¸­çš„å€¼å¹¶å¤„ç†å®ƒï¼Œè¿™ä¸ªè‡ªå®šä¹‰æ³¨è§£æ‰æœ‰æ„ä¹‰ã€‚</p>
<h2 id="åå°„çš„æ–¹å¼ä½¿ç”¨æ³¨è§£">åå°„çš„æ–¹å¼ä½¿ç”¨æ³¨è§£</h2><p>è¿™æ˜¯æœ€ç®€å•æœ€å¸¸è§çš„ä½¿ç”¨è‡ªå®šä¹‰æ³¨è§£çš„æ–¹å¼ï¼Œå…·ä½“æ–¹æ³•æ˜¯æŠŠè‡ªå®šä¹‰æ³¨è§£çš„@Retentionå®šä¹‰ä¸ºRUNTIMEï¼Œç„¶ååœ¨ä»£ç ä¸­åˆ©ç”¨javaåå°„æœºåˆ¶è¯»å–æ³¨è§£çš„å±æ€§å€¼ã€‚  </p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­ï¼š<br>â‘ å®šä¹‰@Testå’Œ@TesterInfoè¿™2ä¸ªæ³¨è§£ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Test.java</span></span><br><span class="line"><span class="keyword">package</span> com.mkyong.test.core;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="annotation">@Target</span>(ElementType.METHOD) <span class="comment">//can use in method only.</span></span><br><span class="line"><span class="keyword">public</span> <span class="annotation">@interface</span> Test &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//should ignore this test?</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">enabled</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">true</span></span>;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//TesterInfo.java</span></span><br><span class="line"><span class="keyword">package</span> com.mkyong.test.core;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.ElementType;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="annotation">@Target</span>(ElementType.TYPE) <span class="comment">//on class level</span></span><br><span class="line"><span class="keyword">public</span> <span class="annotation">@interface</span> TesterInfo &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">enum</span> Priority &#123;</span><br><span class="line">	   LOW, MEDIUM, HIGH</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">Priority <span class="title">priority</span><span class="params">()</span> <span class="keyword">default</span> Priority.MEDIUM</span>;</span><br><span class="line">	</span><br><span class="line">	String[] tags() <span class="keyword">default</span> <span class="string">""</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function">String <span class="title">createdBy</span><span class="params">()</span> <span class="keyword">default</span> "Mkyong"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function">String <span class="title">lastModified</span><span class="params">()</span> <span class="keyword">default</span> "03/01/2014"</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>â‘¡åˆ›å»ºä¸€ä¸ªç®€å•çš„å•å…ƒæµ‹è¯•TestExample.javaï¼Œä½¿ç”¨ä¸Šé¢å®šä¹‰çš„ä¸¤ä¸ªæ³¨è§£ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//TestExample.java</span></span><br><span class="line"><span class="keyword">package</span> com.mkyong.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mkyong.test.core.Test;</span><br><span class="line"><span class="keyword">import</span> com.mkyong.test.core.TesterInfo;</span><br><span class="line"><span class="keyword">import</span> com.mkyong.test.core.TesterInfo.Priority;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@TesterInfo</span>(</span><br><span class="line">	priority = Priority.HIGH, </span><br><span class="line">	createdBy = <span class="string">"mkyong.com"</span>,  </span><br><span class="line">	tags = &#123;<span class="string">"sales"</span>,<span class="string">"test"</span> &#125;</span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestExample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">testA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	  <span class="keyword">if</span> (<span class="keyword">true</span>)</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"This test always failed"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Test</span>(enabled = <span class="keyword">false</span>)</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">testB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	  <span class="keyword">if</span> (<span class="keyword">false</span>)</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"This test always passed"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Test</span>(enabled = <span class="keyword">true</span>)</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">testC</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	  <span class="keyword">if</span> (<span class="number">10</span> &gt; <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="comment">// do nothing, this test always passed.</span></span><br><span class="line">	  &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>â‘¢ä½¿ç”¨Javaåå°„APIè¯»å–å¹¶å¤„ç†ç¬¬â‘¡æ­¥ä¸­ä½¿ç”¨çš„è‡ªå®šä¹‰æ³¨è§£ï¼Œå¦‚ä¸‹æ‰€ç¤º:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//RunTest.java</span></span><br><span class="line"><span class="keyword">package</span> com.mkyong.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Annotation;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mkyong.test.core.Test;</span><br><span class="line"><span class="keyword">import</span> com.mkyong.test.core.TesterInfo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RunTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">	System.out.println(<span class="string">"Testing..."</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> passed = <span class="number">0</span>, failed = <span class="number">0</span>, count = <span class="number">0</span>, ignore = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	Class&lt;TestExample&gt; obj = TestExample.class;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Process @TesterInfo</span></span><br><span class="line">	<span class="keyword">if</span> (obj.isAnnotationPresent(TesterInfo.class)) &#123;</span><br><span class="line"></span><br><span class="line">		Annotation annotation = obj.getAnnotation(TesterInfo.class);</span><br><span class="line">		TesterInfo testerInfo = (TesterInfo) annotation;</span><br><span class="line"></span><br><span class="line">		System.out.printf(<span class="string">"%nPriority :%s"</span>, testerInfo.priority());</span><br><span class="line">		System.out.printf(<span class="string">"%nCreatedBy :%s"</span>, testerInfo.createdBy());</span><br><span class="line">		System.out.printf(<span class="string">"%nTags :"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">int</span> tagLength = testerInfo.tags().length;</span><br><span class="line">		<span class="keyword">for</span> (String tag : testerInfo.tags()) &#123;</span><br><span class="line">			<span class="keyword">if</span> (tagLength &gt; <span class="number">1</span>) &#123;</span><br><span class="line">				System.out.print(tag + <span class="string">", "</span>);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				System.out.print(tag);</span><br><span class="line">			&#125;</span><br><span class="line">			tagLength--;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		System.out.printf(<span class="string">"%nLastModified :%s%n%n"</span>, testerInfo.lastModified());</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Process @Test</span></span><br><span class="line">	<span class="keyword">for</span> (Method method : obj.getDeclaredMethods()) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// if method is annotated with @Test</span></span><br><span class="line">		<span class="keyword">if</span> (method.isAnnotationPresent(Test.class)) &#123;</span><br><span class="line"></span><br><span class="line">			Annotation annotation = method.getAnnotation(Test.class);</span><br><span class="line">			Test test = (Test) annotation;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// if enabled = true (default)</span></span><br><span class="line">			<span class="keyword">if</span> (test.enabled()) &#123;</span><br><span class="line"></span><br><span class="line">			  <span class="keyword">try</span> &#123;</span><br><span class="line">				method.invoke(obj.newInstance());</span><br><span class="line">				System.out.printf(<span class="string">"%s - Test '%s' - passed %n"</span>, ++count, method.getName());</span><br><span class="line">				passed++;</span><br><span class="line">			  &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">				System.out.printf(<span class="string">"%s - Test '%s' - failed: %s %n"</span>, ++count, method.getName(), ex.getCause());</span><br><span class="line">				failed++;</span><br><span class="line">			  &#125;</span><br><span class="line"></span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				System.out.printf(<span class="string">"%s - Test '%s' - ignored%n"</span>, ++count, method.getName());</span><br><span class="line">				ignore++;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	System.out.printf(<span class="string">"%nResult : Total : %d, Passed: %d, Failed %d, Ignore %d%n"</span>, count, passed, failed, ignore);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œä¸Šé¢çš„ç¤ºä¾‹ä»£ç ï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<blockquote>
<p>Testingâ€¦</p>
<p>Priority :HIGH<br>CreatedBy :mkyong.com<br>Tags :sales, test<br>LastModified :03/01/2014</p>
<p>1 - Test â€˜testAâ€™ - failed: java.lang.RuntimeException: This test always failed<br>2 - Test â€˜testCâ€™ - passed<br>3 - Test â€˜testBâ€™ - ignored</p>
<p>Result : Total : 3, Passed: 1, Failed 1, Ignore 1</p>
</blockquote>
<h2 id="ä¸ç¼–è¯‘å™¨ç»“åˆçš„æ–¹æ³•æ¥ä½¿ç”¨æ³¨è§£">ä¸ç¼–è¯‘å™¨ç»“åˆçš„æ–¹æ³•æ¥ä½¿ç”¨æ³¨è§£</h2><p>åå°„çš„æ–¹æ³•å±€é™æ€§è¾ƒå¤§ã€‚é¦–å…ˆï¼Œå®ƒå¿…é¡»å®šä¹‰@Retentionä¸ºRetentionPolicy.RUNTIMEï¼Œåªèƒ½åœ¨è¿è¡Œæ—¶é€šè¿‡åå°„æ¥è·å–æ³¨è§£å€¼ï¼Œä½¿å¾—è¿è¡Œæ—¶ä»£ç æ•ˆç‡é™ä½ã€‚å…¶æ¬¡ï¼Œå¦‚æœæƒ³åœ¨ç¼–è¯‘é˜¶æ®µåˆ©ç”¨æ³¨è§£æ¥è¿›è¡Œä¸€äº›æ£€æŸ¥ï¼Œå¯¹ç”¨æˆ·çš„æŸäº›ä¸åˆç†ä»£ç ç»™å‡ºé”™è¯¯æŠ¥å‘Šï¼Œåå°„çš„ä½¿ç”¨æ–¹æ³•å°±æ— èƒ½ä¸ºåŠ›äº†ã€‚  </p>
<p>è¦æŠŠæ³¨è§£ä¸Javaç¼–è¯‘å™¨ç»“åˆä½¿ç”¨ï¼ŒJavaä¹Ÿç»™å‡ºäº†è§£å†³æ–¹æ¡ˆã€‚Java 5åœ¨å¼•å…¥annotationçš„åŒæ—¶ï¼Œä¹Ÿå¼•å…¥äº†Annotation Processing Tool (apt)ï¼Œè¿™æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œèƒ½å¤Ÿæä¾›æ„å»ºæ—¶ï¼ˆbuild-timeï¼‰ã€åŸºäºæºä»£ç (source-basedï¼‰å¯¹ç¨‹åºç»“æ„çš„è¯»å–åŠŸèƒ½ï¼Œèƒ½å¤Ÿé€šè¿‡è¿è¡Œæ³¨è§£å¤„ç†å™¨æ¥ç”Ÿæˆæ–°çš„ä¸­é—´æ–‡ä»¶è¿›è€Œå½±å“ç¼–è¯‘è¿›ç¨‹ã€‚ä¸è¿‡ï¼Œaptåœ¨Java 8ä¸­è¢«ç§»é™¤äº†ã€‚  </p>
<p>ä½œä¸ºæ›¿ä»£æ–¹æ¡ˆï¼Œå¯ä»¥ä½¿ç”¨JSR 269 annotation processing facilityï¼Œè¿™ä¸ªæœºåˆ¶èƒ½å¤Ÿåœ¨ç¼–è¯‘é˜¶æ®µä½¿ç”¨æ³¨è§£ä¿¡æ¯ï¼Œè¯¥æœºåˆ¶æ˜¯ä»JDK 6å¼€å§‹è¢«å¼•å…¥çš„ã€‚JSR 269çš„æ ‡é¢˜æ˜¯Pluggable Annotation Processing APIï¼Œå®šä¹‰äº†ä¸€å¥—å¯æ’æ‹”çš„æ¥å£ç”¨æ¥å¼€å‘æ„å»ºæ—¶æ³¨è§£å¤„ç†å™¨ï¼Œç”¨æ’ä»¶æœºåˆ¶æ¥æ‰©å±•Javaç¼–è¯‘å™¨ã€‚</p>
<p>JSR 269åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š<br>â‘ æ¨¡æ‹ŸJavaç¼–ç¨‹è¯­è¨€çš„API<br>â‘¡ç¼–å†™æ³¨è§£å¤„ç†å™¨çš„API  </p>
<p>è¿™2éƒ¨åˆ†åˆ†åˆ«ä½äºåŒ…javax.lang.model.*å’Œjavax.annotation.processingä¸­ã€‚  </p>
<p>JSR 269çš„åŠŸèƒ½é€šè¿‡javacå‘½ä»¤è¡Œçš„æ–°é€‰é¡¹æš´éœ²å‡ºæ¥ï¼š  </p>
<table>
<thead>
<tr>
<th>é€‰é¡¹</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>-proc:{none,only}</td>
<td>æ§åˆ¶æ˜¯å¦æ‰§è¡Œæ³¨é‡Šå¤„ç†å’Œ/æˆ–ç¼–è¯‘ã€‚</td>
</tr>
<tr>
<td>-processor <class1>[,<class2>,<class3>â€¦]</class3></class2></class1></td>
<td>è¦è¿è¡Œçš„æ³¨é‡Šå¤„ç†ç¨‹åºçš„åç§°; ç»•è¿‡é»˜è®¤çš„æœç´¢è¿›ç¨‹</td>
</tr>
<tr>
<td>-processorpath &lt;è·¯å¾„&gt;</td>
<td>æŒ‡å®šæŸ¥æ‰¾æ³¨é‡Šå¤„ç†ç¨‹åºçš„ä½ç½®</td>
</tr>
</tbody>
</table>
<p>javacé»˜è®¤å¯ç”¨äº†æ³¨è§£å¤„ç†ã€‚å¦‚æœéœ€è¦ä»…è¿è¡Œæ³¨è§£å¤„ç†è€Œä¸æŠŠæºä»£ç ç¼–è¯‘æˆclassæ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨<code>-proc:only</code>é€‰é¡¹ã€‚  </p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š  </p>
<p>â‘ å®šä¹‰ä¸€ä¸ªåä¸ºHelloWorldçš„æ³¨è§£ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="annotation">@interface</span> HelloWorld &#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>â‘¡åœ¨ç±»Dummyä¸­ä½¿ç”¨ä¸Šé¢å®šä¹‰çš„æ³¨è§£ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@HelloWorld</span>                                                                                                                                  </span><br><span class="line">	<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dummy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>â‘¢ç»§æ‰¿AbstractProcessorå®ç°è‡ªå®šä¹‰Processorï¼Œå¹¶ä½¿ç”¨@SupportedAnnotationTypeså’Œ@SupportedSourceVersionæ¥æ ‡è¯†è¯¥Processorè¦å¤„ç†çš„æ³¨è§£å’Œæ”¯æŒçš„javaç‰ˆæœ¬ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Set;                                                                                                                        </span><br><span class="line"><span class="keyword">import</span> javax.annotation.processing.*;                                                                                                        </span><br><span class="line"><span class="keyword">import</span> javax.lang.model.SourceVersion;                                                                                                       </span><br><span class="line"><span class="keyword">import</span> javax.lang.model.element.TypeElement;                                                                                                 </span><br><span class="line"><span class="keyword">import</span> javax.tools.Diagnostic;                                                                                                               </span><br><span class="line">                                                                                                                                             </span><br><span class="line"><span class="annotation">@SupportedAnnotationTypes</span>(<span class="string">"HelloWorld"</span>)                                                                                                      </span><br><span class="line"><span class="annotation">@SupportedSourceVersion</span>(SourceVersion.RELEASE_6)                                                                                             </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span></span>&#123;                                                                                  </span><br><span class="line">                                                                                                                                             </span><br><span class="line">    <span class="annotation">@Override</span>                                                                                                                                </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnv)</span> </span>&#123;                                                                     </span><br><span class="line">        <span class="keyword">super</span>.init(processingEnv);                                                                                                           </span><br><span class="line">    &#125;                                                                                                                                        </span><br><span class="line">                                                                                                                                             </span><br><span class="line">    <span class="annotation">@Override</span>                                                                                                                                </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> </span>&#123;                                              </span><br><span class="line">        <span class="keyword">if</span> (!roundEnv.processingOver()) &#123;                                                                                                    </span><br><span class="line">            processingEnv.getMessager().printMessage(Diagnostic.Kind.NOTE, <span class="string">"Hello Worlds!"</span>);                                                 </span><br><span class="line">        &#125;                                                                                                                                    </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;                                                                                                                         </span><br><span class="line">    &#125;                                                                                                                                        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>â‘£è¿è¡Œä¸Šé¢çš„ä¾‹å­ï¼š</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">javac</span> <span class="tag">HelloWorldProcessor</span><span class="class">.java</span><span class="tag">javac</span> <span class="tag">-processor</span> <span class="tag">HelloWorldProcessor</span> *<span class="class">.java</span></span><br></pre></td></tr></table></figure>
<p>å¾—åˆ°çš„è¾“å‡ºä¸ºï¼š</p>
<blockquote>
<p>Note: Hello Worlds!</p>
</blockquote>
<p>JSR 269å®šä¹‰çš„APIçš„è¯¦ç»†ä¿¡æ¯ï¼Œå¯ä»¥åœ¨<a href="https://www.jcp.org/en/jsr/detail?id=269" target="_blank" rel="external">Java Community Processç½‘ç«™</a>æŸ¥çœ‹ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="ä»€ä¹ˆæ˜¯Java_Annotation">ä»€ä¹ˆæ˜¯Java Annotation</h2><p>æ³¨è§£ï¼ˆAnnotationï¼‰æœºåˆ¶ä»Java 5å¼€å§‹è¢«å¼•å…¥ï¼Œå®ƒèƒ½å¤Ÿå‘æºä»£ç ä¸­æ·»åŠ å¥æ³•ï¼ˆsyntactic)å…ƒæ•°æ®ã€‚ç±»ã€æ–¹æ³•ã€å˜é‡ï¼ˆvariablesï¼‰ã€å‚æ•°ï¼ˆparametersï¼‰ã€åŒ…ï¼ˆpackagesï¼‰éƒ½å¯ä»¥è¢«æ³¨è§£ã€‚ä¸Javadocæ ‡ç­¾ä¸åŒï¼ŒJavaæ³¨è§£ï¼ˆAnnotationï¼‰èƒ½å¤Ÿè¢«åå°„ï¼Œå› ä¸ºå®ƒä»¬èƒ½å¤Ÿè¢«åµŒå…¥åœ¨ç¼–è¯‘å™¨ç”Ÿæˆçš„classæ–‡ä»¶ä¸­ï¼Œå¹¶ä¸”å¯ä»¥è¢«Javaè™šæ‹Ÿæœºä¿ç•™ä½¿å¾—åœ¨è¿è¡Œæ—¶ä¹Ÿå¯è·å–ã€‚  </p>]]>
    
    </summary>
    
      <category term="Annotation" scheme="http://www.carrotsight.com/tags/Annotation/"/>
    
      <category term="Java" scheme="http://www.carrotsight.com/tags/Java/"/>
    
      <category term="åå°„" scheme="http://www.carrotsight.com/tags/%E5%8F%8D%E5%B0%84/"/>
    
      <category term="Java" scheme="http://www.carrotsight.com/categories/Java/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Androidä¸­çš„Proguard]]></title>
    <link href="http://www.carrotsight.com/2015/12/22/Android%E4%B8%AD%E7%9A%84Proguard.html"/>
    <id>http://www.carrotsight.com/2015/12/22/Androidä¸­çš„Proguard.html</id>
    <published>2015-12-22T06:21:56.000Z</published>
    <updated>2016-05-27T03:31:28.000Z</updated>
    <content type="html"><![CDATA[<h1 id="ä»€ä¹ˆæ˜¯ProGuard">ä»€ä¹ˆæ˜¯ProGuard</h1><p>ProGuardæ˜¯ä¸€æ¬¾å…è´¹çš„Java classæ–‡ä»¶æ”¶ç¼©å™¨ã€ä¼˜åŒ–å™¨ã€æ··æ·†å™¨å’Œé¢„æ ¡éªŒå™¨ã€‚<br>ProGuard å·²é›†æˆåˆ° Android æ„å»ºç³»ç»Ÿï¼Œå®ƒé€šè¿‡ç§»é™¤æ— ç”¨çš„ä»£ç ä»¥åŠä½¿ç”¨è¯­ä¹‰éšæ™¦çš„åç§°æ¥é‡å‘½åç±»ã€å­—æ®µå’Œæ–¹æ³•ï¼Œä»è€Œè¾¾åˆ°å‹ç¼©ã€ä¼˜åŒ–å’Œæ··æ·†ä»£ç çš„ç›®çš„ã€‚æœ€ç»ˆæ‚¨å°†è·å¾—ä¸€ä¸ªè¾ƒå°çš„ .apk æ–‡ä»¶ï¼Œæ­¤æ–‡ä»¶æ›´éš¾äºè¿›è¡Œåå‘å·¥ç¨‹ã€‚ç”±äº ProGuard ä¼šä½¿åº”ç”¨æ›´éš¾äºè¿›è¡Œåå‘å·¥ç¨‹ï¼Œå› æ­¤å½“åº”ç”¨ä½¿ç”¨å¯¹å®‰å…¨æ€§è¦æ±‚æé«˜çš„åŠŸèƒ½æ—¶ï¼ˆä¾‹å¦‚ï¼Œå½“æ‚¨å‘åº”ç”¨æˆäºˆè®¸å¯æ—¶ï¼‰ï¼Œæ‚¨å¿…é¡»ä½¿ç”¨æ­¤å·¥å…·ã€‚å½“æ‚¨åœ¨è°ƒè¯•æ¨¡å¼ä¸‹æ„å»ºåº”ç”¨æ—¶ï¼Œå°±æ— éœ€å¤„ç†æ··æ·†åçš„ä»£ç ã€‚æ˜¯å¦è¿è¡Œ ProGuard å®Œå…¨ç”±æ‚¨å†³å®šã€‚<br>Proguardé€šè¿‡åˆ é™¤ä»£ç ä¸­åœ¨è¿è¡ŒæœŸé—´ä¸æ˜¯ç»å¯¹å¿…è¦çš„ä¿¡æ¯ï¼Œæ¥é˜²æ­¢é™æ€åˆ†æã€‚ç›¸æ¯”äºæŠŠä»£ç æŒ‰ç…§å®ƒåŸæ¥çš„æ ·å­å‘ˆç°å‡ºæ¥ï¼Œè¿™å·²ç»å‰è¿›äº†ä¸€å¤§æ­¥ï¼Œä½†å®ƒä»ç„¶æ˜¯ä¸€ç§è¢«åŠ¨çš„æ–¹æ³•ã€‚<br>ProGuardçš„æä¾›è€…åŒæ—¶æä¾›äº†å¦å¤–ä¸¤ç§é’ˆå¯¹Androidå¹³å°çš„æ›´é«˜çº§çš„å·¥å…·ï¼šDexguardå’ŒDexguard Enterpriseï¼Œèƒ½å¤ŸæŠµå¾¡é™æ€åˆ†æå’ŒåŠ¨æ€åˆ†æã€‚å®ƒä»¬å…¼å®¹ProGuardçš„é…ç½®ï¼Œå¹¶ä¸ºé¢å¤–çš„åŠŸèƒ½æä¾›äº†é¢å¤–çš„é€‰é¡¹ã€‚å¦‚æœä½ éœ€è¦æ›´é«˜çš„å®‰å…¨æ€§æ¥é˜²æ­¢ä½ çš„ä»£ç è¢«é€†å‘åˆ†æï¼Œå¯ä»¥å°è¯•è¿™ä¸¤ä¸ªå·¥å…·ï¼Œä¸è¿‡å®ƒä»¬æ˜¯æ”¶è´¹çš„ã€‚  </p>
<p>ä¸‰è€…çš„å¯¹æ¯”å¦‚ä¸‹ï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/15-12-17/95797670.jpg" alt=""></p>
<a id="more"></a>
<h1 id="å·¥ä½œæµç¨‹">å·¥ä½œæµç¨‹</h1><p>ProGuardçš„åŠŸèƒ½åŒ…å«æ”¶ç¼©(shrink)ã€ä¼˜åŒ–ã€æ··æ·†ã€é¢„æ ¡éªŒ4ä¸ªæ­¥éª¤ï¼Œæ¯ä¸€æ­¥çš„å…·ä½“å·¥ä½œå¦‚ä¸‹ï¼š</p>
<ul>
<li>æ”¶ç¼©ï¼ˆshrinkï¼‰ï¼šæ£€æµ‹å’Œåˆ é™¤æœªä½¿ç”¨çš„ç±»ã€å­—æ®µã€æ–¹æ³•ã€å±æ€§ã€‚ProGuardä»è¿™äº›ç§å­å¼€å§‹é€’å½’å†³å®šå“ªäº›ç±»ä»¥åŠç±»æˆå‘˜æ˜¯è¢«ä½¿ç”¨çš„ã€‚æ‰€æœ‰å…¶ä»–çš„ç±»å’Œç±»æˆå‘˜éƒ½è¢«ä¸¢å¼ƒã€‚</li>
<li>ä¼˜åŒ–ï¼ˆoptimizationï¼‰ï¼šåˆ†æå’Œä¼˜åŒ–å„ä¸ªæ–¹æ³•çš„å­—èŠ‚ç ã€‚ProGuardæ›´è¿›ä¸€æ­¥ä¼˜åŒ–ä»£ç ã€‚é™¤äº†å…¶ä»–çš„ä¸€äº›ä¼˜åŒ–æ“ä½œå¤–ï¼Œè¿˜æŠŠä¸æ˜¯å…¥å£ç‚¹çš„ç±»å’Œæ–¹æ³•å˜æˆprivateã€staticæˆ–è€…finalï¼ŒæŠŠæœªä½¿ç”¨è¿‡çš„å‚æ•°åˆ é™¤ï¼ŒæŠŠæŸäº›æ–¹æ³•å˜æˆå†…è”çš„ï¼ˆinlineï¼‰ã€‚</li>
<li>æ··æ·†ï¼ˆobfuscationï¼‰ï¼šæŠŠå‰©ä¸‹ï¼ˆå³éå…¥å£ç‚¹ï¼‰çš„ç±»ã€å­—æ®µã€æ–¹æ³•é‡å‘½åä¸ºç®€çŸ­è€Œæ— æ„ä¹‰çš„åå­—ã€‚åœ¨æ•´ä¸ªå¤„ç†æµç¨‹ä¸­ï¼Œä¿æŒï¼ˆkeepingï¼‰å…¥å£ç‚¹å¯ä»¥ç¡®ä¿å®ƒä»¬ä»ç„¶èƒ½å¤Ÿè¢«ç”¨åŸæ¥çš„åå­—è®¿é—®ã€‚</li>
<li>é¢„æ ¡éªŒï¼ˆpreverificationï¼‰ï¼šå‘classä¸­æ·»åŠ é¢„æ ¡éªŒä¿¡æ¯ï¼Œè¿™å¯¹Java Micro Editionæ¥è¯´æ˜¯å¿…é¡»çš„ï¼ŒåŒæ—¶ä¹Ÿèƒ½å¤Ÿæé«˜ä»£ç åœ¨Jave 6ä¸Šçš„å¯åŠ¨é€Ÿåº¦ã€‚é¢„æ ¡éªŒæ­¥éª¤æ˜¯å”¯ä¸€ä¸éœ€è¦çŸ¥é“å“ªäº›æ˜¯å…¥å£ç‚¹çš„ä¸€ä¸ªæ­¥éª¤ã€‚</li>
</ul>
<p><img src="http://7xle8x.com1.z0.glb.clouddn.com/15-12-21/47337390.jpg" alt=""></p>
<p>å…¶ä¸­æ”¶ç¼©ã€ä¼˜åŒ–ã€æ··æ·†è¿™3æ­¥ä½¿å¾—ä»£ç ä½“ç§¯æ›´å°ã€æ›´é«˜æ•ˆã€æ›´éš¾ä»¥è¢«é€†å‘å·¥ç¨‹ã€‚4ä¸ªæ­¥éª¤ä¸­çš„æ¯ä¸€æ­¥éƒ½æ˜¯å¯é€‰çš„ã€‚  </p>
<h2 id="å…¥å£ç‚¹ï¼ˆEntry_points)">å…¥å£ç‚¹ï¼ˆEntry points)</h2><p>ä»ä¸Šé¢çš„æè¿°å¯ä»¥çŸ¥é“ï¼Œä¸ºäº†ç¡®å®šå“ªäº›ä»£ç éœ€è¦ä¿ç•™ï¼Œå“ªäº›ä»£ç å¯ä»¥ä¸¢å¼ƒæˆ–è€…æ··æ·†ï¼Œå°±å¿…é¡»ä¸ºä½ çš„ä»£ç æŒ‡å®šä¸€ä¸ªæˆ–å¤šä¸ª<strong>å…¥å£ç‚¹ï¼ˆEntry pointï¼‰</strong>ã€‚è¿™äº›å…¥å£ç‚¹é€šå¸¸æ˜¯åŒ…å«mainæ–¹æ³•çš„ç±»ã€appletæˆ–è€…midletç­‰ç­‰ã€‚</p>
<h2 id="åå°„ï¼ˆReflectionï¼‰">åå°„ï¼ˆReflectionï¼‰</h2><p>åå°„ï¼ˆreflectionï¼‰å’Œå†…çœï¼ˆintrospectionï¼‰å¯¹äºä»»ä½•å¯¹ä»£ç çš„è‡ªåŠ¨å¤„ç†éƒ½ä¼šè¡¨ç°å‡ºç‰¹åˆ«çš„é—®é¢˜ã€‚åœ¨ProGuardä¸­ï¼Œä½ çš„ä»£ç ä¸­è¢«åŠ¨æ€ï¼ˆä¹Ÿå°±æ˜¯é€šè¿‡åå­—ï¼‰åˆ›å»ºæˆ–è°ƒç”¨çš„ç±»å’Œç±»æˆå‘˜ä¹Ÿéƒ½å¿…é¡»è¢«æŒ‡å®šä¸ºå…¥å£ç‚¹ã€‚  </p>
<p>æ¯”å¦‚ï¼ŒClass.forName()åœ¨è¿è¡Œæ—¶å¯èƒ½æŒ‡å‘ä»»ä½•ç±»ã€‚ä¸€èˆ¬ä¸å¯èƒ½é¢„è§åˆ°å“ªäº›ç±»å¿…é¡»è¢«ä»¥å®ƒä»¬åŸæ¥çš„åå­—ä¿ç•™ï¼Œå› ä¸ºè¿™äº›ç±»çš„åå­—å¯èƒ½æ˜¯ä»ä¸€ä¸ªé…ç½®æ–‡ä»¶ä¸­è¯»å–åˆ°çš„ã€‚å› æ­¤ä½ å¿…é¡»åœ¨ä½ çš„ProGuardé…ç½®ä¸­ç”¨ç®€å•çš„<code>-keep</code>é€‰é¡¹æ¥æŒ‡å®šå®ƒä»¬ã€‚  </p>
<p>ä¸è¿‡Proguardä¼šè‡ªåŠ¨ä¸ºä½ æ£€æµ‹å¹¶å¤„ç†ä¸‹é¢è¿™äº›æƒ…å†µï¼š</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">â— <span class="keyword">Class</span>.forName(<span class="string">"SomeClass"</span>)</span><br><span class="line">â— SomeClass.<span class="keyword">class</span></span><br><span class="line">â— SomeClass.<span class="keyword">class</span>.getField(<span class="string">"someField"</span>)</span><br><span class="line">â— SomeClass.<span class="keyword">class</span>.getDeclaredField(<span class="string">"someField"</span>)</span><br><span class="line">â— SomeClass.<span class="keyword">class</span>.getMethod(<span class="string">"someMethod"</span>, <span class="keyword">new</span> <span class="keyword">Class</span>[] &#123;&#125;)</span><br><span class="line">â— SomeClass.<span class="keyword">class</span>.getMethod(<span class="string">"someMethod"</span>, <span class="keyword">new</span> <span class="keyword">Class</span>[] &#123; A.<span class="keyword">class</span> &#125;)</span><br><span class="line">â— SomeClass.<span class="keyword">class</span>.getMethod(<span class="string">"someMethod"</span>, <span class="keyword">new</span> <span class="keyword">Class</span>[] &#123; A.<span class="keyword">class</span>, B.<span class="keyword">class</span> &#125;)</span><br><span class="line">â— SomeClass.<span class="keyword">class</span>.getDeclaredMethod(<span class="string">"someMethod"</span>, <span class="keyword">new</span> <span class="keyword">Class</span>[] &#123;&#125;)</span><br><span class="line">â— SomeClass.<span class="keyword">class</span>.getDeclaredMethod(<span class="string">"someMethod"</span>, <span class="keyword">new</span> <span class="keyword">Class</span>[] &#123; A.<span class="keyword">class</span> &#125;)</span><br><span class="line">â— SomeClass.<span class="keyword">class</span>.getDeclaredMethod(<span class="string">"someMethod"</span>, <span class="keyword">new</span> <span class="keyword">Class</span>[] &#123; A.<span class="keyword">class</span>, B.<span class="keyword">class</span> &#125;)</span><br><span class="line">â— AtomicIntegerFieldUpdater.newUpdater(SomeClass.<span class="keyword">class</span>, <span class="string">"someField"</span>)</span><br><span class="line">â— AtomicLongFieldUpdater.newUpdater(SomeClass.<span class="keyword">class</span>, <span class="string">"someField"</span>)</span><br><span class="line">â— AtomicReferenceFieldUpdater.newUpdater(SomeClass.<span class="keyword">class</span>, SomeType.<span class="keyword">class</span>, <span class="string">"someField"</span>)</span><br></pre></td></tr></table></figure>
<p>è¢«å¼•ç”¨çš„ç±»å’Œç±»æˆå‘˜åœ¨æ”¶ç¼©é˜¶æ®µï¼ˆshrinking phaseï¼‰ä¼šè¢«ä¿ç•™ï¼Œå­—ç¬¦ä¸²å‚æ•°åœ¨æ··æ·†é˜¶æ®µï¼ˆobfuscation phaseï¼‰ä¼šè¢«åˆç†åœ°æ›´æ–°ã€‚<br>é™¤æ­¤ä¹‹å¤–ï¼Œå¦‚æœkeepingæŸäº›ç±»æˆ–ç±»æˆå‘˜çœ‹èµ·æ¥æ˜¯å¿…è¦çš„ï¼ŒProGuardå°±ä¼šæä¾›ä¸€äº›å»ºè®®ã€‚æ¯”å¦‚ï¼ŒProGuardä¼šå¯¹<code>(SomeClass)Class.forName(variable).newInstance()</code>è¿™æ ·çš„æƒ…å†µè¿›è¡Œæç¤ºï¼ŒæŒ‡å‡ºè¿™é‡Œçš„SomeClassç±»æˆ–æ¥å£ä»¥åŠå®ƒçš„å®ç°ç±»éœ€è¦è¢«åŸæ ·ä¿ç•™ã€‚ç„¶åä½ å°±å¯ä»¥æ®æ­¤å¯¹ä½ çš„ProGuardæ–‡ä»¶è¿›è¡Œä¿®æ”¹ã€‚</p>
<h1 id="åœ¨Android_Studioä¸­ä½¿ç”¨ProGuard">åœ¨Android Studioä¸­ä½¿ç”¨ProGuard</h1><p>åœ¨Android Studioä¸­ï¼Œå¦‚æœBuild Typeé€šè¿‡è®¾ç½®minifyEnabledå±æ€§æ¥é…ç½®è¿è¡ŒProGuardï¼Œé‚£ä¹ˆProGuardæ’ä»¶ï¼ˆProGuard pluginï¼‰å°±ä¼šè‡ªåŠ¨è¢«Androidæ’ä»¶ï¼ˆAndroid pluginï¼‰ä½¿ç”¨ï¼Œå¹¶è‡ªåŠ¨åˆ›å»ºtaskã€‚é…ç½®æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">android</span> &#123;</span><br><span class="line">    <span class="title">buildTypes</span> &#123;</span><br><span class="line">        <span class="title">release</span> &#123;</span><br><span class="line">            <span class="title">minifyEnabled</span> <span class="built_in">true</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span>        //sample <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    productFlavors &#123;</span><br><span class="line">        <span class="title">flavor1</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title">flavor2</span> &#123;</span><br><span class="line">            <span class="title">proguardFile</span> <span class="string">'some-other-rules.txt'</span>            //sample <span class="number">2</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨Android SDKä¸­ï¼ˆå…·ä½“è·¯å¾„æ˜¯${sdk.dir}/tools/proguard/ï¼‰å­˜åœ¨2ä¸ªé»˜è®¤çš„è§„åˆ™æ–‡ä»¶ï¼ˆrules filesï¼‰ï¼š</p>
<ul>
<li>proguard-android.txt</li>
<li>proguard-android-optimize.txt</li>
</ul>
<p>ä½¿ç”¨<code>getDefaultProguardFile()</code>ä¼šè¿”å›æ–‡ä»¶çš„å®Œæ•´è·¯å¾„ã€‚è¿™2ä¸ªæ–‡ä»¶é™¤äº†æ˜¯å¦å¼€å¯ä¼˜åŒ–ï¼ˆoptimizationï¼‰ä¸Šä¸åŒï¼Œå…¶ä»–éƒ½æ˜¯å®Œå…¨ç›¸åŒçš„ã€‚è¿™2ä¸ªé»˜è®¤æ–‡ä»¶ï¼ˆå®é™…ä½¿ç”¨ä¸­åªé€‰æ‹©å…¶ä¸­ä¸€ä¸ªï¼‰å®šä¹‰äº† ProGuard ä¼šå¦‚ä½•ä¼˜åŒ–å’Œæ··æ·†ä»£ç ï¼Œé»˜è®¤çš„é…ç½®æ–‡ä»¶åªæ¶µç›–ä¸€èˆ¬çš„ä½¿ç”¨æƒ…å½¢ï¼Œé’ˆå¯¹è‡ªå·±å…·ä½“çš„é¡¹ç›®ProGuardçš„é…ç½®æ˜¯éœ€è¦å®é™…æƒ…å†µè¿›è¡Œå®šåˆ¶çš„ã€‚<br>Android Studioåœ¨æ–°å»ºé¡¹ç›®æ—¶ï¼Œä¼šåœ¨moduleçš„æ ¹ç›®å½•ä¸‹è‡ªåŠ¨ç”Ÿæˆproguard-rules.proæ–‡ä»¶ï¼Œå¦‚æœä½ éœ€è¦è‡ªå®šä¹‰Proguardçš„é…ç½®ï¼Œä¸éœ€è¦å»ä¿®æ”¹sdkä¸‹çš„é‚£2ä¸ªé»˜è®¤é…ç½®æ–‡ä»¶ï¼Œåªéœ€è¦ä¿®æ”¹ä½ çš„moduleæ ¹ç›®å½•ä¸‹çš„proguard-rules.proå°±å¯ä»¥äº†ã€‚</p>
<h2 id="é…ç½®_ProGuard">é…ç½® ProGuard</h2><p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œproguard.cfg æ–‡ä»¶ä¸­çš„é»˜è®¤é…ç½®è¶³ä»¥æ»¡è¶³æ‚¨çš„éœ€æ±‚ã€‚ä¸è¿‡ï¼Œåœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼ŒProGuard å¾ˆéš¾åšå‡ºæ­£ç¡®åˆ†æï¼Œå› æ­¤å¯èƒ½ä¼šç§»é™¤å®ƒè®¤ä¸ºæ— ç”¨è€Œå®é™…ä¸Šæ‚¨çš„åº”ç”¨å´éœ€è¦çš„ä»£ç ã€‚éƒ¨åˆ†ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>ä¸€ä¸ªåªåœ¨ AndroidManifest.xml æ–‡ä»¶ä¸­å¼•ç”¨çš„ç±»</li>
<li>ä¸€ä¸ªé€šè¿‡ JNI è°ƒç”¨çš„æ–¹æ³•</li>
<li>åŠ¨æ€å¼•ç”¨çš„å­—æ®µå’Œæ–¹æ³•</li>
</ul>
<p>é»˜è®¤çš„ proguard.cfg æ–‡ä»¶æ—¨åœ¨æ¶µç›–ä¸€èˆ¬çš„ä½¿ç”¨æƒ…å½¢ï¼Œä½†æ‚¨å¯èƒ½ä¼šé‡åˆ°å¼‚å¸¸æƒ…å†µï¼Œä¾‹å¦‚ ClassNotFoundExceptionï¼ˆæ­¤å¼‚å¸¸æƒ…å†µä¼šåœ¨ ProGuard åˆ é™¤æ‚¨çš„åº”ç”¨è°ƒç”¨çš„æ•´ä¸ªç±»æ—¶å‘ç”Ÿï¼‰ã€‚</p>
<p>æ‚¨å¯ä»¥é€šè¿‡åœ¨ proguard.cfg æ–‡ä»¶ä¸­æ·»åŠ ä¸€ä¸ª<code>-keep</code>è¡Œï¼Œæ¥ä¿®å¤å›  ProGuard åœ¨åˆ é™¤ä»£ç è€Œé€ æˆçš„é”™è¯¯ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby">keep public <span class="class"><span class="keyword">class</span> <span class="inheritance">&lt;<span class="parent">MyClass</span></span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>åœ¨ä½¿ç”¨ -keep é€‰é¡¹æ—¶ï¼Œæ‚¨æ—¢æœ‰è®¸å¤šé€‰æ‹©ä¹Ÿæœ‰ä¸å°‘éœ€è¦æ³¨æ„çš„æ–¹é¢ï¼Œå› æ­¤æˆ‘ä»¬å¼ºçƒˆå»ºè®®æ‚¨é˜…è¯» <a href="http://stuff.mit.edu/afs/sipb/project/android/sdk/android-sdk-linux/tools/proguard/docs/index.html#manual/introduction.html" target="_blank" rel="external">ProGuard æ‰‹å†Œ</a>ï¼Œè¯¦ç»†äº†è§£å¦‚ä½•è‡ªå®šä¹‰æ‚¨çš„é…ç½®æ–‡ä»¶ã€‚è¯¥æ‰‹å†Œä¸­çš„â€œKeep é€‰é¡¹æ¦‚è¿°â€å’Œâ€œç¤ºä¾‹â€éƒ¨åˆ†å°¤å…¶æœ‰ç”¨ï¼›<a href="http://stuff.mit.edu/afs/sipb/project/android/sdk/android-sdk-linux/tools/proguard/docs/index.html#manual/troubleshooting.html" target="_blank" rel="external">é—®é¢˜æ’æŸ¥</a>éƒ¨åˆ†åˆ™æ¦‚è¿°äº†åœ¨ ProGuard åˆ é™¤ä»£ç åæ‚¨å¯èƒ½ä¼šé‡åˆ°çš„å…¶ä»–å¸¸è§é—®é¢˜ã€‚</p>
<h2 id="æ··æ·†ç»“æœ">æ··æ·†ç»“æœ</h2><p>ProGuard åœ¨è¿è¡Œåä¼šè¾“å‡ºä»¥ä¸‹æ–‡ä»¶ï¼š</p>
<p>â‘ dump.txt<br>  æè¿° .apk æ–‡ä»¶ä¸­æ‰€æœ‰ç±»æ–‡ä»¶çš„å†…éƒ¨ç»“æ„ã€‚ä¸€ä¸ªdumpæ–‡ä»¶çš„ç¤ºä¾‹ç‰‡æ®µå¦‚ä¸‹ï¼š<br>    <img src="http://7xle8x.com1.z0.glb.clouddn.com/15-12-22/75237673.jpg" alt=""></p>
<p>â‘¡mapping.txt<br>    åˆ—å‡ºåŸå§‹ä¸æ··æ·†åçš„ç±»ã€æ–¹æ³•å’Œå­—æ®µåç§°ä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚å¦‚æœæ‚¨ä»å‘å¸ƒç‰ˆæœ¬æ”¶åˆ°é—®é¢˜æŠ¥å‘Šï¼Œåˆ™å¿…é¡»ä½¿ç”¨æ­¤æ–‡ä»¶ï¼Œå› ä¸ºé€šè¿‡å®ƒå¯å°†æ··æ·†åçš„å †æ ˆè·Ÿè¸ªä¿¡æ¯è½¬æ¢ä¸ºåŸå§‹çš„ç±»ã€æ–¹æ³•å’Œæˆå‘˜åç§°ã€‚æœ‰å…³è¯¦æƒ…ï¼Œè¯·å‚é˜…<a href="http://developer.android.com/intl/zh-cn/tools/help/proguard.html#decoding" target="_blank" rel="external">è§£ç æ··æ·†åçš„å †æ ˆè·Ÿè¸ªä¿¡æ¯</a>ã€‚<br>    ä¸€ä¸ªmapping.txtçš„ç‰‡æ®µå¦‚ä¸‹ï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/15-12-21/15237497.jpg" alt=""><br>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œç±»å’Œç±»æˆå‘˜çš„åå­—éƒ½è¢«æ›¿æ¢æˆäº†æ— æ„ä¹‰çš„å­—æ¯ã€‚</p>
<p>â‘¢seeds.txt<br>    åˆ—å‡ºæœªæ··æ·†çš„ç±»å’Œæˆå‘˜ã€‚ä¸€ä¸ªç¤ºä¾‹æ–‡ä»¶ç‰‡æ®µå¦‚ä¸‹ï¼š<br>    <img src="http://7xle8x.com1.z0.glb.clouddn.com/15-12-22/93038934.jpg" alt=""></p>
<p>â‘£usage.txt<br>    åˆ—å‡ºä» .apk åˆ é™¤çš„ä»£ç ã€‚ä¸€ä¸ªç¤ºä¾‹æ–‡ä»¶ç‰‡æ®µå¦‚ä¸‹ï¼š<br>    <img src="http://7xle8x.com1.z0.glb.clouddn.com/15-12-22/38493078.jpg" alt=""></p>
<p>è¿™äº›æ–‡ä»¶éƒ½ä½äºä»¥ä¸‹ç›®å½•ä¸­ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">project_root</span>&gt;</span>/<span class="tag">&lt;<span class="title">module_root</span>&gt;</span>/build/outputs/mapping/</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>æ³¨æ„ï¼š</strong>æ¯å½“æ‚¨åœ¨å‘å¸ƒæ¨¡å¼ä¸‹æ„å»ºç‰ˆæœ¬æ—¶ï¼Œè¿™äº›æ–‡ä»¶éƒ½ä¼šè¢« ProGuard æœ€æ–°ç”Ÿæˆçš„æ–‡ä»¶è¦†ç›–ã€‚è¯·åœ¨æ¯æ¬¡å‘å¸ƒåº”ç”¨æ—¶ä¸ºè¿™äº›æ–‡ä»¶ä¿å­˜ä¸€ä»½å‰¯æœ¬ï¼Œä»¥ä¾¿åæ··æ·†æ¥è‡ªå‘å¸ƒç‰ˆæœ¬çš„é—®é¢˜æŠ¥å‘Šã€‚</p>
<p>æ¯æ¬¡å‘ç”¨æˆ·å‘å¸ƒåº”ç”¨æ—¶ï¼Œéƒ½è¯·ä¿å­˜æ‰€å‘å¸ƒç‰ˆæœ¬çš„ mapping.txt æ–‡ä»¶ã€‚è¿™æ ·ä¸€æ¥ï¼Œå¦‚æœç”¨æˆ·é‡åˆ°é—®é¢˜ï¼Œå¹¶å‘æ‚¨æäº¤æ··æ·†åçš„å †æ ˆè·Ÿè¸ªä¿¡æ¯ï¼Œæ‚¨å°±å¯ä»¥åˆ©ç”¨ä¸ºæ¯ä¸ªå‘å¸ƒç‰ˆæœ¬ä¿å­˜çš„ mapping.txt æ–‡ä»¶å‰¯æœ¬è°ƒè¯•é—®é¢˜ã€‚æ¯å½“æ‚¨æ„å»ºå‘å¸ƒç‰ˆæœ¬æ—¶ï¼Œé¡¹ç›®çš„ mapping.txt æ–‡ä»¶éƒ½ä¼šè¢«è¦†ç›–ï¼Œå› æ­¤æ‚¨å¿…é¡»è°¨æ…ä¿å­˜æ‰€éœ€çš„ç‰ˆæœ¬ã€‚</p>
<p>ä¾‹å¦‚ï¼Œå‡è®¾æ‚¨å‘å¸ƒäº†æŸä¸ªåº”ç”¨ï¼Œå¹¶ç»§ç»­å¼€å‘è¯¥åº”ç”¨çš„æ–°åŠŸèƒ½ï¼Œä»¥ä¾¿å°†æ¥å‘å¸ƒæ–°ç‰ˆæœ¬ã€‚ä¹‹åä¸ä¹…æ‚¨ä½¿ç”¨ ProGuard æ„å»ºå‘å¸ƒç‰ˆæœ¬ã€‚æ­¤ç‰ˆæœ¬è¦†ç›–äº†ä¹‹å‰çš„ mapping.txt æ–‡ä»¶ã€‚ä¹‹åï¼ŒæŸä½ç”¨æˆ·æäº¤äº†é—®é¢˜æŠ¥å‘Šï¼Œå…¶ä¸­åŒ…å«æ¥è‡ªå½“å‰å·²å‘å¸ƒçš„åº”ç”¨çš„å †æ ˆè·Ÿè¸ªä¿¡æ¯ã€‚ä½†æ‚¨å·²æ— æ³•è°ƒè¯•è¯¥ç”¨æˆ·çš„å †æ ˆè·Ÿè¸ªä¿¡æ¯ï¼Œå› ä¸ºä¸è¯¥ç”¨æˆ·è®¾å¤‡ä¸Šçš„ç‰ˆæœ¬ç›¸å…³è”çš„ mapping.txt æ–‡ä»¶å·²è¢«è¦†ç›–ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå…¶ä»–ä¸€äº›æƒ…å†µä¹Ÿå¯èƒ½ä¼šå¯¼è‡´æ‚¨çš„ mapping.txt æ–‡ä»¶è¢«è¦†ç›–ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨é¢„è®¡éœ€è¦è¿›è¡Œè°ƒè¯•ï¼Œè¯·åŠ¡å¿…åœ¨æ¯æ¬¡å‘å¸ƒåº”ç”¨æ—¶éƒ½ä¿å­˜ä¸€ä»½å‰¯æœ¬ã€‚</p>
<p>å¦‚ä½•ä¿å­˜ mapping.txt æ–‡ä»¶ç”±æ‚¨è‡ªè¡Œå†³å®šã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥å°†å…¶é‡å‘½åä»¥ä½¿å…¶åç§°ä¸­åŒ…å«ç‰ˆæœ¬å·ï¼Œä¹Ÿå¯ä»¥å¯¹å…¶ï¼ˆè¿åŒæºä»£ç ä¸€èµ·ï¼‰è¿›è¡Œç‰ˆæœ¬ç®¡ç†ã€‚</p>
</blockquote>
<h1 id="è§£ç æ··æ·†åçš„å †æ ˆè·Ÿè¸ªä¿¡æ¯">è§£ç æ··æ·†åçš„å †æ ˆè·Ÿè¸ªä¿¡æ¯</h1><p>å½“æ··æ·†åçš„ä»£ç è¾“å‡ºå †æ ˆè·Ÿè¸ªä¿¡æ¯æ—¶ï¼Œæ–¹æ³•åç§°ä¼šè¢«æ··æ·†ï¼Œå³ä¾¿ä»èƒ½è¿›è¡Œè°ƒè¯•ï¼Œéš¾åº¦ä¹Ÿä¼šå¾ˆå¤§ã€‚å¹¸è¿çš„æ˜¯ï¼ŒProGuard åœ¨æ¯æ¬¡è¿è¡Œæ—¶éƒ½ä¼šè¾“å‡ºä¸€ä¸ª <project_root>/<module_root>/build/outputs/mapping/mapping.txt æ–‡ä»¶ï¼Œå…¶ä¸­ä¼šæ˜¾ç¤ºä¸æ··æ·†åçš„åç§°ç›¸å¯¹åº”çš„åŸå§‹çš„ç±»ã€æ–¹æ³•å’Œå­—æ®µåç§°ã€‚</module_root></project_root></p>
<p>Windows ä¸Šçš„ retrace.bat è„šæœ¬ä»¥åŠ Linux æˆ– Mac OS X ä¸Šçš„ retrace.sh è„šæœ¬å¯ä»¥å°†æ··æ·†åçš„å †æ ˆè·Ÿè¸ªä¿¡æ¯è½¬æ¢æˆå¯è¯»æ–‡ä»¶ï¼Œæ­¤æ–‡ä»¶ä½äº <sdk_root>/tools/proguard/ ç›®å½•ä¸­ã€‚æ‰§è¡Œ retrace å·¥å…·çš„è¯­æ³•å¦‚ä¸‹ï¼š</sdk_root></p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">retrace.bat|retrace.sh [-verbose] mapping.txt <span class="annotation">[&lt;stacktrace_file&gt;]</span></span><br></pre></td></tr></table></figure>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">retrace<span class="class">.bat</span> -verbose mapping<span class="class">.txt</span> obfuscated_trace.txt</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ‚¨ä¸ä¸ºâ€œ<stacktrace_file>â€æŒ‡å®šå€¼ï¼Œretrace å·¥å…·ä¼šä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–ã€‚</stacktrace_file></p>
<h1 id="å…¶ä»–é€‰é¡¹(options)">å…¶ä»–é€‰é¡¹(options)</h1><p>Proguardæ‹¥æœ‰å¾ˆå¤šå¯ç”¨çš„é€‰é¡¹ï¼Œå¯ä»¥é€šè¿‡Proguardè§„åˆ™æ–‡ä»¶è¿›è¡Œé…ç½®ã€‚  </p>
<p>æœ€å¸¸ç”¨çš„æ˜¯keepé€‰é¡¹ï¼Œå¦‚æœéœ€è¦æ˜¾ç¤ºæŒ‡å®šæŸä¸ªç±»è¦ä¿ç•™ï¼Œå¯ä»¥ä½¿ç”¨keepæ¥å®ç°ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-keep class com.android.support.<span class="keyword">*</span><span class="keyword">*</span> &#123;<span class="keyword">*</span>;&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœä½ çš„ä»£ç éœ€è¦æ‰“å°å †æ ˆä¿¡æ¯ï¼Œè€Œæ··æ·†åçš„ä»£ç äº§ç”Ÿçš„å †æ ˆä¿¡æ¯å¯èƒ½æ— æ³•æ­£ç¡®è·å–è¡Œå·å’Œç±»ä¿¡æ¯ï¼Œå¦‚æœä½ éœ€è¦è¿™äº›ä¿¡æ¯æ¥è¿›è¡Œåˆ†æï¼Œå¯ä»¥å¼ºåˆ¶ä¿ç•™è¿™äº›ä¿¡æ¯ï¼š</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">-keepattributes SourceFile,LineNumberTable</span></span><br></pre></td></tr></table></figure>
<p>å½“ä½ å¼•ç”¨ç¬¬ä¸‰æ–¹åº“æ—¶ï¼Œå¾€å¾€è¦åŒæ—¶ä½¿ç”¨keepå’Œdontwarnï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby">libraryjars libs/log4j.jar</span><br><span class="line"></span>-<span class="ruby">dontwarn    org.apache.log4j.*</span><br><span class="line"></span>-<span class="ruby">keep <span class="class"><span class="keyword">class</span>  <span class="title">org</span>.<span class="title">apache</span>.<span class="title">log4j</span>.** &#123; *;</span>&#125;</span></span><br></pre></td></tr></table></figure>
<p>å°†-dontwarnå’Œ-keep ç»“åˆä½¿ç”¨ï¼Œæ„æ€æ˜¯ä¿æŒåŒ…é‡Œé¢çš„æ‰€æœ‰ç±»å’Œæ‰€æœ‰æ–¹æ³•è€Œä¸æ··æ·†ï¼Œæ¥ç€è¿˜å«ProGuardä¸è¦è­¦å‘Šæ‰¾ä¸åˆ°è¿™ä¸ªåŒ…é‡Œé¢çš„ç±»çš„ç›¸å…³å¼•ç”¨ã€‚  </p>
<p>ProGuardæœ‰æ•°é‡ä¼—å¤šçš„optionså¯ç”¨ï¼Œå¦‚æœéœ€è¦æŸ¥è¯¢å„ä¸ªoptionçš„ç”¨æ³•ï¼Œå¯ä»¥å‚è€ƒ<a href="http://proguard.sourceforge.net/manual/usage.html" target="_blank" rel="external">ProGuard-Usage</a>ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="ä»€ä¹ˆæ˜¯ProGuard">ä»€ä¹ˆæ˜¯ProGuard</h1><p>ProGuardæ˜¯ä¸€æ¬¾å…è´¹çš„Java classæ–‡ä»¶æ”¶ç¼©å™¨ã€ä¼˜åŒ–å™¨ã€æ··æ·†å™¨å’Œé¢„æ ¡éªŒå™¨ã€‚<br>ProGuard å·²é›†æˆåˆ° Android æ„å»ºç³»ç»Ÿï¼Œå®ƒé€šè¿‡ç§»é™¤æ— ç”¨çš„ä»£ç ä»¥åŠä½¿ç”¨è¯­ä¹‰éšæ™¦çš„åç§°æ¥é‡å‘½åç±»ã€å­—æ®µå’Œæ–¹æ³•ï¼Œä»è€Œè¾¾åˆ°å‹ç¼©ã€ä¼˜åŒ–å’Œæ··æ·†ä»£ç çš„ç›®çš„ã€‚æœ€ç»ˆæ‚¨å°†è·å¾—ä¸€ä¸ªè¾ƒå°çš„ .apk æ–‡ä»¶ï¼Œæ­¤æ–‡ä»¶æ›´éš¾äºè¿›è¡Œåå‘å·¥ç¨‹ã€‚ç”±äº ProGuard ä¼šä½¿åº”ç”¨æ›´éš¾äºè¿›è¡Œåå‘å·¥ç¨‹ï¼Œå› æ­¤å½“åº”ç”¨ä½¿ç”¨å¯¹å®‰å…¨æ€§è¦æ±‚æé«˜çš„åŠŸèƒ½æ—¶ï¼ˆä¾‹å¦‚ï¼Œå½“æ‚¨å‘åº”ç”¨æˆäºˆè®¸å¯æ—¶ï¼‰ï¼Œæ‚¨å¿…é¡»ä½¿ç”¨æ­¤å·¥å…·ã€‚å½“æ‚¨åœ¨è°ƒè¯•æ¨¡å¼ä¸‹æ„å»ºåº”ç”¨æ—¶ï¼Œå°±æ— éœ€å¤„ç†æ··æ·†åçš„ä»£ç ã€‚æ˜¯å¦è¿è¡Œ ProGuard å®Œå…¨ç”±æ‚¨å†³å®šã€‚<br>Proguardé€šè¿‡åˆ é™¤ä»£ç ä¸­åœ¨è¿è¡ŒæœŸé—´ä¸æ˜¯ç»å¯¹å¿…è¦çš„ä¿¡æ¯ï¼Œæ¥é˜²æ­¢é™æ€åˆ†æã€‚ç›¸æ¯”äºæŠŠä»£ç æŒ‰ç…§å®ƒåŸæ¥çš„æ ·å­å‘ˆç°å‡ºæ¥ï¼Œè¿™å·²ç»å‰è¿›äº†ä¸€å¤§æ­¥ï¼Œä½†å®ƒä»ç„¶æ˜¯ä¸€ç§è¢«åŠ¨çš„æ–¹æ³•ã€‚<br>ProGuardçš„æä¾›è€…åŒæ—¶æä¾›äº†å¦å¤–ä¸¤ç§é’ˆå¯¹Androidå¹³å°çš„æ›´é«˜çº§çš„å·¥å…·ï¼šDexguardå’ŒDexguard Enterpriseï¼Œèƒ½å¤ŸæŠµå¾¡é™æ€åˆ†æå’ŒåŠ¨æ€åˆ†æã€‚å®ƒä»¬å…¼å®¹ProGuardçš„é…ç½®ï¼Œå¹¶ä¸ºé¢å¤–çš„åŠŸèƒ½æä¾›äº†é¢å¤–çš„é€‰é¡¹ã€‚å¦‚æœä½ éœ€è¦æ›´é«˜çš„å®‰å…¨æ€§æ¥é˜²æ­¢ä½ çš„ä»£ç è¢«é€†å‘åˆ†æï¼Œå¯ä»¥å°è¯•è¿™ä¸¤ä¸ªå·¥å…·ï¼Œä¸è¿‡å®ƒä»¬æ˜¯æ”¶è´¹çš„ã€‚  </p>
<p>ä¸‰è€…çš„å¯¹æ¯”å¦‚ä¸‹ï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/15-12-17/95797670.jpg" alt=""></p>]]>
    
    </summary>
    
      <category term="Android" scheme="http://www.carrotsight.com/tags/Android/"/>
    
      <category term="Proguard" scheme="http://www.carrotsight.com/tags/Proguard/"/>
    
      <category term="Android" scheme="http://www.carrotsight.com/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[å¯ç¼©æ”¾æ—¶é—´è½´å’Œå½•åƒç‰‡æ®µé€‰æ‹©å™¨çš„å®ç°]]></title>
    <link href="http://www.carrotsight.com/2015/12/09/%E5%8F%AF%E7%BC%A9%E6%94%BE%E6%97%B6%E9%97%B4%E8%BD%B4%E5%92%8C%E5%BD%95%E5%83%8F%E7%89%87%E6%AE%B5%E9%80%89%E6%8B%A9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0.html"/>
    <id>http://www.carrotsight.com/2015/12/09/å¯ç¼©æ”¾æ—¶é—´è½´å’Œå½•åƒç‰‡æ®µé€‰æ‹©å™¨çš„å®ç°.html</id>
    <published>2015-12-09T06:53:40.000Z</published>
    <updated>2016-02-01T03:45:04.000Z</updated>
    <content type="html"><![CDATA[<p>æœ€è¿‘çš„å·¥ä½œæ˜¯åšäº†ä¸¤ä¸ªè‡ªå®šä¹‰æ§ä»¶ï¼š<br>â‘ å¯ä»¥ç¼©æ”¾çš„æ—¶é—´è½´<br>â‘¡å¸é™„åœ¨åœ¨æ—¶é—´è½´ä¸Šæœ‰ä¸¤ä¸ªæ»‘åŠ¨æŒ‰é’®çš„å½•åƒç‰‡æ®µé€‰æ‹©å™¨  </p>
<p>çœŸæœºæµ‹è¯•æ•ˆæœå¦‚ä¸‹é¢çš„gifåŠ¨ç”»æ‰€ç¤ºï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/15-12-10/74682253.jpg" alt=""></p>
<a id="more"></a>
<p>åœ¨æ­¤è®°å½•ä¸€ä¸‹è®¾è®¡åŸç†å’Œè¸©è¿‡çš„å‘ã€‚</p>
<h2 id="æ—¶é—´è½´">æ—¶é—´è½´</h2><p>æ—¶é—´è½´åˆ†ä¸ºä¸¤éƒ¨åˆ†è½´ï¼Œåˆ»åº¦è½´å’Œå½•åƒç‰‡æ®µè½´ã€‚åˆ»åº¦è½´ç”¨æ¥ç»˜åˆ¶æ—¶é—´åˆ»åº¦è¡¨ç›˜ï¼Œå½•åƒç‰‡æ®µè½´ç”¨æ¥æŒ‡ç¤ºå¯¹åº”ä½ç½®æœ‰æ²¡æœ‰å½•åƒå­˜åœ¨ã€‚<br>æ—¶é—´è½´çš„è§†è§‰æ•ˆæœå¦‚ä¸‹ï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/15-12-9/11028878.jpg" alt=""></p>
<p>å…¶ä¸­ä¸‹é¢æœ‰æ—¶é—´æ ‡æ³¨çš„åˆ»åº¦éƒ¨åˆ†æ˜¯åˆ»åº¦è½´ï¼Œä¸Šé¢ç°è‰²èƒŒæ™¯ä¸€æ®µä¸€æ®µç»¿è‰²çš„éƒ¨åˆ†æ˜¯å½•åƒç‰‡æ®µè½´ï¼Œå¦‚ä¸‹å›¾çš„æ ‡æ³¨æ‰€ç¤ºï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/15-12-9/86365109.jpg" alt=""></p>
<h3 id="åˆ»åº¦è½´">åˆ»åº¦è½´</h3><p>åˆ»åº¦è½´çš„èµ·å§‹æ—¶é—´ç‚¹ã€ç»ˆæ­¢æ—¶é—´ç‚¹ã€è·¨è¶Šé•¿åº¦ã€å½“å‰æ»‘åŠ¨åˆ°çš„æ—¶é—´ç‚¹ï¼ˆå³å±å¹•ä¸­é—´çš„æ¸¸æ ‡æŒ‡ç¤ºçš„æ—¶é—´ï¼‰éƒ½å¯ä»¥æ ¹æ®ä¼ å…¥å‚æ•°å®šåˆ¶ã€‚åˆ»åº¦åˆ†ä¸ºå¤§åˆ»åº¦ï¼ˆå…³é”®åˆ»åº¦ï¼‰å’Œå°åˆ»åº¦ï¼Œå¤§åˆ»åº¦è¦æ˜¾ç¤ºåˆ»åº¦å’Œå¯¹åº”çš„æ—¶é—´æ–‡å­—ï¼Œå°åˆ»åº¦åªæ˜¾ç¤ºåˆ»åº¦ã€‚åˆ»åº¦åˆ†ä¸º6æ¡£ï¼Œæ ¹æ®ç¼©æ”¾çº§åˆ«çš„ä¸åŒï¼ˆç”¨æˆ·åŒæŒ‡ç¼©æ”¾æˆ–ç•Œé¢æŒ‰é’®ç¼©æ”¾ï¼‰ï¼ŒæŠŠåˆ»åº¦æ‰“åˆ°ä¸åŒä½ç½®ã€‚<br>æ¯”å¦‚ï¼Œåˆšè¿›å…¥ç•Œé¢æ—¶åˆ»åº¦è½´çš„åˆ»åº¦ä»¥é»˜è®¤æ¡£ä½æ˜¾ç¤ºï¼Œè¦åœ¨å¦‚å›¾çš„ä½ç½®æ‰“å‡ºåˆ»åº¦ï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/15-12-9/12666172.jpg" alt="åˆ»åº¦è½´1"></p>
<p>å½“ç”¨æˆ·åŒæŒ‡åœ¨å±å¹•ä¸Šæ‹‰ä¼¸ï¼Œæˆ–ç‚¹å‡»æ”¾å¤§æŒ‰é’®ï¼Œå¯¼è‡´æ—¶é—´è½´è¢«æ”¾å¤§æ—¶ï¼Œä¸€å¼€å§‹åˆ»åº¦æ‰“å°æ–¹å¼ä¸å˜ï¼ˆä¾ç„¶åœ¨è¿™å‡ ä¸ªæ—¶åˆ»æ‰“å°æ–‡å­—ï¼‰ï¼Œåªæ˜¯åˆ»åº¦é—´çš„è·ç¦»éšæ‰‹æŒ‡çš„æ‹‰ä¼¸è·ç¦»è€Œé€æ¸å˜å¤§ã€‚å½“åˆ»åº¦é—´è·ç¦»è¾¾åˆ°ä¸€å®šç¨‹åº¦æ—¶ï¼Œåˆ»åº¦æ‰“å°æ–¹å¼æ”¹å˜ï¼Œå˜æˆå¦‚ä¸‹å›¾çš„åˆ»åº¦æ ·å¼ï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/15-12-9/53994347.jpg" alt="åˆ»åº¦è½´2"></p>
<p>å½“ç”¨æˆ·åŒæŒ‡åœ¨å±å¹•ä¸Šæ”¶ç¼©ï¼Œæˆ–ç‚¹å‡»ç¼©å°æŒ‰é’®ï¼Œå¯¼è‡´æ—¶é—´è½´è¢«ç¼©å°æ—¶ï¼Œä¸€å¼€å§‹åˆ»åº¦æ‰“å°æ–¹å¼ä¸å˜ï¼ˆä¾ç„¶åœ¨è¿™å‡ ä¸ªæ—¶åˆ»æ‰“å°æ–‡å­—ï¼‰ï¼Œåªæ˜¯åˆ»åº¦é—´çš„è·ç¦»éšæ‰‹æŒ‡çš„æ”¶ç¼©è·ç¦»è€Œé€æ¸å˜å°ã€‚å½“åˆ»åº¦é—´è·ç¦»å°åˆ°ä¸€å®šç¨‹åº¦æ—¶ï¼Œåˆ»åº¦æ‰“å°æ–¹å¼æ”¹å˜ï¼Œå˜æˆå¦‚ä¸‹å›¾çš„åˆ»åº¦æ ·å¼ï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/15-12-9/78534287.jpg" alt="åˆ»åº¦è½´3"></p>
<p>æˆ‘çš„å®ç°æ–¹å¼æ˜¯ï¼Œé€šè¿‡ç»§æ‰¿viewå®ç°ä¸€ä¸ªè‡ªå®šä¹‰viewï¼Œåœ¨onMeasureï¼ˆï¼‰é˜¶æ®µæŠŠviewå®½åº¦è®¾ç½®æˆæ‰€æœ‰åˆ»åº¦éƒ½ç»˜åˆ¶å‡ºæ¥ä¼šå ç”¨çš„é•¿åº¦ï¼Œå³åŒ…æ‹¬è¶…å‡ºå±å¹•çš„å®é™…é•¿åº¦ã€‚ç”±äºæ¸¸æ ‡å®é™…æ˜¯ä¸ç§»åŠ¨çš„ï¼Œæ¸¸æ ‡æŒ‡ç¤ºæ—¶é—´çš„æ”¹å˜æ˜¯é€šè¿‡åˆ»åº¦è½´çš„åå‘æ»‘åŠ¨æ¥å®ç°çš„ï¼Œæ‰€ä»¥ä¸ºäº†åœ¨æ—¶é—´è½´æ»‘åŠ¨åˆ°å°½å¤´æ—¶æ¸¸æ ‡èƒ½å¤ŸæŒ‡ç¤ºåˆ°åˆ»åº¦è½´å°½å¤´çš„æ—¶é—´ï¼Œè¿˜éœ€è¦åœ¨ç”¨æˆ·æŒ‡å®šçš„é•¿åº¦åŸºç¡€ä¸Šï¼Œåœ¨åˆ»åº¦è½´çš„æœ€å·¦ç«¯å’Œæœ€å³ç«¯åˆ†åˆ«é¢å¤–å¢åŠ å±å¹•ä¸€åŠå®½åº¦çš„ç©ºç™½åŒºã€‚åŸç†å›¾å¦‚ä¸‹ï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/15-12-9/73909141.jpg" alt=""></p>
<h4 id="åˆ»åº¦æ¡£ä½ä¿¡æ¯">åˆ»åº¦æ¡£ä½ä¿¡æ¯</h4><p>ç”±äºåˆ»åº¦è½´æ ¹æ®ç¼©æ”¾çº§åˆ«çš„ä¸åŒï¼Œæœ‰6æ¡£ä¸åŒçš„åˆ»åº¦æ˜¾ç¤ºæ–¹å¼ï¼ˆä¸Šé¢å±•ç¤ºäº†3ç§ï¼‰ï¼Œæ‰€ä»¥å…ˆæŠŠ6æ¡£åˆ»åº¦ä¿¡æ¯å†™è¿›mapç¼“å­˜ï¼Œmapä¸­çš„æ¯ä¸€ä¸ªitemè®°å½•è¿™æ¡£åˆ»åº¦ä»¥ä¸‹ä¿¡æ¯ï¼š</p>
<ul>
<li>ä¸€å±å¹•æ€»å…±è¦æ˜¾ç¤ºçš„ç§’æ•°ï¼ˆå³å¯è§åŒºåŸŸåŒ…å«çš„ç§’æ•°ï¼‰</li>
<li>å¤§åˆ»åº¦å¯¹åº”çš„ç§’æ•°</li>
<li>å°åˆ»åº¦å¯¹åº”çš„ç§’æ•°</li>
<li>å…³é”®åˆ»åº¦æ–‡å­—çš„æ˜¾ç¤ºæ¨¡å¼ï¼ˆDataFormatçš„patternï¼‰</li>
</ul>
<p>æ¯”å¦‚åˆ»åº¦è½´1å¯¹åº”çš„è¿™å‡ ä¸ªå€¼å°±æ˜¯6 <em> 60 </em> 60ï¼ˆä¸€å±å¹•æ€»å…±æ˜¾ç¤º6ä¸ªå°æ—¶é•¿åº¦ï¼‰ã€60 <em> 60ï¼ˆå¤§åˆ»åº¦å¯¹åº”çš„éƒ½æ˜¯æ•´å°æ—¶ï¼Œå³60 </em> 60çš„æ•´æ•°å€ï¼‰ã€5 * 60ï¼ˆå°åˆ»åº¦å¯¹åº”çš„éƒ½æ˜¯5åˆ†é’Ÿçš„æ•´æ•°å€ï¼‰ã€â€HH:mmâ€ï¼ˆæ—¶é—´æ–‡å­—æ˜¾ç¤ºå°æ—¶å’Œåˆ†é’Ÿï¼‰ã€‚</p>
<p>ç„¶åï¼Œåˆ©ç”¨æ‰‹æœºå±å¹•å®½åº¦screenWidthã€ç”¨æˆ·æŒ‡å®šçš„åˆ»åº¦è½´æ€»é•¿åº¦WHOLE_TIMEBAR_TOTAL_SECONDSã€ä»¥åŠåˆšåˆšåœ¨mapä¸­è®¾å®šçš„ä¸€å±å¹•æ€»å…±è¦æ˜¾ç¤ºçš„ç§’æ•°totalSecondsInOneScreenï¼Œå°±å¯ä»¥è®¡ç®—å‡ºæŸä¸ªåˆ»åº¦æ¡£ä½çš„æ—¶é—´è½´æ€»é•¿åº¦ï¼ˆåƒç´ ï¼‰ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">viewLength = (<span class="keyword">int</span>) ((<span class="keyword">float</span>) screenWidth * WHOLE_TIMEBAR_TOTAL_SECONDS / (<span class="keyword">float</span>) totalSecondsInOneScreen);</span><br></pre></td></tr></table></figure><br>æŠŠç®—å‡ºçš„è¿™ä¸ªviewLengthä¹Ÿç¼“å­˜åˆ°mapçš„å¯¹åº”itemä¸­ï¼Œä½œä¸ºæŸä¸€æ¡£çš„é»˜è®¤viewå®½åº¦ã€‚</p>
<h4 id="viewå®½åº¦è®¾å®š">viewå®½åº¦è®¾å®š</h4><p>åœ¨viewç¬¬ä¸€æ¬¡è¢«åˆå§‹åŒ–æ—¶ï¼Œæˆ‘ä»¬é»˜è®¤æŠŠåˆ»åº¦è½´çš„æ ·å¼è®¾å®šåœ¨ç¬¬3æ¡£çš„åˆ»åº¦æ ·å¼ï¼Œé‚£ä¹ˆå°±ä»mapä¸­å–å‡ºå¯¹åº”çš„åˆ»åº¦æ¡£ä½ä¿¡æ¯çš„æ—¶é—´è½´æ€»é•¿åº¦å­—æ®µviewLengthï¼Œç„¶åé€šè¿‡ä¸ºviewæŒ‡å®šæ–°çš„LayoutParamsæ¥æŒ‡å®šæ—¶é—´è½´viewæ§ä»¶çš„å®½åº¦ï¼Œå¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ViewGroup.LayoutParams params = getLayoutParams();</span><br><span class="line">params.width = viewLength;</span><br><span class="line">setLayoutParams(params);</span><br></pre></td></tr></table></figure></p>
<p>è¿™æ ·ä»…ä»…æ˜¯æŠŠviewå®½åº¦æŒ‡å®šä¸ºæœ‰åˆ»åº¦çš„éƒ¨åˆ†çš„æ€»é•¿åº¦ã€‚ä¸ºäº†åŠ ä¸Šviewä¸¤ç«¯æ— åˆ»åº¦çš„ç•™ç™½éƒ¨åˆ†ï¼Œæˆ‘ä»¬è¦åœ¨onMeasureæ–¹æ³•ä¸­åšä¸€äº›æ‰‹è„šï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;       </span><br><span class="line">       setMeasuredDimension(measureWidth(widthMeasureSpec), VIEW_HEIGHT);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">/**</span><br><span class="line">    * è®¡ç®—æ—¶é—´è½´çš„å®½åº¦ï¼Œå·¦å³éƒ½é¢„ç•™åŠä¸ªå±å¹•çš„å®½åº¦    </span><br><span class="line">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">measureWidth</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> measureMode = MeasureSpec.getMode(widthMeasureSpec);</span><br><span class="line">       <span class="keyword">int</span> measureSize = MeasureSpec.getSize(widthMeasureSpec);</span><br><span class="line">       <span class="keyword">int</span> result = getSuggestedMinimumWidth();</span><br><span class="line">       <span class="keyword">switch</span> (measureMode) &#123;</span><br><span class="line">           <span class="keyword">case</span> MeasureSpec.AT_MOST:</span><br><span class="line">           <span class="keyword">case</span> MeasureSpec.EXACTLY:</span><br><span class="line">               result = measureSize + screenWidth;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           <span class="keyword">default</span>:</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> result;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><br>è¿™æ ·çš„è¯ï¼Œæ‰‹æœºåœ¨æµ‹é‡viewå°ºå¯¸çš„æ—¶å€™å°±ä¼šæŠŠå¤šå‡ºæ¥çš„ä¸€ä¸ªå±å¹•çš„å®½åº¦ä¹Ÿç®—è¿›å»ã€‚</p>
<h4 id="ç”»åˆ»åº¦onDraw()">ç”»åˆ»åº¦onDraw()</h4><p>åˆ»åº¦æ€ä¹ˆç”»æ˜¯åˆ»åº¦è½´å®ç°çš„å…³é”®ã€‚æ€è·¯æ˜¯ï¼Œæˆ‘ä»¬åœ¨onDrawï¼ˆï¼‰ä¸­åªç»˜åˆ¶å‡ºå±å¹•ä¸Šå¯è§çš„é‚£ä¸€éƒ¨åˆ†ï¼Œæ¯æ¬¡ç”¨æˆ·æ»‘åŠ¨æˆ–ç¼©æ”¾æ—¶é—´è½´ï¼Œéƒ½é€šè¿‡invalidate()æ¥é‡æ–°å›è°ƒonDrawï¼ˆï¼‰æ–¹æ³•ã€‚  é‚£ä¹ˆå…³é”®é—®é¢˜å°±æ˜¯å¦‚ä½•ç¡®å®šå±å¹•å¯è§éƒ¨åˆ†åœ¨viewä¸­çš„èµ·å§‹ç‚¹ã€ç»ˆæ­¢ç‚¹åˆ†åˆ«æ˜¯ç¬¬å‡ ä¸ªåƒç´ ã€‚  </p>
<p>ä¸ç®¡æ—¶é—´è½´viewè¢«ç”¨æˆ·ç¼©æ”¾åˆ°äº†ä»€ä¹ˆé•¿åº¦ï¼Œå®ƒçš„æ€»é•¿åº¦æˆ‘ä»¬æ€»æ˜¯çŸ¥é“çš„ï¼ˆå› ä¸ºä¹‹æ‰€ä»¥èƒ½çœ‹åˆ°ç¼©æ”¾æ•ˆæœï¼Œå°±æ˜¯æˆ‘ä»¬æ‰‹åŠ¨åˆ©ç”¨ç¼©æ”¾æŒ‡æ•°factorè®¡ç®—æ–°çš„é•¿åº¦ï¼Œç„¶ååœ¨onMeasureä¸­é‡æ–°æ‰‹åŠ¨èµ‹å€¼ï¼Œåé¢ä¼šè®²åˆ°ï¼‰ï¼ŒåŒæ—¶æ•´ä¸ªæ—¶é—´è½´çš„è·¨åº¦æœ‰å¤šå°‘ç§’æˆ‘ä»¬ä¹Ÿæ˜¯çŸ¥é“çš„ï¼ˆç”¨æˆ·éœ€è¦é€šè¿‡å‚æ•°æŒ‡å®šviewçš„èµ·ç‚¹ã€ç»ˆç‚¹æ—¶é—´ï¼Œç±»å‹ä¸ºlongï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è®¡ç®—å‡ºä¸€ç§’é’Ÿå¯¹åº”å¤šå°‘ä¸ªåƒç´ ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pixelsPerSecond = (<span class="keyword">float</span>) (getWidth() - screenWidth) / (<span class="keyword">float</span>) WHOLE_TIMEBAR_TOTAL_SECONDS;</span><br></pre></td></tr></table></figure></p>
<p>ç”±äºç”¨æˆ·åœ¨åˆå§‹åŒ–æ—¶è¿˜æŒ‡å®šäº†å¸Œæœ›æ¸¸æ ‡æŒ‡ç¤ºåœ¨å“ªä¸ªæ—¶åˆ»ä¸ŠcurrentTimeInMillisecondï¼ŒåŒæ—¶æˆ‘ä»¬å†åˆ©ç”¨è¿™ä¸€æ¡£åˆ»åº¦æ ‡å‡†è§„å®šçš„æœ€å°åˆ»åº¦é—´çš„æ—¶é—´é—´éš”minTickInSecondï¼ˆåœ¨ç¬¬ä¸€éƒ¨åˆå§‹åŒ–mapæ—¶æŒ‡å®šï¼‰ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ±‚å‡ºå±å¹•å¯è§åŒºåŸŸæœ€å·¦ç«¯ã€æœ€å³ç«¯å¯¹åº”çš„æ˜¯æ—¶é—´è½´ä¸Šçš„å“ªä¸ªæ—¶åˆ»ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> forStartUTC = (<span class="keyword">long</span>) (currentTimeInMillisecond / <span class="number">1000</span> - screenWidth / pixelsPerSecond / <span class="number">2</span> - minTickInSecond);</span><br><span class="line"><span class="keyword">long</span> endStartUTC = (<span class="keyword">long</span>) (currentTimeInMillisecond / <span class="number">1000</span> + screenWidth / pixelsPerSecond / <span class="number">2</span> + minTickInSecond);</span><br></pre></td></tr></table></figure></p>
<p>è™½ç„¶æˆ‘ä»¬çŸ¥é“äº†å±å¹•ä¸¤ç«¯å¯¹åº”çš„æ—¶åˆ»ï¼Œä½†ç”±äºè¿™ä¸ªæ—¶åˆ»å¾ˆå¯èƒ½æ˜¯ä¸èƒ½è¢«æœ€å°åˆ»åº¦é—´è·minTickInSecondæ•´é™¤çš„ï¼Œæ¯”å¦‚æˆ‘ä»¬çš„æœ€å°åˆ»åº¦æ˜¯5ç§’ä¸€æ¡£ï¼Œä½†æ˜¯å½“å‰æœ€å·¦ç«¯æ˜¯12ï¼š05ï¼š02ï¼Œé‚£ä¹ˆè¿™ä¸ªåœ°æ–¹å°±ä¸åº”è¯¥æ‰“åˆ»åº¦ï¼Œè€Œåº”è¯¥ç»§ç»­å¾€åæ—©åˆ°ç¬¬ä¸€ä¸ªèƒ½è¢«minTickInSecondæ•´é™¤çš„ä½ç½®ã€‚  </p>
<p>è¿™é‡Œå°±æœ‰ä¸€ä¸ªå¤§å‘ã€‚å¦‚æœç›´æ¥å»ç”¨æ±‚æ¨¡è¿ç®—ï¼ˆ%ï¼‰æ‰¾ç¬¬ä¸€ä¸ªåˆ»åº¦ç‚¹ï¼Œå°±ä¼šå¯¼è‡´æ‰‹æœºè°ƒæ•´ä¸åŒæ—¶åŒºæ—¶ï¼Œåˆ»åº¦è¢«æ‰“åœ¨ä¸åŒä½ç½®ä¸Šçš„é—®é¢˜ï¼Œæ¯”å¦‚æˆ‘å¸Œæœ›00ï¼š00ã€06ï¼š00ã€12ï¼š00ã€18ï¼š00æ‰ä½œä¸ºå…³é”®åˆ»åº¦æ‰“å°æ—¶é—´æ–‡å­—ï¼Œä½†æ˜¯æ‰‹æœºæ—¶åŒºè·³åˆ°åŒ—äº¬æ—¶é—´ï¼ˆUTC+8)æ—¶ï¼Œåˆ»åº¦ä¼šè¢«æ‰“åœ¨08ï¼š00ã€14ï¼š00ã€20ï¼š00ã€02ï¼š00è¿™å‡ ä¸ªä½ç½®ä¸Šã€‚æ›´ç³Ÿç³•çš„æ˜¯ï¼Œå½“ç¼©æ”¾åˆ°å…³é”®åˆ»åº¦åªæ‰“å°å¹´æœˆæ—¥è€Œä¸æ‰“å°æ—¶é—´çš„çº§åˆ«æ—¶ï¼Œçœ‹èµ·æ¥æ¸¸æ ‡æŒ‡åœ¨2015-12-09çš„ä½ç½®ä¸Šï¼Œç”¨æˆ·ä¼šä»¥ä¸ºè¿™æ˜¯åŒ—äº¬æ—¶é—´2015-12-09 00ï¼š00ï¼š00ï¼Œè€Œå®é™…ä»–æŒ‡å‘çš„æ˜¯åŒ—äº¬æ—¶é—´2015-12-09 08ï¼š00ï¼š00ã€‚  </p>
<p>è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±è¦åœ¨æ‰¾åˆ»åº¦ã€ç”»åˆ»åº¦çš„æ—¶å€™è€ƒè™‘æ‰‹æœºè®¾å®šæ—¶åŒºä¸UTCçš„æ—¶å·®ï¼Œç”¨UTCæ—¶é—´åŠ ä¸Šæ—¶å·®çš„ç»“æœæ¥è®¡ç®—åˆ»åº¦çš„ä½ç½®ï¼Œä½†æ˜¯æ—¶é—´è½´ä¸Šæ¯ä¸ªç‚¹ä»£è¡¨çš„æ—¶é—´ä»ç„¶æ˜¯UTCæ—¶é—´ï¼Œæ‰“å°å…³é”®åˆ»åº¦æ–‡å­—ä¼ ç»™DataFormatterçš„å‚æ•°ä¹Ÿä»ç„¶æ˜¯UTCæ—¶é—´ï¼Œå› ä¸ºDataFormatæˆ‘ä»¬åœ¨é»˜è®¤ä¸æŒ‡å®šæ—¶åŒºçš„æƒ…å†µä¸‹å°±æ˜¯æŠŠUTCæ—¶é—´è½¬æˆæ‰‹æœºè®¾å®šçš„æœ¬åœ°æ—¶åŒºæ—¶é—´æ¥æ˜¾ç¤ºçš„ã€‚æ‰¾å±å¹•è¦ç”»å‡ºçš„ç¬¬ä¸€ä¸ªåˆ»åº¦çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">       *æ‰¾å‡ºå½“å‰å±å¹•è¦ç”»å‡ºçš„ç¬¬ä¸€ä¸ªåˆ»åº¦å¯¹åº”çš„æ—¶åˆ»</span><br><span class="line">       */</span></span><br><span class="line">      Calendar cal = Calendar.getInstance();</span><br><span class="line">      <span class="keyword">int</span> zoneOffsetInSeconds = cal.get(java.util.Calendar.ZONE_OFFSET) / <span class="number">1000</span>;<span class="comment">//æ‰‹æœºæœ¬åœ°æ—¶åŒºä¸UTCç›¸å·®çš„æ¯«ç§’æ•°</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">long</span> forStartUTC = (<span class="keyword">long</span>) (currentTimeInMillisecond / <span class="number">1000</span> - screenWidth / pixelsPerSecond / <span class="number">2</span> - timebarTickCriterionMap.get(currentTimebarTickCriterionIndex).minTickInSecond);</span><br><span class="line">      <span class="keyword">long</span> endStartUTC = (<span class="keyword">long</span>) (currentTimeInMillisecond / <span class="number">1000</span> + screenWidth / pixelsPerSecond / <span class="number">2</span> + timebarTickCriterionMap.get(currentTimebarTickCriterionIndex).minTickInSecond);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">long</span> forStartLocalTimezone = forStartUTC + zoneOffsetInSeconds;</span><br><span class="line">      <span class="keyword">long</span> endStartLocalTimezone = endStartUTC + zoneOffsetInSeconds;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">long</span> firstTickToSeeInSecondUTC = -<span class="number">1</span>;<span class="comment">//å±å¹•ä¸Šèƒ½çœ‹åˆ°çš„æœ€å·¦è¾¹ä¸€ä¸ªåˆ»åº¦å¯¹åº”çš„æ—¶é—´,å•ä½æ˜¯ç§’</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">long</span> i = forStartLocalTimezone; i &lt;= endStartLocalTimezone; i++) &#123;</span><br><span class="line">          <span class="keyword">if</span> (i % timebarTickCriterionMap.get(currentTimebarTickCriterionIndex).minTickInSecond == <span class="number">0</span>) &#123;</span><br><span class="line">              firstTickToSeeInSecondUTC = i - zoneOffsetInSeconds;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>timebarTickCriterionMap.get(currentTimebarTickCriterionIndex).minTickInSecond</code>å°±æ˜¯ç”¨æ¥å–åˆ°å½“å‰åˆ»åº¦æ¡£ä½çš„æœ€å°åˆ»åº¦æ—¶é—´é—´è·ã€‚<br>è¿™é‡Œä¸ºäº†é¿å…æœ€è¾¹ç¼˜çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªåˆ»åº¦ç»˜åˆ¶ä¸å‡ºæ¥ï¼Œæ‰€ä»¥åœ¨forStartUTCå’ŒendStartUTCé‡Œéƒ½å¤šç»™äº†ä¸€ä¸ªæœ€å°åˆ»åº¦çš„ä½™é‡ï¼Œä¹Ÿå°±æ˜¯ä»£ç ç¬¬7è¡Œå’Œç¬¬8è¡Œæœ€ååŠ å‡çš„ä¸€ä¸ªæœ€å°åˆ»åº¦é—´è·minTickInSecondã€‚<br>è¿™æ ·ï¼Œæˆ‘ä»¬å°±æ‰¾åˆ°äº†åœ¨æœ¬æ¬¡onDrawï¼ˆï¼‰æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä»viewçš„ç¬¬å‡ ä¸ªåƒç´ å¼€å§‹ç”»åˆ»åº¦ï¼ˆviewæœ€å·¦ç«¯çš„ä½ç½®ä¸ºç¬¬0ä¸ªåƒç´ ï¼Œå¤§éƒ¨åˆ†ä¹‹é—´å¯èƒ½åœ¨å±å¹•ä¹‹å¤–å¾ˆè¿œçš„åœ°æ–¹ï¼‰ã€‚</p>
<p>ç„¶åä»firstTickToSeeInSecondUTCçš„ä½ç½®å¼€å§‹ï¼Œä»¥minTickInSecondä¸ºæ­¥è¿›å€¼ï¼Œæ‰¾æ¯ä¸€ä¸ªæ—¶åˆ»ï¼ŒæŠŠæ¯ä¸€ä¸ªåˆ»åº¦ä¹ŸåŠ ä¸Šæœ¬åœ°ä¸UTCçš„æ—¶å·®ï¼Œç„¶åå»å¯¹å…³é”®åˆ»åº¦é—´è·keyTickInSecondå’Œå°åˆ»åº¦é—´è·minTickInSecondåˆ†åˆ«æ±‚æ¨¡è¿ç®—ï¼ˆ%ï¼‰ï¼Œèƒ½è¢«keyTickInSecondæ•´é™¤çš„å°±æ˜¯å…³é”®åˆ»åº¦ï¼Œåªèƒ½è¢«minTickInSecondæ•´é™¤çš„å°±æ˜¯å°åˆ»åº¦ã€‚å¦‚æ­¤ï¼Œå†è°ƒç”¨canvas.drawRect()ã€canvas.drawText(ï¼‰åˆ†åˆ«ç”»åˆ»åº¦å’Œæ–‡å­—ã€‚</p>
<h4 id="åŒæŒ‡ç¼©æ”¾">åŒæŒ‡ç¼©æ”¾</h4><p>ç”¨æˆ·åœ¨è§¦æ‘¸å±ä¸ŠåŒæŒ‡ç¼©æ”¾æˆ–ç‚¹å‡»æ”¾å¤§ã€ç¼©å°æŒ‰é’®æ—¶ï¼Œæ—¶é—´è½´è¦äº§ç”Ÿç¼©æ”¾æ•ˆæœï¼ŒåŸç†å¾ˆç®€å•ï¼Œå°±æ˜¯æ‹¿ç¼©æ”¾æ¯”ä¾‹scaleFactorä¹˜ä»¥å½“å‰æ•´ä¸ªä¸ªviewå®½åº¦ï¼ˆä¸å«ä¸€å±å¹•çš„ç©ºç™½åŒºï¼‰æœ€ä¸ºæ–°çš„å®½åº¦ï¼Œç„¶åæ‹¿è¿™ä¸ªå®½åº¦å’Œæ¯ä¸€æ¡£åˆ»åº¦æ ‡å‡†ä¸­viewæ•´ä½“é•¿åº¦å­—æ®µè¿›è¡Œæ¯”è¾ƒï¼Œåœ¨åˆé€‚çš„ä½ç½®è¿›è¡Œæ¡£ä½åˆ‡æ¢ï¼Œæˆ–è€…åœ¨ç®—å‡ºviewå®½åº¦è¿‡å¤§æˆ–è¿‡å°æ—¶è¿›è¡Œé™åˆ¶ã€‚æ€»ä¹‹ï¼Œå°±æ˜¯ç®—å‡ºä¸€ä¸ªæ–°çš„viewå®½åº¦å€¼ï¼Œç„¶åé‡è®¾viewçš„LayoutParamsï¼ŒonMeasureï¼ˆï¼‰å’ŒonDrawï¼ˆï¼‰ï¼Œå°±å¯ä»¥çœ‹åˆ°ç¼©æ”¾æ•ˆæœäº†ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">   * æŒ‰ç…§æ¯”ä¾‹å¯¹æ—¶é—´è½´è¿›è¡Œç¼©æ”¾</span><br><span class="line">   * <span class="doctag">@param</span> scaleFactor ç¼©æ”¾æ¯”ä¾‹</span><br><span class="line">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scaleTimebarByFactor</span><span class="params">(<span class="keyword">float</span> scaleFactor)</span></span>&#123;</span><br><span class="line">      <span class="keyword">int</span> newWidth = (<span class="keyword">int</span>) ((getWidth() - screenWidth) * scaleFactor);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (newWidth &gt; timebarTickCriterionMap.get(<span class="number">0</span>).viewLength) &#123;</span><br><span class="line">          setCurrentTimebarTickCriterionIndex(<span class="number">0</span>);</span><br><span class="line">          newWidth = timebarTickCriterionMap.get(<span class="number">0</span>).viewLength;</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newWidth &lt; timebarTickCriterionMap.get(<span class="number">0</span>).viewLength</span><br><span class="line">              &amp;&amp; newWidth &gt;= getAverageWidthForTwoCriterion(<span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">          setCurrentTimebarTickCriterionIndex(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newWidth &lt; getAverageWidthForTwoCriterion(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">              &amp;&amp; newWidth &gt;= getAverageWidthForTwoCriterion(<span class="number">1</span>, <span class="number">2</span>)) &#123;</span><br><span class="line">          setCurrentTimebarTickCriterionIndex(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newWidth &lt; getAverageWidthForTwoCriterion(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">              &amp;&amp; newWidth &gt;= getAverageWidthForTwoCriterion(<span class="number">2</span>, <span class="number">3</span>)) &#123;</span><br><span class="line">          setCurrentTimebarTickCriterionIndex(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newWidth &lt; getAverageWidthForTwoCriterion(<span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">              &amp;&amp; newWidth &gt;= getAverageWidthForTwoCriterion(<span class="number">3</span>, <span class="number">4</span>)) &#123;</span><br><span class="line">          setCurrentTimebarTickCriterionIndex(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newWidth &lt; getAverageWidthForTwoCriterion(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">              &amp;&amp; newWidth &gt;= timebarTickCriterionMap.get(<span class="number">4</span>).viewLength) &#123;</span><br><span class="line">          setCurrentTimebarTickCriterionIndex(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newWidth &lt; timebarTickCriterionMap.get(<span class="number">4</span>).viewLength) &#123;</span><br><span class="line">          setCurrentTimebarTickCriterionIndex(<span class="number">4</span>);</span><br><span class="line">          newWidth = timebarTickCriterionMap.get(<span class="number">4</span>).viewLength;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      ViewGroup.LayoutParams params = getLayoutParams();</span><br><span class="line">      params.width = newWidth;</span><br><span class="line">      setLayoutParams(params);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="å½•åƒç‰‡æ®µè½´">å½•åƒç‰‡æ®µè½´</h3><p>å½•åƒç‰‡æ®µè½´çš„ç»˜åˆ¶åŸç†å¾ˆç®€å•ï¼Œå°±æ˜¯æ‹¿åˆ°ä¸€ä¸ªListæ•°æ®æºï¼Œå…¶ä¸­çš„æ¯ä¸€ä¸ªiteméƒ½æœ‰å½•åƒç‰‡æ®µçš„å¼€å§‹æ—¶é—´fromã€ç»“æŸä¹‹é—´endï¼Œæˆ‘ä»¬å°±é€šè¿‡æ¢ç®—ï¼Œå¾—åˆ°æ¯ä¸ªç‰‡æ®µå¯¹åº”çš„å¼€å§‹åƒç´ ä½ç½®ã€ç»“æŸåƒç´ ä½ç½®ï¼Œç„¶ååœ¨å±å¹•çš„å¯¹åº”ä½ç½®ç”¨canvas.drawRect()ç”»æ¡†å°±è¡Œäº†ã€‚<br>ä½†æ˜¯è€ƒè™‘åˆ°æ•ˆç‡é—®é¢˜ï¼Œå¦‚æœå½•åƒç‰‡æ®µæ•°æ®å¾ˆå¤šï¼Œè¾¾åˆ°æ•°åƒç”šè‡³æ•°ä¸‡æ®µï¼ˆæ¯”å¦‚å¾ˆå¤šéƒ½æ˜¯çŸ­è§†é¢‘ï¼‰ï¼Œé‚£ä¹ˆä¸€æ¬¡æ€§å…¨éƒ¨ç»˜åˆ¶å‡ºæ¥æ˜¯ä¸ç°å®çš„ï¼Œè¿˜æ˜¯åªèƒ½ç»˜åˆ¶å±å¹•å¯è§éƒ¨åˆ†ï¼Œç„¶ååœ¨æ—¶é—´è½´è¢«ç¼©æ”¾æ—¶ï¼Œå½•åƒç‰‡æ®µè½´éšä¹‹ç¼©æ”¾ï¼Œå›è°ƒonDrawï¼ˆï¼‰æ–¹æ³•ï¼Œå†æ¬¡é‡ç»˜å±å¹•å¯è§åŒºåŸŸã€‚<br>é—®é¢˜å°±æ¥äº†ï¼Œåœ¨ä¿è¯Listä¸­æ•°æ®ç‰‡æ®µä¸é‡å ï¼ˆå³æ¯ä¸€æ®µçš„fromåˆ°toä¸å¦ä¸€æ®µçš„fromåˆ°toéƒ½æ— äº¤é›†ï¼‰ä¸”æœ‰åºæ’åˆ—çš„æƒ…å†µä¸‹ï¼ˆå‰ä¸€æ®µçš„toå°äºåä¸€æ®µçš„fromï¼‰ï¼Œå¦‚ä½•å¿«é€Ÿæ‰¾åˆ°å“ªä¸€ä¸ªitemæ‰æ˜¯ç¬¬ä¸€ä¸ªåº”è¯¥è¢«ç»˜åˆ¶å‡ºæ¥çš„itemï¼Ÿéå†listçš„æ–¹æ³•æ˜¾ç„¶å¤ªè€—æ—¶ï¼Œæ¯æ¬¡onDrawï¼ˆï¼‰éƒ½å»éå†ä¸€éçš„è¯ï¼Œç•Œé¢åœ¨æ»‘åŠ¨æˆ–ç¼©æ”¾æ—¶ä¼šå¡é¡¿å¾—æ— æ³•æ¥å—ã€‚  </p>
<p>æˆ‘çš„è§£å†³åŠæ³•å¦‚ä¸‹ï¼š<br><strong>æ­¥éª¤ä¸€</strong>ï¼šåœ¨å¤–ç•Œå‘viewè®¾ç½®å½•åƒç‰‡æ®µè½´çš„æ•°æ®æºListåï¼Œç”¨æˆ‘è‡ªå·±çš„ç±»CloudRecordExistTimeClipsæ¥è®°å½•å½•åƒç‰‡æ®µitemä¿¡æ¯ï¼Œå…¶ä¸­åŒ…æ‹¬fromã€toçš„longå€¼ï¼Œè¿˜åŒ…æ‹¬ä¸€ä¸ªListå­—æ®µ<code>coverDateZeroOClockList</code>ç”¨æ¥è®°å½•è¿™ä¸ªitemè·¨è¶Šäº†å“ªå‡ å¤©ï¼Œä¹Ÿå°±æ˜¯<br>ä»startTimeInMillisecondåˆ°endTimeInMillisecondæ‰€æ¶µç›–çš„æ‰€æœ‰æ—¥æœŸçš„00ï¼š00æ‰€å¯¹åº”çš„æ¯«ç§’æ•°ã€‚æ¯”å¦‚ä»2015-11-26 10:10:30åˆ°2015-11-29 19ï¼š12ï¼š55ï¼Œé‚£ä¹ˆcoverDateZeroOClockListå°±è®°å½•â€œ2015-11-26 00ï¼š00ï¼š00â€ã€â€œ2015-11-27 00ï¼š00ï¼š00â€ã€â€œ2015-11-28 00ï¼š00ï¼š00â€ã€â€œ2015-11-29 00ï¼š00ï¼š00â€ã€‚å…·ä½“å®ç°æ–¹å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CloudRecordExistTimeClips</span> </span>&#123;</span><br><span class="line">       <span class="keyword">static</span> <span class="keyword">long</span> mostLeftDayZeroTime = Long.MAX_VALUE;<span class="comment">//æ‰€æœ‰æ—¶é—´ç‰‡æ®µæœ€æ—©çš„å¼€å§‹æ—¥æœŸå¯¹åº”çš„00ï¼š00çš„æ¯«ç§’æ•°</span></span><br><span class="line">       <span class="keyword">static</span> <span class="keyword">long</span> mostRightDayZeroTime = -<span class="number">1</span>;<span class="comment">//æ‰€æœ‰æ—¶é—´ç‰‡æ®µæœ€æ™šçš„å¼€å§‹æ—¥æœŸå¯¹åº”çš„00ï¼š00çš„æ¯«ç§’æ•°</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">long</span> startTimeInMillisecond;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">long</span> endTimeInMillisecond;</span><br><span class="line"></span><br><span class="line">       <span class="comment">/**</span><br><span class="line">        * ä»startTimeInMillisecondåˆ°endTimeInMillisecondæ‰€æ¶µç›–çš„æ‰€æœ‰æ—¥æœŸçš„00ï¼š00æ‰€å¯¹åº”çš„æ¯«ç§’æ•°ã€‚</span><br><span class="line">        * å¦‚ä»2015-11-26 10:10:30åˆ°2015-11-29 19ï¼š12ï¼š55ï¼Œ</span><br><span class="line">        * é‚£ä¹ˆcoverDateZeroOClockListå°±è®°å½•â€œ2015-11-26 00ï¼š00ï¼š00â€ã€â€œ2015-11-27 00ï¼š00ï¼š00â€ã€â€œ2015-11-28 00ï¼š00ï¼š00â€ã€â€œ2015-11-29 00ï¼š00ï¼š00â€</span><br><span class="line">        */</span></span><br><span class="line">       <span class="keyword">private</span> List&lt;Long&gt; coverDateZeroOClockList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">CloudRecordExistTimeClips</span><span class="params">(<span class="keyword">long</span> startTimeInMillisecond, <span class="keyword">long</span> endTimeInMillisecond)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">this</span>.startTimeInMillisecond = startTimeInMillisecond;</span><br><span class="line">           <span class="keyword">this</span>.endTimeInMillisecond = endTimeInMillisecond;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (startTimeInMillisecond &lt; mostLeftDayZeroTime)&#123;</span><br><span class="line">               <span class="keyword">this</span>.mostLeftDayZeroTime = startTimeInMillisecond;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (endTimeInMillisecond &gt; mostRightDayZeroTime)&#123;</span><br><span class="line">               <span class="keyword">this</span>.mostRightDayZeroTime = endTimeInMillisecond;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           SimpleDateFormat dateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>);</span><br><span class="line">           SimpleDateFormat zeroTimeFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line"></span><br><span class="line">           String startTimeDateString = dateFormat.format(startTimeInMillisecond);</span><br><span class="line">           String startTimeZeroTimeString = startTimeDateString + <span class="string">" 00:00:00"</span>;</span><br><span class="line"></span><br><span class="line">           String endTimeDateString = dateFormat.format(endTimeInMillisecond);</span><br><span class="line">           String endTimeZeroTimeString = endTimeDateString + <span class="string">" 00:00:00"</span>;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               Date startTimeZeroDate = zeroTimeFormat.parse(startTimeZeroTimeString);</span><br><span class="line">               Date endTimeZeroDate = zeroTimeFormat.parse(endTimeZeroTimeString);</span><br><span class="line"></span><br><span class="line">               <span class="keyword">long</span> loopZeroDateInMilliseconds = startTimeZeroDate.getTime();</span><br><span class="line">               <span class="keyword">while</span> (loopZeroDateInMilliseconds &lt;= endTimeZeroDate.getTime())&#123;</span><br><span class="line">                   coverDateZeroOClockList.add(loopZeroDateInMilliseconds);</span><br><span class="line">                   loopZeroDateInMilliseconds = loopZeroDateInMilliseconds + SECONDS_PER_DAY * <span class="number">1000</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">               e.printStackTrace();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getStartTimeInMillisecond</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> startTimeInMillisecond;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getEndTimeInMillisecond</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> endTimeInMillisecond;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> List&lt;Long&gt; <span class="title">getCoverDateZeroOClockList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">return</span> coverDateZeroOClockList;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p><strong>æ­¥éª¤äºŒ</strong>ï¼šæ ¹æ®æ¯ä¸ªå½•åƒç‰‡æ®µå¯¹è±¡CloudRecordExistTimeClipsè¦†ç›–çš„æ—¥æœŸï¼Œå°†æ¯ä¸€ä¸ªitemç¼“å­˜åœ¨ä¸€ä¸ªå…¨å±€Mapä¸­ï¼Œmapçš„keyæ˜¯æŸä¸ªæ—¥æœŸ00ï¼š00ï¼š00å¯¹åº”çš„longï¼Œvalueå°±æ˜¯è¿™ä¸ªç‰‡æ®µCloudRecordExistTimeClipså¯¹è±¡ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªç‰‡æ®µçš„fromæ˜¯<code>2015-12-08 11:32:22</code>ï¼Œtoå€¼æ˜¯<code>2015-12-10 11:32:22</code>ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°±åŒæ—¶å¤„åœ¨keyä¸º<code>2015-12-08 00:00:00</code>ã€<code>2015-12-09 00:00:00</code>ã€<code>2015-12-10 00:00:00</code>çš„mapæ§½ä¸­ã€‚</p>
<p><strong>æ­¥éª¤ä¸‰</strong>ï¼šåœ¨onDrawï¼ˆï¼‰æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“å±å¹•å¯è§åŒºåŸŸå·¦è¾¹ç¼˜ä¸viewçš„äº¤ç‚¹å¯¹åº”çš„æ—¶é—´è½´UTCæ—¶é—´ï¼ˆæ¯”å¦‚<code>2015-12-09 15:30:12</code>ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä»¥å½“å¤©0ç‚¹çš„æ—¶é—´ï¼ˆå³ä¾‹å­çš„<code>2015-12-09 00ï¼š00ï¼š00</code>ï¼‰ä¸ºkeyå»å–å‡ºå½“å¤©ç¬¬ä¸€ä¸ªç‰‡æ®µï¼Œä»è¿™ä¸ªç‰‡æ®µç”»èµ·ã€‚å¦‚æœè¿™ä¸ªkeyå¯¹åº”çš„valuesä¸ºnullï¼Œé‚£ä¹ˆå°±æŠŠkeyçš„å€¼å¾€ååŠ ä¸€å¤©ï¼Œç»§ç»­æ‰¾ï¼Œæ‰¾åˆ°æ‰¾åˆ°ç¬¬ä¸€ä¸ªç‰‡æ®µå¼€å§‹ç”»ï¼›æˆ–è€…keyçš„æ—¶é—´å¤§äºå±å¹•å³è¾¹ç¼˜çš„æ—¶é—´è¿˜æ²¡æ‰¾åˆ°å°±åœæ­¢å¯»æ‰¾ï¼Œå› ä¸ºè¯´æ˜å±å¹•å¯è§åŒºåŸŸä¸­æ²¡æœ‰éœ€è¦ç»˜åˆ¶çš„å½•åƒç‰‡æ®µã€‚</p>
<h3 id="æ»‘åŠ¨ä¸ç¼©æ”¾">æ»‘åŠ¨ä¸ç¼©æ”¾</h3><p>ç¼©æ”¾äº‹ä»¶æ¯«æ— ç–‘é—®ç›´æ¥ä½¿ç”¨androidæä¾›çš„ç¼©æ”¾æ‰‹åŠ¿æ¢æµ‹å™¨ScaleGestureDetectoræ¥æ£€æµ‹ï¼Œç›´æ¥å¯ä»¥æ‹¿åˆ°ç¼©æ”¾æ¯”ä¾‹å‚æ•°scaleFactorï¼Œç„¶åç”¨ä¸Šé¢æåˆ°çš„ç¼©æ”¾å‡½æ•°æ¥å¤„ç†ã€‚<br>æ»‘åŠ¨å¯ä»¥åœ¨<code>onTouchEventï¼ˆMotionEvent eventï¼‰</code>ä¸­è‡ªå·±å¤„ç†ACTION_DOWNã€ACTION_MOVEã€ACTION_UPäº‹ä»¶æµï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨androidæä¾›çš„æ‰‹åŠ¿æ¢æµ‹å™¨GestureDetectoræ¥å¤„ç†ï¼Œæ‹¿åˆ°æ»‘åŠ¨çš„è·ç¦»deltaXï¼Œåœ¨åŸæ¥viewçš„layoutä½ç½®çš„åŸºç¡€ä¸Šè®¡ç®—æ»‘åŠ¨ååº”è¯¥å¤„äºçš„ä½ç½®ï¼Œç„¶åè°ƒç”¨layout(left, top, right, top + getHeight())æ¥ä½¿viewæ»‘åŠ¨ï¼Œæœ€åè°ƒç”¨invalidate()æ¥å‘èµ·é‡ç»˜ã€‚</p>
<p><strong>è¿™é‡Œè¸©åˆ°ä¸€ä¸ªå‘</strong>ï¼š<br>ScaleGestureDetectorå’ŒGestureDetectoréƒ½è¦åœ¨<code>onTouchEventï¼ˆMotionEvent eventï¼‰</code>å‡½æ•°çš„æœ€å‰é¢é€šè¿‡æˆªè·eventæ¥è¿›è¡Œæ‰‹åŠ¿å¤„ç†ã€‚å¦‚æœæ˜¯ä¸€ä¸ªç¼©æ”¾äº‹ä»¶ï¼ŒScaleGestureDetectorå·²ç»å¤„ç†äº†ç¼©æ”¾æ‰‹åŠ¿ï¼Œé‚£ä¹ˆACTION_DOWNã€ACTION_MOVEã€ACTION_UPä»¥åŠå…¶ä»–äº‹ä»¶æµå°±ä¸åº”è¯¥å†ç»§ç»­åœ¨onTouchEventï¼ˆï¼‰åé¢çš„ACTION_DOWNã€ACTION_MOVEã€ACTION_UPç­‰åˆ†æ”¯ä¸­å¤„ç†äº†ï¼ŒæŒ‰ç…§androidæ–‡æ¡£è¯´æ˜ï¼Œæˆ‘ä½¿ç”¨<code>scaleGestureDetector.onTouchEvent(event)</code>çš„è¿”å›å€¼æ¥åˆ¤æ–­è¿™ä¸ªeventæ˜¯ä¸æ˜¯å·²è¿‘è¢«å¤„ç†è¿‡çš„ç¼©æ”¾äº‹ä»¶ï¼Œå¦‚æœæ˜¯å°±ç›´æ¥returnä¸å†èµ°åé¢çš„æµç¨‹ã€‚<br>ç»“æœè¯æ˜æˆ‘å¾ˆå‚»å¾ˆå¤©çœŸï¼Œæ—¶é—´è½´åœ¨è¢«æˆ‘åŒæŒ‡ç¼©æ”¾æ—¶åŒæ—¶ä¹Ÿå‡ºç°äº†æ„å¤–çš„ä½ç§»ï¼Œè¯´æ˜scaleGestureDetector.onTouchEvent(event)çš„è¿”å›å€¼æ˜¯æ— æ•ˆçš„ã€‚<br>googleä¹‹åå‘ç°ï¼Œå¾ˆå¤šå¼€å‘è€…éƒ½é‡åˆ°äº†åŒæ ·çš„é—®é¢˜ï¼Œè¯´è¿™åº”è¯¥æ˜¯android sdkçš„ä¸€ä¸ªbugï¼ŒscaleGestureDetector.onTouchEvent(event)æ°¸è¿œåªä¼šè¿”å›falseã€‚æ‰€ä»¥ï¼Œåœ¨è¿™é‡Œè¦å…ˆé€šè¿‡<code>scaleGestureDetector.onTouchEvent(event)</code>è°ƒç”¨ç¼©æ”¾æ‰‹åŠ¿æ¢æµ‹å™¨ï¼Œç„¶åç”¨<code>scaleGestureDetector.isInProgress()</code>æ¥åˆ¤æ–­æœ¬æ¬¡äº‹ä»¶æ˜¯å¦è¢«ä½œä¸ºç¼©æ”¾æ‰‹åŠ¿å¤„ç†äº†ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123; </span><br><span class="line">       scaleGestureDetector.onTouchEvent(event);</span><br><span class="line">       <span class="keyword">if</span> (scaleGestureDetector.isInProgress()) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">switch</span> (event.getAction() &amp; MotionEvent.ACTION_MASK) &#123;</span><br><span class="line">           <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">               ...</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">          </span><br><span class="line">           <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">               ...</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">              	...</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å½•åƒç‰‡æ®µé€‰æ‹©å™¨">å½•åƒç‰‡æ®µé€‰æ‹©å™¨</h2><p>é€šè¿‡ä¸¤ä¸ªæ»‘åŠ¨æŒ‰é’®æ¥é€‰æ‹©å½•åƒç‰‡æ®µï¼Œä¸¤ä¸ªæ»‘åŠ¨æŒ‰é’®ä¹‹é—´çš„éƒ¨åˆ†è¡¨ç¤ºè¢«é€‰ä¸­çš„ç‰‡æ®µï¼Œä¸¤ä¸ªæ»‘åŠ¨æŒ‰é’®ä¸Šè¦æ˜¾ç¤ºå¯¹åº”çš„å½•åƒæˆªå›¾ã€æ—¶é—´æ–‡å­—æç¤ºï¼Œåœ¨æ»‘åŠ¨æ—¶ã€é™æ­¢æ—¶æ ¹æ®è·å–æˆåŠŸä¸å¦æ˜¾ç¤ºä¸åŒçš„å ä½å›¾ã€‚ç”±äºå½•åƒç‰‡æ®µé€‰æ‹©å™¨ä¸Šçš„æ—¶é—´ä¿¡æ¯æ˜¯ä¾é™„äºæ—¶é—´è½´æ§ä»¶çš„ï¼Œæ‰€ä»¥å½“æ—¶é—´è½´è¢«æ»‘åŠ¨ã€ç¼©æ”¾æ—¶ï¼Œå½•åƒç‰‡æ®µé€‰æ‹©å™¨ä¹Ÿè¦åŒæ­¥æ›´æ–°ã€‚</p>
<p><img src="http://7xle8x.com1.z0.glb.clouddn.com/15-12-10/52392486.jpg" alt=""></p>
<p>å¾ˆæ˜æ˜¾ï¼Œè¿™ä¸ªæ§ä»¶ç®€åŒ–ä¸€ä¸‹å°±æ˜¯æœ‰ä¸¤ä¸ªthumbçš„seekbarï¼Œæ‰€ä»¥å°±å–githubä¸Šæ‰¾äº†ä¸€ä¸‹ä¸¤ä¸ªæŒ‰é’®çš„seekbaræ§ä»¶ï¼Œç»“æœæ‰¾åˆ°äº†<a href="https://github.com/yahoo/android-range-seek-bar" target="_blank" rel="external">anothem/android-range-seek-baré¡¹ç›®</a>ï¼Œå®ƒæä¾›ä¸androidçš„seekbarè§†è§‰æ•ˆæœç±»ä¼¼çš„åŒæŒ‰é’®seekbaræ§ä»¶ã€‚<br>æˆ‘çš„æ”¹é€ å·¥ä½œä¸»è¦å°±æ˜¯é‡å†™onMeasure()ã€onLayout()ã€onDraw()ã€onTouchEvent()æ–¹æ³•ï¼Œæœ€éº»çƒ¦çš„å°±æ˜¯onDrawï¼ˆï¼‰ä¸­ç»˜åˆ¶æ—¶å¯¹ç»å¯¹åæ ‡çš„è®¡ç®—ã€‚å…¶è®¡ç®—æ–¹æ³•ä¸æ—¶é—´è½´ç±»ä¼¼ï¼Œç”šè‡³è¿˜ç®€å•è®¸å¤šï¼Œè¿™é‡Œå°±ä¸å†é‡å¤å†™äº†ã€‚</p>
<p><em>è¿™é‡Œçš„ä¸€ä¸ªå‘</em>ï¼š<br>ç”±äºè¿™ä¸ªè‡ªå®šä¹‰viewä¸­éœ€è¦ç”¨åˆ°androidçš„ImageViewï¼ˆç»™Glideä½¿ç”¨ï¼‰ï¼Œæ‰€ä»¥è¿™ä¸ªè‡ªå®šä¹‰viewå°±ä¸èƒ½ç»§æ‰¿äº<code>view</code>ï¼Œè€Œæ˜¯ç»§æ‰¿äº<code>ViewGroup</code>ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨åˆå§‹åŒ–é˜¶æ®µå‘å…¶ä¸­æ·»åŠ å…¶ä»–viewäº†ã€‚ç„¶è€Œè°ƒè¯•çš„æ—¶å€™å‘ç°ï¼Œ<code>onDrawï¼ˆï¼‰</code>æ–¹æ³•æ€ä¹ˆéƒ½ä¸ä¼šè¢«è°ƒç”¨ã€‚åŸæ¥ï¼ŒViewGroupé»˜è®¤åªæ˜¯ç”¨æ¥å¸ƒå±€ï¼Œä¸€èˆ¬æ²¡æœ‰ä»€ä¹ˆéœ€è¦ç»˜åˆ¶çš„ä¸œè¥¿ï¼Œæ‰€ä»¥ç³»ç»Ÿé»˜è®¤å°±ä¸è°ƒç”¨å®ƒçš„onDrawï¼ˆï¼‰å›è°ƒã€‚å¦‚æœè¦è®©ViewGroupçš„onDrawï¼ˆï¼‰æ–¹æ³•è¢«å›è°ƒï¼Œæœ‰ä¸¤ç§æ–¹æ³•ï¼š  </p>
<p>ã€æ–¹æ³•1ã€‘è®©ç³»ç»ŸçŸ¥é“è¿™ä¸ªViewGroupæœ‰å¯ç»˜åˆ¶çš„ä¸œè¥¿ï¼Œæ¯”å¦‚åœ¨xmlä¸­å®šä¹‰è¿™ä¸ªViewGroupçš„æ—¶å€™ä¸ºå®ƒæŒ‡å®šbackgroundå±æ€§ã€‚<br>ã€æ–¹æ³•2ã€‘åœ¨ä»£ç ä¸­è°ƒç”¨setWillNotDraw(false)å¼ºåˆ¶è¦æ±‚è°ƒç”¨onDraw()æ–¹æ³•ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>æœ€è¿‘çš„å·¥ä½œæ˜¯åšäº†ä¸¤ä¸ªè‡ªå®šä¹‰æ§ä»¶ï¼š<br>â‘ å¯ä»¥ç¼©æ”¾çš„æ—¶é—´è½´<br>â‘¡å¸é™„åœ¨åœ¨æ—¶é—´è½´ä¸Šæœ‰ä¸¤ä¸ªæ»‘åŠ¨æŒ‰é’®çš„å½•åƒç‰‡æ®µé€‰æ‹©å™¨  </p>
<p>çœŸæœºæµ‹è¯•æ•ˆæœå¦‚ä¸‹é¢çš„gifåŠ¨ç”»æ‰€ç¤ºï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/15-12-10/74682253.jpg" alt=""></p>]]>
    
    </summary>
    
      <category term="Android" scheme="http://www.carrotsight.com/tags/Android/"/>
    
      <category term="æ—¶é—´è½´" scheme="http://www.carrotsight.com/tags/%E6%97%B6%E9%97%B4%E8%BD%B4/"/>
    
      <category term="Android" scheme="http://www.carrotsight.com/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[ä¸€ä¸ªandroidæ—¥å¿—åº“çš„å®ç°]]></title>
    <link href="http://www.carrotsight.com/2015/11/13/%E4%B8%80%E4%B8%AAandroid%E6%97%A5%E5%BF%97%E5%BA%93%E7%9A%84%E5%AE%9E%E7%8E%B0.html"/>
    <id>http://www.carrotsight.com/2015/11/13/ä¸€ä¸ªandroidæ—¥å¿—åº“çš„å®ç°.html</id>
    <published>2015-11-13T06:12:58.000Z</published>
    <updated>2015-12-04T10:45:54.000Z</updated>
    <content type="html"><![CDATA[<h1 id="è°ƒç ”">è°ƒç ”</h1><p>åœ¨androidå¼€å‘ä¸­ï¼Œå¦‚æœéœ€è¦æ‰“å°è°ƒè¯•ä¿¡æ¯ï¼Œå¾€å¾€ä¼šä½¿ç”¨Log.d()ã€Log.e()ä¹‹ç±»çš„ç”±android.util.Logæä¾›çš„æ–¹æ³•ã€‚å®ƒçš„å¥½å¤„æ˜¯ç®€å•ã€æ–¹ä¾¿ï¼Œä¸è¶³ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå¯å®šåˆ¶æ€§å·®ï¼Œä¸èƒ½æ‰“å°åˆ°æ–‡ä»¶ã€‚å¦‚æœæƒ³åœ¨å‘è¡Œç‰ˆappä¸­çš„æŸäº›å…³é”®è¯­å¥æ‰“å°logåˆ°æ–‡ä»¶ï¼Œæˆ–è€…åœ¨appå´©æºƒæ—¶æŠŠå´©æºƒä¿¡æ¯æ‰“å°åˆ°æ–‡ä»¶ä¾›ä¸Šä¼ åˆ†æï¼Œé‚£ä¹ˆandroid.util.Logå°±æ— èƒ½ä¸ºåŠ›äº†ã€‚<br><a id="more"></a><br>åœ¨ç½‘ä¸Šåšäº†ä¸€ä¸‹androidå¹³å°æ—¥å¿—åº“çš„è°ƒç ”ï¼ŒæŒ‘å‡ºä¸€äº›æ¯”è¾ƒæœ‰ä»£è¡¨æ€§æœ‰å½±å“åŠ›çš„ï¼Œå¤§è‡´ç»“æœå¦‚ä¸‹ï¼š</p>
<blockquote>
<p>â‘ orhanobut/loggerï¼š<br>æ¥è‡ªgithub.comï¼Œæˆªæ­¢2015å¹´11æœˆ10æ—¥15:53:20è¯¥é¡¹ç›®å·²ç»æœ‰1996é¢—æ˜Ÿï¼ï¼ï¼<br>åœ°å€ï¼š<a href="https://github.com/orhanobut/logger" target="_blank" rel="external">https://github.com/orhanobut/logger</a></p>
<p>â‘¡JakeWharton/timberï¼š<br>æ¥è‡ªgithub.comï¼Œæˆªæ­¢2015å¹´11æœˆ10æ—¥15:54:22è¯¥é¡¹ç›®å·²ç»æœ‰1571é¢—æ˜Ÿï¼ï¼ï¼<br>åœ°å€ï¼š<a href="https://github.com/JakeWharton/timber" target="_blank" rel="external">https://github.com/JakeWharton/timber</a></p>
<p>â‘¢noveogroup/android-loggerï¼š<br>æ¥è‡ªgithub.comï¼Œæˆªæ­¢2015å¹´11æœˆ10æ—¥15:55:56è¯¥é¡¹ç›®å·²ç»æœ‰125é¢—æ˜Ÿï¼ˆè·Ÿä¸Šé¢ä¸¤ä½æ¯”å·®çš„æŒºå¤šï¼‰ã€‚<br>åœ°å€ï¼š<a href="https://github.com/noveogroup/android-logger" target="_blank" rel="external">https://github.com/noveogroup/android-logger</a></p>
<p>â‘£SLF4Jï¼š<br>å®ƒåªæ˜¯ä¸€ä¸ªå¯¹logç³»ç»Ÿè¿›è¡ŒæŠ½è±¡çš„è¡¨ç°å½¢å¼ï¼Œä¸æ˜¯å…·ä½“çš„å®ç°ã€‚å®ƒæ”¯æŒç¬¬ä¸‰æ–¹logæ¡†æ¶ï¼Œæ¯”å¦‚log4jç­‰ã€‚å¦‚æœéœ€è¦æŒ‡å®šç¬¬ä¸‰æ–¹logæ¡†æ¶ï¼Œåªéœ€è¦åœ¨è¿è¡Œæ—¶æŠŠå¯¹åº”çš„slf4jçš„jaræ–‡ä»¶æ”¾åœ¨ä½ çš„class pathä¸­ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨bindè¯¥logæ¡†æ¶ã€‚æ¯”å¦‚ï¼Œè¦ä»java.util.loggingä¸­åˆ‡æ¢åˆ°log4jï¼Œåªéœ€è¦æŠŠslf4j-jdk-1.7.12.jaræ›¿æ¢ä¸ºslf4j-log4j12-1.7.12.jarå³å¯ã€‚<br>åœ°å€ï¼š<a href="http://www.slf4j.org/download.html" target="_blank" rel="external">http://www.slf4j.org/download.html</a></p>
<p>â‘¤SLF4J-Androidï¼š<br>SLF4J-Androidæ˜¯å¯¹SLF4Jçš„APIçš„é‡æ–°åŒ…è£…ï¼Œä»¥åŠä¸€ä¸ªè½»é‡çº§çš„bindå®ç°ã€‚è¯¥å®ç°ç®€å•çš„æŠŠæ‰€æœ‰çš„SLF4Jçš„logè¯·æ±‚éƒ½ç”¨Androidçš„Logå·¥å…·è¿›è¡Œäº†æ›¿æ¢ã€‚åŠŸèƒ½ä¸SLF4Jç±»ä¼¼ã€‚ä¸è¿‡åªæ”¯æŒ23ä¸ªå­—ç¬¦é•¿åº¦çš„Tagï¼Œä¾‹å¦‚com.example.myapp.MyClassä¼šè¢«æˆªæ–­ä¸ºc*.e*.m*.MyClassï¼Œä¼šå¯¼è‡´ä¸åŒçš„ç±»åœ¨tagä¸­æ˜¾ç¤ºåŒæ ·çš„åç§°ï¼Œå¼•èµ·æ··æ·†ã€‚<br>åœ°å€ï¼š<a href="http://www.slf4j.org/android/" target="_blank" rel="external">http://www.slf4j.org/android/</a></p>
<p>â‘¥ LOGBackï¼š<br>LOGBackä¸Log4Jçš„ä½œè€…æ˜¯åŒä¸€ä¸ªäººã€‚ä½œè€…æ›´æ¨èä½¿ç”¨LOGBackã€‚å…·ä½œè€…è¯´LOGBackåœ¨æŸäº›è‹›åˆ»çš„æ‰§è¡Œè·¯å¾„ä¸‹ï¼Œæ¯”log4jå·®ä¸å¤šè¦å¿«10å€ï¼Œç»è¿‡äº†é•¿æœŸè€Œå¹¿æ³›çš„æµ‹è¯•ï¼Œæ¯”log4jæ›´ä¸ºå¯é ã€‚ä¸è¿‡è¿™è´§æ˜¯ä¸ªé‡é‡çº§é€‰æ‰‹ï¼ŒåŠŸèƒ½å¤ªå…¨ï¼Œä½“ç§¯åºå¤§ã€‚<br>åœ°å€ï¼š<a href="http://logback.qos.ch/" target="_blank" rel="external">http://logback.qos.ch/</a></p>
<p>â‘¦android-logging-log4jï¼š<br>å†…éƒ¨ä½¿ç”¨log4jï¼Œæ”¯æŒslf4j;é€‚ç”¨äºlog4jçš„LogCatAppenderï¼Œå®ƒèƒ½å¤ŸæŠŠlogæ‰“å°åˆ°LogCat;æä¾›äº†ä¸€ä¸ªlog4jçš„é…ç½®è£…é¥°ç±»ï¼Œç”¨å®ƒèƒ½å¤Ÿæ–¹ä¾¿åœ°é…ç½®Log4J;åŒæ—¶ä¸éœ€è¦ä¿®æ”¹log4j.jaræ–‡ä»¶ã€‚<br>åœ°å€ï¼š<a href="https://code.google.com/p/android-logging-log4j/" target="_blank" rel="external">https://code.google.com/p/android-logging-log4j/</a></p>
</blockquote>
<p>å‰ä¸‰ä¸ªåº“æ˜¯ä¸“ä¸ºandroidè®¾è®¡çš„ï¼Œå¯ä»¥çœ‹åˆ°æ”¯æŒè€…ä¼—å¤šï¼Œä¸è¿‡å®ƒä»¬å†…éƒ¨å®ç°ä¸Šä¹Ÿæ˜¯è°ƒç”¨android.util.Logçš„æ–¹æ³•æ‰“å°åˆ°æ§åˆ¶å°ï¼Œä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚åé¢çš„å‡ ä¸ªåº“ä¸­æœ‰ä¸€äº›é€‰æ‰‹éå¸¸å…¨èƒ½ï¼Œä¸è¿‡ä½“ç§¯è¾ƒå¤§ï¼Œå¾ˆå¤šåŠŸèƒ½æ˜¯æˆ‘ä»¬ä¸éœ€è¦çš„ï¼Œè€Œä¸”å®ƒä¹Ÿæ— æ³•å¾ˆæ–¹ä¾¿çš„æ‰©å±•è‡ªå®šä¹‰çš„æ—¥å¿—å®ç°ï¼Œæ¯”å¦‚appå´©æºƒä¿¡æ¯è·å–ã€æ—¥å¿—æ–‡ä»¶åå°ä¸Šä¼ ç­‰ã€‚äºæ˜¯ä¹å¼€å§‹è‡ªå·±åŠ¨æ‰‹å®ç°ä¸€ä¸ªæ—¢æ–¹ä¾¿å®ç”¨ï¼Œèƒ½è¦†ç›–åŸºæœ¬çš„æ§åˆ¶å°ã€æ–‡ä»¶è¾“å‡ºï¼Œåˆä¾¿äºè‡ªå®šä¹‰æ‰©å±•çš„androidæ—¥å¿—åº“ã€‚</p>
<h1 id="gradleç›´æ¥é…ç½®æ—¥å¿—åº“">gradleç›´æ¥é…ç½®æ—¥å¿—åº“</h1><p>log4jæœ€å¼ºå¤§æ–¹ä¾¿çš„åœ°æ–¹åº”è¯¥å°±æ˜¯å®ƒå¯ä»¥ç›´æ¥é€šè¿‡propertyæ–‡ä»¶è¿›è¡Œé…ç½®ã€‚è¿™é‡Œç”±äºæˆ‘ä»¬å®ç”¨Android Studioè¿›è¡Œå¼€å‘ï¼Œæ‰€ä»¥å¸Œæœ›èƒ½å¤Ÿç›´æ¥é€šè¿‡build.gradleæ–‡ä»¶å¯¹æˆ‘ä»¬çš„æ—¥å¿—åº“è¿›è¡Œé…ç½®ã€‚åœ¨ç½‘ä¸Šæœç´¢äº†è‰¯ä¹…ï¼Œå‘ç°å¯ä»¥åœ¨buildTypesä¸­åˆ†åˆ«ä¸ºdebugç‰ˆæœ¬å’Œreleaseç‰ˆæœ¬ï¼ˆç”šè‡³æ›´å¤šå…¶ä»–è‡ªå®šä¹‰ç‰ˆæœ¬ï¼‰å®šä¹‰ä¸åŒçš„buildConfigFieldå‚æ•°ï¼Œç„¶ååœ¨javaä»£ç ä¸­é€šè¿‡è‡ªåŠ¨ç”Ÿæˆçš„BuildConfigæ–‡ä»¶è¿›è¡Œè¯»å–ã€‚</p>
<p>ä¾‹å¦‚ï¼Œæˆ‘åœ¨moduleçš„build.gradeæ–‡ä»¶ä¸­åšäº†å¦‚ä¸‹é…ç½®ï¼š</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="keyword">false</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//Logger settings for release mode</span></span><br><span class="line">            <span class="comment">//ä»¥ä¸‹æ˜¯é…ç½®MyLogæ‰“å°åŠŸèƒ½çš„å„é¡¹å‚æ•°</span></span><br><span class="line">            buildConfigField(<span class="string">"String"</span>, <span class="string">"logLevel"</span>, <span class="string">"\"VERBOSE\""</span>)<span class="comment">//è®¾ç½®å½“å‰logçš„æ‰“å°çº§åˆ«ã€‚æ”¯æŒçš„æ‰“å°çº§åˆ«åˆ†åˆ«ä¸ºï¼šVERBOSE,DEBUG,INFO,WARN,ERROR,ASSERTã€‚ä¸logcatçš„çº§åˆ«ä¸€ä¸€å¯¹åº”ã€‚åªæœ‰ç­‰äºæˆ–é«˜äºæ­¤çº§åˆ«çš„logæ‰ä¼šè¢«æ‰“å°å‡ºæ¥ã€‚</span></span><br><span class="line">            buildConfigField(<span class="string">"String"</span>, <span class="string">"logToSDDirName"</span>, <span class="string">"\"MyLogs-release\""</span>)<span class="comment">//å¦‚æœè®¾ç½®äº†æ‰“å°åˆ°æ–‡ä»¶ï¼Œåˆ™æ­¤å­—æ®µæŒ‡å®šæŠŠæ—¥å¿—æ‰“å°åˆ°SDå¡çš„å“ªä¸ªç›®å½•</span></span><br><span class="line">            buildConfigField(<span class="string">"int"</span>, <span class="string">"singleLogFileSizeLimit"</span>, <span class="string">"10"</span>)<span class="comment">//å¦‚æœè®¾ç½®äº†æ‰“å°åˆ°æ–‡ä»¶ï¼Œåˆ™æ­¤å­—æ®µè®¾ç½®å•ä¸ªlogæ–‡ä»¶çš„å¤§å°ä¸Šé™ï¼Œå•ä½æ˜¯MB</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        debug &#123;</span><br><span class="line">            <span class="comment">//Logger settings for debug mode</span></span><br><span class="line">            buildConfigField(<span class="string">"String"</span>, <span class="string">"logLevel"</span>, <span class="string">"\"DEBUG\""</span>)<span class="comment">//è®¾ç½®å½“å‰logçš„æ‰“å°çº§åˆ«ã€‚æ”¯æŒçš„æ‰“å°çº§åˆ«åˆ†åˆ«ä¸ºï¼šVERBOSE,DEBUG,INFO,WARN,ERROR,ASSERTã€‚ä¸logcatçš„çº§åˆ«ä¸€ä¸€å¯¹åº”ã€‚åªæœ‰ç­‰äºæˆ–é«˜äºæ­¤çº§åˆ«çš„logæ‰ä¼šè¢«æ‰“å°å‡ºæ¥ã€‚</span></span><br><span class="line">            buildConfigField(<span class="string">"String"</span>, <span class="string">"logToSDDirName"</span>, <span class="string">"\"MyLogs-debug\""</span>)<span class="comment">//å¦‚æœè®¾ç½®äº†æ‰“å°åˆ°æ–‡ä»¶ï¼Œåˆ™æ­¤å­—æ®µæŒ‡å®šæŠŠæ—¥å¿—æ‰“å°åˆ°SDå¡çš„å“ªä¸ªç›®å½•</span></span><br><span class="line">            buildConfigField(<span class="string">"int"</span>, <span class="string">"singleLogFileSizeLimit"</span>, <span class="string">"10"</span>)<span class="comment">//å¦‚æœè®¾ç½®äº†æ‰“å°åˆ°æ–‡ä»¶ï¼Œåˆ™æ­¤å­—æ®µè®¾ç½®å•ä¸ªlogæ–‡ä»¶çš„å¤§å°ä¸Šé™ï¼Œå•ä½æ˜¯MB</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆå°±å¯ä»¥åœ¨å¯¹åº”moduleçš„javaä»£ç ä¸­è¿›è¡Œè¯»å–ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a = BuildConfig.logMethodDepth;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–¹æ¡ˆå¹¶æ²¡æœ‰é—®é¢˜ï¼Œä¸è¿‡æ¥ä¸‹æ¥å´è¸©è¿›äº†ä¸€ä¸ªå‘ï¼Œå› ä¸ºæˆ‘ä¸‹æ„è¯†çš„æŠŠè¿™äº›é…ç½®éƒ½å†™åœ¨äº†æˆ‘çš„Logåº“moduleä¸­ï¼ŒåŒæ ·ï¼Œå¯¹é…ç½®å‚æ•°ï¼ˆå¦‚logMethodDepthç­‰ï¼‰çš„è¯»å–ä¹Ÿæ˜¯åœ¨Logåº“moduleçš„javaä»£ç ä¸­ã€‚è¿™æ ·å°±å¸¦æ¥ä¸¤ä¸ªé—®é¢˜ï¼Œä¹Ÿæ˜¯åæ¥æ‰æ„è¯†åˆ°çš„ï¼š</p>
<ul>
<li>å‘â‘ ï¼š<br>Gradleç›®å‰æœ‰ä¸€ä¸ªbugï¼šä½ åœ¨åº“é¡¹ç›®çš„build.gradleä¸­å®šä¹‰äº†releaseå’Œdebugä¸¤ç§é…ç½®ï¼Œç„¶åä¸è®ºä½ çš„Build Variantsæ˜¯é€‰æ‹©debugè¿˜æ˜¯releaseï¼Œé»˜è®¤éƒ½åªä¼šç¼–è¯‘releaseç‰ˆæœ¬ã€‚åœ¨stackoverflowä¸Šæœç´¢åå‘ç°å¥½å‡ å¹´å‰å°±å·²ç»æœ‰äººåœ¨æè¿™ä¸ªé—®é¢˜äº†ï¼Œä¸è¿‡ç›´åˆ°æ—¥å‰åœ¨androidå¼€å‘è€…ç½‘ç«™ä¸Šä»ç„¶æŠŠè¿™ä¸ªé—®é¢˜åˆ—ä¸ºå¸Œæœ›åœ¨å°†æ¥è§£å†³çš„é—®é¢˜ã€‚ä¸è¿‡è¿™ä¸ªé—®é¢˜åæ¥é€šè¿‡ä¸€ä¸ªæ¯”è¾ƒç»•çš„æ–¹æ³•è§£å†³äº†ï¼Œå°±æ˜¯åœ¨Logåº“moduleçš„build.gradleä¸­åŠ å…¥defaultPublishConfigé…ç½®ï¼Œå˜æˆè¿™æ ·ï¼š</li>
</ul>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">defaultConfig &#123;</span><br><span class="line">        minSdkVersion <span class="number">15</span></span><br><span class="line">        targetSdkVersion <span class="number">23</span></span><br><span class="line">        versionCode <span class="number">1</span></span><br><span class="line">        versionName <span class="string">"1.0"</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//å¦‚æœè¦ä½¿ç”¨buildTypesä¸­debugç‰ˆçš„logé…ç½®ï¼Œåˆ™è®¾ç½®ä¸ºdebugï¼›å¦åˆ™ï¼Œè®¾ç½®ä¸ºrelease</span></span><br><span class="line">        defaultPublishConfig <span class="string">"debug"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·å°±å¯ä»¥æŒ‡å®šæ˜¯ä½¿ç”¨debugç‰ˆè¿˜æ˜¯releaseç‰ˆçš„é…ç½®äº†ã€‚ä¸è¿‡è¿™æ ·çš„åº“æä¾›ç»™ç”¨æˆ·ä¹Ÿå¤Ÿéº»çƒ¦çš„ï¼Œå› ä¸ºç”¨æˆ·ä¸ä»…è¦è®¾ç½®è‡ªå·±appçš„buildTypeï¼Œè¿˜å¾—æ¯æ¬¡æ‰‹åŠ¨æ¥è®¾ç½®Logåº“moduleçš„ç¼–è¯‘typeï¼Œæä¸å¥½ä¸€ä¸å°å¿ƒä¸¤è€…è®¾çš„ä¸ç»Ÿä¸€å°±éº»çƒ¦äº†ã€‚</p>
<ul>
<li>å‘â‘¡ï¼š<br>å¦‚æœä»¥è¿™æ ·çš„æ–¹å¼æ¥é…ç½®Logåº“ï¼Œé‚£ä¹ˆç”¨æˆ·å°±åªèƒ½ä»¥moduleæºç çš„æ–¹å¼å°†Logåº“å¼•å…¥è‡ªå·±çš„å·¥ç¨‹ã€‚å¦‚æœè¦æŠŠLogåº“æ‰“æˆaaråŒ…æä¾›ç»™ç”¨æˆ·æ€ä¹ˆåŠï¼Ÿå‚æ•°å°±æ²¡æ³•è‡ªå®šä¹‰äº†å§ã€‚</li>
</ul>
<p>æ‰€ä»¥ï¼Œé†’æ‚Ÿåå°±æŠŠå¯¹Logåº“çš„è‡ªå®šä¹‰é…ç½®å‚æ•°ä»Logåº“çš„build.gradleç§»åŠ¨åˆ°äº†ç”¨æˆ·appçš„build.gradleä¸­ï¼Œä¹Ÿå°±æ˜¯åœ¨readme.mdæ–‡ä»¶ä¸­è¯´æ˜ä½¿ç”¨æ–¹æ³•ï¼Œå…¶ä¸­ä¸€æ­¥å°±æ˜¯è¦ç”¨æˆ·ä¸æŠŠç¤ºä¾‹ä»£ç æ‹·è´åˆ°è‡ªå·±appçš„build.gradleä¸­ï¼Œåœ¨å¯¹Logè¿›è¡Œåˆå§‹åŒ–æ—¶è¿›è¡Œé…ç½®å‚æ•°çš„è°ƒç”¨ã€‚å½“ç„¶ï¼Œè¿™é‡ŒLogåˆå§‹åŒ–çš„ä»£ç ä¹Ÿæ˜¯åœ¨è¯´æ˜æ–‡ä»¶ä¸­å†™å¥½çš„ï¼Œç”¨æˆ·æ‹·è´å³å¯ã€‚</p>
<h1 id="æ—¥å¿—å†™å…¥åˆ°æ–‡ä»¶">æ—¥å¿—å†™å…¥åˆ°æ–‡ä»¶</h1><p>è¦å®ç°æŠŠæ—¥å¿—å†™å…¥åˆ°sdçš„æŒ‡å®šç›®å½•ä¸‹ï¼Œæ—¥å¿—æ–‡ä»¶æŒ‰ç…§æ—¥æœŸè¿›è¡Œè‡ªåŠ¨å‘½åï¼Œæ¯ä¸ªæ—¥å¿—æ–‡ä»¶è¦é™åˆ¶å¤§å°ï¼Œè¾¾åˆ°æ–‡ä»¶å¤§å°ä¸Šé™åè‡ªåŠ¨åˆ›å»ºæ–°çš„æ–‡ä»¶ï¼Œç­‰ç­‰ã€‚äºæ˜¯åˆgoogleäº†è‰¯ä¹…ï¼Œå‘ç°å¯ä»¥ç”¨java.util.logging.FileHandleré…åˆjava.util.logging.loggeræ¥å®ç°ã€‚<br>è¦ä½¿ç”¨FileHandlerï¼Œå…ˆè¦å®ç°ä¸€ä¸ªè‡ªå·±çš„Formatterç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyFormatter</span> <span class="keyword">extends</span> <span class="title">Formatter</span> </span>&#123;</span><br><span class="line">        String appPackageName;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyFormatter</span><span class="params">(String appPackageName)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.appPackageName = appPackageName;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">format</span><span class="params">(LogRecord rec)</span> </span>&#123;</span><br><span class="line">            StringBuffer buf = <span class="keyword">new</span> StringBuffer();</span><br><span class="line"></span><br><span class="line">            SimpleDateFormat timeFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line"></span><br><span class="line">            buf.append(timeFormat.format(<span class="keyword">new</span> Date()));</span><br><span class="line">            buf.append(<span class="string">'/'</span>);</span><br><span class="line">            buf.append(appPackageName);</span><br><span class="line">            buf.append(<span class="string">' '</span>);</span><br><span class="line">            buf.append(MYLogLevel.getSimpleLevelStringByJavaLevel(rec.getLevel()));</span><br><span class="line">            buf.append(<span class="string">'/'</span>);</span><br><span class="line">            buf.append(rec.getParameters()[<span class="number">0</span>]);</span><br><span class="line">            buf.append(<span class="string">':'</span>);</span><br><span class="line">            buf.append(<span class="string">' '</span>);</span><br><span class="line">            buf.append(formatMessage(rec));</span><br><span class="line">            buf.append(<span class="string">'\n'</span>);</span><br><span class="line">            <span class="keyword">return</span> buf.toString();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>   
<p>ç„¶åï¼Œåˆ›å»ºä¸€ä¸ªFileHandlerå®ä¾‹ï¼Œå¹¶æŠŠMyFormatterçš„ä¸€ä¸ªå®ä¾‹ä½œä¸ºå‚æ•°ä¼ ç»™æˆ‘ä»¬çš„FileHandlerå®ä¾‹ï¼Œå¹¶ç”¨FileHandleræ¥ä½œä¸ºæˆ‘ä»¬çš„Loggerçš„å¤„ç†å™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;                                                                                                                                        </span><br><span class="line">		Logger logger = Logger.getLogger(packageName);                                                                                       </span><br><span class="line">		logger.setUseParentHandlers(<span class="keyword">false</span>);                                                                                                  </span><br><span class="line">                                                                                                                                             </span><br><span class="line">		SimpleDateFormat dateformat1 = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd"</span>);                                                                   </span><br><span class="line">		String datestring = dateformat1.format(<span class="keyword">new</span> Date());                                                                                  </span><br><span class="line">		fh = <span class="keyword">new</span> FileHandler(file.getAbsolutePath() + <span class="string">"_"</span> + datestring + <span class="string">"_%g"</span> + <span class="string">".log"</span>,                                                     </span><br><span class="line">				singleLogFileSizeLimit * <span class="number">1024</span> * <span class="number">1024</span>, <span class="number">9999</span>, <span class="keyword">true</span>);                                                                           </span><br><span class="line">		fh.setFormatter(<span class="keyword">new</span> MyFormatter(packageName));                                                                                       </span><br><span class="line">		logger.addHandler(fh);                                                                                                               </span><br><span class="line">                                                                                                                                             </span><br><span class="line">		<span class="keyword">return</span> logger;                                                                                                                       </span><br><span class="line">	&#125; <span class="keyword">catch</span> (IOException e) &#123;                                                                                                                </span><br><span class="line">		e.printStackTrace();                                                                                                                 </span><br><span class="line">		<span class="keyword">if</span> (fh != <span class="keyword">null</span>) &#123;                                                                                                                    </span><br><span class="line">			fh.close();                                                                                                                      </span><br><span class="line">		&#125;                                                                                                                                    </span><br><span class="line">                                                                                                                                             </span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;                                                                                                                         </span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>å…³äºFileHandlerå®ä¾‹åŒ–çš„å‚æ•°ï¼Œå®˜ç½‘è¯´æ˜å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>public class FileHandler<br>extends StreamHandler<br>Simple file logging Handler.<br>The FileHandler can either write to a specified file, or it can write to a rotating set of files.<br>For a rotating set of files, as each file reaches a given size limit, it is closed, rotated out, and a new file opened. Successively older files are named by adding â€œ0â€, â€œ1â€, â€œ2â€, etc. into the base filename.<br>By default buffering is enabled in the IO libraries but each log record is flushed out when it is complete.<br>By default the XMLFormatter class is used for formatting.<br>Configuration: By default each FileHandler is initialized using the following LogManager configuration properties. If properties are not defined (or have invalid values) then the specified default values are used.<br>java.util.logging.FileHandler.level specifies the default level for the Handler (defaults to Level.ALL).<br>java.util.logging.FileHandler.filter specifies the name of a Filter class to use (defaults to no Filter).<br>java.util.logging.FileHandler.formatter specifies the name of a Formatter class to use (defaults to java.util.logging.XMLFormatter)<br>java.util.logging.FileHandler.encoding the name of the character set encoding to use (defaults to the default platform encoding).<br>java.util.logging.FileHandler.limit specifies an approximate maximum amount to write (in bytes) to any one file. If this is zero, then there is no limit. (Defaults to no limit).<br>java.util.logging.FileHandler.count specifies how many output files to cycle through (defaults to 1).<br>java.util.logging.FileHandler.pattern specifies a pattern for generating the output file name. See below for details. (Defaults to â€œ%h/java%u.logâ€).<br>java.util.logging.FileHandler.append specifies whether the FileHandler should append onto any existing files (defaults to false).<br>A pattern consists of a string that includes the following special components that will be replaced at runtime:<br>â€œ/â€œ the local pathname separator<br>â€œ%tâ€ the system temporary directory<br>â€œ%hâ€ the value of the â€œuser.homeâ€ system property<br>â€œ%gâ€ the generation number to distinguish rotated logs<br>â€œ%uâ€ a unique number to resolve conflicts<br>â€œ%%â€ translates to a single percent sign â€œ%â€<br>If no â€œ%gâ€ field has been specified and the file count is greater than one, then the generation number will be added to the end of the generated filename, after a dot.<br>Thus for example a pattern of â€œ%t/java%g.logâ€ with a count of 2 would typically cause log files to be written on Solaris to /var/tmp/java0.log and /var/tmp/java1.log whereas on Windows 95 they would be typically written to C:\TEMP\java0.log and C:\TEMP\java1.log<br>Generation numbers follow the sequence 0, 1, 2, etc.<br>Normally the â€œ%uâ€ unique field is set to 0. However, if the FileHandler tries to open the filename and finds the file is currently in use by another process it will increment the unique number field and try again. This will be repeated until FileHandler finds a file name that is not currently in use. If there is a conflict and no â€œ%uâ€ field has been specified, it will be added at the end of the filename after a dot. (This will be after any automatically added generation number.)<br>Thus if three processes were all trying to log to fred%u.%g.txt then they might end up using fred0.0.txt, fred1.0.txt, fred2.0.txt as the first file in their rotating sequences.<br>Note that the use of unique ids to avoid conflicts is only guaranteed to work reliably when using a local disk file system.</p>
</blockquote>
<h1 id="é…ç½®æ—¥å¿—åº“æœåŠ¡">é…ç½®æ—¥å¿—åº“æœåŠ¡</h1><p>æˆ‘ä»¬å¸Œæœ›æ—¥å¿—åº“èƒ½å¤Ÿæ ¹æ®ç”¨æˆ·éœ€æ±‚ï¼ŒæŠŠlogæ‰“å°åˆ°æ§åˆ¶å°ã€æˆ–è€…è¾“å‡ºåˆ°SDå¡çš„æ–‡ä»¶ï¼Œæˆ–è€…åœ¨æŸäº›æ¡ä»¶ä¸‹æŠŠSDçš„æ—¥å¿—æ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œé‚£ä¹ˆå°±éœ€è¦ä»¥serviceçš„å½¢å¼æ¥æä¾›æ—¥å¿—åº“çš„åŠŸèƒ½ã€‚</p>
<p>å¤§ä½“çš„æ¶æ„è®¾è®¡ï¼Œå°±æ˜¯æŠŠæ—¥å¿—åº“serviceè·‘åœ¨ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ä¸­ï¼Œæä¾›ä¸€ä¸ªwrapperç±»ä¾›ç”¨æˆ·è°ƒç”¨ï¼Œå¯¹äºæ—¥å¿—åº“servcieçš„ä»»ä½•è°ƒç”¨éƒ½å¯¹ç”¨æˆ·æ˜¯é€æ˜çš„ï¼Œç”¨æˆ·åªéœ€è¦åƒä½¿ç”¨androidè‡ªå¸¦çš„Logå·¥å…·é‚£æ ·ä½¿ç”¨.d()ã€.e()æ–¹æ³•å°±å¯ä»¥äº†ã€‚æ¯ä¸ªappåœ¨è‡ªå·±çš„Applicationç±»ä¸­è°ƒç”¨æ—¥å¿—åº“wrappeç±»çš„åˆå§‹åŒ–å‡½æ•°ï¼Œåœ¨è¿™ä¸€æ­¥ä¼ å…¥appè‡ªå·±çš„ç›¸å…³ä¿¡æ¯å¦‚åŒ…åç­‰ï¼Œæ—¥å¿—åº“ä¼šæ ¹æ®åŒ…åç”Ÿæˆå¯¹åº”çš„æ—¥å¿—æ–‡ä»¶ã€‚serviceä¸­å¼€ä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œé‡Œé¢æ˜¾ç¤ºåœ°å¯åŠ¨ä¸€ä¸ªlooperï¼Œå¤–ç•Œå‘æ¥çš„æ‰“å°logçš„è¯·æ±‚éƒ½è¢«ä»¥æ¶ˆæ¯çš„å½¢å¼ä¼ é€’ç»™è¿™ä¸ªæ–°çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—æ¥å¤„ç†ã€‚</p>
<p>Threadçš„runæ–¹æ³•å¤§è‡´å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Looper.prepare();</span><br><span class="line">        mHandler = <span class="keyword">new</span> Handler() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">                    <span class="keyword">case</span> Log.VERBOSE:</span><br><span class="line">                        printToFile(msg, <span class="string">"VERBOSE"</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">case</span> Log.DEBUG:</span><br><span class="line">                        printToFile(msg, <span class="string">"DEBUG"</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">case</span> Log.INFO:</span><br><span class="line">                        printToFile(msg, <span class="string">"INFO"</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">case</span> Log.WARN:</span><br><span class="line">                        printToFile(msg, <span class="string">"WARN"</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">case</span> Log.ERROR:</span><br><span class="line">                        printToFile(msg, <span class="string">"ERROR"</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">case</span> Log.ASSERT:</span><br><span class="line">                        printToFile(msg, <span class="string">"ASSERT"</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        Looper.loop();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸€å¼€å§‹servcieçš„å·¥ä½œçº¿ç¨‹æ˜¯åœ¨orhanobut/loggerä¹‹ä¸Šåšæ‰©å±•ï¼Œå¯¹äºwrapperç±»çš„å®ç°æ˜¯ä½¿ç”¨AIDLï¼Œåœ¨appè°ƒç”¨wrapperçš„åˆå§‹åŒ–å‡½æ•°æ—¶ï¼Œwrapperè‡ªåŠ¨bindåˆ°æ—¥å¿—åº“serviceï¼Œç„¶åå†é€šè¿‡AIDLè°ƒç”¨serviceçš„åˆå§‹åŒ–ä»¥åŠæ‰“å°logçš„æ–¹æ³•ï¼ˆè¿™äº›å¯¹ç”¨æˆ·appéƒ½æ˜¯é€æ˜çš„ï¼‰ã€‚è¿™é‡Œå°±é‡åˆ°ä¸€ä¸ªå¤§å‘ï¼š</p>
<p>å¦‚æœä»¥æ˜¾ç¤ºIntentçš„æ–¹æ³•æ¥å¯åŠ¨servcieï¼Œå°±ä¼šå‘ç°æŠŠæ—¥å¿—åº“ä»¥moduleæºç çš„å½¢å¼æä¾›ç»™appä½¿ç”¨æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯å¦‚æœæ‰“æˆaaråŒ…æä¾›ç»™appä½¿ç”¨ï¼Œå°±ä¼šå‡ºç°bindå¤±è´¥ï¼Œå¾ˆå¥‡æ€ªã€‚</p>
<p>å¦‚æœä»¥éšå¼Intentçš„æ–¹æ³•æ¥å¯åŠ¨serviceï¼Œæ‰“æˆaaråŒ…ä¹Ÿå¯ä»¥æ­£å¸¸å¯åŠ¨servieï¼Œä½†æ˜¯ç”±äºandroid 5.0ä»¥ä¸Šè¦æ±‚å¿…é¡»ä»¥æ˜¾ç¤ºIntentå¯åŠ¨serviceï¼Œæ•…è¿™ç§æ–¹æ³•çš„è¦†ç›–èŒƒå›´å¤ªå°ã€‚</p>
<p>åæ¥å¤§ç¥reviewäº†æˆ‘çš„ä»£ç ï¼Œè¯´æœ€å¥½ä¸è¦ç”¨AIDLï¼Œå› ä¸ºé‚£æ ·ä¼šä¸€ç›´åœ¨appå’Œservcieä¹‹é—´ä¿æŒä¸€ä¸ªé•¿è¿æ¥ï¼Œæ²¡æœ‰å¿…è¦ã€‚å¯ä»¥ç›´æ¥ç”¨startæ–¹æ³•å¯åŠ¨servcieï¼Œç”¨intentæ¥ä¼ é€’è¯·æ±‚å‚æ•°ï¼Œä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚å†åŠ ä¸Šæˆ‘å†™çš„ç¬¬ä¸€ç‰ˆæ˜¯ä»¥log4jçš„å½¢å¼ï¼Œè™½ç„¶æä¾›äº†gradleçš„å‚æ•°é…ç½®æ—¥å¿—åº“çš„å„é¡¹åŠŸèƒ½ï¼Œä½†æ˜¯åŠŸèƒ½æ˜¯å†™æ­»çš„ï¼Œæ— æ³•æ‰©å±•ï¼Œå¦‚æœç”¨æˆ·æœ‰ä¸€äº›ä¸ªæ€§åŒ–çš„æ—¥å¿—éœ€æ±‚å°±æ²¡æ³•ç”¨æˆ‘è¿™ä¸ªä¸œè¥¿ã€‚</p>
<p>æ‰€ä»¥åæ¥å°±å¯¹ä»£ç è¿›è¡Œäº†é‡æ„ï¼Œæ”¹ä¸ºåœ¨JakeWharton/timberä¹‹ä¸Šæ‰©å±•ï¼Œæˆ‘æä¾›ä¸€ä¸ªæ—¥å¿—æ¡†æ¶ï¼Œä»¥åŠä¸¤ä¸ªæ—¥å¿—å·¥å…·ï¼ˆæ‰“å°åˆ°æ§åˆ¶å°ã€æ‰“å°åˆ°æ–‡ä»¶ï¼‰ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥ç»§æ‰¿æˆ‘çš„æ—¥å¿—å·¥å…·åŸºç±»å®ç°è‡ªå·±çš„æ—¥å¿—å·¥å…·ã€‚ç”¨æˆ·åœ¨è‡ªå·±çš„appä¸­ï¼Œæ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼Œåœ¨åˆå§‹åŒ–æ—¶é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªæ—¥å¿—å·¥å…·å®‰è£…åˆ°æ¡†æ¶ï¼Œå…·ä½“çš„æ‰“å°è¯·æ±‚ä¹Ÿæ˜¯åŒandroidé»˜è®¤æ—¥å¿—å·¥å…·ä¸€æ ·ç›´æ¥.d()ã€.e()è¿™æ ·è°ƒç”¨ï¼Œå¾ˆæ–¹ä¾¿ã€‚</p>
<p>è¿™é‡Œè®°ä¸€ä¸‹è¸©åˆ°çš„å¦å¤–å‡ ä¸ªå‘ï¼Œæœ‰äº›æ¯”è¾ƒä½çº§ğŸ˜“ï¼š<br>1ã€ä¸€å¼€å§‹ä¹‹æ‰€ä»¥é€‰æ‹©åœ¨orhanobut/loggerä¸Šæ‰©å±•ï¼Œæ˜¯å› ä¸ºå®ƒé»˜è®¤æä¾›äº†éå¸¸ç¾è§‚çš„æ‰“å°æ ¼å¼ï¼Œä»¥åŠçº¿ç¨‹ä¿¡æ¯ã€æ—¥å¿—è°ƒç”¨æ ˆä¿¡æ¯ã€‚åæ¥çªç„¶ååº”è¿‡æ¥ï¼Œæˆ‘æä¾›çš„åº“è™½ç„¶ä¼šä¸ç”¨æˆ·appæ‰“è¿›åŒä¸€ä¸ªapkï¼Œwrapperä¹Ÿæ˜¯ä¸ç”¨æˆ·appè·‘åœ¨åŒä¸€çº¿ç¨‹ï¼Œä½†æ˜¯çœŸæ­£çš„æ—¥å¿—æ‰“å°å·¥ä½œæ˜¯åœ¨serviceçš„å•ç‹¬è¿›ç¨‹ä¸­å®Œæˆçš„ï¼Œé‚£ä¹ˆå®ƒé»˜è®¤æä¾›çš„è°ƒç”¨æ ˆä¿¡æ¯å°±æ— æ„ä¹‰äº†ã€‚  </p>
<p>2ã€AIDLæ˜¯åŒæ­¥è°ƒç”¨ï¼Œè€Œserviceçš„æ‰€æœ‰å…¶å®ƒæ¥å£ï¼ˆbind, unbind, startService, stopServiceï¼‰éƒ½æ˜¯å¼‚æ­¥æ¥å£ï¼Œç«‹å³è¿”å›ã€‚å‚è€ƒï¼š<a href="http://blog.csdn.net/edisonlg/article/details/7164761ï¼‰ã€‚" target="_blank" rel="external">http://blog.csdn.net/edisonlg/article/details/7164761ï¼‰ã€‚</a>  </p>
<p>3ã€åœ¨è°ƒè¯•æ—¶å‘ç°åˆå§‹åŒ–è²Œä¼¼å¾ˆè€—æ—¶ï¼Œè·Ÿè¸ªäº†ä¸€ä¸‹ï¼Œå‘ç°new FileHandler()è¿™ä¸€æ“ä½œå±…ç„¶è¦è€—æ—¶30~40ms!!!</p>
]]></content>
    <summary type="html">
    <![CDATA[<h1 id="è°ƒç ”">è°ƒç ”</h1><p>åœ¨androidå¼€å‘ä¸­ï¼Œå¦‚æœéœ€è¦æ‰“å°è°ƒè¯•ä¿¡æ¯ï¼Œå¾€å¾€ä¼šä½¿ç”¨Log.d()ã€Log.e()ä¹‹ç±»çš„ç”±android.util.Logæä¾›çš„æ–¹æ³•ã€‚å®ƒçš„å¥½å¤„æ˜¯ç®€å•ã€æ–¹ä¾¿ï¼Œä¸è¶³ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå¯å®šåˆ¶æ€§å·®ï¼Œä¸èƒ½æ‰“å°åˆ°æ–‡ä»¶ã€‚å¦‚æœæƒ³åœ¨å‘è¡Œç‰ˆappä¸­çš„æŸäº›å…³é”®è¯­å¥æ‰“å°logåˆ°æ–‡ä»¶ï¼Œæˆ–è€…åœ¨appå´©æºƒæ—¶æŠŠå´©æºƒä¿¡æ¯æ‰“å°åˆ°æ–‡ä»¶ä¾›ä¸Šä¼ åˆ†æï¼Œé‚£ä¹ˆandroid.util.Logå°±æ— èƒ½ä¸ºåŠ›äº†ã€‚<br>]]>
    
    </summary>
    
      <category term="Android" scheme="http://www.carrotsight.com/tags/Android/"/>
    
      <category term="åº“é¡¹ç›®" scheme="http://www.carrotsight.com/tags/%E5%BA%93%E9%A1%B9%E7%9B%AE/"/>
    
      <category term="æ—¥å¿—" scheme="http://www.carrotsight.com/tags/%E6%97%A5%E5%BF%97/"/>
    
      <category term="Android" scheme="http://www.carrotsight.com/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[FlatBufferså­¦ä¹ æ€»ç»“]]></title>
    <link href="http://www.carrotsight.com/2015/10/10/FlatBuffers%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93.html"/>
    <id>http://www.carrotsight.com/2015/10/10/FlatBufferså­¦ä¹ æ€»ç»“.html</id>
    <published>2015-10-10T13:37:08.000Z</published>
    <updated>2015-12-03T08:41:07.000Z</updated>
    <content type="html"><![CDATA[<p>æ®è¯´facebookä½¿ç”¨googleçš„é»‘ç§‘æŠ€flatbuffersï¼Œç”¨æ¥æ›¿ä»£ä¼ ç»Ÿçš„jsonè¿›è¡Œæ•°æ®äº¤æ¢ï¼Œå¤§å¤§æé«˜äº†facebook androidå®¢æˆ·ç«¯çš„æ•ˆç‡ã€‚äºæ˜¯æˆ‘åœ¨ç½‘ä¸ŠæŸ¥æ‰¾å„ç§èµ„æ–™å­¦ä¹ äº†ä¸€ä¸‹flatbuffersï¼Œå‚çœ‹èµ„æ–™åŒ…æ‹¬GOOGLEå®˜æ–¹æ–‡æ¡£ã€facebookæŠ€æœ¯åšå®¢ã€ä»¥åŠå…¶ä»–å›½å†…çš„ä¸ªäººåšå®¢ï¼Œä¹Ÿå†™äº†äº›ä»£ç åšå®éªŒï¼Œä»¥æ­¤æ–‡ä½œä¸ºå­¦ä¹ æ€»ç»“ã€‚</p>
<h2 id="ä»€ä¹ˆæ˜¯Google_FlatBuffers">ä»€ä¹ˆæ˜¯Google FlatBuffers</h2><p>FlatBuffersæ˜¯ä¸€ä¸ªå¼€æºçš„ã€è·¨å¹³å°çš„ã€é«˜æ•ˆçš„ã€æä¾›äº†C++/Javaæ¥å£çš„åºåˆ—åŒ–å·¥å…·åº“ã€‚å®ƒæ˜¯Googleä¸“é—¨ä¸ºæ¸¸æˆå¼€å‘æˆ–å…¶ä»–æ€§èƒ½æ•æ„Ÿçš„åº”ç”¨ç¨‹åºéœ€æ±‚è€Œåˆ›å»ºã€‚å°¤å…¶æ›´é€‚ç”¨äºç§»åŠ¨å¹³å°ï¼Œè¿™äº›å¹³å°ä¸Šå†…å­˜å¤§å°åŠå¸¦å®½ç›¸æ¯”æ¡Œé¢ç³»ç»Ÿéƒ½æ˜¯å—é™çš„ï¼Œè€Œåº”ç”¨ç¨‹åºæ¯”å¦‚æ¸¸æˆåˆæœ‰æ›´é«˜çš„æ€§èƒ½è¦æ±‚ã€‚å®ƒå°†åºåˆ—åŒ–æ•°æ®å­˜å‚¨åœ¨ç¼“å­˜ä¸­ï¼Œè¿™äº›æ•°æ®æ—¢å¯ä»¥å­˜å‚¨åœ¨æ–‡ä»¶ä¸­ï¼Œåˆå¯ä»¥é€šè¿‡ç½‘ç»œåŸæ ·ä¼ è¾“ï¼Œè€Œä¸éœ€è¦ä»»ä½•è§£æå¼€é”€ã€‚<br><a id="more"></a></p>
<h2 id="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨Google_FlatBuffers">ä¸ºä»€ä¹ˆè¦ä½¿ç”¨Google FlatBuffers</h2><ol>
<li>å¯¹åºåˆ—åŒ–æ•°æ®çš„è®¿é—®ä¸éœ€è¦æ‰“åŒ…å’Œæ‹†åŒ…â€”â€”å®ƒå°†åºåˆ—åŒ–æ•°æ®å­˜å‚¨åœ¨ç¼“å­˜ä¸­ï¼Œè¿™äº›æ•°æ®æ—¢å¯ä»¥å­˜å‚¨åœ¨æ–‡ä»¶ä¸­ï¼Œåˆå¯ä»¥é€šè¿‡ç½‘ç»œåŸæ ·ä¼ è¾“ï¼Œè€Œæ²¡æœ‰ä»»ä½•è§£æå¼€é”€ï¼›  </li>
<li>å†…å­˜æ•ˆç‡å’Œé€Ÿåº¦â€”â€”è®¿é—®æ•°æ®æ—¶çš„å”¯ä¸€å†…å­˜éœ€æ±‚å°±æ˜¯ç¼“å†²åŒºï¼Œä¸éœ€è¦é¢å¤–çš„å†…å­˜åˆ†é…ï¼›   </li>
<li>æ‰©å±•æ€§ã€çµæ´»æ€§â€”â€”å®ƒæ”¯æŒçš„å¯é€‰å­—æ®µæ„å‘³ç€ä¸ä»…èƒ½è·å¾—å¾ˆå¥½çš„å‰å‘/åå‘å…¼å®¹æ€§ï¼ˆå¯¹äºé•¿ç”Ÿå‘½å‘¨æœŸçš„æ¸¸æˆæ¥è¯´å°¤å…¶é‡è¦ï¼Œå› ä¸ºä¸éœ€è¦æ¯ä¸ªæ–°ç‰ˆæœ¬éƒ½æ›´æ–°æ‰€æœ‰æ•°æ®ï¼‰ï¼›  </li>
<li>æœ€å°ä»£ç ä¾èµ–â€”â€”ä»…ä»…éœ€è¦è‡ªåŠ¨ç”Ÿæˆçš„å°‘é‡ä»£ç å’Œä¸€ä¸ªå•ä¸€çš„å¤´æ–‡ä»¶ä¾èµ–ï¼Œå¾ˆå®¹æ˜“é›†æˆåˆ°ç°æœ‰ç³»ç»Ÿä¸­ã€‚  </li>
<li>å¼ºç±»å‹è®¾è®¡â€”â€”å°½å¯èƒ½ä½¿é”™è¯¯å‡ºç°åœ¨ç¼–è¯‘æœŸï¼Œè€Œä¸æ˜¯ç­‰åˆ°è¿è¡ŒæœŸæ‰æ‰‹åŠ¨æ£€æŸ¥å’Œä¿®æ­£ï¼›</li>
<li>ä½¿ç”¨ç®€å•â€”â€”ç”Ÿæˆçš„C++ä»£ç æä¾›äº†ç®€å•çš„è®¿é—®å’Œæ„é€ æ¥å£ï¼›è€Œä¸”å¦‚æœéœ€è¦ï¼Œé€šè¿‡ä¸€ä¸ªå¯é€‰åŠŸèƒ½å¯ä»¥ç”¨æ¥åœ¨è¿è¡Œæ—¶é«˜æ•ˆè§£æSchemaå’Œç±»JSONæ ¼å¼çš„æ–‡æœ¬ï¼›</li>
<li>è·¨å¹³å°â€”â€”æ”¯æŒC++11ã€Javaï¼Œè€Œä¸éœ€è¦ä»»ä½•ä¾èµ–åº“ï¼›åœ¨æœ€æ–°çš„gccã€clangã€vs2010ç­‰ç¼–è¯‘å™¨ä¸Šå·¥ä½œè‰¯å¥½ã€‚  </li>
</ol>
<p>å®˜ç½‘çš„åŸºå‡†æµ‹è¯•ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/å±å¹•å¿«ç…§%202015-09-30%20ä¸‹åˆ3.08.24.png" alt=""></p>
<h2 id="ä¸ºä»€ä¹ˆä¸ä½¿ç”¨Protocol_Buffersæˆ–è€…JSON">ä¸ºä»€ä¹ˆä¸ä½¿ç”¨Protocol Buffersæˆ–è€…JSON</h2><h3 id="Protocol_Buffers_vs_FlatBuffers">Protocol Buffers vs FlatBuffers</h3><p>Protocol Buffersçš„ç¡®å’ŒFlatBuffersæ¯”è¾ƒç±»ä¼¼ï¼Œä½†å…¶ä¸»è¦åŒºåˆ«åœ¨äºFlatBuffersåœ¨è®¿é—®æ•°æ®å‰ä¸éœ€è¦è§£æ/æ‹†åŒ…è¿™ä¸€æ­¥ï¼Œè€Œä¸”Protocol Buffersæ²¡æœ‰å¯é€‰çš„æ–‡æœ¬å¯¼å…¥/å¯¼å‡ºåŠŸèƒ½ï¼ˆFlatBufferså¯ä»¥ç›´æ¥æ ¹æ®Schemaå’Œjsonæ–‡æœ¬ç”Ÿæˆå¯¹åº”çš„äºŒè¿›åˆ¶æ•°æ®æ–‡ä»¶ï¼‰ã€‚<br>Protocol Buffersä½¿ç”¨ä¸€äº›ç‰¹æ®Šçš„æ•°æ®ç»“æ„æ¥å­˜å‚¨æ•°æ®ï¼Œä»è€Œåœ¨è§£ææ•°æ®æ—¶éœ€è¦èŠ±è´¹é¢å¤–çš„æ—¶é—´ã€‚æ¯”å¦‚ï¼Œä½¿ç”¨varintsæ¥å­˜å‚¨æ•´å‹æ•°ï¼Œvarintsæ˜¯ä¸€ç§ä½¿ç”¨ä¸€ä¸ªæˆ–å¤šä¸ªå­—èŠ‚æ¥åºåˆ—åŒ–æ•´å‹æ•°çš„æ–¹æ³•ï¼Œè¶Šå°çš„æ•°å ç”¨çš„å­—èŠ‚æ•°å°±è¶Šå°‘ã€‚åŒæ—¶ï¼Œä»£è¡¨ä¸€ä¸ªæ•°å­—çš„å¤šä¸ªå­—èŠ‚é‡‡ç”¨little endiançš„æ–¹å¼æ¥å­˜å‚¨ã€‚è¿™å°±å¯¼è‡´åœ¨è§£ææ•°æ®æ—¶ï¼Œéœ€è¦åˆ¤æ–­å“ªå‡ ä¸ªå­—èŠ‚æ˜¯è¡¨ç¤ºè¿™ä¸ªå­—æ®µçš„ï¼Œå¹¶è¿›è¡Œå…¶ä»–çš„æ•°å­¦å˜æ¢æ¥è¿˜åŸå‡ºåŸå§‹æ•°æ®ã€‚<br>å…³äºprotocal bufferså…·ä½“çš„æ•°æ®ç¼–ç æ–¹å¼ï¼Œå¯ä»¥å‚è€ƒ<a href="https://developers.google.com/protocol-buffers/docs/encoding" target="_blank" rel="external">googleå¼€å‘è€…ç½‘ç«™</a>ä»¥åŠ<a href="http://www.ibm.com/developerworks/cn/linux/l-cn-gpb/" target="_blank" rel="external">IBMæŠ€æœ¯åšå®¢</a>ã€‚  </p>
<p>ä¸ä¹‹ç›¸å¯¹ï¼ŒFlatBufferså¯ä»¥ç›´æ¥æ ¹æ®èµ·å§‹ä½ç½®+åç§»é‡ç›´æ¥è·å–åˆ°æ•°æ®ï¼Œæ— è§£æè¿‡ç¨‹ï¼Œæ•ˆç‡æ›´é«˜ï¼Œè€Œä¼´éšçš„å‰¯ä½œç”¨æ˜¯FlatBufferséœ€è¦å ç”¨ç›¸å¯¹æ›´å¤šçš„ç©ºé—´ï¼Œå› ä¸ºProtocol Buffersçš„ç¼–ç åœ¨ä¸€å®šç¨‹åº¦ä¸Šå‹ç¼©äº†æ•°æ®ã€‚</p>
<p>ç½‘ä¸Šæœ‰äººè¿›è¡Œäº†æ€§èƒ½å¯¹æ¯”è¯•éªŒï¼Œç»“æœå¦‚ä¸‹å›¾ï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/15-10-10/60479922.jpg" alt=""></p>
<h3 id="JSON_vs_FlatBuffers">JSON vs FlatBuffers</h3><p>JSONæ˜¯éå¸¸å¯è¯»çš„ï¼Œè€Œä¸”å½“å’ŒåŠ¨æ€ç±»å‹è¯­è¨€ï¼ˆå¦‚JavaScriptï¼‰ä¸€èµ·ä½¿ç”¨æ—¶éå¸¸æ–¹ä¾¿ã€‚ç„¶è€Œåœ¨é™æ€ç±»å‹è¯­è¨€ä¸­åºåˆ—åŒ–æ•°æ®æ—¶ï¼ŒJSONä¸ä½†å…·æœ‰è¿è¡Œæ•ˆç‡ä½çš„æ˜æ˜¾ç¼ºç‚¹ï¼Œè€Œä¸”ä¼šè®©ä½ å†™æ›´å¤šçš„ä»£ç æ¥è®¿é—®æ•°æ®ï¼ˆè¿™ä¸ªä¸ç›´è§‰ç›¸åï¼‰ã€‚</p>
<h2 id="å“ªäº›é¡¹ç›®ä½¿ç”¨äº†FlatBuffers">å“ªäº›é¡¹ç›®ä½¿ç”¨äº†FlatBuffers</h2><ul>
<li><strong>Cocos2d-x</strong>, the #1 open source mobile game engine, uses it to serialize all their game data.</li>
<li><strong>Facebook</strong> uses it for client-server communication in their Android app. They have a nice article explaining how it speeds up loading their posts.</li>
<li><strong>Fun Propulsion Labs</strong> at Google uses it extensively in all their libraries and games.</li>
</ul>
<h2 id="FlatBuffersåŸç†">FlatBuffersåŸç†</h2><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªpersonç±»ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    String name;</span><br><span class="line">    <span class="keyword">int</span> friendshipStatus;</span><br><span class="line">    Person spouse;</span><br><span class="line">    List&lt;Person&gt;friends;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­çš„spouseå’Œfriendså­—æ®µé¡µåŒ…å«äº†personå¯¹è±¡ï¼Œè¿™æ ·å°±å½¢æˆäº†ä¸€ä¸ªæ ‘ç»“æ„ã€‚ä¸‹é¢å°±æ˜¯å…³äºæ­¤å¯¹è±¡åœ¨FlatBufferä¸­å­˜å‚¨çš„ç®€åŒ–å›¾ç¤ºï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/15-10-8/13378046.jpg" alt=""></p>
<p>ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼š</p>
<ul>
<li>æ¯ä¸ªå¯¹è±¡éƒ½è¢«åˆ†æˆä¸¤éƒ¨åˆ†ï¼šä¸­å¿ƒç‚¹å·¦è¾¹çš„å…ƒæ•°æ®éƒ¨åˆ†ï¼ˆæˆ–è€…å«vtableï¼‰ï¼Œå’Œä¸­å¿ƒç‚¹å³è¾¹çš„çœŸå®æ•°æ®éƒ¨åˆ†ã€‚</li>
<li>æ¯ä¸ªå­—æ®µéƒ½å¯¹åº”vtableä¸­çš„ä¸€ä¸ªæ§½ï¼ˆslotï¼‰ï¼Œå®ƒå­˜å‚¨äº†é‚£ä¸ªå­—æ®µçš„çœŸå®æ•°æ®çš„åç§»é‡ã€‚ä¾‹å¦‚ï¼ŒJohnçš„vtableçš„ç¬¬ä¸€ä¸ªæ§½çš„å€¼æ˜¯1ï¼Œè¡¨æ˜Johnçš„åå­—è¢«å­˜å‚¨åœ¨Johnçš„ä¸­å¿ƒç‚¹å³è¾¹çš„ä¸€ä¸ªå­—èŠ‚çš„ä½ç½®ä¸Šã€‚</li>
<li>å¦‚æœä¸€ä¸ªå­—æ®µæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆå®ƒåœ¨vtableä¸­çš„åç§»é‡ä¼šæŒ‡å‘å­å¯¹è±¡çš„ä¸­å¿ƒç‚¹ï¼ˆpivot pointï¼‰ã€‚æ¯”å¦‚ï¼ŒJohnçš„vtableä¸­ç¬¬ä¸‰ä¸ªæ§½æŒ‡å‘Maryçš„ä¸­å¿ƒç‚¹ã€‚</li>
<li>è¦è¡¨æ˜æŸä¸ªå­—æ®µç°åœ¨æ²¡æœ‰æ•°æ®ï¼Œå¯ä»¥åœ¨vtableå¯¹åº”çš„æ§½ä¸­ä½¿ç”¨åç§»é‡0æ¥æ ‡æ³¨ã€‚</li>
</ul>
<p>è¦äº†è§£æ›´å¤æ‚çš„å…³äºFlatBufferså­—æ®µä¿®æ”¹çš„å®ç°åŸç†ï¼Œå¯ä»¥æŸ¥çœ‹<a href="https://code.facebook.com/posts/872547912839369/improving-facebook-s-performance-on-android-with-flatbuffers/" target="_blank" rel="external">facebookçš„æ–‡æ¡£</a>ä¸­çš„â€œMutation on FlatBuffersâ€éƒ¨åˆ†ã€‚</p>
<h2 id="ç®€æ˜ä½¿ç”¨æ­¥éª¤">ç®€æ˜ä½¿ç”¨æ­¥éª¤</h2><ol>
<li>ç¼–å†™ä¸€ä¸ªç”¨æ¥å®šä¹‰ä½ æƒ³åºåˆ—åŒ–çš„æ•°æ®çš„schemaæ–‡ä»¶ï¼ˆåˆç§°IDLï¼‰ï¼Œæ•°æ®ç±»å‹å¯ä»¥æ˜¯å„ç§å¤§å°çš„intã€floatï¼Œæˆ–è€…æ˜¯stringã€arrayï¼Œæˆ–è€…å¦ä¸€å¯¹è±¡çš„å¼•ç”¨ï¼Œç”šè‡³æ˜¯å¯¹è±¡é›†åˆã€‚å„ä¸ªæ•°æ®å±æ€§éƒ½æ˜¯å¯é€‰çš„ï¼Œä¸”å¯ä»¥è®¾ç½®é»˜è®¤å€¼,æ‰€ä»¥ä¸å¿…è¦ä¸ºæ¯ä¸ªå¯¹è±¡å®ä¾‹éƒ½å»å‘ˆç°è¿™äº›å­—æ®µã€‚  </li>
<li>ä½¿ç”¨FlatBufferç¼–è¯‘å™¨flatcç”ŸæˆC++å¤´æ–‡ä»¶æˆ–è€…Javaç±»ï¼Œç”Ÿæˆçš„ä»£ç é‡Œé¢å¤–æä¾›äº†è®¿é—®ã€æ„é€ åºåˆ—åŒ–æ•°æ®çš„è¾…åŠ©ç±»ã€‚ç”Ÿæˆçš„ä»£ç ä»…ä»…ä¾èµ–flatbuffers.hï¼›  </li>
<li>ä½¿ç”¨FlatBufferBuilderç±»æ„é€ ä¸€ä¸ªäºŒè¿›åˆ¶bufferã€‚ä½ å¯ä»¥å‘è¿™ä¸ªbufferé‡Œå¾ªç¯æ·»åŠ å„ç§å¯¹è±¡ï¼Œè€Œä¸”å¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ªå•ä¸€å‡½æ•°è°ƒç”¨ï¼›</li>
<li>ä¿å­˜æˆ–è€…å‘é€è¯¥bufferï¼›</li>
<li>å½“å†æ¬¡è¯»å–è¯¥bufferæ—¶ï¼Œä½ å¯ä»¥å¾—åˆ°è¿™ä¸ªbufferæ ¹å¯¹è±¡çš„æŒ‡é’ˆï¼Œç„¶åå°±å¯ä»¥ç®€å•çš„å°±åœ°è¯»å–æ•°æ®å†…å®¹ã€‚</li>
</ol>
<h2 id="FlatBuffersä½¿ç”¨å®æˆ˜">FlatBuffersä½¿ç”¨å®æˆ˜</h2><h3 id="æ„å»ºflatc(FlatBuffersç¼–è¯‘å™¨)">æ„å»ºflatc(FlatBuffersç¼–è¯‘å™¨)</h3><p>ä»<a href="https://github.com/google/flatbuffers" target="_blank" rel="external">Googleçš„flatbuffersä»“åº“</a>ä¸‹è½½æˆ–å…‹éš†æºä»£ç ,å¯ä»¥åœ¨<a href="https://google.github.io/flatbuffers/md__building.html" target="_blank" rel="external">Googleçš„FlatBuffersæ„å»ºæ–‡æ¡£ä¸­</a>æŸ¥çœ‹æ„å»ºè¿‡ç¨‹ã€‚å¦‚æœä½ æ˜¯Macç”¨æˆ·çš„è¯å°±å¯ä»¥ç›´æ¥æŒ‰ç…§ä¸‹é¢çš„æ­¥éª¤æ¥æ“ä½œï¼š  </p>
<ol>
<li>æ‰“å¼€ä¸‹è½½çš„æºä»£ç ï¼Œç›®å½•æ˜¯<code>\{extract directory}\build\Xcode\FlatBuffers.xcodeproj</code> ï¼Œç”¨Xcodeæ‰“å¼€æ­¤æ–‡ä»¶ã€‚   </li>
<li>ç‚¹å‡»<code>Play</code>æŒ‰é’®æˆ–è€…<code>âŒ˜ + R</code>è¿è¡Œã€‚  </li>
<li>flatcå¯æ‰§è¡Œæ–‡ä»¶ä¼šå‡ºç°åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹ã€‚<br>ç°åœ¨å°±å¯ä»¥ä½¿ç”¨flatcæ¥ä»ç»™å®šçš„schemaç”Ÿæˆæ¨¡å‹ç±»ï¼Œæˆ–è€…æŠŠJSONè½¬æ¢æˆFlatBuffersäºŒè¿›åˆ¶æ–‡ä»¶äº†ã€‚</li>
</ol>
<h3 id="ç¼–å†™ä¸€ä¸ªSchema">ç¼–å†™ä¸€ä¸ªSchema</h3><p>Schemaè¯­è¨€ï¼ˆå³IDLï¼‰çš„è¯­æ³•ä¸Cè¯­è¨€å®¶æ—å¾ˆç±»ä¼¼ã€‚ä¸€ä¸ªç®€å•çš„ä¾‹å­å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// example IDL file</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> MyGame;</span><br><span class="line"></span><br><span class="line">attribute <span class="string">"priority"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> Color : byte &#123; Red = <span class="number">1</span>, Green, Blue &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">union</span> Any &#123; Monster, Weapon, Pickup &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> Vec3 &#123;</span><br><span class="line">  x:<span class="keyword">float</span>;</span><br><span class="line">  y:<span class="keyword">float</span>;</span><br><span class="line">  z:<span class="keyword">float</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">table Monster &#123;</span><br><span class="line">  pos:Vec3;</span><br><span class="line">  mana:<span class="keyword">short</span> = <span class="number">150</span>;</span><br><span class="line">  hp:<span class="keyword">short</span> = <span class="number">100</span>;</span><br><span class="line">  name:<span class="built_in">string</span>;</span><br><span class="line">  friendly:<span class="keyword">bool</span> = <span class="literal">false</span> (deprecated, priority: <span class="number">1</span>);</span><br><span class="line">  inventory:[ubyte];</span><br><span class="line">  color:Color = Blue;</span><br><span class="line">  test:Any;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">root_type Monster;</span><br></pre></td></tr></table></figure>
<p>ï¼ˆWeapon å’Œ Pickupæ²¡æœ‰åœ¨è¿™ä¸ªä¾‹å­ä¸­åˆ—å‡ºã€‚ï¼‰</p>
<h4 id="Tables">Tables</h4><p>Tablesæ˜¯åœ¨FlatBuffersä¸­å®šä¹‰å¯¹è±¡çš„ä¸»è¦æ–¹å¼ï¼Œç”±åå­—ï¼ˆè¿™é‡Œçš„Monsterï¼‰å’Œå­—æ®µåˆ—è¡¨ç»„æˆã€‚æ¯ä¸€ä¸ªå­—æ®µéƒ½æœ‰åå­—ã€ç±»å‹ã€å’Œä¸€ä¸ªå¯é€‰çš„é»˜è®¤å€¼ï¼ˆå¦‚æœå¿½ç•¥çš„è¯ï¼Œé»˜è®¤æ˜¯0/NULLï¼‰ã€‚<br><strong>æ¯ä¸€ä¸ªå­—æ®µéƒ½æ˜¯å¯é€‰çš„</strong>ï¼šå¯¹æ¯ä¸€ä¸ªå•ç‹¬çš„å¯¹è±¡ä¸ªä½“ï¼Œä½ éƒ½å¯ä»¥é€‰æ‹©å¿½ç•¥ä¸€äº›å­—æ®µã€‚ä¹Ÿå°±ä½¿ä½ å¯ä»¥çµæ´»çš„å¢åŠ å­—æ®µï¼Œè€Œä¸å¿…æ‹…å¿ƒæ•°æ®è†¨èƒ€ã€‚è¿™ä¸ªè®¾è®¡ä¹Ÿæ˜¯FlatBufferså‘å‰å’Œå‘åå…¼å®¹çš„æœºåˆ¶ã€‚<br><strong>æ³¨æ„ï¼š</strong>  </p>
<ul>
<li>å¦‚æœè¦åœ¨schemaä¸­æ·»åŠ æ–°å­—æ®µï¼Œåªèƒ½åœ¨tableçš„æœ«å°¾è¿›è¡Œæ·»åŠ ã€‚</li>
<li>å¦‚æœä½ ä¸å†ä½¿ç”¨æŸäº›å­—æ®µäº†ï¼Œä½ ä¸èƒ½ä»schemaä¸­åˆ é™¤å®ƒä»¬ã€‚ä½ å¯ä»¥ä¸å†æŠŠå®ƒä»¬å†™å…¥åˆ°ä½ çš„æ•°æ®ä¸­ï¼Œæ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚  </li>
</ul>
<h4 id="Structs">Structs</h4><p>Structsä¸Tableç±»ä¼¼ï¼Œåªä¸è¿‡æ²¡æœ‰å­—æ®µæ˜¯å¯é€‰çš„äº†(æ‰€ä»¥æ²¡æœ‰é»˜è®¤å€¼äº†)ï¼Œå¹¶ä¸”å­—æ®µä¸èƒ½å¢åŠ æˆ–è¢«åºŸå¼ƒï¼ˆdeprecatedï¼‰ã€‚Structåªèƒ½åŒ…å«æ ‡é‡æˆ–è€…å…¶ä»–structã€‚å¦‚æœä½ <strong>éå¸¸ç¡®å®š</strong>ä»»ä½•å˜åŒ–éƒ½ä¸ä¼šå‘ç”Ÿï¼Œé‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨structã€‚Structä½¿ç”¨çš„å†…å­˜æ¯”tableå°‘ï¼Œå¹¶ä¸”è¯»å–æ—¶æ¯”tableæ›´å¿«ï¼ˆå®ƒä»¬é€šå¸¸è¢«ä»¥in-lineçš„æ–¹å¼å­˜å‚¨åœ¨å®ƒä»¬çš„çˆ¶å¯¹è±¡ä¸­ï¼Œå¹¶ä¸”ä¸é€‚ç”¨virtual tableï¼‰ã€‚</p>
<h4 id="ç±»å‹">ç±»å‹</h4><p>å†…å»ºçš„æ ‡é‡ç±»å‹ï¼š  </p>
<blockquote>
<ul>
<li>8 bit: byte ubyte bool</li>
<li>16 bit: short ushort</li>
<li>32 bit: int uint float</li>
<li>64 bit: long ulong double</li>
</ul>
</blockquote>
<p>å†…å»ºçš„éæ ‡é‡ç±»å‹ï¼š  </p>
<blockquote>
<ul>
<li>å…³äºä»»ä½•å…¶ä»–ç±»å‹çš„Vector</li>
<li>stringï¼Œåªèƒ½å­˜å‚¨UTF-8æˆ–è€…7-bit ASCIIã€‚å¦‚æœéœ€è¦å­˜å‚¨å…¶ä»–ç¼–ç çš„æ–‡æœ¬ï¼Œæˆ–è€…é€šç”¨äºŒè¿›åˆ¶æ•°æ®ï¼Œè¯·ä½¿ç”¨vectorï¼ˆ[byte]æˆ–è€…[ubyte]ï¼‰ã€‚</li>
<li>å¯¹å…¶ä»–tableã€structã€enumæˆ–è€…unionçš„å¼•ç”¨ã€‚</li>
</ul>
</blockquote>
<p>å…³äºç¼–å†™Schemaçš„æ›´å¤šä¿¡æ¯ï¼Œå¯ä»¥å‚è€ƒ<a href="https://google.github.io/flatbuffers/md__schemas.html" target="_blank" rel="external">Googleæ–‡æ¡£ï¼šWriting a aschema</a>ã€‚</p>
<p>åœ¨å®éªŒä¸­ï¼Œæˆ‘ç›´æ¥ä½¿ç”¨ç½‘ä¸Šçš„ç¤ºä¾‹æ–‡ä»¶ã€‚<br>è¦å¤„ç†çš„æ•°æ®å¯¹åº”çš„JSONæ–‡ä»¶çš„ä¸‹è½½åœ°å€ä¸ºï¼š<a href="https://github.com/frogermcs/FlatBuffs/blob/master/flatbuffers/repos_json.json" target="_blank" rel="external">https://github.com/frogermcs/FlatBuffs/blob/master/flatbuffers/repos_json.json</a>    </p>
<p>è¿™ä¸ªJSONçš„ç»“æ„å¦‚ä¸‹é¢çš„ç‰‡æ®µæ‰€ç¤ºï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "repos": [</span><br><span class="line">    &#123;</span><br><span class="line">      "id": 27149168,</span><br><span class="line">      "name": "acai",</span><br><span class="line">      "full_name": "google/acai",</span><br><span class="line">      "owner": &#123;</span><br><span class="line">        "login": "google",</span><br><span class="line">        "id": 1342004,</span><br><span class="line">        ...</span><br><span class="line">        "type": "Organization",</span><br><span class="line">        "site_admin": false</span><br><span class="line">      &#125;,</span><br><span class="line">      "private": false,</span><br><span class="line">      "html_url": "https://github.com/google/acai",</span><br><span class="line">      "description": "Testing library for JUnit4 and Guice.",</span><br><span class="line">      ...</span><br><span class="line">      "watchers": 21,</span><br><span class="line">      "default_branch": "master"</span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸ºäº†ä½¿ç”¨FlatBufferså¤„ç†è¿™ä¸ªJSONæ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦ç¼–å†™å¯¹åº”çš„Schemaï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­éœ€è¦åˆ›å»º3ä¸ªTableï¼š<code>ReposList</code>, <code>Repo</code> å’Œ <code>User</code>ï¼Œè¿˜è¦å®šä¹‰<code>root_type</code>ã€‚  </p>
<p>å¯ä»¥ç›´æ¥ä»githubä¸‹è½½å·²ç»ç¼–å†™å¥½çš„Schemaï¼Œåœ°å€ä¸º<a href="https://github.com/frogermcs/FlatBuffs/blob/master/flatbuffers/repos_schema.fbs" target="_blank" rel="external">https://github.com/frogermcs/FlatBuffs/blob/master/flatbuffers/repos_schema.fbs</a>ã€‚<br>è¿™ä¸ªSchemaçš„éƒ¨åˆ†ç‰‡æ®µå¦‚ä¸‹ï¼š  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">table ReposList &#123;</span><br><span class="line">    repos : [Repo];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">table Repo &#123;</span><br><span class="line">    id : <span class="keyword">long</span>;</span><br><span class="line">    name : <span class="built_in">string</span>;</span><br><span class="line">    full_name : <span class="built_in">string</span>;</span><br><span class="line">    owner : User;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    labels_url : <span class="built_in">string</span> (deprecated);</span><br><span class="line">    releases_url : <span class="built_in">string</span> (deprecated);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">table User &#123;</span><br><span class="line">    login : <span class="built_in">string</span>;</span><br><span class="line">    id : <span class="keyword">long</span>;</span><br><span class="line">    avatar_url : <span class="built_in">string</span>;</span><br><span class="line">    gravatar_id : <span class="built_in">string</span>;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    site_admin : <span class="keyword">bool</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">root_type ReposList;</span><br></pre></td></tr></table></figure>
<h3 id="FlatBuffersæ•°æ®æ–‡ä»¶">FlatBuffersæ•°æ®æ–‡ä»¶</h3><p>ç°åœ¨æˆ‘ä»¬è¦åšçš„å°±æ˜¯æŠŠJSONæ–‡ä»¶è½¬æ¢æˆFlatBuffersäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¹¶ä¸”ç”Ÿæˆèƒ½å¤Ÿä»¥JAVAå‹å¥½æ–¹å¼è¡¨è¾¾æˆ‘ä»¬çš„æ•°æ®çš„JAVAæ¨¡å‹ã€‚æ–¹æ³•æ˜¯åœ¨ä¸­æ–­ä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š<br><code>$ ./flatc -j -b repos_schema.fbs repos_json.json</code></p>
<p>å¦‚æœä¸€åˆ‡è¿è¡Œæ­£å¸¸ï¼Œä¼šçœ‹åˆ°ä¸€ç³»åˆ—æ–°ç”Ÿæˆçš„æ–‡ä»¶ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li>repos_json.bin (æˆ‘ä»¬æŠŠå®ƒé‡å‘½åä¸ºrepos_flat.bin)</li>
<li>Repos/Repo.java</li>
<li>Repos/ReposList.java</li>
<li>Repos/User.java</li>
</ul>
<p>Schemaç¼–è¯‘å™¨(å³flatc)çš„å®Œæ•´ä½¿ç”¨æ–¹æ³•ä¸ºï¼š  </p>
<blockquote>
<p>flatc [ -c ] [ -j ] [ -b ] [ -t ] [ -o PATH ] [ -I PATH ] [ -S ] FILESâ€¦<br>      [ â€“ FILESâ€¦]  </p>
</blockquote>
<p>å…·ä½“å‚æ•°è¯´æ˜å¯ä»¥åœ¨<a href="https://google.github.io/flatbuffers/md__compiler.html" target="_blank" rel="external">Googleè¯´æ˜æ–‡æ¡£</a>æŸ¥çœ‹ã€‚</p>
<h3 id="åœ¨Android_appä¸­è¯»æ•°æ®">åœ¨Android appä¸­è¯»æ•°æ®</h3><p>åœ¨Android Studioä¸­ä½¿ç”¨FlatBuffersï¼Œéœ€è¦æŠŠrepos_flat.binæ”¾åˆ°res/raw/ç›®å½•ä¸‹ï¼ŒåŒæ—¶æŠŠ<code>repo.java</code>, <code>ReposList.java</code> å’Œ <code>User.java</code>æ”¾åˆ°å·¥ç¨‹æºä»£ç çš„æŸä¸ªç›®å½•ä¸‹ã€‚  </p>
<p>FlatBuffersæä¾›javaåº“æ¥ç›´æ¥åœ¨javaä¸­æ“çºµè¿™ç§æ•°æ®æ ¼å¼ã€‚ä»<a href="https://github.com/frogermcs/FlatBuffs/blob/master/app/libs/flatbuffers-java-1.2.0-SNAPSHOT.jar" target="_blank" rel="external">è¿™é‡Œ</a>ä¸‹è½½jaræ–‡ä»¶ï¼ˆä¹Ÿå¯ä»¥è‡ªå·±ä¸‹è½½çš„latBuffersæºä»£ç ï¼Œç”¨mvnç”Ÿæˆè¿™ä¸ªåº“æ–‡ä»¶ï¼‰ï¼ŒæŠŠå®ƒæ”¾åœ¨Androidå·¥ç¨‹çš„app/libs/ç›®å½•ä¸‹ã€‚  </p>
<p>åœ¨éœ€è¦è¯»å–FlatBuffersæ•°æ®çš„åœ°æ–¹ï¼Œå…ˆæŠŠbinæ–‡ä»¶è¯»å–åˆ°ä¸€ä¸ªbyteæ•°ç»„ä¸­ï¼Œç„¶åç”¨å¦‚ä¸‹æ‰€ç¤ºçš„ä»£ç è®¿é—®å„æ•°æ®å­—æ®µï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ByteBuffer bb = ByteBuffer.wrap(dataByteArray);</span><br><span class="line">ReposList rootRoposList = ReposList.getRootAsReposList(bb);</span><br><span class="line">Log.i(<span class="string">"TAG"</span>, <span class="string">"reposLength = "</span> + rootRoposList.reposLength());</span><br><span class="line">Repo repo1 = rootRoposList.repos(<span class="number">0</span>);</span><br><span class="line">Log.i(<span class="string">"TAG"</span>, <span class="string">"id: "</span> + repo1.id() + <span class="string">"\nname: "</span> + repo1.name() + <span class="string">"\nforks: "</span> + repo1.forks());</span><br></pre></td></tr></table></figure>
<p>ç¬¬ä¸€è¡Œä»£ç ä¸­ä¼ å…¥çš„å‚æ•°dataByteArrayå°±æ˜¯ä»binæ–‡ä»¶è¯»å‡ºçš„äºŒè¿›åˆ¶byteæ•°ç»„ã€‚</p>
<p><em>æ³¨æ„ï¼š</em><br>Javaä¸æ”¯æŒæ— ç¬¦å·æ ‡é‡ã€‚è¿™æ„å‘³ç€ä½ åœ¨schemaä¸­ä½¿ç”¨çš„ä»»ä½•æ— ç¬¦å·ç±»å‹å®é™…ä¸Šéƒ½ä¼šè¢«è¡¨è¾¾æˆä¸ºä¸€ä¸ªæœ‰ç¬¦å·çš„å€¼ã€‚è¿™è¡¨æ˜ï¼Œæ‰€æœ‰çš„bitéƒ½ä»ç„¶åœ¨ï¼Œä½†å¯èƒ½ä»£è¡¨ä¸€ä¸ªè´Ÿæ•°ã€‚æ¯”å¦‚ï¼Œè¦æŠŠä¸€ä¸ª<code>byte b</code>ä½œä¸ºä¸€ä¸ªæ— ç¬¦å·æ•°æ¥è¯»å–ï¼Œå¯ä»¥è¿™æ ·åšï¼š<code>(short)(b &amp; 0xFF)</code>ã€‚</p>
<h3 id="åœ¨Android_appä¸­å†™æ•°æ®ï¼ˆä»¥FlatBuffersæ ¼å¼ä¼ è¾“æ•°æ®ï¼‰">åœ¨Android appä¸­å†™æ•°æ®ï¼ˆä»¥FlatBuffersæ ¼å¼ä¼ è¾“æ•°æ®ï¼‰</h3><p>å…ˆåˆ›å»ºBuilderï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FlatBufferBuilder fbb = <span class="keyword">new</span> FlatBufferBuilder();</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºStringå­—æ®µï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> str = fbb.createString(<span class="string">"MyMonster"</span>);</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºä¸€ä¸ªåŒ…å«structçš„tableï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Monster.startMonster(fbb);</span><br><span class="line">Monster.addPos(fbb, Vec3.createVec3(fbb, <span class="number">1.0f</span>, <span class="number">2.0f</span>, <span class="number">3.0f</span>, <span class="number">3.0</span>, (<span class="keyword">byte</span>)<span class="number">4</span>, (<span class="keyword">short</span>)<span class="number">5</span>, (<span class="keyword">byte</span>)<span class="number">6</span>));</span><br><span class="line">Monster.addHp(fbb, (<span class="keyword">short</span>)<span class="number">80</span>);</span><br><span class="line">Monster.addName(fbb, str);</span><br><span class="line">Monster.addInventory(fbb, inv);</span><br><span class="line">Monster.addTest_type(fbb, (<span class="keyword">byte</span>)<span class="number">1</span>);</span><br><span class="line">Monster.addTest(fbb, mon2);</span><br><span class="line">Monster.addTest4(fbb, test4s);</span><br><span class="line"><span class="keyword">int</span> mon = Monster.endMonster(fbb);</span><br></pre></td></tr></table></figure>
<p>æœ€åï¼Œéœ€è¦ç»ˆæ­¢è¿™ä¸ªbufferï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Monster.finishMonsterBuffer(fbb, mon);</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªbufferç°åœ¨å·²ç»å¯ä»¥è¢«ä¼ è¾“äº†ã€‚å®ƒè¢«åŒ…å«åœ¨ByteBufferä¸­ï¼Œå¯ä»¥é€šè¿‡fbb.dataBuffer()æ¥è·å–ã€‚å¾ˆé‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œbufferä¸­æœ‰æ•ˆçš„æ•°æ®ä¸æ˜¯ä»åç§»é‡0å¼€å§‹çš„ï¼Œè€Œæ˜¯ä»fbb.dataBuffer().position()å¼€å§‹çš„ï¼Œåœ¨fbb.dataBuffer().capacity()ç»“æŸã€‚</p>
<p>æ›´è¯¦ç»†çš„javaä½¿ç”¨æ–¹æ³•ï¼Œå¯ä»¥å‚è§<a href="https://google.github.io/flatbuffers/md__java_usage.html" target="_blank" rel="external">googleå®˜æ–¹æ–‡æ¡£</a>ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>æ®è¯´facebookä½¿ç”¨googleçš„é»‘ç§‘æŠ€flatbuffersï¼Œç”¨æ¥æ›¿ä»£ä¼ ç»Ÿçš„jsonè¿›è¡Œæ•°æ®äº¤æ¢ï¼Œå¤§å¤§æé«˜äº†facebook androidå®¢æˆ·ç«¯çš„æ•ˆç‡ã€‚äºæ˜¯æˆ‘åœ¨ç½‘ä¸ŠæŸ¥æ‰¾å„ç§èµ„æ–™å­¦ä¹ äº†ä¸€ä¸‹flatbuffersï¼Œå‚çœ‹èµ„æ–™åŒ…æ‹¬GOOGLEå®˜æ–¹æ–‡æ¡£ã€facebookæŠ€æœ¯åšå®¢ã€ä»¥åŠå…¶ä»–å›½å†…çš„ä¸ªäººåšå®¢ï¼Œä¹Ÿå†™äº†äº›ä»£ç åšå®éªŒï¼Œä»¥æ­¤æ–‡ä½œä¸ºå­¦ä¹ æ€»ç»“ã€‚</p>
<h2 id="ä»€ä¹ˆæ˜¯Google_FlatBuffers">ä»€ä¹ˆæ˜¯Google FlatBuffers</h2><p>FlatBuffersæ˜¯ä¸€ä¸ªå¼€æºçš„ã€è·¨å¹³å°çš„ã€é«˜æ•ˆçš„ã€æä¾›äº†C++/Javaæ¥å£çš„åºåˆ—åŒ–å·¥å…·åº“ã€‚å®ƒæ˜¯Googleä¸“é—¨ä¸ºæ¸¸æˆå¼€å‘æˆ–å…¶ä»–æ€§èƒ½æ•æ„Ÿçš„åº”ç”¨ç¨‹åºéœ€æ±‚è€Œåˆ›å»ºã€‚å°¤å…¶æ›´é€‚ç”¨äºç§»åŠ¨å¹³å°ï¼Œè¿™äº›å¹³å°ä¸Šå†…å­˜å¤§å°åŠå¸¦å®½ç›¸æ¯”æ¡Œé¢ç³»ç»Ÿéƒ½æ˜¯å—é™çš„ï¼Œè€Œåº”ç”¨ç¨‹åºæ¯”å¦‚æ¸¸æˆåˆæœ‰æ›´é«˜çš„æ€§èƒ½è¦æ±‚ã€‚å®ƒå°†åºåˆ—åŒ–æ•°æ®å­˜å‚¨åœ¨ç¼“å­˜ä¸­ï¼Œè¿™äº›æ•°æ®æ—¢å¯ä»¥å­˜å‚¨åœ¨æ–‡ä»¶ä¸­ï¼Œåˆå¯ä»¥é€šè¿‡ç½‘ç»œåŸæ ·ä¼ è¾“ï¼Œè€Œä¸éœ€è¦ä»»ä½•è§£æå¼€é”€ã€‚<br>]]>
    
    </summary>
    
      <category term="Android" scheme="http://www.carrotsight.com/tags/Android/"/>
    
      <category term="FlatBuffers" scheme="http://www.carrotsight.com/tags/FlatBuffers/"/>
    
      <category term="Google" scheme="http://www.carrotsight.com/tags/Google/"/>
    
      <category term="facebook" scheme="http://www.carrotsight.com/tags/facebook/"/>
    
      <category term="Android" scheme="http://www.carrotsight.com/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Androidç¼–ç¨‹è¦æ³¨æ„çš„å®‰å…¨è§„èŒƒ]]></title>
    <link href="http://www.carrotsight.com/2015/09/19/2015-9-19-Android%E7%BC%96%E7%A8%8B%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E5%AE%89%E5%85%A8%E8%A7%84%E8%8C%83.html"/>
    <id>http://www.carrotsight.com/2015/09/19/2015-9-19-Androidç¼–ç¨‹è¦æ³¨æ„çš„å®‰å…¨è§„èŒƒ.html</id>
    <published>2015-09-19T11:46:08.000Z</published>
    <updated>2015-12-03T08:08:03.000Z</updated>
    <content type="html"><![CDATA[<p>è¿™ä¸¤å¤©é˜…è¯»äº†ä¸€ä¸‹android developerç½‘ç«™ä¸å®‰å…¨ç›¸å…³çš„éƒ¨åˆ†ï¼Œå¯¹androidç¼–ç¨‹è¿‡ç¨‹ä¸­ä¸»è¦æ³¨æ„çš„å®‰å…¨ç»†èŠ‚è¿›è¡Œäº†å­¦ä¹ ï¼Œåœ¨æ­¤æ€»ç»“ä¸€ä¸‹è¦ç‚¹ã€‚</p>
<h2 id="Androidæ¡†æ¶è‡ªèº«çš„å®‰å…¨æ€§æœºåˆ¶">Androidæ¡†æ¶è‡ªèº«çš„å®‰å…¨æ€§æœºåˆ¶</h2><ol>
<li>Androidåº”ç”¨ç¨‹åºæ²™ç›’ï¼ŒæŠŠæ¯ä¸ªappçš„æ•°æ®ä¸ä»£ç éƒ½åˆ†éš”å¼€ã€‚  </li>
<li>å¯¹å„ç§å®‰å…¨åŠŸèƒ½è¿›è¡Œäº†å¼ºå¥å®ç°çš„åº”ç”¨ç¨‹åºæ¡†æ¶ï¼Œå¦‚å¯†ç å­¦ã€æƒé™ã€å®‰å…¨IPCç­‰ã€‚  </li>
<li>åŠ å¯†çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒèƒ½å¤Ÿä¿æŠ¤ä¸¢å¤±æˆ–è¢«ç›—è®¾å¤‡çš„æ•°æ®ã€‚  </li>
<li>ç”¨æˆ·èƒ½å¤Ÿæˆæƒæƒé™æ¥é™åˆ¶å¯¹ç³»ç»Ÿå’Œç”¨æˆ·æ•°æ®çš„è®¿é—®ã€‚  </li>
<li>åº”ç”¨ç¨‹åºå®šä¹‰çš„æƒé™ã€‚<a id="more"></a>
<h2 id="æ•°æ®å­˜å‚¨">æ•°æ®å­˜å‚¨</h2><h3 id="ä½¿ç”¨å†…éƒ¨å­˜å‚¨">ä½¿ç”¨å†…éƒ¨å­˜å‚¨</h3></li>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œä½ åœ¨å†…éƒ¨å­˜å‚¨ä¸Šåˆ›å»ºçš„æ–‡ä»¶åªèƒ½è¢«è¯¥appæœ¬èº«è®¿é—®ã€‚  </li>
<li>åº”è¯¥å°½é‡é¿å…åœ¨IPCæ–‡ä»¶ä¸Šä½¿ç”¨ MODE_WORLD_WRITEABLEæˆ–MODE_WORLD_READABLEæ¨¡å¼ã€‚å¦‚æœå®åœ¨éœ€è¦æ•°æ®å…±äº«ï¼Œåº”è¯¥ä½¿ç”¨content providerã€‚  </li>
<li>å¯¹äºæ•æ„Ÿæ•°æ®ï¼Œåº”è¯¥é€‰æ‹©ä¸€ä¸ªå¯†é’¥å¯¹æœ¬åœ°æ–‡ä»¶è¿›è¡ŒåŠ å¯†ï¼Œè¿™ä¸ªå¯†é’¥åº”è¯¥ä¸èƒ½ç›´æ¥è¢«åº”ç”¨ç¨‹åºè®¿é—®ã€‚æ¯”å¦‚ï¼ŒæŠŠå¯†é’¥ä¿å­˜åœ¨KeyStoreä¸­ï¼Œå¹¶ä¸”ç”¨ä¸€ä¸ªä¸å­˜å‚¨åœ¨è¯¥è®¾å¤‡ä¸Šçš„ç”¨æˆ·å¯†ç æ¥ä¿æŠ¤å®ƒã€‚</li>
</ol>
<h3 id="ä½¿ç”¨æ‰©å±•å­˜å‚¨">ä½¿ç”¨æ‰©å±•å­˜å‚¨</h3><ol>
<li>æ‰©å±•å­˜å‚¨ï¼ˆå¦‚SDå¡ï¼‰ä¸Šçš„æ–‡ä»¶æ˜¯å…¨å±€å¯è¯»å†™çš„ï¼ˆè¢«å…¶ä»–åº”ç”¨ç¨‹åºï¼‰ã€‚ä¸è¦åœ¨æ‰©å±•å­˜å‚¨ä¸Šå­˜æ”¾æ•æ„Ÿä¿¡æ¯ã€‚  </li>
<li>å¤„ç†æ‰©å±•å­˜å‚¨ä¸Šçš„æ•°æ®å‰æœ€å¥½è¿›è¡Œè¾“å…¥éªŒè¯ã€‚</li>
</ol>
<h3 id="ä½¿ç”¨content_providers">ä½¿ç”¨content providers</h3><ol>
<li>å¦‚æœä¸æ‰“ç®—è®©å…¶ä»–åº”ç”¨ç¨‹åºè®¿é—®ä½ çš„ContentProviderï¼Œå°±åœ¨manifestæ–‡ä»¶ä¸­ç”¨<code>android:exported=false</code>æ¥æ ‡è®°å®ƒã€‚  </li>
<li>å¦‚æœåˆ›å»ºçš„ContentProvideréœ€è¦è¢«æä¾›ç»™å…¶ä»–åº”ç”¨ç¨‹åºä½¿ç”¨ï¼Œå¯ä»¥ç‰¹åˆ«æŒ‡å®šå•ç‹¬çš„è¯»æƒé™å’Œå†™æƒé™ã€‚  </li>
<li>å¦‚æœä½¿ç”¨ContentProvideråªæ˜¯åœ¨ä½ è‡ªå·±çš„å‡ ä¸ªappä¹‹é—´å…±äº«æ•°æ®ï¼Œé‚£ä¹ˆæœ€å¥½æŠŠ<code>android:protectionLevel</code>å±æ€§è®¾ç½®ä¸º<code>&quot;signature&quot;</code>ã€‚  </li>
<li>å¯ä»¥å¯¹content provideræä¾›æ›´ç»†ç²’åº¦çš„è®¿é—®æ§åˆ¶ï¼Œå¦‚ä½¿ç”¨<code>android:grantUriPermissions</code>å±æ€§ï¼Œåœ¨Intentå¯¹è±¡ä¸­ä½¿ç”¨<code>FLAG_GRANT_READ_URI_PERMISSION</code>å’Œ<code>FLAG_GRANT_WRITE_URI_PERMISSION</code>æ ‡è®°ã€‚  </li>
<li>åœ¨è®¿é—®content provideræ—¶ï¼Œä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢æ–¹æ³•å¦‚query()ã€update()ã€delete()ç­‰æ¥é¿å…æ½œåœ¨çš„SQLæ³¨å…¥é£é™©ã€‚ä½†è¿™ä»æœ‰é£é™©ï¼Œæ¯”å¦‚selectionå‚æ•°æ˜¯é€šè¿‡ä¹‹å‰ç”¨æˆ·æäº¤çš„æ•°æ®è¿æ¥è€Œæˆçš„ã€‚  </li>
<li>ä¸è¦å¯¹å†™æƒé™çš„å®‰å…¨æ€§äº§ç”Ÿé”™è§‰ã€‚æ¯”å¦‚ï¼Œå¦‚æœå†™æƒé™å…è®¸å†™SQLè¯­å¥ï¼Œé‚£ä¹ˆWHEREå­—å¥å·§å¦™åœ°æ„é€ å°±å¯ä»¥ä½¿å¾—â€œå†™æƒé™â€ç­‰ä»·äºâ€œè¯»å†™æƒé™â€ã€‚</li>
</ol>
<h2 id="ä½¿ç”¨æƒé™">ä½¿ç”¨æƒé™</h2><h3 id="è¯·æ±‚æƒé™">è¯·æ±‚æƒé™</h3><ol>
<li>è¯·æ±‚æœ€å°‘æ•°é‡çš„æƒé™ï¼Œå¦‚æœä¸€ä¸ªæƒé™å¯¹ä½ çš„appæ¥è¯´ä¸æ˜¯å¿…é¡»çš„ï¼Œå°±ä¸è¦è¯·æ±‚ã€‚  </li>
<li>å®Œå…¨æœ‰å¯èƒ½ç”¨ä¸€ç§æ–¹æ³•ä¸è¯·æ±‚ä»»ä½•æƒé™ï¼Œæ¯”å¦‚ä¸ºäº†åˆ›å»ºç‹¬ä¸€æ— äºŒçš„æ ‡ç¤ºç¬¦å¯ä»¥ä½¿ç”¨GUIDè€Œä¸æ˜¯è¯·æ±‚è®¾å¤‡ä¿¡æ¯ï¼Œå¯ä»¥æŠŠæ•°æ®å­˜å‚¨åœ¨å†…éƒ¨å­˜å‚¨ï¼ˆæ— é¡»æƒé™ï¼‰è€Œä¸æ˜¯å­˜å‚¨åœ¨æ‰©å±•å­˜å‚¨ï¼ˆéœ€è¦æƒé™ï¼‰ã€‚  </li>
<li>æ¨èå°½å¯èƒ½ä½¿ç”¨è®¿é—®æ§åˆ¶ï¼Œè€Œä¸æ˜¯ç”¨æˆ·ç¡®è®¤çš„æƒé™ï¼Œå› ä¸ºæƒé™å¯èƒ½è®©ç”¨æˆ·ç–‘æƒ‘ã€‚</li>
<li>ä¸è¦æ³„éœ²æœ‰æƒé™ä¿æŠ¤çš„æ•°æ®ã€‚</li>
</ol>
<h3 id="åˆ›å»ºæƒé™">åˆ›å»ºæƒé™</h3><p>è¿™ç§æƒ…å†µå¾ˆå°‘è§ï¼Œå› ä¸ºç³»ç»Ÿå®šä¹‰çš„æƒé™å·²è¿‘è¦†ç›–äº†å¤§éƒ¨åˆ†çš„éœ€æ±‚ã€‚<br>å¦‚æœå¿…é¡»åˆ›å»ºæ–°æƒé™ï¼Œè€ƒè™‘æ˜¯å¦å¯ä»¥ç”¨<code>&quot;signature&quot;</code>çº§åˆ«çš„<code>protection level</code>æ¥å®ç°ã€‚</p>
<h2 id="ä½¿ç”¨ç½‘ç»œ">ä½¿ç”¨ç½‘ç»œ</h2><h3 id="ä½¿ç”¨IPç½‘ç»œ">ä½¿ç”¨IPç½‘ç»œ</h3><ol>
<li>ç¡®ä¿å¯¹äºæ•æ„Ÿä¿¡æ¯ä½¿ç”¨åˆé€‚çš„åè®®ï¼Œæ¯”å¦‚HttpsURLConnectionã€‚å¦‚æœæœåŠ¡å™¨æ”¯æŒçš„è¯ï¼Œæˆ‘ä»¬æ›´å€¾å‘äºä½¿ç”¨HTTPSè€Œä¸æ˜¯HTTPï¼Œå› ä¸ºç§»åŠ¨è®¾å¤‡é¢‘ç¹çš„è¿æ¥åœ¨ä¸å®‰å…¨çš„ç½‘ç»œä¸­ï¼Œæ¯”å¦‚å…¬å…±Wi-Fiçƒ­ç‚¹ã€‚  </li>
<li>è®¤è¯çš„åŠ å¯†çš„å¥—æ¥å­—çº§åˆ«çš„ä¼šè¯ï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°ç”¨SSLSocketç±»æ¥å®ç°ã€‚  </li>
<li>æœ‰äº›å¼•ç”¨ç¨‹åºä½¿ç”¨localhostç½‘ç»œç«¯å£æ¥å¤„ç†æ•æ„Ÿçš„IPCï¼Œè¿™ç§åšæ³•åº”è¯¥é¿å…ï¼Œå› ä¸ºå…¶ä»–åº”ç”¨ç¨‹åºä¹Ÿèƒ½å¤Ÿè®¿é—®åˆ°è¿™äº›æ¥å£ã€‚åº”è¯¥ä½¿ç”¨å…·æœ‰æˆæƒæ§åˆ¶çš„Android IPCæœºåˆ¶æ¯”å¦‚Serviceã€‚</li>
<li>æ‰€æœ‰é€šè¿‡HTTPåè®®æˆ–å…¶ä»–ä¸å®‰å…¨åè®®è·å–åˆ°çš„æ•°æ®éƒ½æ˜¯ä¸å¯ä¿¡ä»»çš„ï¼Œè¦åšå¥½æ•°æ®éªŒè¯å·¥ä½œã€‚</li>
</ol>
<h3 id="ä½¿ç”¨ç”µè¯ç½‘ç»œ">ä½¿ç”¨ç”µè¯ç½‘ç»œ</h3><p>SMSåè®®çš„è®¾è®¡æœ¬å°±ä¸é€‚åˆappä¼ è¾“æ•°æ®ã€‚ä¸ç®¡æ˜¯åœ¨ç½‘ç»œä¸Šè¿˜æ˜¯è®¾å¤‡ä¸Šï¼ŒSMSæ—¢æ²¡æœ‰åŠ å¯†ä¹Ÿæ²¡æœ‰å¼ºå£®çš„è®¤è¯ã€‚åœ¨Androidè®¾å¤‡ä¸Šï¼ŒSMSæ¶ˆæ¯æ˜¯ä»¥å¹¿æ’­å½¢å¼ä¼ è¾“çš„ï¼Œæ‰€ä»¥å®ƒä»¬å¯ä»¥è¢«æ‰€æœ‰å…¶ä»–å…·æœ‰<code>READ_SMS</code>æƒé™çš„åº”ç”¨ç¨‹åºè¯»å–æˆ–æ•è·ã€‚  </p>
<h2 id="ä½¿ç”¨WebView">ä½¿ç”¨WebView</h2><ol>
<li>å¦‚æœä½ çš„åº”ç”¨ç¨‹åºä¸ç›´æ¥é€šè¿‡webviewä½¿ç”¨JavaScriptï¼Œé‚£ä¹ˆå°±ä¸è¦è°ƒç”¨<code>setJavaScriptEnabled()</code>ã€‚é»˜è®¤æƒ…å†µä¸‹webviewæ˜¯ä¸æ‰§è¡ŒJavaScriptçš„ï¼Œè¿™æ ·å°±å¯ä»¥é˜²æ­¢è·¨ç«™è„šæœ¬æ”»å‡»ã€‚  </li>
<li>åªæŠŠ<code>addJavaScriptInterface()</code>æš´éœ²ç»™å…·æœ‰å¯ä¿¡è¾“å…¥çš„ç½‘é¡µã€‚  </li>
<li>å¦‚æœä½ çš„åº”ç”¨ç¨‹åºé€šè¿‡WebViewè®¿é—®æ•æ„Ÿæ•°æ®ï¼Œä½ å¯ä»¥ä½¿ç”¨    <code>clearCache()</code>æ–¹æ³•æ¥åˆ é™¤ä»»ä½•å­˜å‚¨åœ¨æœ¬åœ°çš„æ–‡ä»¶ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨æœåŠ¡å™¨ç«¯çš„headeræ¯”å¦‚<code>no-cache</code>æ¥è¡¨æ˜ä¸€ä¸ªåº”ç”¨ç¨‹åºä¸åº”è¯¥ç¼“å­˜ç‰¹å®šçš„å†…å®¹ã€‚</li>
<li>ç”¨æˆ·åå’Œå¯†ç ä¸åº”è¯¥å­˜å‚¨åœ¨è®¾å¤‡ä¸Šã€‚åˆæ¬¡è®¤è¯çš„æ—¶å€™ä½¿ç”¨ç”¨æˆ·æä¾›çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œä»¥åå°±ä½¿ç”¨ä¸€ä¸ªçŸ­ç”Ÿå‘½å‘¨æœŸçš„ã€serviceç‰¹æœ‰çš„è®¤è¯tokenã€‚</li>
<li>è¢«å¤šä¸ªåº”ç”¨ç¨‹åºè®¿é—®çš„Serviceåº”è¯¥ä½¿ç”¨AccountManageræ¥è®¿é—®ã€‚</li>
</ol>
<h2 id="ä½¿ç”¨å¯†ç å­¦">ä½¿ç”¨å¯†ç å­¦</h2><ol>
<li>å¦‚æœéœ€è¦å®‰å…¨åœ°ä»å·²çŸ¥ä½ç½®è·å–ä¸€ä¸ªæ–‡ä»¶ï¼Œå¯ä»¥å¾ˆç®€å•åœ°ä½¿ç”¨<code>HTTPS URI</code>ã€‚  </li>
<li>å¦‚æœéœ€è¦å®‰å…¨æ•°æ®é€šé“ï¼Œè€ƒè™‘ä½¿ç”¨<code>HttpsURLConnection</code>æˆ–è€…<code>SSLSocket</code>ï¼Œè€Œä¸æ˜¯å»å†™ä¸€ä¸ªä½ è‡ªå·±çš„åè®®ã€‚  </li>
<li>å¦‚æœä½ çœŸçš„éœ€è¦å®ç°è‡ªå·±çš„åè®®ï¼Œä¹Ÿä¸è¦è‡ªå·±å®ç°åŠ å¯†ç®—æ³•ï¼Œå¯ä»¥ç›´æ¥åªç”¨å­˜åœ¨çš„å·²å®ç°çš„åŠ å¯†ç®—æ³•ï¼Œæ¯”å¦‚<code>Cipher</code>ç±»ä¸­çš„AESæˆ–è€…RSAç®—æ³•ã€‚  </li>
<li>ä½¿ç”¨å®‰å…¨éšæœºæ•°ç”Ÿæˆå™¨<code>SecureRandom</code>æ¥åˆå§‹åŒ–ä»»ä½•çš„å¯†é’¥ã€<code>KeyGenerator</code>ã€‚ä½¿ç”¨éå®‰å…¨éšæœºæ•°ç”Ÿæˆå™¨å¾—åˆ°çš„å¯†é’¥ï¼Œä¼šå‰Šå¼±ç®—æ³•çš„å®‰å…¨å¼ºåº¦ï¼Œä¹Ÿä¼šå¯¼è‡´ç¦»çº¿æ”»å‡»ã€‚</li>
<li>å¦‚æœéœ€è¦å­˜å‚¨ä¸€ä¸ªå¯†é’¥æ¥æä¾›å¤šæ¬¡ä½¿ç”¨ï¼Œåº”è¯¥ä½¿ç”¨è¯¸å¦‚<code>KeyStore</code>ä¹‹ç±»çš„æœºåˆ¶ã€‚  </li>
</ol>
<h2 id="ä½¿ç”¨IPC">ä½¿ç”¨IPC</h2><ol>
<li>ä¸è¦ä½¿ç”¨ä¼ ç»ŸLinuxä¸­çš„IPCæŠ€æœ¯æ¯”å¦‚ç½‘ç»œå¥—æ¥å­—å’Œå…±äº«æ–‡ä»¶ç­‰ã€‚åº”è¯¥ä½¿ç”¨Androidç³»ç»Ÿæä¾›çš„IPCåŠŸèƒ½æ¯”å¦‚Intentã€ä¸Serviceé…åˆçš„Binderæˆ–è€…Messengerã€BroadcastReceiverã€‚Androidçš„IPCæœºåˆ¶å…è®¸ä½ éªŒè¯è¿æ¥åˆ°ä½ IPCçš„åº”ç”¨ç¨‹åºçš„èº«ä»½ï¼Œå¹¶ä¸”èƒ½å¤Ÿä¸ºæ¯ä¸ªIPCæœºåˆ¶è®¾ç½®å®‰å…¨ç­–ç•¥ã€‚  </li>
<li>å¦‚æœä½ çš„IPCæœºåˆ¶ä¸æ‰“ç®—ç»™å…¶ä»–åº”ç”¨ç¨‹åºä½¿ç”¨ï¼Œå¯ä»¥åœ¨manifestæ¸…å•ä¸­æŠŠ<code>android:exported</code>å±æ€§è®¾ç½®ä¸º<code>false</code>ã€‚  </li>
</ol>
<hr>
<p>å…¶ä»–å®‰å…¨æ€§ç›¸å…³é—®é¢˜ï¼Œå¯ä»¥å‚è€ƒ:<br>1ã€<a href="http://developer.android.com/training/best-security.html" target="_blank" rel="external">http://developer.android.com/training/best-security.html</a><br>2ã€<a href="https://www.owasp.org/index.php/OWASP_Mobile_Security_Project#tab=Secure_Mobile_Development" target="_blank" rel="external">https://www.owasp.org/index.php/OWASP_Mobile_Security_Project#tab=Secure_Mobile_Development</a></p>
]]></content>
    <summary type="html">
    <![CDATA[<p>è¿™ä¸¤å¤©é˜…è¯»äº†ä¸€ä¸‹android developerç½‘ç«™ä¸å®‰å…¨ç›¸å…³çš„éƒ¨åˆ†ï¼Œå¯¹androidç¼–ç¨‹è¿‡ç¨‹ä¸­ä¸»è¦æ³¨æ„çš„å®‰å…¨ç»†èŠ‚è¿›è¡Œäº†å­¦ä¹ ï¼Œåœ¨æ­¤æ€»ç»“ä¸€ä¸‹è¦ç‚¹ã€‚</p>
<h2 id="Androidæ¡†æ¶è‡ªèº«çš„å®‰å…¨æ€§æœºåˆ¶">Androidæ¡†æ¶è‡ªèº«çš„å®‰å…¨æ€§æœºåˆ¶</h2><ol>
<li>Androidåº”ç”¨ç¨‹åºæ²™ç›’ï¼ŒæŠŠæ¯ä¸ªappçš„æ•°æ®ä¸ä»£ç éƒ½åˆ†éš”å¼€ã€‚  </li>
<li>å¯¹å„ç§å®‰å…¨åŠŸèƒ½è¿›è¡Œäº†å¼ºå¥å®ç°çš„åº”ç”¨ç¨‹åºæ¡†æ¶ï¼Œå¦‚å¯†ç å­¦ã€æƒé™ã€å®‰å…¨IPCç­‰ã€‚  </li>
<li>åŠ å¯†çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒèƒ½å¤Ÿä¿æŠ¤ä¸¢å¤±æˆ–è¢«ç›—è®¾å¤‡çš„æ•°æ®ã€‚  </li>
<li>ç”¨æˆ·èƒ½å¤Ÿæˆæƒæƒé™æ¥é™åˆ¶å¯¹ç³»ç»Ÿå’Œç”¨æˆ·æ•°æ®çš„è®¿é—®ã€‚  </li>
<li>åº”ç”¨ç¨‹åºå®šä¹‰çš„æƒé™ã€‚]]>
    
    </summary>
    
      <category term="Android" scheme="http://www.carrotsight.com/tags/Android/"/>
    
      <category term="å®‰å…¨" scheme="http://www.carrotsight.com/tags/%E5%AE%89%E5%85%A8/"/>
    
      <category term="Android" scheme="http://www.carrotsight.com/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[ã€ŠThink in Javaã€‹ç±»å‹ä¿¡æ¯ â€“ å­¦ä¹ ç¬”è®°]]></title>
    <link href="http://www.carrotsight.com/2015/09/16/2015-9-16-%E3%80%8AThink-in-Java%E3%80%8B%E7%B1%BB%E5%9E%8B%E4%BF%A1%E6%81%AF-%E2%80%93-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"/>
    <id>http://www.carrotsight.com/2015/09/16/2015-9-16-ã€ŠThink-in-Javaã€‹ç±»å‹ä¿¡æ¯-â€“-å­¦ä¹ ç¬”è®°.html</id>
    <published>2015-09-16T08:22:16.000Z</published>
    <updated>2015-12-03T08:07:51.000Z</updated>
    <content type="html"><![CDATA[<h2 id="Classå¯¹è±¡">Classå¯¹è±¡</h2><p>Classå¯¹è±¡æ˜¯ä¸€ç§ç‰¹æ®Šçš„å¯¹è±¡ï¼Œå®ƒåŒ…å«äº†ä¸ç±»æœ‰å…³çš„ä¿¡æ¯ã€‚Classå¯¹è±¡ç”¨æ¥åˆ›å»ºç±»çš„æ‰€æœ‰çš„â€œå¸¸è§„â€å¯¹è±¡ã€‚Javaä½¿ç”¨Classå¯¹è±¡æ¥æ‰§è¡ŒRTTIï¼ˆåŒ…æ‹¬ç±»å‹è½¬æ¢æ“ä½œï¼‰ã€‚<br>æ¯å½“ç¼–å†™å¹¶ç¼–è¯‘ä¸€ä¸ªæ–°ç±»ï¼Œå°±ä¼šäº§ç”Ÿä¸€ä¸ªClasså¯¹è±¡ï¼ˆæˆ–è€…è¯´è¢«ä¿å­˜åœ¨ä¸€ä¸ªåŒåçš„.classæ–‡ä»¶ä¸­ï¼‰ã€‚  </p>
<p>Classå¯¹è±¡çš„å¼•ç”¨å¯ä»¥é€šè¿‡Class.forName()æˆ–æ™®é€šå¯¹è±¡çš„getClass()æ–¹æ³•æ¥è·å–,æˆ–ç±»ååŠ ä¸Š.classæ¥è·å¾—ã€‚å…¶ä¸­ï¼ŒgetClass()æ–¹æ³•å±äºæ ¹ç±»Objectçš„ä¸€éƒ¨åˆ†ã€‚â€.classâ€ç§°ä¸º<em>ç±»å­—é¢å¸¸é‡</em>ï¼Œä»–åœ¨ç¼–è¯‘æ—¶å°±ä¼šå—åˆ°æ£€æŸ¥ï¼Œæ‰€ä»¥æ›´å®‰å…¨ï¼Œä¹Ÿæ›´é«˜æ•ˆã€‚  </p>
<p>å·®åˆ«ï¼šâ€œ.classâ€ä¸ä¼šå¼•èµ·ç±»çš„åˆå§‹åŒ–ï¼Œè€ŒClass.forName()æ–¹æ³•ä¼šç«‹å³å°±è¿›è¡Œåˆå§‹åŒ–ã€‚<br><a id="more"></a><br>Classå¯¹è±¡åŒ…å«å¾ˆå¤šæœ‰ç”¨çš„æ–¹æ³•ï¼Œèƒ½å¤Ÿäº†è§£ä¸€ä¸ªç±»å‹çš„æ‰€æœ‰ä¿¡æ¯ï¼Œæ¯”å¦‚ï¼š  </p>
<ol>
<li>getNameï¼ˆï¼‰ï¼šäº§ç”Ÿå…¨é™å®šçš„ç±»å  </li>
<li>getSimpleNameï¼ˆï¼‰ï¼šäº§ç”Ÿä¸å«åŒ…åçš„ç±»å  </li>
<li>getCanonicalNameï¼ˆï¼‰ï¼šäº§ç”Ÿå…¨é™å®šçš„ç±»å  </li>
<li>isInterfaceï¼ˆï¼‰ï¼šåˆ¤å®šè¿™ä¸ªClasså¯¹è±¡æ˜¯å¦è¡¨ç¤ºæŸä¸ªæ¥å£  </li>
<li>getSuperclassï¼ˆï¼‰ï¼šæŸ¥è¯¢ç›´æ¥åŸºç±»```</li>
</ol>
<p>å¦‚æœè°ƒç”¨Classå¯¹è±¡çš„newInstanceï¼ˆï¼‰æ–¹æ³•æ¥å®ä¾‹åŒ–ä¸€ä¸ªç±»ï¼Œåˆ™è¿™ä¸ªç±»å¿…é¡»å¸¦æœ‰é»˜è®¤æ„é€ å™¨ã€‚  </p>
<p>ä¸ºäº†ä½¿ç”¨ç±»è€Œåšçš„å‡†å¤‡å·¥ä½œå®é™…åŒ…å«3ä¸ªæ­¥éª¤ï¼š  </p>
<ol>
<li><strong>åŠ è½½</strong>ã€‚è¿™æ˜¯ç”±ç±»åŠ è½½å™¨æ‰§è¡Œçš„ã€‚è¯¥æ­¥éª¤æŸ¥æ‰¾å­—èŠ‚ç å¹¶ä»è¿™äº›å­—èŠ‚ç ä¸­åˆ›å»ºä¸€ä¸ªClasså¯¹è±¡ã€‚  </li>
<li><strong>é“¾æ¥</strong>ã€‚åœ¨é“¾æ¥é˜¶æ®µå°†éªŒè¯ç±»ä¸­çš„å­—èŠ‚ç ï¼Œä¸ºé™æ€åŸŸåˆ†é…å­˜å‚¨ç©ºé—´ï¼Œå¹¶ä¸”å¦‚æœå¿…è¦çš„è¯ï¼Œå°†è§£æè¿™ä¸ªç±»åˆ›å»ºçš„å¯¹å…¶ä»–ç±»çš„æ‰€æœ‰å¼•ç”¨ã€‚  </li>
<li><strong>åˆå§‹åŒ–</strong>ã€‚å¦‚æœè¯¥ç±»å…·æœ‰è¶…ç±»ï¼Œåˆ™å¯¹å…¶åˆå§‹åŒ–ï¼Œæ‰§è¡Œé™æ€åˆå§‹åŒ–å™¨å’Œé™æ€åˆå§‹åŒ–å—ã€‚  </li>
</ol>
<h2 id="åå°„ï¼šè¿è¡Œæ—¶çš„ç±»ä¿¡æ¯">åå°„ï¼šè¿è¡Œæ—¶çš„ç±»ä¿¡æ¯</h2><p>RTTIå’Œåå°„ä¹‹é—´çœŸæ­£çš„åŒºåˆ«åªåœ¨äºï¼Œå¯¹RTTIæ¥è¯´ï¼Œç¼–è¯‘å™¨åœ¨<strong>ç¼–è¯‘æ—¶</strong>æ‰“å¼€å’Œæ£€æŸ¥.classæ–‡ä»¶ï¼ˆå³æˆ‘ä»¬å¯ä»¥ç”¨â€œæ™®é€šâ€æ–¹å¼è°ƒç”¨å¯¹è±¡çš„æ‰€æœ‰æ–¹æ³•ï¼‰ã€‚è€Œå¯¹äºåå°„æœºåˆ¶æ¥è¯´ï¼Œ.classæ–‡ä»¶åœ¨ç¼–è¯‘æ—¶æ˜¯ä¸å¯è·å–çš„ï¼Œæ‰€ä»¥æ˜¯åœ¨<strong>è¿è¡Œæ—¶</strong>æ‰“å¼€å’Œæ£€æŸ¥.classæ–‡ä»¶ã€‚  </p>
<p>Classç±»ä¸java.lang.reflectç±»åº“ä¸€èµ·å¯¹<em>åå°„</em>çš„æ¦‚å¿µè¿›è¡Œäº†æ”¯æ’‘ï¼Œè¯¥ç±»åº“åŒ…å«äº†Fieldã€Methodä»¥åŠConstructorç±»ï¼ˆæ¯ä¸ªç±»éƒ½å®ç°äº†Memberæ¥å£ï¼‰ã€‚è¿™äº›ç±»å‹çš„å¯¹è±¡æ˜¯ç”±JVMåœ¨è¿è¡Œæ—¶åˆ›å»ºçš„ï¼Œç”¨ä»¥è¡¨ç¤ºæœªçŸ¥ç±»é‡Œå¯¹åº”çš„æˆå‘˜ã€‚è¿™æ ·å°±å¯ä»¥ä½¿ç”¨Constructoråˆ›å»ºæ–°çš„å¯¹è±¡ï¼Œç”¨get()å’Œset()æ–¹æ³•è¯»å–å’Œä¿®æ”¹ä¸Fieldå¯¹è±¡å…³è”çš„å­—æ®µï¼Œç”¨invoke()æ–¹æ³•è°ƒç”¨ä¸Methodå¯¹è±¡å…³è”çš„æ–¹æ³•ã€‚å¦å¤–ï¼Œè¿˜å¯ä»¥è°ƒç”¨getField()ã€getMethods()å’ŒgetConstructors()ç­‰å¾ˆä¾¿åˆ©çš„æ–¹æ³•ï¼Œä»¥è¿”å›è¡¨ç¤ºå­—æ®µã€æ–¹æ³•ä»¥åŠæ„é€ å™¨çš„å¯¹è±¡çš„æ•°ç»„ã€‚è¿™æ ·ï¼Œ<strong>åŒ¿åå¯¹è±¡çš„ç±»ä¿¡æ¯å°±èƒ½åœ¨è¿è¡Œæ—¶è¢«å®Œå…¨ç¡®å®šä¸‹æ¥ï¼Œè€Œåœ¨ç¼–è¯‘æ—¶ä¸éœ€è¦çŸ¥é“ä»»ä½•äº‹æƒ…ã€‚</strong>  </p>
<p>ç”¨å¦‚ä¸‹ä»£ç æ¥æµ‹è¯•åå°„æœºåˆ¶ï¼š </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Class&lt;?&gt; appleClass = Class.forName(<span class="string">"classinfo.Apple"</span>);</span><br><span class="line">			System.out.println(<span class="string">"===Methods:===\n"</span>);</span><br><span class="line">			<span class="keyword">for</span>( Method method : appleClass.getMethods())&#123;</span><br><span class="line">				System.out.println(method.toString());</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			System.out.println(<span class="string">"===Constructors:===\n"</span>);</span><br><span class="line">			<span class="keyword">for</span>( Constructor&lt;?&gt; cons : appleClass.getConstructors())&#123;</span><br><span class="line">				System.out.println(cons.toString());</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Apple</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> weight;</span><br><span class="line">	<span class="keyword">private</span> String color;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Apple</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Apple</span><span class="params">(<span class="keyword">int</span> weight, String color)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="keyword">this</span>.weight = weight;</span><br><span class="line">		<span class="keyword">this</span>.color = color;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">incWeight</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ++weight;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">decWeight</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> --weight;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœä¸ºï¼š </p>
<blockquote>
<p>===Methods:===<br>public int classinfo.Apple.incWeight()<br>public int classinfo.Apple.decWeight()<br>public final void java.lang.Object.wait(long,int) throws java.lang.InterruptedException<br>public final native void java.lang.Object.wait(long) throws java.lang.InterruptedException<br>public final void java.lang.Object.wait() throws java.lang.InterruptedException<br>public boolean java.lang.Object.equals(java.lang.Object)<br>public java.lang.String java.lang.Object.toString()<br>public native int java.lang.Object.hashCode()<br>public final native java.lang.Class java.lang.Object.getClass()<br>public final native void java.lang.Object.notify()<br>public final native void java.lang.Object.notifyAll()</p>
<p>===Constructors:===<br>public classinfo.Apple()<br>public classinfo.Apple(int,java.lang.String)</p>
</blockquote>
]]></content>
    <summary type="html">
    <![CDATA[<h2 id="Classå¯¹è±¡">Classå¯¹è±¡</h2><p>Classå¯¹è±¡æ˜¯ä¸€ç§ç‰¹æ®Šçš„å¯¹è±¡ï¼Œå®ƒåŒ…å«äº†ä¸ç±»æœ‰å…³çš„ä¿¡æ¯ã€‚Classå¯¹è±¡ç”¨æ¥åˆ›å»ºç±»çš„æ‰€æœ‰çš„â€œå¸¸è§„â€å¯¹è±¡ã€‚Javaä½¿ç”¨Classå¯¹è±¡æ¥æ‰§è¡ŒRTTIï¼ˆåŒ…æ‹¬ç±»å‹è½¬æ¢æ“ä½œï¼‰ã€‚<br>æ¯å½“ç¼–å†™å¹¶ç¼–è¯‘ä¸€ä¸ªæ–°ç±»ï¼Œå°±ä¼šäº§ç”Ÿä¸€ä¸ªClasså¯¹è±¡ï¼ˆæˆ–è€…è¯´è¢«ä¿å­˜åœ¨ä¸€ä¸ªåŒåçš„.classæ–‡ä»¶ä¸­ï¼‰ã€‚  </p>
<p>Classå¯¹è±¡çš„å¼•ç”¨å¯ä»¥é€šè¿‡Class.forName()æˆ–æ™®é€šå¯¹è±¡çš„getClass()æ–¹æ³•æ¥è·å–,æˆ–ç±»ååŠ ä¸Š.classæ¥è·å¾—ã€‚å…¶ä¸­ï¼ŒgetClass()æ–¹æ³•å±äºæ ¹ç±»Objectçš„ä¸€éƒ¨åˆ†ã€‚â€.classâ€ç§°ä¸º<em>ç±»å­—é¢å¸¸é‡</em>ï¼Œä»–åœ¨ç¼–è¯‘æ—¶å°±ä¼šå—åˆ°æ£€æŸ¥ï¼Œæ‰€ä»¥æ›´å®‰å…¨ï¼Œä¹Ÿæ›´é«˜æ•ˆã€‚  </p>
<p>å·®åˆ«ï¼šâ€œ.classâ€ä¸ä¼šå¼•èµ·ç±»çš„åˆå§‹åŒ–ï¼Œè€ŒClass.forName()æ–¹æ³•ä¼šç«‹å³å°±è¿›è¡Œåˆå§‹åŒ–ã€‚<br>]]>
    
    </summary>
    
      <category term="Java" scheme="http://www.carrotsight.com/tags/Java/"/>
    
      <category term="reflection" scheme="http://www.carrotsight.com/tags/reflection/"/>
    
      <category term="åå°„" scheme="http://www.carrotsight.com/tags/%E5%8F%8D%E5%B0%84/"/>
    
      <category term="Java" scheme="http://www.carrotsight.com/categories/Java/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Ottoå­¦ä¹ ç¬”è®°]]></title>
    <link href="http://www.carrotsight.com/2015/09/15/2015-9-15-Otto%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"/>
    <id>http://www.carrotsight.com/2015/09/15/2015-9-15-Ottoå­¦ä¹ ç¬”è®°.html</id>
    <published>2015-09-15T07:49:16.000Z</published>
    <updated>2015-12-02T04:19:44.000Z</updated>
    <content type="html"><![CDATA[<p>ä¸EventBusç±»ä¼¼çš„è¿˜æœ‰ottoï¼Œäºæ˜¯ä¹Ÿå­¦ä¹ äº†ä¸€ä¸‹ã€‚åœ¨ç½‘ä¸Šæ‰¾åˆ°çš„å¤§éƒ¨åˆ†åšå®¢å…¶å®éƒ½æ˜¯å¯¹ottoå®˜æ–¹æ–‡æ¡£çš„ä¸­æ–‡ç¿»è¯‘ï¼Œå¯¹ç”Ÿäº§è€…çš„@Produceã€PUBLISHINGã€PRODUCINGä¹‹é—´çš„å…³ç³»è®²å¾—æ¯”è¾ƒæ¨¡ç³Šï¼Œä¹Ÿæ²¡æœ‰å¯¹EventBusçš„StickyEvnetä¸Ottoä¸­ç±»ä¼¼æœºåˆ¶çš„å¯¹æ¯”ï¼Œè€Œè¿™æ­£æ˜¯æˆ‘æƒ³äº†è§£çš„ã€‚äºæ˜¯å°±è‡ªå·±å†™demoå®éªŒï¼Œä»¥æ­¤æ–‡æ€»ç»“ã€‚</p>
<p><strong><br>æœ¬æ–‡çš„OttoæŒ‡çš„æ˜¯ï¼šsquare/otto<br>EventBusæŒ‡çš„æ˜¯ï¼šgreenrobot/EventBus<br>Githubä¸Šæœ‰å¾ˆå¤šåŒåé¡¹ç›®ï¼Œä¸è¦æé”™ã€‚
</strong></p>
<p>æœ¬æ–‡æ¡£å‰é¢æ˜¯å¯¹Ottoå„æ–¹é¢çš„ä»‹ç»ã€‚å¦‚æœè¦å­¦ä¹ å¿«é€Ÿä½¿ç”¨ï¼Œå¯ä»¥ç›´æ¥è·³è½¬åˆ°åé¢çš„<a href="#è¯¦ç»†ä½¿ç”¨å®ä¾‹">è¯¦ç»†ä½¿ç”¨å®ä¾‹</a>éƒ¨åˆ†ã€‚</p>
<h2 id="ç‰¹ç‚¹">ç‰¹ç‚¹</h2><p>Ottoçš„ä½œç”¨ä¸EventBusç±»ä¼¼ï¼Œéƒ½æ˜¯ç”¨äºç»„ä»¶é—´é€šä¿¡ï¼Œé™ä½ä¸åŒçš„ç±»ç›¸äº’ä¹‹é—´çš„è€¦åˆã€‚å¦‚æœä¸ç†Ÿæ‚‰EventBusï¼Œå¯ä»¥å…ˆäº†è§£EventBusï¼Œä¸‹æ–‡æ¶‰åŠåˆ°ottoä¸EventBusçš„å¯¹æ¯”ã€‚</p>
<p>Ottoå¯ä»¥éšä¾¿å®šä¹‰è®¢é˜…è€…çš„æ¶ˆæ¯å¤„ç†å‡½æ•°çš„å‡½æ•°åï¼Œé‡‡ç”¨æ³¨è§£çš„æ–¹å¼æ¥è¯†åˆ«ç”Ÿäº§å‡½æ•°å’Œæ¶ˆè´¹å‡½æ•°ï¼ˆ@Produceå’Œ@Subscribeï¼‰ï¼Œè¿™æ˜¯ä¸EventBusæ˜æ˜¾çš„ä¸åŒã€‚<br><a id="more"></a></p>
<h2 id="PUBLISHINGã€SUBSCRIBINGä¸PRODUCING">PUBLISHINGã€SUBSCRIBINGä¸PRODUCING</h2><p>è™½ç„¶åŒæ ·æ˜¯è®¢é˜…è€…æ¨¡å¼çš„å®ç°ï¼Œä½†æ˜¯Ottoä¸Eventbusç›¸æ¯”ï¼Œå¤šäº†ä¸€ä¸ªâ€œPRODUCINGâ€çš„æ¦‚å¿µï¼ˆEventbusä¸­åªæœ‰PUBLISHINGå’ŒSUBSCRIBINGçš„æ¦‚å¿µï¼‰ã€‚<br>å…¶å®è¿™é‡Œçš„PRODUCINGè®¾è®¡çš„åˆè¡·ä¸Eventbusä¸­çš„StickyEventæ˜¯ç›¸ä¼¼çš„ï¼Œéƒ½æ˜¯ä¸ºäº†èƒ½å¤Ÿå–åˆ°æŸä¸­ç±»å‹çš„äº‹ä»¶çš„æœ€æ–°å€¼ï¼Œä½†åœ¨å®ç°ä¸Šæœ‰è¾ƒå¤§å·®å¼‚ã€‚</p>
<h3 id="è®¢é˜…äº‹ä»¶">è®¢é˜…äº‹ä»¶</h3><p><strong>ç”¨æ¥æ¶ˆè€—ï¼ˆæˆ–è€…è¯´å¤„ç†ï¼‰äº‹ä»¶çš„æ˜¯è®¢é˜…è€…ï¼Œå¿…é¡»ç”¨@Subscribeæ ‡æ³¨ã€‚</strong>  è®¢é˜…è€…ï¼ˆå‡å®šæ˜¯ä¸€ä¸ªActivityï¼‰éœ€è¦åœ¨åˆå§‹åŒ–æ—¶ï¼ˆonCreate()æ–¹æ³•æˆ–onResume()æ–¹æ³•ä¸­ï¼‰ä½¿ç”¨registerï¼ˆï¼‰æ–¹æ³•å‘æ€»çº¿æ³¨å†Œï¼Œåœ¨onDestroyï¼ˆï¼‰æˆ–onPauseï¼ˆï¼‰æ—¶è°ƒç”¨unregisterï¼ˆï¼‰ä»æ€»çº¿åæ³¨å†Œã€‚  </p>
<h3 id="å‘å¸ƒäº‹ä»¶">å‘å¸ƒäº‹ä»¶</h3><h4 id="PUBLISHING">PUBLISHING</h4><p>è€Œäº§ç”Ÿï¼ˆæˆ–è€…è¯´å‘å¸ƒï¼‰äº‹ä»¶çš„æ–¹å¼æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯ä¸ä½¿ç”¨@Produceæ ‡æ³¨ï¼Œè¿™ç§æ–¹å¼è¢«ottoå®˜æ–¹æ–‡æ¡£ç§°ä¸º<strong>PUBLISHING</strong>ï¼Œæ–¹æ³•æ˜¯ç›´æ¥è°ƒç”¨buså¯¹è±¡çš„postæ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MyApplicationUtil.bus.post(<span class="keyword">new</span> TextEvent(<span class="string">"è¿™æ˜¯PUBLISHINGäº‹ä»¶: "</span> + <span class="keyword">new</span> Date()));</span><br></pre></td></tr></table></figure>   </p>
<h4 id="PRODUCING">PRODUCING</h4><p>å¦ä¸€ç§æ˜¯ä½¿ç”¨@Produceæ ‡æ³¨ï¼Œè¿™ç§æ–¹å¼è¢«ottoå®˜æ–¹æ–‡æ¡£ç§°ä¸º<strong>PRODUCING</strong>ã€‚å¦‚æœä½¿ç”¨äº†@Produceæ¥æ ‡æ³¨ç”Ÿäº§è€…ï¼ˆå³å®ç°PRODUCINGåŠŸèƒ½ï¼‰ï¼Œå°±éœ€è¦åŒæ—¶åœ¨åˆå§‹åŒ–æ—¶ä½¿ç”¨bus.register(this)æ¥æ³¨å†Œè¿™ä¸ªç”Ÿäº§è€…ï¼Œåœ¨é”€æ¯ç»„ä»¶æ—¶è°ƒç”¨unregisterï¼ˆï¼‰ã€‚  </p>
<p>PRODUCINGå…¶å®ç±»ä¼¼äºEventBusä¸­çš„StickyEventã€‚ ç”¨rigisteræ–¹æ³•æ³¨å†Œ@Produceæ ‡æ³¨çš„ç”Ÿäº§è€…ï¼ˆè¢«æ³¨å†Œçš„å‡½æ•°éœ€è¦è¿”å›ä¸€ä¸ªäº‹ä»¶å®ä¾‹ï¼‰æ—¶ï¼Œ @Produceæ ‡æ³¨çš„ç”Ÿäº§è€…å‡½æ•°ä¼šä¸ºæ‰€æœ‰ä¹‹å‰æ³¨å†Œäº†è¯¥äº‹ä»¶ç±»å‹çš„è®¢é˜…è€…<strong>åˆ†åˆ«è¿›è¡Œä¸€æ¬¡å›è°ƒ</strong>ï¼Œå¹¶ä¸”æ­¤ç”Ÿäº§è€…å‡½æ•°ä¹Ÿå°†ä¸ºåœ¨æ­¤ä¹‹åæ³¨å†Œçš„è¯¥äº‹ä»¶ç±»å‹çš„è®¢é˜…è€…<strong>åˆ†åˆ«è¿›è¡Œä¸€æ¬¡å›è°ƒ</strong>ã€‚  </p>
<p>Ottoæ²¡æœ‰EventBusä¸­é‚£ç§å¯ä»¥åœ¨ä»»æ„åœ°æ–¹è·å–StickyEventçš„æ–¹æ³•ï¼Œå› ä¸ºè™½ç„¶PRODUCINGä¸StickyEventç±»ä¼¼ï¼Œä½†<strong>Eventbusæ˜¯é€šè¿‡ä¸€ä¸ªmapæ¥ç¼“å­˜StickyEventçš„æœ€åä¸€æ¬¡æ›´æ–°å€¼ï¼Œä¸ä¼šè§¦å‘ä»»ä½•å‡½æ•°å›è°ƒï¼Œè€ŒOttoçš„PRODUCINGå¹¶æ²¡æœ‰è¿™ç§ç¼“å­˜ï¼Œæ˜¯å®æ—¶å»å›è°ƒProduceå‡½æ•°æ¥æ‹¿åˆ°æœ€æ–°å€¼çš„</strong>ã€‚</p>
<p>PRODUCINGçš„å®šä¹‰å¦‚ä¸‹é¢ä»£ç æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Produce</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> TextEvent <span class="title">postEvent</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> TextEvent(<span class="string">"hahaah"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œä»…ä»…æ˜¯ä¸ºäº†å®éªŒè°ƒè¯•æ˜¯ä¸æ˜¯æ¯ä¸ªè®¢é˜…è€…éƒ½è§¦å‘è¿™ä¸ªå›è°ƒï¼Œæ‰€ä»¥æ‰å†™æˆæ¯æ¬¡returnçš„éƒ½æ˜¯newå‡ºæ¥çš„æ–°å¯¹è±¡ã€‚äº‹å®ä¸Šï¼ŒOttoçš„æ–‡æ¡£ä¸­è¯´@Produceæœºåˆ¶æ˜¯ä¸ºäº†ä¾¿äºå¤šä¸ªè®¢é˜…è€…èƒ½å…¨éƒ½æŸä¸ªäº‹ä»¶çš„æœ€æ–°çŠ¶æ€ï¼Œæ¯”å¦‚æœ€åä¸€æ¬¡å®šä½çš„ä½ç½®ã€‚æ‰€ä»¥ï¼Œè¦å®ç°å®˜æ–¹æ–‡æ¡£ä¸­è¯´çš„è¿™ä¸€ç‚¹ï¼Œå°±ä¸èƒ½åœ¨@Produceå‡½æ•°ä¸­æ¯æ¬¡returnæ–°å¯¹è±¡ï¼Œè€Œæ˜¯returnä¸€ä¸ªå¤–éƒ¨çš„å…¨å±€å¯¹è±¡ï¼ˆeventï¼‰ï¼Œè¿™ä¸ªå¯¹è±¡åœ¨å¤–å›´è¢«å…¶ä»–é€»è¾‘æ›´æ–°ï¼Œè€Œä¸æ˜¯ä¸åœ¨@Produceå‡½æ•°ä¸­è¢«æ›´æ–°ã€‚</p>
<p>åœ¨ä¸€ä¸ªæ€»çº¿ä¸Šï¼ˆä¸€ä¸ªbuså¯¹è±¡ï¼‰ä¸Šï¼ŒåŒä¸€æ—¶åˆ»åŒä¸€ç±»å‹çš„ç”¨@Produceæ ‡æ³¨çš„äº‹ä»¶ç”Ÿäº§è€…åªèƒ½æœ‰ä¸€ä¸ªã€‚å®˜æ–¹æ–‡æ¡£çš„åŸæ–‡æ˜¯ï¼š</p>
<blockquote>
<p><strong>You may only have one producer per event type registered at a time on a bus.  </strong></p>
</blockquote>
<p>ä¸€èˆ¬åœ¨ä½¿ç”¨EventBusæ—¶ï¼Œä¼šç›´æ¥é‡‡ç”¨EventBus.getDefault()æ¥è·å–ç³»ç»Ÿé»˜è®¤æä¾›çš„å•ä¾‹å¯¹è±¡ï¼Œç„¶åå†è¯¥å¯¹è±¡ï¼ˆæ€»çº¿å¯¹è±¡ï¼‰ä¸Šè¿›è¡Œå®è·µçš„å‘å¸ƒå’Œè®¢é˜…ã€‚ä½†æ˜¯ottoæ²¡æœ‰æä¾›é»˜è®¤çš„å•ä¾‹ï¼Œä¸€èˆ¬éœ€è¦è‡ªå·±åœ¨åº”ç”¨ç¨‹åºèŒƒå›´å†…ï¼Œè‡ªå·±å»æ‰‹åŠ¨åˆ›å»ºå¹¶ç»´æŠ¤ä¸€ä¸ªottoçš„buså¯¹è±¡ã€‚</p>
<p>Ottoåœ¨åˆå§‹åŒ–Busçš„æ—¶å€™æ¥å†³å®šå¤„ç†äº‹ä»¶çš„æ‰§è¡Œçº¿ç¨‹ã€‚é»˜è®¤åªæœ‰ThreadEnforcer.ANYå’ŒThreadEnforcer.MAINä¸¤ç§ã€‚å¦‚æœéœ€è¦å…¶ä»–ç±»å‹çš„çº¿ç¨‹æ§åˆ¶ï¼Œéœ€è¦è‡ªå·±å®ç°ThreadEnforceræ¥å£ã€‚ç›¸å¯¹è€Œè¨€ï¼ŒEventBusçš„æ§åˆ¶æ›´ç²¾ç»†æ›´ç®€å•ã€‚   </p>
<h2 id="ä¸EventBusçš„å¯¹æ¯”">ä¸EventBusçš„å¯¹æ¯”</h2><p><img src="http://7xle8x.com1.z0.glb.clouddn.com/15-8-28/24002070.jpg" alt="Ottoä¸EventBusçš„å¯¹æ¯”"></p>
<h2 id="è¯¦ç»†ä½¿ç”¨å®ä¾‹"><a href="id:è¯¦ç»†ä½¿ç”¨å®ä¾‹" target="_blank" rel="external">è¯¦ç»†ä½¿ç”¨å®ä¾‹</a></h2><p>1.åœ¨build.gradleçš„dependenciesä¸­åŠ å…¥ä»¥ä¸‹å†…å®¹ï¼š  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">compile <span class="string">'com.squareup:otto:1.3.8'</span></span><br></pre></td></tr></table></figure>
<p>2.æ ¹æ®ä¸šåŠ¡éœ€è¦å®šä¹‰äº‹ä»¶</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TextEvent</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String data;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TextEvent</span><span class="params">(String data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3.åˆ›å»ºä¸€ä¸ªç±»ï¼Œåœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºèŒƒå›´å†…æŒæœ‰ä¸€ä¸ªæ€»çº¿å¯¹è±¡ã€‚ï¼ˆä½¿ç”¨EventBusä¸éœ€è¦è¿™ä¸€æ­¥ï¼Œå› ä¸ºEventBuså·²è¿‘æ›¿æˆ‘ä»¬å®ç°å¥½äº†é»˜è®¤çš„å•ä¾‹å¯¹è±¡ï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplicationUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Bus bus = <span class="keyword">new</span> Bus();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4.åœ¨éœ€è¦è®¢é˜…äº‹ä»¶çš„ç»„ä»¶ä¸­ï¼ˆå³è®¢é˜…è€…ï¼Œå‡è®¾æ˜¯ä¸€ä¸ªActivityï¼‰ï¼Œåšä»¥ä¸‹ä¸‰ä¸ªå·¥ä½œï¼š  </p>
<ul>
<li>åœ¨åˆå§‹åŒ–ç»„ä»¶æ—¶å‘æ€»çº¿æ³¨å†Œè‡ªå·±ä¸ºæŸç±»å‹äº‹ä»¶çš„è®¢é˜…è€…  </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">       setContentView(R.layout.activity_main3);</span><br><span class="line">       tv = (TextView)findViewById(R.id.getdatatv);</span><br><span class="line">       </span><br><span class="line">       MyApplicationUtil.bus.register(<span class="keyword">this</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>å®ç°äº‹ä»¶å¤„ç†å‡½æ•°</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Subscribe</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getEvent</span><span class="params">(TextEvent event)</span></span>&#123;</span><br><span class="line">       tv.setText(event.getData());</span><br><span class="line">       Log.d(<span class="string">"TAG"</span>,  <span class="string">"==in Main3Activity==   getEvent:"</span> + event.getData());</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>åœ¨ç»„ä»¶é”€æ¯æ—¶åæ³¨å†Œè®¢é˜…è€…</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">super</span>.onDestroy();</span><br><span class="line">       MyApplicationUtil.bus.unregister(<span class="keyword">this</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>5.åœ¨äº§ç”Ÿäº‹ä»¶çš„ç»„ä»¶ï¼ˆç”Ÿäº§è€…ï¼‰ä¸­ï¼Œå¦‚æœåªæ˜¯å‘é€æ™®é€šäº‹ä»¶ï¼Œå°±ç›´æ¥è°ƒç”¨buså¯¹è±¡çš„postæ–¹æ³•å³å¯ï¼Œä¹‹å‰æ³¨å†Œçš„è®¢é˜…è€…å°±å¯ä»¥æ¥æ”¶åˆ°è¿™ä¸ªäº‹ä»¶äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MyApplicationUtil.bus.post(<span class="keyword">new</span> TextEvent(dataEditText.getText().toString()));</span><br></pre></td></tr></table></figure>
<p>6.å¦‚æœéœ€è¦å®ç°PRODUCINGåŠŸèƒ½ï¼ˆå³ç±»ä¼¼StickyEventåŠŸèƒ½ï¼‰ï¼Œå°±éœ€è¦ç”¨@Produceræ˜¾ç¤ºæ ‡æ³¨ç”Ÿäº§è€…ï¼ŒåŒæ—¶ä¹Ÿè¦å¯¹è¯¥ç”Ÿäº§è€…è¿›è¡Œæ³¨å†Œå’Œåæ³¨å†Œï¼Œå¦‚ä¸‹é¢ä»£ç æ‰€ç¤ºã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">       setContentView(R.layout.activity_main2);</span><br><span class="line">       dataEditText = (EditText)findViewById(R.id.activity2_et);</span><br><span class="line">       btn1 = (Button)findViewById(R.id.activity2_btn1);</span><br><span class="line">       btn1.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">       MyApplicationUtil.bus.register(<span class="keyword">this</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="annotation">@Produce</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> TextEvent <span class="title">postEvent</span><span class="params">()</span></span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> TextEvent(<span class="string">"hahaah"</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="annotation">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">super</span>.onDestroy();</span><br><span class="line">       MyApplicationUtil.bus.unregister(<span class="keyword">this</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>æŒ‰ç…§è¿™ç§æ–¹å¼æ˜¾ç¤ºå®šä¹‰äº†ç”Ÿäº§è€…ä¹‹åï¼Œä¹‹å‰åœ¨æ­¤busä¸Šæ³¨å†Œè¿‡çš„æ‰€æœ‰è¯¥ç±»å‹äº‹ä»¶çš„è®¢é˜…è€…éƒ½ä¼šæ¥æ”¶åˆ°æœ¬äº‹ä»¶çš„å®ä¾‹ã€‚ä¹‹åå†å†æ­¤busä¸Šæ³¨å†Œçš„æ­¤ç±»å‹çš„æ–°çš„è®¢é˜…è€…åŒæ ·èƒ½å¤Ÿæ¥æ”¶åˆ°æœ¬äº‹ä»¶å®ä¾‹ã€‚</p>
<hr>
<p>å‚è€ƒèµ„æ–™</p>
<ol>
<li><p><a href="https://github.com/square/otto" target="_blank" rel="external">å®˜æ–¹ä¸‹è½½ï¼šhttps://github.com/square/otto</a></p>
</li>
<li><p><a href="http://square.github.io/otto/" target="_blank" rel="external">å®˜æ–¹ä½¿ç”¨è¯´æ˜ï¼šhttp://square.github.io/otto/</a></p>
</li>
<li><p><a href="http://blog.csdn.net/wangjia55/article/details/17148535" target="_blank" rel="external">Ottoä»‹ç»ï¼šhttp://blog.csdn.net/wangjia55/article/details/17148535</a></p>
</li>
<li><p><a href="http://www.cnblogs.com/qianxudetianxia/p/4216949.html" target="_blank" rel="external">ä½¿ç”¨äº‹ä»¶æ€»çº¿æ¡†æ¶EventBuså’ŒOttoï¼š<br>http://www.cnblogs.com/qianxudetianxia/p/4216949.html</a></p>
</li>
<li><p><a href="http://m.blog.csdn.net/blog/Estellise/41758401" target="_blank" rel="external">Androidç»„ä»¶é—´é€šä¿¡æœºè§£è€¦â€”â€”Android EventBuså’ŒOttoæ¡†æ¶ï¼š<br>http://m.blog.csdn.net/blog/Estellise/41758401</a></p>
</li>
</ol>
]]></content>
    <summary type="html">
    <![CDATA[<p>ä¸EventBusç±»ä¼¼çš„è¿˜æœ‰ottoï¼Œäºæ˜¯ä¹Ÿå­¦ä¹ äº†ä¸€ä¸‹ã€‚åœ¨ç½‘ä¸Šæ‰¾åˆ°çš„å¤§éƒ¨åˆ†åšå®¢å…¶å®éƒ½æ˜¯å¯¹ottoå®˜æ–¹æ–‡æ¡£çš„ä¸­æ–‡ç¿»è¯‘ï¼Œå¯¹ç”Ÿäº§è€…çš„@Produceã€PUBLISHINGã€PRODUCINGä¹‹é—´çš„å…³ç³»è®²å¾—æ¯”è¾ƒæ¨¡ç³Šï¼Œä¹Ÿæ²¡æœ‰å¯¹EventBusçš„StickyEvnetä¸Ottoä¸­ç±»ä¼¼æœºåˆ¶çš„å¯¹æ¯”ï¼Œè€Œè¿™æ­£æ˜¯æˆ‘æƒ³äº†è§£çš„ã€‚äºæ˜¯å°±è‡ªå·±å†™demoå®éªŒï¼Œä»¥æ­¤æ–‡æ€»ç»“ã€‚</p>
<p><strong><br>æœ¬æ–‡çš„OttoæŒ‡çš„æ˜¯ï¼šsquare/otto<br>EventBusæŒ‡çš„æ˜¯ï¼šgreenrobot/EventBus<br>Githubä¸Šæœ‰å¾ˆå¤šåŒåé¡¹ç›®ï¼Œä¸è¦æé”™ã€‚
</strong></p>
<p>æœ¬æ–‡æ¡£å‰é¢æ˜¯å¯¹Ottoå„æ–¹é¢çš„ä»‹ç»ã€‚å¦‚æœè¦å­¦ä¹ å¿«é€Ÿä½¿ç”¨ï¼Œå¯ä»¥ç›´æ¥è·³è½¬åˆ°åé¢çš„<a href="#è¯¦ç»†ä½¿ç”¨å®ä¾‹">è¯¦ç»†ä½¿ç”¨å®ä¾‹</a>éƒ¨åˆ†ã€‚</p>
<h2 id="ç‰¹ç‚¹">ç‰¹ç‚¹</h2><p>Ottoçš„ä½œç”¨ä¸EventBusç±»ä¼¼ï¼Œéƒ½æ˜¯ç”¨äºç»„ä»¶é—´é€šä¿¡ï¼Œé™ä½ä¸åŒçš„ç±»ç›¸äº’ä¹‹é—´çš„è€¦åˆã€‚å¦‚æœä¸ç†Ÿæ‚‰EventBusï¼Œå¯ä»¥å…ˆäº†è§£EventBusï¼Œä¸‹æ–‡æ¶‰åŠåˆ°ottoä¸EventBusçš„å¯¹æ¯”ã€‚</p>
<p>Ottoå¯ä»¥éšä¾¿å®šä¹‰è®¢é˜…è€…çš„æ¶ˆæ¯å¤„ç†å‡½æ•°çš„å‡½æ•°åï¼Œé‡‡ç”¨æ³¨è§£çš„æ–¹å¼æ¥è¯†åˆ«ç”Ÿäº§å‡½æ•°å’Œæ¶ˆè´¹å‡½æ•°ï¼ˆ@Produceå’Œ@Subscribeï¼‰ï¼Œè¿™æ˜¯ä¸EventBusæ˜æ˜¾çš„ä¸åŒã€‚<br>]]>
    
    </summary>
    
      <category term="Android" scheme="http://www.carrotsight.com/tags/Android/"/>
    
      <category term="EventBus" scheme="http://www.carrotsight.com/tags/EventBus/"/>
    
      <category term="Otto" scheme="http://www.carrotsight.com/tags/Otto/"/>
    
      <category term="è§‚å¯Ÿè€…æ¨¡å¼" scheme="http://www.carrotsight.com/tags/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/"/>
    
      <category term="Android" scheme="http://www.carrotsight.com/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[EventBuså­¦ä¹ æ€»ç»“]]></title>
    <link href="http://www.carrotsight.com/2015/09/14/2015-9-14-EventBus%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93.html"/>
    <id>http://www.carrotsight.com/2015/09/14/2015-9-14-EventBuså­¦ä¹ æ€»ç»“.html</id>
    <published>2015-09-14T12:12:43.000Z</published>
    <updated>2015-12-02T13:07:27.000Z</updated>
    <content type="html"><![CDATA[<p>è¿™ä¸¤å¤©å¯¹Githubä¸Šå¾ˆç«çš„Eventbusè¿›è¡Œäº†å­¦ä¹ ï¼ŒæŸ¥é˜…äº†ä¸€äº›åšå®¢ï¼Œå†™ä»£ç åšäº†å®éªŒï¼Œä»¥æ­¤æ–‡æ€»ç»“ã€‚<br>æœ¬æ–‡æ¡£å‰é¢æ˜¯å¯¹EventBuså„æ–¹é¢çš„ä»‹ç»ã€‚å¦‚æœè¦å­¦ä¹ å¿«é€Ÿä½¿ç”¨ï¼Œå¯ä»¥ç›´æ¥è·³è½¬åˆ°åé¢çš„<a href="#è¯¦ç»†ä½¿ç”¨å®ä¾‹">è¯¦ç»†ä½¿ç”¨å®ä¾‹</a>éƒ¨åˆ†ã€‚</p>
<p><strong>æœ¬æ–‡EventBusæŒ‡çš„æ˜¯ï¼šgreenrobot/EventBus<br>Githubä¸Šæœ‰å¾ˆå¤šåŒåé¡¹ç›®ï¼Œä¸è¦æé”™ã€‚</strong><br>EventBusæ˜¯ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼æ¥æ›¿ä»£Intentã€Handlerã€Broadcastçš„åœ¨Activityã€Fragmentã€Serviceä¹‹é—´ä¼ é€’æ¶ˆæ¯çš„æœºåˆ¶ã€‚èƒ½é™ä½ç»„ä»¶é—´çš„è€¦åˆï¼Œä½¿ä»£ç æ›´ç®€æ´ã€‚</p>
<h2 id="æ¦‚å¿µå›¾">æ¦‚å¿µå›¾</h2><p><img src="http://7xle8x.com1.z0.glb.clouddn.com/15-8-28/38822932.jpg" alt="EventBusæ¦‚å¿µå›¾"><br><a id="more"></a></p>
<h2 id="ç‰¹ç‚¹">ç‰¹ç‚¹</h2><p>â€œäº‹ä»¶â€æ˜¯ä¸€ä¸ªPOJOï¼Œæ ¹æ®è‡ªå·±éœ€è¦è‡ªå·±éšä¾¿å®šä¹‰çš„ä¸€ä¸ªJAVAç±»ï¼ŒåŒ…å«éœ€è¦ä¼ é€’ç»™å…¶ä»–ç»„ä»¶çš„ä¿¡æ¯ã€‚  </p>
<p>äº‹ä»¶å‘å¸ƒè€…ä¸éœ€è¦æ³¨å†Œï¼Œç›´æ¥ä½¿ç”¨EventBus.getDefault().post(new TextEvent(â€œæˆ‘æœ‰ä¸€å¤´å°æ¯›é©´â€))ã€‚å…¶ä¸­TextEventæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰ç±»ã€‚  </p>
<p>äº‹ä»¶è®¢é˜…è€…ï¼ˆæ¥å—è€…ã€å¤„ç†è€…ï¼‰éœ€è¦åœ¨onCreate()æ–¹æ³•ä¸­é€šè¿‡EventBus.getDefault().register(this)æ³¨å†Œè‡ªå·±ï¼Œåœ¨onDestroy()æ–¹æ³•ä¸­é€šè¿‡EventBus.getDefault().unregister(this)å–æ¶ˆæ³¨å†Œã€‚åŒæ—¶ï¼Œéœ€è¦è‡³å°‘å®ç°4ç§onEventXXXæ–¹æ³•ä¸­çš„ä¸€ç§ã€‚   </p>
<p>æ”¯æŒ4ç§äº‹ä»¶å“åº”æ¨¡å¼ï¼š  </p>
<blockquote>
<ol>
<li>MainThreadï¼šå¯¹åº”çš„å“åº”å‡½æ•°å†™æ³•ä¸ºonEventMainThreadï¼Œäº‹ä»¶å“åº”å‡½æ•°ä¼šåœ¨Androidåº”ç”¨çš„ä¸»çº¿ç¨‹(å¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½æ˜¯UIçº¿ç¨‹)ä¸­æ‰§è¡Œã€‚</li>
<li>PostThreadï¼šå¯¹åº”çš„å“åº”å‡½æ•°å†™æ³•ä¸ºonEventï¼Œå³é»˜è®¤çš„å¤„ç†æ–¹å¼å°±æ˜¯postæ–¹å¼ã€‚äº‹ä»¶å“åº”å‡½æ•°å’Œäº‹ä»¶å‘å¸ƒåœ¨åŒä¸€çº¿ç¨‹ä¸­æ‰§è¡Œã€‚è¿™ä¸ªæ˜¯é»˜è®¤å€¼ï¼Œè¿™æ ·å¯ä»¥é¿å…çº¿ç¨‹åˆ‡æ¢ã€‚</li>
<li>BackgroundThreadï¼šå¯¹åº”çš„å“åº”å‡½æ•°å†™æ³•ä¸ºonEventBackgroundThreadï¼Œäº‹ä»¶å“åº”å‡½æ•°ä¼šåœ¨ä¸€ä¸ªåå°çº¿ç¨‹ä¸­æ‰§è¡Œã€‚å¦‚æœäº‹ä»¶å‘å¸ƒå‡½æ•°ä¸æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­ï¼Œåˆ™ä¼šç«‹å³åœ¨äº‹ä»¶å‘å¸ƒçº¿ç¨‹ä¸­æ‰§è¡Œå“åº”å‡½æ•°ã€‚å¦‚æœäº‹ä»¶å‘å¸ƒå‡½æ•°åœ¨ä¸»çº¿ç¨‹ä¸­ï¼ŒEventBusåˆ™ä¼šåœ¨å”¯ä¸€çš„ä¸€ä¸ªåå°çº¿ç¨‹ä¸­æŒ‰ç…§é¡ºåºæ¥æ‰§è¡Œæ‰€æœ‰çš„åå°äº‹ä»¶å“åº”å‡½æ•°ã€‚</li>
<li>Asyncï¼šå¯¹åº”çš„å“åº”å‡½æ•°å†™æ³•ä¸ºonEventAsyncï¼Œæ¯æ¥æ”¶åˆ°ä¸€ä¸ªäº‹ä»¶éƒ½ä¼šå¼€å¯ä¸€ä¸ªå¼‚æ­¥çº¿ç¨‹æ‰§è¡Œã€‚  </li>
</ol>
</blockquote>
<p>å‰3ç§å“åº”å‡½æ•°éƒ½è¦æ±‚å…¶ä¸­ä¸èƒ½æœ‰è€—æ—¶æ“ä½œï¼Œé˜²æ­¢UIæ›´æ–°ã€äº‹ä»¶åˆ†å‘æˆ–æ–°äº‹ä»¶çš„å¤„ç†ç­‰æ“ä½œè¢«é˜»å¡ã€‚ </p>
<p>é€šè¿‡å®éªŒï¼Œå¦‚æœåœ¨åŒä¸€ä¸ªè®¢é˜…è€…ä¸­å¯¹åŒä¸€ä¸ªäº‹ä»¶åŒæ—¶æ³¨å†Œäº†è¿™4ç§å“åº”å‡½æ•°ï¼Œåˆ™æ§åˆ¶å°æ‰“å°çš„æ—¶é—´å¤„ç†å‡½æ•°é¡ºåºä¸º :</p>
<blockquote>
<p>onEvent()-&gt;onEventMainThread()-&gt;onEventAsync()-&gt;onEventBackgroundThread()</p>
</blockquote>
<p>æˆ–</p>
<blockquote>
<p>onEvent()-&gt;onEventMainThread()-&gt;onEventBackgroundThread()-&gt;onEventAsync()ã€‚ </p>
</blockquote>
<p>ç”±äºonEventBackgroundThreadï¼ˆï¼‰å’ŒonEventAsyncï¼ˆï¼‰éƒ½æ˜¯åœ¨åå°çº¿ç¨‹æ‰§è¡Œçš„ï¼ŒåŒ…æ‹¬åœ¨æ§åˆ¶å°æ‰“å°å‡½æ•°åçš„æ“ä½œï¼Œæ‰€ä»¥æ­¤é¡ºåºä¸ä¸€å®šå°±æ˜¯è¿™å‡ ä¸ªå‡½æ•°è¢«è§¦å‘çš„é¡ºåºã€‚</p>
<h2 id="ä¼˜å…ˆçº§">ä¼˜å…ˆçº§</h2><p>EventBusåœ¨æ³¨å†Œè®¢é˜…è€…æ—¶éœ€è¦æŒ‡å®šæ­¤è®¢é˜…è€…çš„ä¼˜å…ˆçº§ï¼Œç”¨æ•´å‹æ•°è¡¨ç¤ºï¼Œæ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ã€‚å¦‚æœä¸æ˜¾ç¤ºæŒ‡å®šä¼˜å…ˆçº§ï¼Œåˆ™é»˜è®¤ä¸º0ã€‚ä¼˜å…ˆçº§å¯ä»¥ä¸ºè´Ÿæ•°ã€‚  </p>
<p>å¯¹äºåŒä¸€ä¸ªäº‹ä»¶çš„å¤šä¸ªè®¢é˜…è€…ï¼Œé«˜ä¼˜å…ˆçº§çš„è®¢é˜…è€…ä¼šå…ˆæ¥æ”¶åˆ°Eventã€‚</p>
<p>æ¥æ”¶åˆ°Eventçš„è®¢é˜…è€…å¯ä»¥å†³å®šæ˜¯å¦å–æ¶ˆäº‹ä»¶çš„ä¼ é€’ï¼Œæ¥ä½¿åé¢çš„è®¢é˜…è€…æ— æ³•æ¥æ”¶åˆ°Eventã€‚æ–¹æ³•æ˜¯åœ¨onEventæ–¹æ³•ä¸­è°ƒç”¨EventBus.getDefault().cancelEventDelivery(event)ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåªèƒ½åœ¨Postçº¿ç¨‹çš„onEventæ–¹æ³•ä¸­å–æ¶ˆäº‹ä»¶çš„ä¼ é€’ã€‚ </p>
<p>ç»è¿‡å®éªŒï¼Œ<strong>ç›¸åŒä¼˜å…ˆçº§çš„è®¢é˜…è€…æ˜¯æŒ‰ç…§æ³¨å†Œçš„å…ˆåé¡ºåºæ¥æ¥æ”¶äº‹ä»¶çš„</strong>ã€‚å…ˆæ¥æ”¶åˆ°äº‹ä»¶çš„è®¢é˜…è€…å¦‚æœåœ¨onEvent()æ–¹æ³•ä¸­è°ƒç”¨EventBus.getDefault().cancelEventDelivery(event)ï¼ŒåŒæ ·å¯ä»¥ä¸­æ–­äº‹ä»¶ç»§ç»­ä¼ æ’­ï¼Œä½†ä¸­æ–­å¾—ä¸å½»åº•ï¼Œç´§éšå…¶åçš„1ä¸ªè®¢é˜…è€…ä»ç„¶æœ‰å¯èƒ½æ¥æ”¶åˆ°äº‹ä»¶ã€‚</p>
<p><strong><em>æ³¨æ„ï¼š</em></strong>  </p>
<p>å¦‚æœç¬¬ä¸€ä¸ªæ¥æ”¶åˆ°æ—¶é—´çš„è®¢é˜…è€…åœ¨ä»»ä½•ä¸€ä¸ªè®¢é˜…å‡½æ•°ä¸­å¯¹æ¥æ”¶åˆ°çš„eventçš„å†…å®¹åšäº†ä¿®æ”¹ï¼Œé‚£ä¹ˆåç»­çš„å…¶ä»–è®¢é˜…è€…çš„æ‰€æœ‰onEventXXXå‡½æ•°æ¥å—åˆ°çš„eventä¹Ÿéƒ½æ˜¯è¢«ä¿®æ”¹çš„ã€‚å³<strong>postæ“ä½œåªäº§ç”Ÿä¸€ä¸ªeventå¯¹è±¡ï¼Œæ‰€æœ‰è®¢é˜…è€…çš„onEventXXXå‡½æ•°æ¥å—åˆ°çš„éƒ½æ˜¯åŒä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨</strong>ã€‚</p>
<p>å¦‚æœeventè¢«ç”Ÿäº§è€…postä¹‹åï¼Œè®¢é˜…è€…æ¥æ”¶åˆ°äº†äº‹ä»¶å¹¶è¶³å¤Ÿå¿«çš„å¯¹è¯¥eventçš„æŸäº›å­—æ®µåšäº†ä¿®æ”¹ï¼Œé‚£ä¹ˆç”Ÿäº§è€…åœ¨postè¯­å¥ä¹‹åå¯¹eventçš„å¼•ç”¨ä¹Ÿä¼šä½“ç°å‡ºå­—æ®µçš„ä¿®æ”¹ã€‚è¿™é‡Œçš„â€œè¶³å¤Ÿå¿«â€æ²¡æœ‰å®šè®ºï¼Œå®éªŒçš„æ¯æ¬¡ç»“æœéƒ½æœ‰å·®å¼‚ï¼Œä¸è¿‡åŸºæœ¬çš„è§„å¾‹æ˜¯ç”Ÿäº§è€…çš„postï¼ˆï¼‰è¯­å¥ä¹‹åçš„ä¸‹ä¸€æ¡è¯­å¥ï¼Œä¼šåœ¨æ‰€æœ‰è®¢é˜…è€…çš„onEvent()å’ŒonEventMainThread()éƒ½æ‰§è¡Œå®Œæˆåæ‰æ‰§è¡Œã€‚è€ŒonEventAsync()å’ŒonEventBackgroundThread()ç›¸å¯¹äºpostï¼ˆï¼‰ä¸‹ä¸€æ¡è¯­å¥çš„æ‰§è¡Œé¡ºåºåˆ™æ²¡æœ‰å®šè®ºã€‚</p>
<h2 id="å…³äºcancelEventDeliveryçš„é—®é¢˜">å…³äºcancelEventDeliveryçš„é—®é¢˜</h2><p>å¦‚æœåœ¨postçº¿ç¨‹çš„onEventæ–¹æ³•ä¸­ï¼Œå…ˆæœ‰ä¸€æ®µç‰¹åˆ«è€—æ—¶çš„æ“ä½œï¼Œç„¶åæ‰è°ƒç”¨cancelEventDeliveryï¼Œé‚£ä¹ˆåé¢çš„è®¢é˜…è€…æœ‰å¯èƒ½å› ä¸ºcancelEventDeliveryæ²¡è¢«å³æ—¶æ‰§è¡Œè€Œæ¥æ”¶åˆ°äº‹ä»¶å—ï¼Ÿæ¯”å¦‚è®¢é˜…è€…1çš„onEventæ–¹æ³•æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(TextEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">99999999</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">int</span> a = i;</span><br><span class="line">            &#125;</span><br><span class="line">            EventBus.getDefault().cancelEventDelivery(event);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆæœ¬è¯¥åœ¨è®¢é˜…è€…1åé¢æ‰æ¥æ”¶åˆ°äº‹ä»¶çš„è®¢é˜…è€…2ä¼šæ¥æ”¶åˆ°eventå—ï¼Ÿä¹Ÿè®¸EventBusä¼šåœ¨forå¾ªç¯è¿™æ®µæ—¶é—´å†…å·²è¿‘æŠŠäº‹ä»¶ä¼ é€’ç»™è®¢é˜…è€…2äº†ï¼Œæ¯•ç«Ÿè¿™æ—¶è¿˜æ²¡æœ‰æ‰§è¡ŒEventBus.getDefault().cancelEventDelivery(event)ï¼Ÿ</p>
<p>å¸¦ç€è¿™ä¸ªé—®é¢˜ï¼Œè·Ÿè¿›äº†ä¸€ä¸‹EventBusçš„æºç ï¼Œæœ‰ä»¥ä¸‹å‘ç°ã€‚  </p>
<p><img src="http://7xle8x.com1.z0.glb.clouddn.com/15-12-2/91530689.jpg" alt=""></p>
<p>åœ¨äº‹ä»¶ç”Ÿäº§è€…è°ƒç”¨postæ–¹æ³•æ—¶ï¼ŒEventbuså†…éƒ¨æ˜¯é€šè¿‡è°ƒç”¨è¿™ä¸ªpostSingleEventForEventType<br>æ–¹æ³•æ¥è¿›è¡Œæ¶ˆæ¯ä¼ é€’çš„ï¼Œä¸€æ—¦EventBus.getDefault().cancelEventDelivery<br>(event)æ–¹æ³•è¢«è°ƒç”¨ï¼Œabortedå°±è¢«ç½®ä¸ºfalseï¼Œè¿™ä¸ªforå¾ªç¯å°±ä¼šåœæ­¢ï¼Œæ¶ˆæ¯ä¸ä¼šå†å‘åé¢ä»»ä½•è®¢é˜…è€…çš„ä»»ä½•ä¸€ç§çº¿ç¨‹å‡½æ•°ä¼ é€’ã€‚<br>ç”±äºcancelEventDeliveryæ–¹æ³•åªèƒ½åœ¨postçº¿ç¨‹çš„onEventå‡½æ•°ä¸­è°ƒç”¨ï¼Œè€Œè¿™é‡Œçš„postToSubscriptionæ–¹æ³•å¯¹äºpostçº¿ç¨‹çš„æ‰§è¡Œæ˜¯åŒæ­¥çš„ï¼Œæ‰€ä»¥å³ä½¿æŸä¸ªè®¢é˜…è€…åœ¨postçº¿ç¨‹çš„onEventä¸­å…ˆè¿›è¡Œè€—æ—¶æ“ä½œå†è°ƒç”¨cancelEventDeliveryï¼Œåé¢çš„è®¢é˜…è€…ä¹Ÿæ¥å—ä¸åˆ°è¿™ä¸ªäº‹ä»¶ï¼Œå› ä¸ºpostSingleEventForEventTypeæ–¹æ³•è¿˜åœ¨ç­‰å¾…2è¿”å›ï¼ˆåŒæ­¥æ–¹æ³•ï¼‰ã€‚  </p>
<p>postToSubscriptionçš„å†…éƒ¨å®ç°å¦‚ä¸‹ï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/15-12-2/70984573.jpg" alt=""></p>
<p>æˆ‘ç”¨ä»£ç åœ¨å„ç§çº¿ç¨‹ä¸­éƒ½è¯•è¿‡äº†ï¼Œç¡®å®ä¸ç”¨æ‹…å¿ƒcancelEventDeliveryä¹‹å‰çš„è€—æ—¶æ“ä½œå¯¼è‡´åœ¨è€—æ—¶æ“ä½œæœŸé—´äº‹ä»¶ä»ç„¶è¢«ä¼ é€’çš„é—®é¢˜ã€‚åªæœ‰ä¸€ç§ä¾‹å¤–ï¼Œå°±æ˜¯åœ¨postçº¿ç¨‹çš„onThreadæ–¹æ³•ä¸­å†å¯æ–°çº¿ç¨‹è¿›è¡ŒcancelEventDeliveryè°ƒç”¨ï¼Œä¸ä¼šè¿™æ ·åšæ²¡æœ‰æ„ä¹‰ï¼Œå› ä¸ºeventbuså·²ç»æä¾›äº†4ç§çº¿ç¨‹æ¨¡å‹äº†ï¼Œä¸éœ€è¦è¿™æ ·å¤šæ­¤ä¸€ä¸¾ï¼Œ ç›¸ä¿¡ä¸ä¼šæœ‰äººè¿™æ ·å†™ä»£ç ï¼Œå°±åƒä¸‹é¢è¿™æ ·ï¼š<br><img src="http://7xle8x.com1.z0.glb.clouddn.com/15-12-2/40991601.jpg" alt=""></p>
<h2 id="åŸºæœ¬ç”¨æ³•æµç¨‹3æ­¥æå®š">åŸºæœ¬ç”¨æ³•æµç¨‹3æ­¥æå®š</h2><p>1.å®šä¹‰äº‹ä»¶  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageEvent</span> </span>&#123; <span class="comment">/* Additional fields if needed */</span> &#125;</span><br></pre></td></tr></table></figure>
<p>2.æ³¨å†Œè®¢é˜…è€…</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eventBus.register(<span class="keyword">this</span>);<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(AnyEventType event)</span> </span>&#123;<span class="comment">/* Do something */</span>&#125;;</span><br></pre></td></tr></table></figure>
<p>3.å‘é€äº‹ä»¶</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eventBus.post(event);</span><br></pre></td></tr></table></figure>
<h2 id="StickyEvent">StickyEvent</h2><p>é™¤äº†æ™®é€šçš„Eventï¼Œè¿˜æœ‰ä¸€ç±»ç‰¹æ®Šçš„StickyEventï¼Œå®ƒä¹Ÿæ˜¯POJOï¼Œäº‹ä»¶æœ¬èº«å’Œæ™®é€šäº‹ä»¶æ— åŒºåˆ«ï¼Œåªæ˜¯åœ¨æ³¨å†Œè®¢é˜…è€…æ³¨å†Œæ—¶éœ€è¦ä½¿ç”¨EventBus.getDefault().registerSticky(this)ã€‚äº‹ä»¶å¤„ç†å‡½æ•°çš„å‡½æ•°åä¹Ÿä¸æ™®é€šäº‹ä»¶çš„å¤„ç†å‡½æ•°ä¸€æ ·ï¼Œå› ä¸ºæ³¨å†Œä¸ºäº†StickyEventçš„ç›‘å¬å™¨ï¼Œæ‰€ä»¥EventBusåœ¨è°ƒç”¨è¿™äº›äº‹ä»¶å¤„ç†å‡½æ•°æ—¶ä¼šæŒ‰ç…§StickyEventçš„æ–¹å¼æ¥å¤„ç†ã€‚  </p>
<p>StickyEventä¸æ™®é€šEventçš„æ™®é€šå°±åœ¨äºï¼ŒEventBusä¼šè‡ªåŠ¨ç»´æŠ¤è¢«ä½œä¸ºStickyEventè¢«postå‡ºæ¥ï¼ˆå³åœ¨å‘å¸ƒäº‹ä»¶æ—¶ä½¿ç”¨EventBus.getDefault().postSticky(new MyEvent())æ–¹æ³•ï¼‰çš„äº‹ä»¶çš„æœ€åä¸€ä¸ªå‰¯æœ¬åœ¨ç¼“å­˜ä¸­ã€‚  </p>
<p>ä»»ä½•æ—¶å€™åœ¨ä»»ä½•ä¸€ä¸ªè®¢é˜…äº†è¯¥äº‹ä»¶çš„è®¢é˜…è€…ä¸­çš„ä»»ä½•åœ°æ–¹ï¼ˆå¯ä»¥åœ¨ä»»ä½•å‡½æ•°ä¸­ï¼Œè€Œä¸ä»…ä»…æ˜¯åœ¨onEventXXXæ–¹æ³•ä¸­ï¼‰ï¼Œéƒ½å¯ä»¥é€šè¿‡EventBus.getDefault().getStickyEvent(MyEvent.class)æ¥å–å¾—è¯¥ç±»å‹äº‹ä»¶çš„æœ€åä¸€æ¬¡ç¼“å­˜ã€‚  </p>
<p>åŒæ—¶ï¼Œå³ä¾¿äº‹ä»¶å·²ç»åœ¨æ‰€æœ‰è®¢é˜…è€…ä¸­ä¼ é€’å®Œæˆäº†ï¼Œå¦‚æœæ­¤æ—¶å†åˆ›å»ºä¸€ä¸ªæ–°çš„è®¢é˜…è€…ï¼ˆå¦‚ä¸€ä¸ªæ³¨å†Œäº†è¯¥StickyEventçš„Activityï¼‰ï¼Œåˆ™åœ¨è®¢é˜…è€…å¯åŠ¨åï¼Œä¼šè‡ªåŠ¨è°ƒç”¨ä¸€æ¬¡è¯¥è®¢é˜…è€…çš„noEventXXXæ–¹æ³•æ¥å¤„ç†è¯¥StickyEventã€‚  </p>
<p>ä¹Ÿå¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™ï¼Œåˆ©ç”¨removeStickyEventæ–¹æ³•æ¥ç§»é™¤å¯¹æŸç§StickyEventçš„ç¼“å­˜ã€‚</p>
<h2 id="ç½‘ä¸Šåšæ–‡æ€»ç»“EventBusçš„ä¼˜ç‚¹">ç½‘ä¸Šåšæ–‡æ€»ç»“EventBusçš„ä¼˜ç‚¹</h2><blockquote>
<ol>
<li>æ”¯æŒåœ¨ä¸åŒç±»å‹çš„çº¿ç¨‹ä¸­å¤„ç†è®¢é˜…ï¼ŒåŒ…æ‹¬å‘å¸ƒæ‰€åœ¨çº¿ç¨‹ï¼ŒUIçº¿ç¨‹ã€å•ä¸€åå°çº¿ç¨‹ã€å¼‚æ­¥çº¿ç¨‹</li>
<li>æ”¯æŒäº‹ä»¶ä¼˜å…ˆçº§å®šä¹‰ï¼Œæ”¯æŒä¼˜å…ˆçº§é«˜çš„è®¢é˜…è€…å–æ¶ˆäº‹ä»¶ç»§ç»­ä¼ é€’ï¼Œæ”¯æŒç²˜æ€§äº‹ä»¶ï¼Œæ˜¯ä¸æ˜¯è·Ÿç³»ç»Ÿçš„æœ‰åºå¹¿æ’­ã€ç²˜æ€§å¹¿æ’­å¾ˆåƒå•Š</li>
<li>ä¸æ˜¯åŸºäºannotations</li>
<li>æ€§èƒ½æ›´ä¼˜</li>
<li>ä½“ç§¯å°</li>
<li>æ”¯æŒå•ä¾‹åˆ›å»ºæˆ–åˆ›å»ºå¤šä¸ªå¯¹è±¡</li>
<li>æ”¯æŒæ ¹æ®äº‹ä»¶ç±»å‹è®¢é˜…</li>
</ol>
</blockquote>
<h2 id="è¯¦ç»†ä½¿ç”¨å®ä¾‹"><a href="id:è¯¦ç»†ä½¿ç”¨å®ä¾‹" target="_blank" rel="external">è¯¦ç»†ä½¿ç”¨å®ä¾‹</a></h2><p>1.å‡†å¤‡å·¥ä½œï¼š  </p>
<p>åœ¨é¡¹ç›®build.gradleçš„dependenciesä¸­åŠ å…¥ä»¥ä¸‹å†…å®¹ï¼š<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">compile</span> <span class="string">'de.greenrobot:eventbus:2.4.0'</span></span><br></pre></td></tr></table></figure></p>
<p>2.ç¼–å†™äº‹ä»¶</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TextEvent</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TextEvent</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMsg</span><span class="params">()</span> </span>&#123;        </span><br><span class="line">    	<span class="keyword">return</span> msg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3.åœ¨éœ€è¦è®¢é˜…è¯¥äº‹ä»¶çš„Activityçš„onCreateï¼ˆï¼‰æ–¹æ³•ä¸­ï¼ŒæŠŠè‡ªå·±æ³¨å†Œä¸ºè®¢é˜…è€…ã€‚<br>é»˜è®¤ä½¿ç”¨EventBusæä¾›çš„é»˜è®¤æ€»çº¿ï¼Œå³EventBus.getDefault()æ–¹æ³•è·å¾—çš„æ€»çº¿ï¼Œå…¶å†…éƒ¨å®ç°äº†å•ä¾‹æ¨¡å¼ã€‚è‡ªå·±ä¹Ÿå¯ä»¥æ ¹æ®éœ€è¦å®šåˆ¶ä¸åŒçš„æ€»çº¿ã€‚<br>register()æ–¹æ³•æ˜¯å‘æ€»çº¿è®¢é˜…æ™®é€šäº‹ä»¶ï¼ŒregisterStickyæ–¹æ³•æ˜¯å‘æ€»çº¿è®¢é˜…Stickyäº‹ä»¶ã€‚åªèƒ½ä½¿ç”¨äºŒè€…å½“ä¸­çš„ä¸€ç§æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    	<span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    	<span class="comment">//EventBus.getDefault().registerSticky(this);</span></span><br><span class="line">        EventBus.getDefault().register(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4.åœ¨æ³¨å†Œä¸ºè®¢é˜…è€…çš„Activityçš„onDestroyï¼ˆï¼‰æ–¹æ³•ä¸­ï¼Œè§£é™¤æ³¨å†Œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;	</span><br><span class="line">	<span class="keyword">super</span>.onDestroy();</span><br><span class="line">	EventBus.getDefault().unregister(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>5.åœ¨æ³¨å†Œä¸ºè®¢é˜…è€…çš„Activityä¸­ï¼Œç¼–å†™äº‹ä»¶å¤„ç†æ–¹æ³•ã€‚<br>ä¸‹é¢çš„ä»£ç åˆ—ä¸¾äº†4ç§çº¿ç¨‹ç±»å‹çš„äº‹ä»¶å¤„ç†æ–¹æ³•ï¼Œå®é™…ä½¿ç”¨æ—¶å¯ä»¥æ ¹æ®éœ€è¦åªå®ç°å…¶ä¸­çš„å‡ ç§ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEventAsync</span><span class="params">(TextEvent event)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">/* messageTextView.setText(event.getMsg());</span><br><span class="line">           Toast.makeText(this, event.getMsg(), Toast.LENGTH_SHORT).show();*/</span></span><br><span class="line">           Log.d(<span class="string">"TAG"</span>, event.getMsg());</span><br><span class="line">           Log.d(<span class="string">"onEvent"</span>, <span class="string">"onEventAsync()"</span>);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(TextEvent event)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           messageTextView.setText(event.getMsg());</span><br><span class="line">           Toast.makeText(<span class="keyword">this</span>, event.getMsg(), Toast.LENGTH_SHORT).show();</span><br><span class="line">           Log.d(<span class="string">"TAG"</span>, event.getMsg());</span><br><span class="line">           Log.d(<span class="string">"onEvent"</span>, <span class="string">"onEvent()"</span>);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEventMainThread</span><span class="params">(TextEvent event)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">/* messageTextView.setText(event.getMsg());</span><br><span class="line">           Toast.makeText(this, event.getMsg(), Toast.LENGTH_SHORT).show();*/</span></span><br><span class="line">           Log.d(<span class="string">"TAG"</span>, event.getMsg());</span><br><span class="line">           Log.d(<span class="string">"onEvent"</span>, <span class="string">"onEventMainThread()"</span>);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125; </span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEventBackgroundThread</span><span class="params">(TextEvent event)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">/* messageTextView.setText(event.getMsg());</span><br><span class="line">           Toast.makeText(this, event.getMsg(), Toast.LENGTH_SHORT).show();*/</span></span><br><span class="line">           Log.d(<span class="string">"TAG"</span>, event.getMsg());</span><br><span class="line">           Log.d(<span class="string">"onEvent"</span>, <span class="string">"onEventBackgroundThread()"</span>);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125; </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>6.åœ¨éœ€è¦äº§ç”Ÿäº‹ä»¶çš„ç»„ä»¶ï¼ˆActivityã€Fragmentã€Serviceç­‰ï¼‰ä¸­ï¼Œè°ƒç”¨å‘é€äº‹ä»¶çš„æ–¹æ³•ã€‚<br>ä¸‹é¢çš„ä»£ç åˆ—ä¸¾äº†å‘é€æ™®é€šäº‹ä»¶å’Œå‘é€Stickyäº‹ä»¶ä¸¤ç§æƒ…å†µã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">switch</span> (v.getId())&#123;</span><br><span class="line">           <span class="keyword">case</span> R.id.activity8_btn1:</span><br><span class="line">               EventBus.getDefault().post(<span class="keyword">new</span> TextEvent(<span class="string">"æˆ‘æœ‰ä¸€å¤´å°æ¯›é©´"</span>));</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">case</span> R.id.activity8_btn2:</span><br><span class="line">               EventBus.getDefault().postSticky(<span class="keyword">new</span> TextEvent(<span class="string">"æˆ‘æœ‰ä¸€å¤´å°æ¯›é©´"</span>));</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·ï¼Œå½“ç‚¹å‡»æŒ‰é’®è§¦å‘onClickï¼ˆï¼‰æ—¶ï¼Œå°±èƒ½åœ¨ç¬¬5æ­¥çš„MainActivityä¸­çš„onEventXXXæ–¹æ³•ä¸­æ¥æ”¶åˆ°äº‹ä»¶äº†ã€‚<br>å¦‚æœå‘é€çš„æ˜¯Stickyäº‹ä»¶ï¼Œåˆ™å¯ä»¥åœ¨ä»»ä½•éœ€è¦è·å–è¯¥äº‹ä»¶çš„åœ°æ–¹é€šè¿‡EventBus.getDefault().getStickyEvent(TextEvent.class)æ–¹æ³•æ¥è·å–è¯¥ç±»å‹çš„StickyEventçš„æœ€åä¸€æ¬¡æ•°æ®ã€‚</p>
<hr>
<p>å‚è€ƒèµ„æ–™</p>
<ol>
<li><p><a href="https://github.com/greenrobot/EventBus" target="_blank" rel="external">å®˜æ–¹ä¸‹è½½: https://github.com/greenrobot/EventBus
</a></p>
</li>
<li><p><a href="https://github.com/greenrobot/EventBus/blob/master/HOWTO.md" target="_blank" rel="external">å®˜æ–¹ä½¿ç”¨è¯´æ˜: https://github.com/greenrobot/EventBus/blob/master/HOWTO.md</a></p>
</li>
<li><p><a href="http://blog.csdn.net/marktheone/article/details/47725553" target="_blank" rel="external">EventBus, otto, LocalBroadcastçš„å¯¹æ¯”ï¼šhttp://blog.csdn.net/marktheone/article/details/47725553</a></p>
</li>
<li><p><a href="http://blog.csdn.net/harvic880925/article/details/40660137" target="_blank" rel="external">EventBusä½¿ç”¨è¯¦è§£ï¼š<br>http://blog.csdn.net/harvic880925/article/details/40660137</a></p>
</li>
<li><p><a href="http://www.cnblogs.com/wangjq/archive/2012/07/12/2587966.html" target="_blank" rel="external">è§‚å¯Ÿè€…æ¨¡å¼ï¼š<br>http://www.cnblogs.com/wangjq/archive/2012/07/12/2587966.html</a></p>
</li>
</ol>
]]></content>
    <summary type="html">
    <![CDATA[<p>è¿™ä¸¤å¤©å¯¹Githubä¸Šå¾ˆç«çš„Eventbusè¿›è¡Œäº†å­¦ä¹ ï¼ŒæŸ¥é˜…äº†ä¸€äº›åšå®¢ï¼Œå†™ä»£ç åšäº†å®éªŒï¼Œä»¥æ­¤æ–‡æ€»ç»“ã€‚<br>æœ¬æ–‡æ¡£å‰é¢æ˜¯å¯¹EventBuså„æ–¹é¢çš„ä»‹ç»ã€‚å¦‚æœè¦å­¦ä¹ å¿«é€Ÿä½¿ç”¨ï¼Œå¯ä»¥ç›´æ¥è·³è½¬åˆ°åé¢çš„<a href="#è¯¦ç»†ä½¿ç”¨å®ä¾‹">è¯¦ç»†ä½¿ç”¨å®ä¾‹</a>éƒ¨åˆ†ã€‚</p>
<p><strong>æœ¬æ–‡EventBusæŒ‡çš„æ˜¯ï¼šgreenrobot/EventBus<br>Githubä¸Šæœ‰å¾ˆå¤šåŒåé¡¹ç›®ï¼Œä¸è¦æé”™ã€‚</strong><br>EventBusæ˜¯ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼æ¥æ›¿ä»£Intentã€Handlerã€Broadcastçš„åœ¨Activityã€Fragmentã€Serviceä¹‹é—´ä¼ é€’æ¶ˆæ¯çš„æœºåˆ¶ã€‚èƒ½é™ä½ç»„ä»¶é—´çš„è€¦åˆï¼Œä½¿ä»£ç æ›´ç®€æ´ã€‚</p>
<h2 id="æ¦‚å¿µå›¾">æ¦‚å¿µå›¾</h2><p><img src="http://7xle8x.com1.z0.glb.clouddn.com/15-8-28/38822932.jpg" alt="EventBusæ¦‚å¿µå›¾"><br>]]>
    
    </summary>
    
      <category term="Android" scheme="http://www.carrotsight.com/tags/Android/"/>
    
      <category term="EventBus" scheme="http://www.carrotsight.com/tags/EventBus/"/>
    
      <category term="Android" scheme="http://www.carrotsight.com/categories/Android/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[ã€ŠThink in Javaã€‹å¹¶å‘ - å­¦ä¹ ç¬”è®°]]></title>
    <link href="http://www.carrotsight.com/2015/09/08/2015-9-8-%E3%80%8AThink-in-Java%E3%80%8B%E5%B9%B6%E5%8F%91-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"/>
    <id>http://www.carrotsight.com/2015/09/08/2015-9-8-ã€ŠThink-in-Javaã€‹å¹¶å‘-å­¦ä¹ ç¬”è®°.html</id>
    <published>2015-09-08T08:08:15.000Z</published>
    <updated>2015-12-03T08:07:13.000Z</updated>
    <content type="html"><![CDATA[<p>1.Executorå…è®¸ä½ ç®¡ç†å¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œï¼Œè€Œæ— é¡»æ˜¾ç¤ºåœ°ç®¡ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸã€‚Executoråœ¨Java SE5/6ä¸­æ˜¯å¯åŠ¨ä»»åŠ¡çš„ä¼˜é€‰æ–¹æ³•ã€‚å¯ä»¥ä½¿ç”¨Executoræ¥ä»£æ›¿æ˜¾ç¤ºåœ°åˆ›å»ºThreadå¯¹è±¡ã€‚  </p>
<p>2.ExecutorServiceçŸ¥é“å¦‚ä½•æ„å»ºæ°å½“çš„ä¸Šä¸‹æ–‡æ¥æ‰§è¡ŒRunnableå¯¹è±¡ã€‚  </p>
<p>3.CachedThreadPoolåœ¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­é€šå¸¸ä¼šåˆ›å»ºä¸æ‰€éœ€æ•°é‡ç›¸åŒçš„çº¿ç¨‹ï¼Œç„¶åå†å®ƒå›æ”¶æ—§çº¿ç¨‹æ—¶åœæ­¢åˆ›å»ºæ–°çº¿ç¨‹ï¼Œå› æ­¤å®ƒæ˜¯åˆç†çš„Executorçš„é¦–é€‰ã€‚åªæœ‰å½“è¿™ç§æ–¹å¼ä¼šå¼•å‘é—®é¢˜æ—¶ï¼Œæ‰éœ€è¦åˆ‡æ¢åˆ°FixedThreadPoolã€‚<br><a id="more"></a><br>4.SingleThreadExecutorå°±åƒæ˜¯çº¿ç¨‹æ•°é‡ä¸º1çš„FixedThreadPoolã€‚å¦‚æœå‘SingleThreadExecutoræäº¤äº†å¤šä¸ªä»»åŠ¡ï¼Œé‚£ä¹ˆè¿™äº›ä»»åŠ¡å°†æ’é˜Ÿï¼Œæ¯ä¸ªä»»åŠ¡éƒ½ä¼šåœ¨ä¸‹ä¸€ä¸ªä»»åŠ¡å¼€å§‹ä¹‹å‰è¿è¡Œç»“æŸï¼Œæ‰€æœ‰çš„ä»»åŠ¡å°†ä½¿ç”¨ç›¸åŒçš„çº¿ç¨‹ã€‚SingleThreadExecutorä¼šåºåˆ—åŒ–æ‰€æœ‰æäº¤ç»™å®ƒçš„ä»»åŠ¡ï¼Œå¹¶ä¼šç»´æŠ¤å®ƒè‡ªå·±ï¼ˆéšè—ï¼‰çš„æ‚¬æŒ‚ä»»åŠ¡é˜Ÿåˆ—ã€‚<br>SingleThreadExecutorç¡®ä¿ä»»ä½•æ—¶åˆ»åœ¨ä»»ä½•çº¿ç¨‹ä¸­éƒ½åªæœ‰å”¯ä¸€çš„ä»»åŠ¡åœ¨è¿è¡Œï¼Œå°±ä¸éœ€è¦åœ¨å…±äº«èµ„æºä¸Šå¤„ç†åŒæ­¥ã€‚  </p>
<p>5.Runnableæ˜¯æ‰§è¡Œå·¥ä½œçš„ç‹¬ç«‹ä»»åŠ¡ï¼Œä½†æ˜¯ä»–ä¸è¿”å›ä»»ä½•å€¼ã€‚å¦‚æœå¸Œæœ›ä»»åŠ¡åœ¨å®Œæˆæ—¶èƒ½å¤Ÿè¿”å›ä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆå¯ä»¥å®ç°Callableæ¥å£è€Œä¸æ˜¯Runnableæ¥å£ã€‚åœ¨Java SE5ä¸­å¼•å…¥çš„Callableæ˜¯ä¸€ç§å…·æœ‰ç±»å‹å‚æ•°çš„æ³›å‹ï¼Œå®ƒçš„ç±»å‹å‚æ•°è¡¨ç¤ºçš„æ˜¯ä»æ–¹æ³•callï¼ˆï¼‰ï¼ˆè€Œä¸æ˜¯runï¼ˆï¼‰ï¼‰ä¸­è¿”å›çš„å€¼ï¼Œå¹¶ä¸”å¿…é¡»ä½¿ç”¨ExecutorService.submitï¼ˆï¼‰æ–¹æ³•è°ƒç”¨å®ƒã€‚<br>æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaskWithResult</span> <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">String</span>&gt;</span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">TaskWithResult</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.id = id;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		Thread.sleep((<span class="keyword">new</span> Random()).nextInt(<span class="number">2000</span>) + <span class="number">1000</span>);<span class="comment">//åœ¨è¿™é‡Œéšæœºç¡çœ æ—¶é—´ï¼Œä¸ºäº†æµ‹è¯•Future.isDone()çš„æ•ˆæœ</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">"TaskWithResult id: "</span> + id;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CallableTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		ExecutorService exec = Executors.newCachedThreadPool();</span><br><span class="line">		ArrayList&lt;Future&lt;String&gt;&gt; results = <span class="keyword">new</span> ArrayList&lt;Future&lt;String&gt;&gt;();</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">			results.add(exec.submit(<span class="keyword">new</span> TaskWithResult(i)));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span>(Future&lt;String&gt; fs : results)&#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				System.out.println(<span class="string">"\n==taskIndex "</span> + results.indexOf(fs) + <span class="string">"=="</span>);</span><br><span class="line">				System.out.println(<span class="string">"isDone(): "</span> + fs.isDone());</span><br><span class="line">				System.out.println(fs.get());</span><br><span class="line">				System.out.println(<span class="string">"isDone(): "</span> + fs.isDone());</span><br><span class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">				e.printStackTrace();</span><br><span class="line">			&#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">				exec.shutdown();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºç»“æœä¸ºï¼š</p>
<blockquote>
<p>==taskIndex 0==<br>isDone(): false<br>TaskWithResult id: 0<br>isDone(): true</p>
<p>==taskIndex 1==<br>isDone(): false<br>TaskWithResult id: 1<br>isDone(): true</p>
<p>==taskIndex 2==<br>isDone(): true<br>TaskWithResult id: 2<br>isDone(): true</p>
<p>==taskIndex 3==<br>isDone(): false<br>TaskWithResult id: 3<br>isDone(): true</p>
<p>==taskIndex 4==<br>isDone(): true<br>TaskWithResult id: 4<br>isDone(): true</p>
<p>==taskIndex 5==<br>isDone(): true<br>TaskWithResult id: 5<br>isDone(): true</p>
<p>==taskIndex 6==<br>isDone(): true<br>TaskWithResult id: 6<br>isDone(): true</p>
<p>==taskIndex 7==<br>isDone(): false<br>TaskWithResult id: 7<br>isDone(): true</p>
<p>==taskIndex 8==<br>isDone(): true<br>TaskWithResult id: 8<br>isDone(): true</p>
<p>==taskIndex 9==<br>isDone(): true<br>TaskWithResult id: 9<br>isDone(): true</p>
</blockquote>
<p>ä¸”æ¯å½“è¾“å‡ºåˆ°isDone(): falseçš„åœ°æ–¹ï¼Œè¾“å‡ºçº¿ç¨‹å°±ä¼šå¡ä½ï¼Œç›´åˆ°å–åˆ°è¿™ä¸ªçº¿ç¨‹çš„è¿”å›å€¼åï¼Œæ‰ä¼šç»§ç»­åç»­çš„æ‰“å°ã€‚  </p>
<p>Futureçš„javadocè¯´æ˜å¦‚ä¸‹ï¼š  </p>
<blockquote>
<p>A Future represents the result of an asynchronous computation. Methods are provided to check if the computation is complete, to wait for its completion, and to retrieve the result of the computation. The result can only be retrieved using method get when the computation has completed, blocking if necessary until it is ready. Cancellation is performed by the cancel method. Additional methods are provided to determine if the task completed normally or was cancelled. Once a computation has completed, the computation cannot be cancelled. If you would like to use a Future for the sake of cancellability but not provide a usable result, you can declare types of the form Future&lt;?&gt; and return null as a result of the underlying task.</p>
</blockquote>
<p>Future.get()æ–¹æ³•çš„javadocè¯´æ˜å¦‚ä¸‹ï¼š  </p>
<blockquote>
<p>Waits if necessary for the computation to complete, and then retrieves its result.</p>
</blockquote>
<p>6.è°ƒåº¦å™¨å€¾å‘äºè®©ä¼˜å…ˆçº§æœ€é«˜çš„çº¿ç¨‹å…ˆæ‰§è¡Œã€‚å¦‚æœè¦è®¾ç½®çº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼Œåº”è¯¥åœ¨runï¼ˆï¼‰æ–¹æ³•ä½“ä¸­ä½¿ç”¨<br><code>Thread.currentThread().setPriority(newPriority)</code>æ¥è®¾ç½®ï¼Œè€Œä¸è¦åœ¨æ„é€ å™¨ä¸­è®¾ç½®ã€‚<br>ä¸åŒæ“ä½œç³»ç»Ÿå¯¹ä¼˜å…ˆçº§çš„åˆ†çº§ä¸åŒï¼Œä¸ºäº†å¯ç§»æ¤æ€§ï¼Œåº”è¯¥åªä½¿ç”¨MAX_PRIORITYã€NORM_PRIORITYå’ŒMIN_PRIORITYä¸‰ç§çº§åˆ«ã€‚  </p>
<p>7.yieldï¼ˆï¼‰æ–¹æ³•ä¼šæš—ç¤ºçº¿ç¨‹è°ƒåº¦å™¨ï¼Œæˆ‘çš„å·¥ä½œåšå¾—å·®ä¸å¤šäº†ï¼Œå…·æœ‰ç›¸åŒä¼˜å…ˆçº§çš„å…¶ä»–çº¿ç¨‹å¯ä»¥è¿è¡Œäº†ã€‚ä½†è¿™ä»…ä»…æ˜¯ä¸€ä¸ªæš—ç¤ºï¼Œæ²¡æœ‰ä»»ä½•æœºåˆ¶ä¿è¯å®ƒå°†è¢«é‡‡çº³ã€‚æ‰€ä»¥ï¼Œä¸èƒ½ä¾èµ–äºyieldï¼ˆï¼‰ã€‚å®é™…ä¸Šï¼Œyieldï¼ˆï¼‰ç»å¸¸è¢«è¯¯ç”¨ã€‚  </p>
<p>8.æ‰€è°“åå°ï¼ˆdaemonï¼‰çº¿ç¨‹ï¼Œæ˜¯æŒ‡åœ¨ç¨‹åºè¿è¡Œçš„æ—¶å€™åœ¨åå°æä¾›ä¸€ç§é€šç”¨æœåŠ¡çš„çº¿ç¨‹ï¼Œå¹¶ä¸”è¿™ç§çº¿ç¨‹å¹¶ä¸å±äºç¨‹åºä¸­ä¸å¯æˆ–ç¼ºçš„éƒ¨åˆ†ã€‚å› æ­¤ï¼Œ<strong>å½“æ‰€æœ‰çš„éåå°çº¿ç¨‹ç»“æŸæ—¶ï¼Œç¨‹åºä¹Ÿå°±ç»ˆæ­¢äº†ï¼ŒåŒæ—¶ä¼šæ€æ­»è¿›ç¨‹ä¸­çš„æ‰€æœ‰åå°çº¿ç¨‹</strong>ã€‚åè¿‡æ¥è¯´ï¼Œåªè¦æœ‰ä»»ä½•éåå°çº¿ç¨‹è¿˜åœ¨è¿è¡Œï¼Œç¨‹åºå°±ä¸ä¼šç»ˆæ­¢ã€‚<br>å¿…é¡»åœ¨çº¿ç¨‹å¯åŠ¨ä¹‹å‰è°ƒç”¨setDaemonï¼ˆï¼‰æ–¹æ³•æ‰èƒ½æŠŠå®ƒè®¾ç½®ä¸ºåå°çº¿ç¨‹ï¼Œå¦‚ä»¥ä¸‹ä»£ç ï¼š </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Thread daemon = <span class="keyword">new</span> Thread(<span class="keyword">new</span> SimpleDaemon());</span><br><span class="line">daemon.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">daemon.start();</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥ç”¨isDaemon()æ–¹æ³•æ¥ç¡®å®šçº¿ç¨‹æ˜¯å¦æ˜¯ä¸€ä¸ªåå°çº¿ç¨‹ã€‚å¦‚æœæ˜¯ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œé‚£ä¹ˆå®ƒåˆ›å»ºçš„ä»»ä½•å­çº¿ç¨‹éƒ½å°†è¢«è‡ªåŠ¨è®¾ç½®æˆåå°çº¿ç¨‹ã€‚</p>
<p>9.æ˜¯çº¿ç¨‹ç¡çœ æ—¶å¯ä»¥è°ƒç”¨  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TimeUnit.MILLISECONDS.sleep(timeout);</span><br><span class="line">TimeUnit.HOURS.sleep(timeout);</span><br><span class="line">TimeUnit.MICROSECONDS.sleep(timeout);</span><br></pre></td></tr></table></figure>
<p>ç­‰æ–¹æ³•æ¥ä»£æ›¿ç›´æ¥è°ƒç”¨<code>Thread.sleep(timeout)</code>æ–¹æ³•ï¼Œè¿™æ ·æ—¶é—´çš„é•¿åº¦å°±æ›´ç›´è§‚ï¼Œè¿™äº›æ–¹æ³•å†…éƒ¨ä¼šè‡ªåŠ¨è°ƒç”¨Thread.sleep(timeout)æ–¹æ³•ã€‚  </p>
<p>10.join()æ–¹æ³•ï¼š  </p>
<ul>
<li>ä¸€ä¸ªçº¿ç¨‹å¯ä»¥åœ¨å…¶ä»–çº¿ç¨‹ä¹‹ä¸Šè°ƒç”¨joinï¼ˆï¼‰æ–¹æ³•ï¼Œå…¶æ•ˆæœæ˜¯ç­‰å¾…ä¸€æ®µæ—¶é—´ç›´åˆ°ç¬¬äºŒä¸ªçº¿ç¨‹ç»“æŸæ‰ç»§ç»­æ‰§è¡Œã€‚å¦‚æœæŸä¸ªçº¿ç¨‹åœ¨å¦ä¸€ä¸ªçº¿ç¨‹tä¸Šè°ƒç”¨t.join()ï¼Œæ­¤çº¿ç¨‹å°†è¢«æŒ‚èµ·ï¼Œç›´åˆ°ç›®æ ‡çº¿ç¨‹tç»“æŸæ‰æ¢å¤ï¼ˆå³t.isAlive()è¿”å›ä¸ºå‡ï¼‰ã€‚  </li>
<li>å¯ä»¥åœ¨è°ƒç”¨join()æ—¶å¸¦ä¸Šä¸€ä¸ªè¶…æ—¶å‚æ•°ï¼ˆå•ä½å¯ä»¥æ˜¯æ¯«ç§’ï¼Œæˆ–è€…æ¯«ç§’å’Œçº³ç§’ï¼‰ï¼Œè¿™æ ·å¦‚æœç›®æ ‡çº¿ç¨‹åœ¨è¿™æ®µæ—¶é—´åˆ°æœŸæ—¶è¿˜æ²¡æœ‰ç»“æŸçš„è¯ï¼Œjoin()æ–¹æ³•æ€»èƒ½è¿”å›ã€‚</li>
<li>å¯¹join()æ–¹æ³•çš„è°ƒç”¨å¯ä»¥è¢«ä¸­æ–­ï¼Œåšæ³•æ˜¯åœ¨è°ƒç”¨joinï¼ˆï¼‰çš„çº¿ç¨‹ä¸Šå†æ¬¡è°ƒç”¨interrupt()æ–¹æ³•ã€‚  </li>
</ul>
<p>11.ç”±äºçº¿ç¨‹çš„æœ¬è´¨ç‰¹æ€§ï¼Œä¸èƒ½æ•è·ä»çº¿ç¨‹ä¸­é€ƒé€¸çš„å¼‚å¸¸ï¼Œå³ä½¿åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œå­çº¿ç¨‹ä»»åŠ¡æ—¶æŠŠå®ƒåŒ…åœ¨try-catchå—ä¸­ï¼Œä»»ç„¶æ— æ³•æ•è·åˆ°é€ƒé€¸çš„å¼‚å¸¸ï¼Œå¼‚å¸¸ä¼šç›´æ¥å‘å¤–ä¼ æ’­çš„æ§åˆ¶å°ã€‚ä¸ºäº†æ•è·å¼‚å¸¸ï¼Œå¯ä»¥åœ¨æ¯ä¸ªæ–°åˆ›å»ºçš„Threadå¯¹è±¡ä¸Šé™„ç€ä¸€ä¸ªThread.UncaughtExceptionHandlerã€‚</p>
<p>ä¾‹å¦‚ä¸‹é¢çš„ä»£ç ï¼š  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>.run();</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"I throw this Exception on purpose!"</span>);</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadExceptionCaughtTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			MyThread t1 = <span class="keyword">new</span> MyThread();</span><br><span class="line">			t1.start();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			System.out.println(<span class="string">"Haha! Exception caught!!!"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œçš„ç»“æœä¸ºï¼š  </p>
<blockquote>
<p>Exception in thread â€œThread-0â€ java.lang.RuntimeException: I throw this Exception on purpose!<br>    at MyThread.run(ThreadExceptionCaughtTest.java:5)</p>
</blockquote>
<p>å¯è§try-catchå¹¶ä¸èƒ½æ•è·åˆ°æˆ‘åœ¨MyThreadä¸­æŠ›å‡ºçš„å¼‚å¸¸ã€‚  </p>
<p>é‚£ä¹ˆæˆ‘ä¸ºMyThreadé™„åŠ ä¸€ä¸ªæˆ‘è‡ªå·±å®ç°çš„UncaughtExceptionHandlerï¼Œä»£ç å¦‚ä¸‹ï¼š  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>.run();</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"I throw this Exception on purpose!"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyUncaughtExceptionHandler</span> <span class="keyword">implements</span> <span class="title">Thread</span>.<span class="title">UncaughtExceptionHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">uncaughtException</span><span class="params">(Thread t, Throwable e)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"Haha! I caught : "</span> + e);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadExceptionCaughtTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			MyThread t1 = <span class="keyword">new</span> MyThread();</span><br><span class="line">			t1.setUncaughtExceptionHandler(<span class="keyword">new</span> MyUncaughtExceptionHandler());</span><br><span class="line">			t1.start();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">			System.out.println(<span class="string">"Haha! Exception caught!!!"</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> 
<p>æ‰§è¡Œçš„ç»“æœä¸ºï¼š</p>
<blockquote>
<p>Haha! I caught : java.lang.RuntimeException: I throw this Exception on purpose!</p>
</blockquote>
<p>å¯ä»¥çœ‹åˆ°MyUncaughtExceptionHandleræˆåŠŸæ•è·åˆ°äº†MyThreadæŠ›å‡ºçš„å¼‚å¸¸ï¼Œtry-catchä»ç„¶æ²¡æœ‰æ•è·åˆ°å¼‚å¸¸ã€‚  </p>
<p>12.å…³äº<strong>synchronizedæ–¹æ³•</strong><br>æ‰€æœ‰å¯¹è±¡éƒ½è‡ªåŠ¨å«æœ‰å•ä¸€çš„é”ï¼ˆä¹Ÿç§°ä¸ºç›‘è§†å™¨ï¼‰ã€‚å½“åœ¨å¯¹è±¡ä¸Šè°ƒç”¨å…¶ä»»æ„synchronizedæ–¹æ³•çš„æ—¶å€™ï¼Œæ­¤å¯¹è±¡éƒ½è¢«åŠ é”ï¼Œ<strong>è¿™æ—¶è¯¥å¯¹è±¡ä¸Šçš„å…¶ä»–synchronizedæ–¹æ³•åªæœ‰ç­‰åˆ°å‰ä¸€ä¸ªæ–¹æ³•è°ƒç”¨å®Œæ¯•å¹¶é‡Šæ”¾äº†é”ä¹‹åæ‰èƒ½è¢«è°ƒç”¨</strong>ã€‚<br>ä¾‹å¦‚è¿™æ®µä»£ç ï¼š  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserAccount</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> account;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">UserAccount</span><span class="params">(<span class="keyword">int</span> account)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="keyword">this</span>.account = account;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">synchronized</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">incAccount</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Thread.currentThread().sleep(<span class="number">2000</span>);</span><br><span class="line">			System.out.println(<span class="string">"incAccount result: "</span> + ++account);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">synchronized</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decAccount</span><span class="params">()</span></span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"decAccount result: "</span> + --account);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchronizedTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		UserAccount ua = <span class="keyword">new</span> UserAccount(<span class="number">200</span>);</span><br><span class="line">		Thread t1 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				ua.incAccount();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		Thread t2 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				ua.decAccount();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		System.out.println(<span class="string">"===start==="</span>);</span><br><span class="line">		t1.start();</span><br><span class="line">		t2.start();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> 
<p>å…¶æ‰§è¡Œç»“æœå§‹ç»ˆä¸ºï¼š  </p>
<blockquote>
<p>===start===<br>incAccount result: 201<br>decAccount result: 200</p>
</blockquote>
<p>ä¸”æ§åˆ¶å°æ‰“å°å‡ºâ€œ===start===â€åï¼Œä¼šæš‚åœ2ç§’é’Ÿæ‰ç»§ç»­è¾“å‡ºåé¢çš„2è¡Œç»“æœã€‚</p>
<p>è€Œå¦‚æœæŠŠå‡½æ•°decAccountï¼ˆï¼‰å‰é¢çš„synchronizedä¿®é¥°ç¬¦å»æ‰ï¼Œåˆ™æ‰“å°ç»“æœä¸ºï¼š   </p>
<blockquote>
<p>===start===<br>decAccount result: 199<br>incAccount result: 200</p>
</blockquote>
<p>ä¸”å‰ä¸¤è¡Œç»“æœæ˜¯ç¬é—´æ‰“å°å‡ºæ¥çš„ï¼Œç„¶åæš‚åœäº†2ç§’ï¼Œæ‰è¾“å‡ºæœ€åä¸€è¡Œç»“æœã€‚  </p>
<p>13.åœ¨ä½¿ç”¨å¹¶å‘æ—¶ï¼Œå°†åŸŸè®¾ç½®ä¸ºprivateæ˜¯éå¸¸é‡è¦çš„ï¼Œå¦åˆ™ï¼Œsynchronizedå…³é”®å­—å°±ä¸èƒ½é˜²æ­¢å…¶ä»–ä»»åŠ¡ç›´æ¥è®¿é—®åŸŸï¼Œè¿™æ ·å°±ä¼šäº§ç”Ÿå†²çªã€‚<br>å¦‚æœä½ çš„ç±»ä¸­æœ‰è¶…è¿‡ä¸€ä¸ªæ–¹æ³•åœ¨å¤„ç†ä¸´ç•Œæ•°æ®ï¼Œé‚£ä¹ˆä½ å¿…é¡»åŒæ­¥æ‰€æœ‰ç›¸å…³çš„æ–¹æ³•ã€‚</p>
<p>14.ä¸€ä¸ªä»»åŠ¡å¯ä»¥å¤šæ¬¡è·å¾—å¯¹è±¡çš„é”ã€‚JVMè´Ÿè´£è·Ÿè¸ªå¯¹è±¡è¢«åŠ é”çš„æ¬¡æ•°ã€‚åªæœ‰é¦–å…ˆè·å¾—äº†é”çš„ä»»åŠ¡æ‰èƒ½å…è®¸ç»§ç»­è·å–å¤šä¸ªé”ã€‚  </p>
<p>15.é’ˆå¯¹æ¯ä¸ªç±»ï¼Œä¹Ÿæœ‰ä¸€ä¸ªé”ï¼Œä½œä¸ºç±»çš„Classå¯¹è±¡çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥synchronized staticæ–¹æ³•å¯ä»¥åœ¨ç±»çš„èŒƒå›´å†…é˜²æ­¢å¯¹staticæ•°æ®çš„å¹¶å‘è®¿é—®ã€‚  </p>
<p>16.åœ¨java.util.concurrent.locksä¸­å®šä¹‰äº†æ˜¾ç¤ºçš„äº’æ–¥æœºåˆ¶Lockã€‚Lockå¯¹è±¡å¿…é¡»è¢«æ˜¾ç¤ºåœ°åˆ›å»ºã€é”å®šå’Œé‡Šæ”¾ã€‚<br>å¥½çš„ä½¿ç”¨ä¹ æƒ¯æ˜¯ï¼Œä½¿ç”¨try-finallyè¯­å¥å—ï¼Œå°†lockï¼ˆï¼‰æ”¾åœ¨tryä¸­ï¼Œå°†unlockï¼ˆï¼‰æ”¾åœ¨finallyä¸­ã€‚æ³¨æ„ï¼Œreturnè¯­å¥å¿…é¡»æ”¾åœ¨tryå­å¥ä¸­ï¼Œä»¥ç¡®ä¿unlockï¼ˆï¼‰ä¸ä¼šè¿‡æ—©å‘ç”Ÿï¼Œä»è€Œå°†æ•°æ®æš´éœ²ç»™ç¬¬äºŒä¸ªä»»åŠ¡ã€‚  </p>
<p>17.å¦‚æœå°†ä¸€ä¸ªåŸŸå£°æ˜ä¸ºvolatileçš„ï¼Œé‚£ä¹ˆåªè¦å¯¹è¿™ä¸ªåŸŸäº§ç”Ÿäº†å†™æ“ä½œï¼Œé‚£ä¹ˆæ‰€æœ‰çš„è¯»æ“ä½œå°±éƒ½å¯ä»¥çœ‹åˆ°è¿™ä¸ªä¿®æ”¹ã€‚å³ä¾¿ä½¿ç”¨äº†æœ¬åœ°ç¼“å­˜ï¼Œæƒ…å†µä¹Ÿç¡®å®å¦‚æ­¤ï¼ŒvolatileåŸŸä¼šç«‹å³è¢«å†™å…¥åˆ°ä¸»å­˜ä¸­ï¼Œè€Œè¯»å–æ“ä½œå°±å‘ç”Ÿåœ¨ä¸»å­˜ä¸­ã€‚<br>å¦‚æœå¤šä¸ªä»»åŠ¡åœ¨åŒæ—¶è®¿é—®æŸä¸ªåŸŸï¼Œé‚£ä¹ˆè¿™ä¸ªåŸŸå°±åº”è¯¥æ˜¯volatileçš„ï¼Œå¦åˆ™ï¼Œè¿™ä¸ªåŸŸå°±åº”è¯¥åªèƒ½ç»ç”±åŒæ­¥æ¥è®¿é—®ã€‚åŒæ­¥ä¹Ÿä¼šå¯¼è‡´å‘ä¸»å­˜ä¸­åˆ·æ–°ï¼Œå› æ­¤å¦‚æœä¸€ä¸ªåŸŸå®Œå…¨ç”±synchronizedæ–¹æ³•æˆ–è¯­å¥å—æ¥é˜²æŠ¤ï¼Œé‚£å°±ä¸å¿…å°†å…¶è®¾ç½®ä¸ºæ˜¯volatileçš„ã€‚<br>ä½¿ç”¨volatileè€Œä¸æ˜¯synchronizedçš„å”¯ä¸€å®‰å…¨çš„æƒ…å†µæ˜¯ç±»ä¸­åªæœ‰ä¸€ä¸ªå¯å˜çš„åŸŸã€‚ä½ çš„ç¬¬ä¸€é€‰æ‹©åº”è¯¥æ˜¯ä½¿ç”¨synchronizedå…³é”®å­—ï¼Œè¿™æ˜¯æœ€å®‰å…¨çš„æ–¹å¼ï¼Œè€Œå°è¯•å…¶ä»–ä»»ä½•æ–¹å¼éƒ½æ˜¯æœ‰é£é™©çš„ã€‚ï¼ˆæˆ‘ç†è§£è¿™å¥è¯æƒ³è¡¨è¾¾çš„æ„æ€æ˜¯ï¼Œå°½é‡ä¸è¦ä½¿ç”¨volatileå…³é”®å­—ï¼Œè€Œæ˜¯ä½¿ç”¨synchronizedå…³é”®å­—æˆ–è€…Lockç±»ã€‚ï¼‰  </p>
<p>18.è°ƒç”¨sleep()å’Œyieldï¼ˆï¼‰çš„æ—¶å€™å¹¶æ²¡æœ‰é‡Šæ”¾é”ã€‚<br>è°ƒç”¨wait()çš„æ—¶å€™é”è¢«é‡Šæ”¾ã€‚<br>wait()ã€notifyï¼ˆï¼‰ä»¥åŠnotifyAll()æœ‰ä¸€ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„æ–¹é¢ï¼Œé‚£å°±æ˜¯è¿™äº›æ–¹æ³•æ˜¯åŸºç±»Objectçš„ä¸€éƒ¨åˆ†ï¼Œè€Œä¸æ˜¯å±äºThreadçš„ä¸€éƒ¨åˆ†ï¼Œåªèƒ½åœ¨synchronizedæ–¹æ³•æˆ–synchronizedå—ä¸­è°ƒç”¨è¿™å‡ ä¸ªæ–¹æ³•ã€‚sleepï¼ˆï¼‰å¯ä»¥åœ¨ésynchronizedæ§åˆ¶æ–¹æ³•é‡Œè°ƒç”¨ï¼Œæ˜¯å› ä¸ºä¸ç”¨æ“ä½œé”ã€‚</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>1.Executorå…è®¸ä½ ç®¡ç†å¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œï¼Œè€Œæ— é¡»æ˜¾ç¤ºåœ°ç®¡ç†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸã€‚Executoråœ¨Java SE5/6ä¸­æ˜¯å¯åŠ¨ä»»åŠ¡çš„ä¼˜é€‰æ–¹æ³•ã€‚å¯ä»¥ä½¿ç”¨Executoræ¥ä»£æ›¿æ˜¾ç¤ºåœ°åˆ›å»ºThreadå¯¹è±¡ã€‚  </p>
<p>2.ExecutorServiceçŸ¥é“å¦‚ä½•æ„å»ºæ°å½“çš„ä¸Šä¸‹æ–‡æ¥æ‰§è¡ŒRunnableå¯¹è±¡ã€‚  </p>
<p>3.CachedThreadPoolåœ¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­é€šå¸¸ä¼šåˆ›å»ºä¸æ‰€éœ€æ•°é‡ç›¸åŒçš„çº¿ç¨‹ï¼Œç„¶åå†å®ƒå›æ”¶æ—§çº¿ç¨‹æ—¶åœæ­¢åˆ›å»ºæ–°çº¿ç¨‹ï¼Œå› æ­¤å®ƒæ˜¯åˆç†çš„Executorçš„é¦–é€‰ã€‚åªæœ‰å½“è¿™ç§æ–¹å¼ä¼šå¼•å‘é—®é¢˜æ—¶ï¼Œæ‰éœ€è¦åˆ‡æ¢åˆ°FixedThreadPoolã€‚<br>]]>
    
    </summary>
    
      <category term="Java" scheme="http://www.carrotsight.com/tags/Java/"/>
    
      <category term="å¤šçº¿ç¨‹" scheme="http://www.carrotsight.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
      <category term="å¹¶å‘" scheme="http://www.carrotsight.com/tags/%E5%B9%B6%E5%8F%91/"/>
    
      <category term="Java" scheme="http://www.carrotsight.com/categories/Java/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[ã€FLEX bug:æ— æ³•å¯åŠ¨æœåŠ¡ï¼Œå› ä¸ºfmlæ–‡ä»¶æŸåã€‘çš„è§£å†³åŠæ³•]]></title>
    <link href="http://www.carrotsight.com/2013/12/02/2013-12-2-FLEX%E6%97%A0%E6%B3%95%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1%E5%9B%A0%E4%B8%BAfml%E6%96%87%E4%BB%B6%E6%8D%9F%E5%9D%8F.html"/>
    <id>http://www.carrotsight.com/2013/12/02/2013-12-2-FLEXæ— æ³•å¯åŠ¨æœåŠ¡å› ä¸ºfmlæ–‡ä»¶æŸå.html</id>
    <published>2013-12-02T05:01:15.000Z</published>
    <updated>2015-12-03T12:00:06.000Z</updated>
    <content type="html"><![CDATA[<p>åœ¨Flash Builderä¸­ï¼Œæç¤º</p>
<blockquote>
<p>FLEX bug:æ— æ³•å¯åŠ¨æœåŠ¡ï¼Œå› ä¸ºfmlæ–‡ä»¶æŸåã€‚</p>
</blockquote>
<a id="more"></a>
<p>å…·ä½“é”™è¯¯æç¤ºå¿˜äº†ï¼Œå·®ä¸å¤šå°±æ˜¯è¿™å¥è¯ã€‚</p>
<p>å¦‚æœé‡åˆ°è¿™ç§æƒ…å†µï¼ŒæŠŠé¡¹ç›®ç›®å½•ä¸‹çš„.model/<em>*</em>.fmlæ–‡ä»¶ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€ï¼Œåˆ æ‰åæ‰çš„æœåŠ¡ï¼Œä¹Ÿå°±æ˜¯<service>æ ‡ç­¾ä¹‹é—´çš„éƒ¨åˆ†ï¼Œç„¶ååœ¨å›å»çœ‹FLEXï¼Œå°±å¯ä»¥åˆ æ‰ä¹‹å‰çš„æ•°æ®æœåŠ¡äº†ã€‚</service></p>
]]></content>
    <summary type="html">
    <![CDATA[<p>åœ¨Flash Builderä¸­ï¼Œæç¤º</p>
<blockquote>
<p>FLEX bug:æ— æ³•å¯åŠ¨æœåŠ¡ï¼Œå› ä¸ºfmlæ–‡ä»¶æŸåã€‚</p>
</blockquote>]]>
    
    </summary>
    
      <category term="Flex" scheme="http://www.carrotsight.com/categories/Flex/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[Flexä¸­datagridä¸­checkboxçš„å…¨é€‰å®ç°]]></title>
    <link href="http://www.carrotsight.com/2013/04/03/2013-4-3-Flex%E4%B8%ADdatagrid%E4%B8%ADcheckbox%E7%9A%84%E5%85%A8%E9%80%89%E5%AE%9E%E7%8E%B0.html"/>
    <id>http://www.carrotsight.com/2013/04/03/2013-4-3-Flexä¸­datagridä¸­checkboxçš„å…¨é€‰å®ç°.html</id>
    <published>2013-04-03T03:44:21.000Z</published>
    <updated>2015-12-03T08:05:31.000Z</updated>
    <content type="html"><![CDATA[<p>å‡è®¾ä½ç¨‹åºçš„è¡¨æ ¼ä¸­æœ‰ä¸€åˆ—æ˜¯checkboxï¼Œç”¨æˆ·å‹¾é€‰åè¿›è¡Œå…¶ä»–æ“ä½œï¼Œå®šä¹‰ä¸ºï¼š</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">chkChooseAll_changeHandler</span><span class="params">(event:Event)</span><span class="type">:void</span></span><br><span class="line"></span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> <span class="keyword">each</span>(<span class="keyword">var</span> item:XML <span class="keyword">in</span> adg.dataProvider)</span><br><span class="line">   &#123;</span><br><span class="line">       item.@selected = chkChooseAll.selected;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>å³å°†è¡¨æ ¼æ•°æ®æºå¯¹åº”é¡¹çš„selectdå±æ€§è®¾ç½®ä¸ºå…¨é€‰æ¡†çš„é€‰ä¸­çŠ¶æ€ã€‚</p>
<p>ä¸‹é¢ä¸»è¦è¦å¤„ç†è¡¨æ ¼ä¸­chkColåˆ—å¯¹å±æ€§æ”¹å˜çš„å“åº”ï¼Œå³è‡ªåŠ¨æ›´æ–°å…¨é€‰çŠ¶æ€ã€‚æ–¹æ³•ä¸ºï¼š<br>åœ¨itemRenderä¸­ï¼Œé‡è½½dataå±æ€§çš„setæ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span> <span class="title">data</span><span class="params">(value:Object)</span><span class="type">:void</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(value.@selected == <span class="string">"true"</span>)</span><br><span class="line">    &#123;</span><br><span class="line">         chkbox.selected = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         chkbox.selected = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®Œæ•´çš„itemRenderæºç å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://7xle8x.com1.z0.glb.clouddn.com/FlexItemRender.png" alt=""></p>
]]></content>
    <summary type="html">
    <![CDATA[<p>å‡è®¾ä½ç¨‹åºçš„è¡¨æ ¼ä¸­æœ‰ä¸€åˆ—æ˜¯checkboxï¼Œç”¨æˆ·å‹¾é€‰åè¿›è¡Œå…¶ä»–æ“ä½œï¼Œå®šä¹‰ä¸ºï¼š</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">chkChooseAll_changeHandler</span><span class="params">(event:Event)</span><span class="type">:void</span></span><br><span class="line"></span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> <span class="keyword">each</span>(<span class="keyword">var</span> item:XML <span class="keyword">in</span> adg.dataProvider)</span><br><span class="line">   &#123;</span><br><span class="line">       item.@selected = chkChooseAll.selected;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]>
    
    </summary>
    
      <category term="Flex" scheme="http://www.carrotsight.com/categories/Flex/"/>
    
  </entry>
  
</feed>
